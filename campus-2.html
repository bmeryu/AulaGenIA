<!DOCTYPE html>  
<html lang="es-CL" class="scroll-smooth">

<head>
    <!-- Meta Pixel Code -->
    <script>
        !function (f, b, e, v, n, t, s) {
            if (f.fbq) return; n = f.fbq = function () {
                n.callMethod ?
                    n.callMethod.apply(n, arguments) : n.queue.push(arguments)
            };
            if (!f._fbq) f._fbq = n; n.push = n; n.loaded = !0; n.version = '2.0';
            n.queue = []; t = b.createElement(e); t.async = !0;
            t.src = v; s = b.getElementsByTagName(e)[0];
            s.parentNode.insertBefore(t, s)
        }(window, document, 'script',
            'https://connect.facebook.net/en_US/fbevents.js');
        fbq('init', '1356922049450142');
        fbq('track', 'PageView');
    </script>
    <noscript><img height="1" width="1" style="display:none"
            src="https://www.facebook.com/tr?id=1356922049450142&ev=PageView&noscript=1" /></noscript>
    <!-- End Meta Pixel Code -->
    <meta charset="UTF-8">
    <title>Campus Virtual ‚Äì Aula GenIA (Con Acceso)</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="robots" content="noindex, nofollow">
    <meta name="description"
        content="Dashboard de estudiante para acceder a cursos, recursos y comunidad de Aula GenIA.">
    <link rel="canonical" href="https://aulagenia.cl/campus.html">
    <link rel="icon" href="https://aulagenia.cl/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="https://aulagenia.cl/Logo_AGIA.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link href="css/styles.css" rel="stylesheet">
    <script src="https://unpkg.com/lucide@0.368.0/dist/umd/lucide.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --brand-teal: #14b8a6;
            --brand-green: #22c55e;
            --brand-purple: #7c3aed
        }

        html {
            font-family: Poppins, sans-serif
        }

        body {
            background-color: #f8fafc
        }

        .pro-shine {
            position: relative;
            overflow: hidden
        }

        .pro-shine::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 50%;
            height: 100%;
            background: linear-gradient(to right, transparent, rgba(255, 255, 255, .2), transparent);
            transform: skewX(-25deg);
            animation: shine 6s infinite
        }

        @keyframes shine {
            0% {
                left: -100%
            }

            20% {
                left: 200%
            }

            100% {
                left: 200%
            }
        }

        #profile-modal {
            transition: all .3s ease-in-out
        }

        @keyframes pulse-slow {

            0%,
            100% {
                opacity: 1
            }

            50% {
                opacity: .85
            }
        }

        .animate-pulse-slow {
            animation: pulse-slow 3s cubic-bezier(.4, 0, .6, 1) infinite
        }
    </style>
</head>

<body class="text-gray-800">
    <header class="bg-white shadow-sm sticky top-0 z-30">
        <nav class="container mx-auto px-6 py-4 flex items-center justify-between"><a href="/"
                class="flex items-center gap-2" aria-label="Ir al inicio de Aula GenIA"><img
                    src="https://aulagenia.cl/Logo_AGIA.png" alt="Logo Aula GenIA" class="h-16 w-auto"></a>
            <div id="user-profile" class="hidden sm:flex items-center gap-3 relative"><span id="user-name"
                    class="font-semibold text-gray-700 truncate max-w-[15ch]"></span> <button id="avatar-button"
                    aria-label="Abrir men√∫ de perfil"><img id="user-avatar" alt="Avatar del usuario"
                        class="w-10 h-10 rounded-full border-2 border-teal-500 cursor-pointer hover:opacity-90 transition-opacity"></button>
                <button id="logout-btn" class="text-sm text-gray-500 hover:text-red-600 transition-colors">Cerrar
                    sesi√≥n</button>
            </div>
        </nav>
    </header>
    <main class="container mx-auto px-6 py-12 max-w-7xl">
        <section class="mb-12">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900 leading-tight">¬°Bienvenido de nuevo, <span
                    id="welcome-name" class="whitespace-nowrap">Aprendiz</span>!</h1>
            <p class="text-lg text-gray-600 mt-2">Tu centro de comando para dominar la IA.</p>
        </section>
        <section aria-labelledby="courses-heading" class="mb-16">
            <h2 id="courses-heading"
                class="text-2xl font-bold border-b border-gray-300 pb-3 mb-6 flex items-center gap-2"><i
                    data-lucide="graduation-cap" class="w-6 h-6 text-gray-400"></i> Mis Cursos</h2>
            <div class="grid gap-8 sm:grid-cols-2 lg:grid-cols-3">
                <!-- Starter Card -->
                <article class="bg-white rounded-2xl shadow card-hover overflow-hidden flex flex-col"
                    data-course-id="ia-aplicada-starter">
                    <div class="p-6 flex-grow">
                        <span
                            class="tag inline-block text-xs font-semibold uppercase tracking-wider text-gray-600 bg-gray-100 px-2 py-1 rounded-full">B√°sico</span>
                        <h3 class="text-xl font-bold mt-4 mb-1">IA Aplicada ¬∑ Pack Starter</h3>
                        <p class="text-gray-600 text-sm mb-6">M√≥dulos 1-4. Domina los fundamentos y ahorra tiempo.
                            <br><span class="text-xs text-teal-600 font-bold flex items-center gap-1 mt-1"><i
                                    data-lucide="check-circle" class="w-3 h-3"></i> Incluye 100 Prompts + App</span>
                        </p>
                        <div class="mb-2 progress-container hidden">
                            <div class="flex justify-between text-sm font-medium text-gray-600 mb-1">
                                <span>Progreso</span> <span class="percent">0%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2.5">
                                <div class="fill h-2.5 rounded-full transition-all duration-500"
                                    style="background-color:var(--brand-teal);width:0%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer bg-gray-50 px-6 py-4">
                        <button onclick="initiateStarterPurchase('campus_card')"
                            class="course-action-btn w-full block text-center bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-5 rounded-lg transition-colors">
                            üîí Obtener por $5 USD
                        </button>
                    </div>
                </article>

                <!-- Esencial Card -->
                <article class="bg-white rounded-2xl shadow card-hover overflow-hidden flex flex-col"
                    data-course-id="ia-aplicada-esencial">
                    <div class="p-6 flex-grow">
                        <span
                            class="tag inline-block text-xs font-semibold uppercase tracking-wider text-purple-600 bg-purple-100 px-2 py-1 rounded-full">Completo</span>
                        <h3 class="text-xl font-bold mt-4 mb-1">IA Aplicada ¬∑ Pack Esencial</h3>
                        <p class="text-gray-600 text-sm mb-6">M√≥dulos 1-4 + Sesi√≥n Estrat√©gica y Consultor√≠a.
                            <br><span class="text-xs text-teal-600 font-bold flex items-center gap-1 mt-1"><i
                                    data-lucide="check-circle" class="w-3 h-3"></i> Incluye 100 Prompts + App</span>
                        </p>
                        <div class="mb-2 progress-container hidden">
                            <div class="flex justify-between text-sm font-medium text-gray-600 mb-1">
                                <span>Progreso</span> <span class="percent">0%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2.5">
                                <div class="fill h-2.5 rounded-full transition-all duration-500"
                                    style="background-color:var(--brand-purple);width:0%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer bg-gray-50 px-6 py-4">
                        <button onclick="initiateEssentialPurchase('campus_card')"
                            class="course-action-btn w-full block text-center bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-5 rounded-lg transition-colors">
                            üîí Mejorar Plan ($20 USD)
                        </button>
                    </div>
                </article>
                <article id="prompts-card"
                    class="relative group rounded-2xl overflow-hidden shadow-lg transition-all duration-500 hover:shadow-2xl bg-white border-2 border-gray-200 flex flex-col">
                    <div class="p-6 flex-grow flex flex-col">
                        <h3 class="text-2xl font-bold text-gray-900 mb-2">Generador Maestro de Prompts</h3>
                        <p class="text-gray-600 text-sm mb-4 leading-relaxed">Crea prompts de nivel experto en segundos.
                            B√≥veda interactiva con <span class="font-bold text-teal-600">+100 estructuras
                                probadas</span>.</p>

                        <!-- Buttons container (Dynamic) -->
                        <div id="prompts-actions" class="mt-auto">
                            <!-- Locked State (Default) -->
                            <a href="#" onclick="event.preventDefault(),buyCourse('ia-aplicada-starter', 'LANZAMIENTO')"
                                style="background-color: #0d9488 !important;"
                                class="btn-locked block text-center bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-5 rounded-xl shadow-md hover:shadow-lg transition-all transform hover:-translate-y-0.5 mb-3">üîí
                                Inscr√≠bete para Acceder ‚ú®</a>
                            <button onclick="buyCourse('ia-aplicada-starter', 'LANZAMIENTO')"
                                style="background-color: #0d9488 !important;"
                                class="btn-locked block w-full text-center bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-5 rounded-xl shadow-md hover:shadow-lg transition-all transform hover:-translate-y-0.5">üîí
                                Descargar 100 Prompts PDF ‚ú®</button>
                        </div>
                    </div>
                </article>
                <article class="bg-white rounded-2xl shadow card-hover overflow-hidden flex flex-col"
                    id="programa-avanzado" data-course-id="programa-avanzado">
                    <div class="p-6 flex-grow">
                        <h3 class="text-xl font-bold mt-4 mb-2">Creador de <span class="text-blue-600">Magia</span></h3>
                        <p class="font-semibold text-gray-500 text-sm mb-4">Programa Avanzado</p>
                        <p class="text-gray-600 text-sm mb-6">Deja de copiar. Aprende a crear tus propias herramientas y
                            asistentes inteligentes.</p>
                    </div>
                    <div class="bg-gray-50 px-6 py-4 mt-auto"><button id="waitlist-btn"
                            class="w-full text-center bg-white border-2 border-blue-600 text-blue-600 hover:bg-blue-50 font-bold py-3 px-5 rounded-lg transition-colors flex items-center justify-center gap-2"><span
                                id="waitlist-btn-text">Unirme a la lista de espera</span> <i id="waitlist-btn-spinner"
                                data-lucide="loader-2" class="h-5 w-5 animate-spin hidden"></i></button></div>
                </article>
                <article
                    class="bg-white rounded-2xl shadow card-hover overflow-hidden flex flex-col opacity-75 hover:opacity-100 transition-opacity"
                    data-course-id="laboratorio-experto">
                    <div class="p-6 flex-grow">
                        <h3 class="text-xl font-bold mt-4 mb-2">Mentor√≠a <span class="text-indigo-600">Experta</span>
                        </h3>
                        <p class="text-gray-600 text-sm mb-6">Acompa√±amiento 1 a 1 para tus proyectos m√°s importantes.
                        </p>
                    </div>
                    <div class="bg-gray-50 px-6 py-4 mt-auto"><button id="reserve-btn"
                            class="w-full text-center text-gray-500 hover:text-indigo-600 font-bold py-3 px-5 transition-colors text-sm"><span
                                id="reserve-btn-text">Consultar disponibilidad</span> <i id="reserve-btn-spinner"
                                data-lucide="loader-2" class="h-5 w-5 animate-spin hidden"></i></button></div>
                </article>
            </div>
            <footer class="bg-white border-t mt-16 text-center text-gray-500 text-sm py-6">¬© 2025 Aula GenIA ¬∑ Todos los
                derechos reservados.</footer>
            <div id="profile-modal-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden z-40"></div>
            <div id="profile-modal" class="fixed inset-0 hidden z-50 flex items-center justify-center p-4">
                <div
                    class="bg-white rounded-2xl shadow-2xl w-full max-w-lg flex flex-col transform transition-all scale-95 opacity-0">
                    <div class="p-6 flex-shrink-0">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 id="profile-modal-title" class="text-2xl font-bold text-gray-900">Editar Perfil</h3>
                                <p id="profile-modal-subtitle" class="text-gray-600 mt-1">Mant√©n tus datos actualizados.
                                </p>
                            </div><button id="close-profile-modal-btn"
                                class="text-gray-400 hover:text-gray-600">&times;</button>
                        </div>
                    </div>
                    <div class="px-6 pb-2 flex-grow overflow-y-auto">
                        <form id="profile-form" class="space-y-3" novalidate>
                            <div><label for="profile-name-input"
                                    class="block text-sm font-medium text-gray-700 mb-1">Nombre Completo <span
                                        class="required">*</span></label>
                                <div class="relative"><input type="text" id="profile-name-input" name="fullName"
                                        class="w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 pr-10"
                                        placeholder="Ej: Ada Lovelace"> <span id="name-status-icon"
                                        class="absolute inset-y-0 right-0 flex items-center pr-3"></span></div>
                                <p class="text-xs text-gray-500 mt-1">Este ser√° el nombre en tu certificado.</p>
                                <div id="name-error" class="error-message"></div>
                            </div>
                            <div><label for="profile-rut-input" class="block text-sm font-medium text-gray-700 mb-1">RUT
                                    (Chile) <span class="required">*</span></label>
                                <div class="relative"><input type="text" id="profile-rut-input" name="rut"
                                        class="w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 pr-10"
                                        placeholder="Ej: 12345678-9"> <span id="rut-status-icon"
                                        class="absolute inset-y-0 right-0 flex items-center pr-3"></span></div>
                                <p class="text-xs text-gray-500 mt-1">Requerido si tu pa√≠s es Chile.</p>
                                <div id="rut-error" class="error-message"></div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <div><label for="profile-country-select"
                                        class="block text-sm font-medium text-gray-700 mb-1">Pa√≠s <span
                                            class="required">*</span></label>
                                    <div class="relative"><select id="profile-country-select" name="country"
                                            class="w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 pr-12 appearance-none">
                                            <option value="" class="text-gray-400" disabled selected>Selecciona tu
                                                pa√≠s...</option>
                                            <option value="CL">Chile</option>
                                            <option value="AR">Argentina</option>
                                            <option value="PE">Per√∫</option>
                                            <option value="CO">Colombia</option>
                                            <option value="MX">M√©xico</option>
                                            <option value="ES">Espa√±a</option>
                                            <option value="US">Estados Unidos</option>
                                            <option value="OT">Otro</option>
                                        </select>
                                        <!-- Custom Arrow to avoid double arrows with padding adjustments -->
                                        <div
                                            class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                                            <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg"
                                                viewBox="0 0 20 20">
                                                <path
                                                    d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z" />
                                            </svg>
                                        </div>
                                        <span id="country-status-icon"
                                            class="absolute inset-y-0 right-8 flex items-center pointer-events-none"></span>
                                    </div>
                                    <div id="country-error" class="error-message"></div>
                                </div>
                                <div><label for="profile-job-input"
                                        class="block text-sm font-medium text-gray-700 mb-1">Cargo o Profesi√≥n</label>
                                    <input type="text" id="profile-job-input" name="jobTitle"
                                        class="w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500"
                                        placeholder="Ej: Estudiante">
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <div><label for="profile-gender-select"
                                        class="block text-sm font-medium text-gray-700 mb-1">G√©nero</label> <select
                                        id="profile-gender-select" name="gender"
                                        class="w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500">
                                        <option value="">Seleccionar...</option>
                                        <option value="female">Femenino</option>
                                        <option value="male">Masculino</option>
                                        <option value="other">Otro</option>
                                        <option value="prefer_not_to_say">Prefiero no decir</option>
                                    </select></div>
                                <div><label for="profile-birthdate-input"
                                        class="block text-sm font-medium text-gray-700 mb-1">Fecha de Nacimiento</label>
                                    <input type="date" id="profile-birthdate-input" name="birthdate"
                                        class="w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500">
                                </div>
                            </div>
                            <div><label for="profile-email-input"
                                    class="block text-sm font-medium text-gray-700 mb-1">Correo Electr√≥nico</label>
                                <input type="email" id="profile-email-input"
                                    class="w-full rounded-md border-gray-300 shadow-sm bg-gray-100 cursor-not-allowed"
                                    disabled="disabled">
                            </div>
                            <div id="form-status" class="text-center p-3 rounded-lg hidden"></div>
                        </form>
                    </div>
                    <div class="p-6 pt-4 flex-shrink-0">
                        <div class="flex justify-end gap-3 pt-4 border-t"><button type="button" id="cancel-profile-btn"
                                class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors">Cancelar</button>
                            <button type="submit" form="profile-form" id="save-profile-btn"
                                class="bg-teal-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-600 transition-colors flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"><span
                                    id="save-btn-text">Guardar Cambios</span> <i id="save-spinner"
                                    data-lucide="loader-2" class="h-5 w-5 animate-spin hidden"></i></button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="coupon-modal"
                class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
                <div class="bg-white rounded-2xl max-w-md w-full p-8 shadow-2xl transform transition-all">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-black text-gray-900">¬øTienes un cup√≥n?</h3><button
                            onclick="closeCouponModal()" class="text-gray-400 hover:text-gray-600"><svg class="w-6 h-6"
                                fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12" />
                            </svg></button>
                    </div>
                    <div class="mb-6"><label class="block text-sm font-bold text-gray-700 mb-2">C√≥digo de descuento
                            (opcional)</label> <input type="text" id="modal-coupon-input"
                            placeholder="Ingresa tu c√≥digo"
                            class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 uppercase font-mono text-lg"
                            maxlength="20">
                        <div id="modal-coupon-message" class="mt-2 text-sm font-medium hidden"></div>
                    </div>
                    <div id="modal-discount-summary"
                        class="mb-6 p-4 bg-green-50 border-2 border-green-200 rounded-lg hidden">
                        <div class="flex justify-between items-center mb-2"><span class="text-gray-600">Precio
                                original:</span> <span class="text-gray-900 font-bold" id="modal-original-price"></span>
                        </div>
                        <div class="flex justify-between items-center mb-2"><span
                                class="text-green-600 font-bold">Descuento (<span
                                    id="modal-discount-label"></span>):</span> <span
                                class="text-green-600 font-bold text-xl" id="modal-discount-amount"></span></div>
                        <div class="flex justify-between items-center pt-2 border-t-2 border-green-300"><span
                                class="text-gray-900 font-black text-lg">Total a pagar:</span> <span
                                class="text-3xl font-black text-green-600" id="modal-final-price"></span></div>
                        <p class="mt-3 text-xs text-gray-500 italic">* El descuento se aplicar√° autom√°ticamente en
                            Mercado Pago. Si el cup√≥n no se aplica correctamente, cont√°ctanos antes de completar el
                            pago.</p>
                    </div>
                    <div class="flex gap-3"><button onclick="proceedWithoutCoupon()"
                            class="flex-1 px-6 py-3 border-2 border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-bold">Sin
                            cup√≥n</button> <button id="modal-apply-btn" onclick="applyModalCoupon()"
                            class="flex-1 px-6 py-3 bg-teal-600 text-white rounded-lg hover:bg-teal-700 transition-colors font-bold">Aplicar
                            y continuar</button></div>
                </div>
            </div>
            <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js" defer="defer"></script>
            <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js" defer="defer"></script>
            <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js" defer="defer"></script>
            <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-functions-compat.js" defer="defer"></script>
            <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-analytics-compat.js" defer="defer"></script>
            <script defer="defer">document.addEventListener("DOMContentLoaded", () => {
                    const e = { apiKey: "AIzaSyC9sVJwEfFdIN4VmSMooAoQLXYl5Mcu1yM", authDomain: "aulagenia.firebaseapp.com", projectId: "aulagenia", storageBucket: "aulagenia.appspot.com", messagingSenderId: "173328075630", appId: "1:173328075630:web:825606db4271ea1e66cf7f" }; try { firebase.initializeApp(e) } catch (e) { console.warn("Firebase ya fue inicializado.") } const t = firebase.auth(), o = firebase.firestore(), n = firebase.analytics(); n.logEvent("view_item_list", { item_list_id: "campus_dashboard", item_list_name: "Campus Main" }); let a = null;

                    // s = showCouponModal
                    async function s() {
                        const user = t.currentUser;
                        // Verificar curso si est√° logueado
                        if (user) {
                            try {
                                const userDoc = await o.collection("users").doc(user.uid).get();
                                const enrollments = userDoc.data().enrollments || {};
                                if (enrollments["ia-aplicada-esencial"] || enrollments["ia-aplicada-starter"]) {
                                    alert("¬°Ya est√°s inscrito en este curso! Puedes acceder al contenido.");
                                    window.location.reload();
                                    return;
                                }
                            } catch (e) { console.error(e); }
                        }

                        // Abrir modal siempre y precargar 2026
                        const modal = document.getElementById("coupon-modal");
                        if (modal) {
                            modal.classList.remove("hidden");
                            modal.classList.add("flex");

                            // Resetear listener del input
                            const input = document.getElementById("modal-coupon-input");
                            const applyBtn = document.getElementById("modal-apply-btn");

                            if (input && applyBtn) {
                                // Clonar para remover listeners previos
                                const newHeader = input.cloneNode(true);
                                input.parentNode.replaceChild(newHeader, input);
                                const freshInput = document.getElementById("modal-coupon-input");

                                freshInput.addEventListener("input", function () {
                                    applyBtn.textContent = "Aplicar y continuar";
                                    applyBtn.onclick = r; // r = applyModalCoupon
                                    applyBtn.disabled = false;

                                    const summary = document.getElementById("modal-discount-summary");
                                    if (summary) summary.classList.add("hidden");
                                    const msg = document.getElementById("modal-coupon-message");
                                    if (msg) msg.classList.add("hidden");
                                    a = null; // Limpiar variable 'a' (cup√≥n actual)
                                });

                                freshInput.value = "2026";
                                await r(); // Auto-aplicar
                            }
                        }
                    }

                    // r = applyModalCoupon
                    async function r() {
                        const code = document.getElementById("modal-coupon-input").value.trim().toUpperCase();
                        if (!code) return void l();

                        const btn = document.getElementById("modal-apply-btn");
                        const originalText = btn.textContent;
                        btn.disabled = true;
                        btn.textContent = "Validando...";

                        try {
                            const valFunc = firebase.functions().httpsCallable("validateCoupon");
                            const res = await valFunc({ couponCode: code, courseId: "ia-aplicada-esencial" });

                            if (res.data.valid) {
                                a = res.data;
                                document.getElementById("modal-original-price").textContent = `$${res.data.originalPrice} USD`;
                                const discountStr = res.data.discountType === "percentage" ? `${res.data.discountValue}%` : `$${res.data.discountValue} USD`;
                                document.getElementById("modal-discount-label").textContent = discountStr;
                                document.getElementById("modal-discount-amount").textContent = `-$${res.data.discountAmount.toFixed(2)} USD`;
                                document.getElementById("modal-final-price").textContent = `$${res.data.finalPrice.toFixed(2)} USD`;
                                document.getElementById("modal-discount-summary").classList.remove("hidden");
                                i(`‚úÖ Cup√≥n aplicado: ${discountStr} de descuento`, "success");

                                btn.textContent = "Aplicar y continuar";
                                btn.onclick = c;
                                btn.disabled = false;
                            } else {
                                i("Cup√≥n no v√°lido", "error");
                                btn.textContent = originalText;
                                btn.disabled = false;
                            }
                        } catch (e) {
                            console.error("Error validation:", e);
                            let msg = "Cup√≥n inv√°lido";
                            if (e.message && e.message.includes("expirado")) msg = "Cup√≥n expirado";
                            else if (e.message && e.message.includes("agotado")) msg = "Cup√≥n agotado";
                            i(msg, "error");
                            btn.textContent = originalText;
                            btn.disabled = false;
                        }
                    }

                    // i = showCouponMessage
                    function i(msg, type) {
                        const el = document.getElementById("modal-coupon-message");
                        if (el) {
                            el.textContent = msg;
                            el.className = "mt-2 text-sm font-medium " + (type === "error" ? "text-red-600" : "text-green-600");
                            el.classList.remove("hidden");
                        }
                    }

                    // l = proceedWithoutCoupon
                    async function l() {
                        a = null;
                        const m = document.getElementById("coupon-modal");
                        if (m) m.classList.add("hidden");
                        await buyCourse('ia-aplicada-starter', 'LANZAMIENTO'); // Default Fallback, but c is usually manual
                    }

                    // c = proceedWithCoupon
                    async function c() {
                        // No cerrar modal para mantener variable 'a' (cup√≥n) y mostrar feedback visual
                        // const m = document.getElementById("coupon-modal"); 
                        // if (m) m.classList.add("hidden"); 
                        // Default to essential if logic falls here manually, but usually we use buyCourse properly.
                        // We will check global pending logic or assume 'ia-aplicada-esencial'
                        await buyCourse('ia-aplicada-esencial');
                    }

                    // buyCourse = handlePurchase (Refactored)
                    async function buyCourse(courseId, couponCodeOverride) {
                        // Feedback inmediato en botones (antes de redirigir)
                        const applyBtn = document.getElementById("modal-apply-btn");
                        const noCouponBtn = document.querySelector("button[onclick='proceedWithoutCoupon()']");

                        if (applyBtn) {
                            applyBtn.innerHTML = '<span class="flex items-center justify-center gap-2"><svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg> Procesando...</span>';
                            applyBtn.disabled = true;
                        }
                        if (noCouponBtn) {
                            noCouponBtn.innerHTML = "Procesando...";
                            noCouponBtn.disabled = true;
                        }

                        // Determine Coupon to Use
                        const codeToUse = couponCodeOverride || (a ? a.code : null);
                        const idToUse = (a && !couponCodeOverride) ? a.couponId : null;

                        if (!t.currentUser) {
                            sessionStorage.setItem("pendingPurchase", JSON.stringify({ courseId: courseId, couponId: idToUse, couponCode: codeToUse }));
                            window.location.href = "acceso.html";
                            return;
                        }

                        try {
                            const createPref = firebase.functions().httpsCallable("createMercadoPagoPreference");
                            const result = await createPref({ courseId: courseId, couponId: idToUse, couponCode: codeToUse });
                            if (result.data && result.data.init_point) {
                                window.location.href = result.data.init_point;
                            }
                        } catch (e) {
                            console.error("Error pago:", e);
                            alert("Error iniciando pago.");
                            if (applyBtn) { applyBtn.disabled = false; applyBtn.innerHTML = "Aplicar y continuar"; }
                        }
                    }

                    // Purchase Redirects
                    window.initiateStarterPurchase = function (origin) {
                        n.logEvent("begin_checkout", { items: [{ item_id: "ia-aplicada-starter", item_name: "Pack Starter" }], origin: origin });
                        window.location.href = "landing-nuevo2.html";
                    };
                    window.initiateEssentialPurchase = function (origin) {
                        n.logEvent("begin_checkout", { items: [{ item_id: "ia-aplicada-esencial", item_name: "Pack Esencial" }], origin: origin });
                        window.location.href = "landing-nuevo2.html";
                    };

                    window.showCouponModal = s;
                    window.closeCouponModal = function () {
                        const e = document.getElementById("coupon-modal");
                        if (e) {
                            e.classList.add("hidden"), e.classList.remove("flex");
                            const t = document.getElementById("modal-coupon-input");
                            t && (t.value = "");
                            const o = document.getElementById("modal-coupon-message");
                            o && o.classList.add("hidden");
                            const n = document.getElementById("modal-discount-summary");
                            n && n.classList.add("hidden");
                            const a = document.getElementById("modal-apply-btn");
                            a && (a.textContent = "Aplicar y continuar", a.onclick = r, a.disabled = !1)
                        }
                        a = null
                    };
                    window.applyModalCoupon = r;
                    window.proceedWithoutCoupon = l;
                    window.proceedWithCoupon = c;

                    const u = {
                        "ia-aplicada-esencial": { title: "IA Aplicada ¬∑ Esencial", totalLessons: 19, modules: [{ title: "Bienvenida al Curso", lessons: [{ id: "0-1" }, { id: "0-2" }] }, { title: "M√≥dulo 1: ¬øQu√© es la Inteligencia Artificial?", lessons: [{ id: "1-1" }, { id: "1-2" }, { id: "1-3" }, { id: "q-1" }] }, { title: "M√≥dulo 2: La IA para ti, en tu d√≠a a d√≠a", lessons: [{ id: "2-1" }, { id: "2-2" }, { id: "2-3" }, { id: "2-taller" }, { id: "q-2" }] }, { title: "M√≥dulo 3: Preparando tus herramientas", lessons: [{ id: "3-1" }, { id: "3-2" }, { id: "3-3" }, { id: "q-3" }] }, { title: "M√≥dulo 4: Arquitectura de Ideas", lessons: [{ id: "4-1" }, { id: "4-2" }, { id: "q-4" }] }, { title: "Final del Camino: Certificaci√≥n", lessons: [{ id: "final-exam" }] }] },
                        "ia-aplicada-starter": { title: "IA Aplicada ¬∑ Starter", totalLessons: 19, modules: [{ title: "Bienvenida al Curso", lessons: [{ id: "0-1" }, { id: "0-2" }] }, { title: "M√≥dulo 1: ¬øQu√© es la Inteligencia Artificial?", lessons: [{ id: "1-1" }, { id: "1-2" }, { id: "1-3" }, { id: "q-1" }] }, { title: "M√≥dulo 2: La IA para ti, en tu d√≠a a d√≠a", lessons: [{ id: "2-1" }, { id: "2-2" }, { id: "2-3" }, { id: "2-taller" }, { id: "q-2" }] }, { title: "M√≥dulo 3: Preparando tus herramientas", lessons: [{ id: "3-1" }, { id: "3-2" }, { id: "3-3" }, { id: "q-3" }] }, { title: "M√≥dulo 4: Arquitectura de Ideas", lessons: [{ id: "4-1" }, { id: "4-2" }, { id: "q-4" }] }, { title: "Final del Camino: Certificaci√≥n", lessons: [{ id: "final-exam" }] }] }
                    }, m = document.getElementById("profile-modal-overlay"), p = document.getElementById("profile-modal"), g = document.getElementById("avatar-button"), h = document.getElementById("cancel-profile-btn"), f = document.getElementById("close-profile-modal-btn"), v = document.getElementById("profile-form"), x = document.getElementById("profile-name-input"), y = document.getElementById("profile-rut-input"), C = document.getElementById("profile-email-input"), b = document.getElementById("profile-job-input"), w = document.getElementById("profile-country-select"), E = document.getElementById("profile-gender-select"), F = document.getElementById("profile-birthdate-input"), I = document.getElementById("profile-modal-title"), L = document.getElementById("profile-modal-subtitle"), T = document.getElementById("form-status"), S = document.getElementById("save-profile-btn"), P = document.getElementById("save-btn-text"), A = document.getElementById("save-spinner");




                    async function k(e, t, n, a) {
                        const s = document.getElementById(t);
                        if (!s) return;
                        const r = document.getElementById(`${t}-text`),
                            i = document.getElementById(`${t}-spinner`),
                            l = o.collection(n).doc(e.uid);
                        try {
                            if ((await l.get()).exists) return r.textContent = a.alreadyIn, s.disabled = !0, s.classList.add("bg-gray-400", "cursor-not-allowed"), void s.classList.remove(a.defaultColor, a.hoverColor)
                        } catch (e) {
                            console.error(e)
                        }
                        s.addEventListener("click", async () => {
                            s.disabled = !0, r.textContent = a.adding, i.classList.remove("hidden");
                            try {
                                const t = e.displayName || "Alumno sin nombre";
                                await l.set({
                                    email: e.email,
                                    displayName: t,
                                    uid: e.uid,
                                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                                }), r.textContent = a.success, s.classList.remove(a.defaultColor, a.hoverColor), s.classList.add(a.successColor)
                            } catch (e) {
                                r.textContent = a.error, s.classList.remove(a.defaultColor, a.hoverColor), s.classList.add(a.errorColor), setTimeout(() => {
                                    s.disabled = !1, r.textContent = a.default, s.classList.remove(a.errorColor), s.classList.add(a.defaultColor, a.hoverColor)
                                }, 3e3)
                            } finally {
                                i.classList.add("hidden")
                            }
                        })
                    }

                    async function z(e = !1) {
                        v.reset();
                        const n = t.currentUser;
                        if (!n) return;
                        C.value = n.email || "";

                        // Limpiar errores visuales al abrir
                        document.querySelectorAll(".form-input-error, .form-input-success").forEach(el => el.classList.remove("form-input-error", "form-input-success"));
                        document.querySelectorAll(".error-message").forEach(el => el.textContent = "");
                        document.querySelectorAll("span[id$='-status-icon']").forEach(el => el.innerHTML = "");

                        const a = o.collection("users").doc(n.uid);
                        try {
                            const e = await a.get(),
                                t = e.exists ? e.data() : {},
                                o = !0 === t.profileCompleted;
                            x && (x.value = o ? t.displayName || "" : n.displayName || ""), y && (y.value = t.rut || ""), b && (b.value = t.jobTitle || ""), w && (w.value = t.country || ""), E && (E.value = t.gender || ""), F && (F.value = t.birthdate || "")
                        } catch (e) {
                            console.error("Error al cargar datos del perfil:", e)
                        }

                        e ? (I.textContent = "¬°Completa tu perfil para continuar!", L.textContent = "Necesitamos estos datos para generar tus certificados correctamente.", h.classList.add("hidden"), f.classList.add("hidden"), m.removeEventListener("click", D)) : (I.textContent = "Editar Perfil", L.textContent = "Mant√©n tus datos actualizados.", h.classList.remove("hidden"), f.classList.remove("hidden"), m.addEventListener("click", D)), T.classList.add("hidden"), m.classList.remove("hidden"), p.classList.remove("hidden"), setTimeout(() => {
                            const e = p.querySelector("div.bg-white");
                            e && e.classList.remove("scale-95", "opacity-0");
                            // Auto-focus logic: Priorizar RUT si est√° vac√≠o, sino Nombre
                            if (y && !y.value) y.focus();
                            else if (x) x.focus();
                        }, 100)
                    }

                    function D() {
                        const e = p.querySelector("div.bg-white");
                        e && e.classList.add("scale-95", "opacity-0"), setTimeout(() => {
                            m.classList.add("hidden"), p.classList.add("hidden"), e && e.classList.remove("scale-95", "opacity-0")
                        }, 300)
                    }

                    function B(e, t, o = "") {
                        const n = document.getElementById(`profile-${e}-input`) || document.getElementById(`profile-${e}-select`),
                            a = document.getElementById(`${e}-error`),
                            s = document.getElementById(`${e}-status-icon`);
                        n && (n.classList.remove("form-input-error", "form-input-success"), a && (a.textContent = ""), s && (s.innerHTML = ""), "error" === t ? (n.classList.add("form-input-error"), a && (a.textContent = o), s && (s.innerHTML = '<i data-lucide="alert-circle" class="h-5 w-5 text-red-500"></i>')) : "success" === t && (n.classList.add("form-input-success"), s && (s.innerHTML = '<i data-lucide="check-circle" class="h-5 w-5 text-green-500"></i>')), s && s.innerHTML && lucide.createIcons({
                            nodes: [s.querySelector("i")]
                        }))
                    }

                    // Validation Functions Breakdown
                    function validateName(showError = true) {
                        const valid = x.value.trim().length >= 3 && x.value.includes(" ");
                        if (!valid && showError) B("name", "error", "Ingresa tu nombre y apellido completo.");
                        else if (valid) B("name", "success");
                        else B("name", "neutral"); // Clear if not showing error
                        return valid;
                    }

                    function validateCountry(showError = true) {
                        const valid = w.value !== "";
                        if (!valid && showError) B("country", "error", "Selecciona tu pa√≠s de residencia.");
                        else if (valid) B("country", "success");
                        else B("country", "neutral");
                        return valid;
                    }

                    function validateRUT(showError = true) {
                        if (w.value !== "CL") {
                            B("rut", "neutral");
                            return true; // No validation for non-CL
                        }
                        const r = y.value;
                        const e = r.replace(/\./g, "").replace(/-/g, "").trim().toLowerCase();
                        const t = e.slice(0, -1);
                        let o = e.slice(-1);
                        let isValid = false;
                        if (/^[0-9]+[0-9kK]{1}$/.test(e)) {
                            let n = 0,
                                a = 2;
                            for (let e = t.length - 1; e >= 0; e--) n += t.charAt(e) * a, a < 7 ? a++ : a = 2;
                            const s = 11 - n % 11;
                            isValid = o === (11 === s ? "0" : 10 === s ? "k" : s.toString());
                        }

                        if (!isValid && showError) B("rut", "error", "El RUT ingresado no es v√°lido.");
                        else if (isValid) B("rut", "success");
                        else B("rut", "neutral");
                        return isValid;
                    }

                    function validateAll() {
                        const vName = validateName(true);
                        const vCountry = validateCountry(true);
                        const vRut = validateRUT(true);
                        return vName && vCountry && vRut;
                    }

                    // Setup Listeners for "Lazy" Validation
                    g.addEventListener("click", () => z(!1)), h.addEventListener("click", D), f.addEventListener("click", D);

                    // Input: Clear error (neutral) or show success if valid immediately. Do NOT show error while typing.
                    x.addEventListener("input", () => validateName(false));
                    y.addEventListener("input", () => validateRUT(false));
                    w.addEventListener("change", () => validateCountry(true)); // Select usually safe to validate on change

                    // Blur: Show error if invalid
                    x.addEventListener("blur", () => validateName(true));
                    y.addEventListener("blur", () => validateRUT(true));
                    w.addEventListener("blur", () => validateCountry(true));

                    v.addEventListener("submit", async e => {
                        e.preventDefault();

                        // Validate All on Submit
                        if (!validateAll()) {
                            T.className = "text-center p-3 rounded-lg bg-yellow-100 text-yellow-700";
                            T.textContent = "Por favor, completa los campos marcados en rojo.";
                            T.classList.remove("hidden");
                            return;
                        }

                        if (S.disabled) return; // Double check

                        S.disabled = !0, P.textContent = "Guardando...", A.classList.remove("hidden"), T.classList.add("hidden");
                        const n = t.currentUser,
                            a = x.value.trim(),
                            s = o.collection("users").doc(n.uid);
                        try {
                            a !== n.displayName && await n.updateProfile({
                                displayName: a
                            }), await s.set({
                                displayName: a,
                                email: n.email,
                                rut: y.value.trim(),
                                jobTitle: b.value.trim(),
                                country: w.value,
                                gender: E.value,
                                birthdate: F.value,
                                profileCompleted: !0
                            }, {
                                merge: !0
                            }), document.querySelectorAll("#user-name, #welcome-name").forEach(e => e && (e.textContent = a)), T.className = "text-center p-3 rounded-lg bg-green-100 text-green-700", T.textContent = "¬°Perfil actualizado con √©xito!", T.classList.remove("hidden"), setTimeout(() => {
                                D(), checkUserAccess(n.uid)
                            }, 1500)
                        } catch (e) {
                            console.error("Error al guardar perfil:", e);
                            T.className = "text-center p-3 rounded-lg bg-red-100 text-red-700";
                            if (e.code === 'permission-denied') {
                                T.textContent = "Error de permisos: No tienes autorizaci√≥n para modificar este perfil. Contacta soporte.";
                            } else {
                                T.textContent = `Hubo un error al guardar: ${e.message || "Int√©ntalo de nuevo."}`;
                            }
                            T.classList.remove("hidden");
                        } finally {
                            S.disabled = false; // Re-enable
                            P.textContent = "Guardar Cambios", A.classList.add("hidden")
                        }
                    }), t.onAuthStateChanged(e => {
                        if (e) {
                            o.collection("users").doc(e.uid).get().then(t => {
                                const o = (t.exists ? t.data() : {}).displayName || e.displayName || "Alumno";
                                document.querySelectorAll("#user-name, #welcome-name").forEach(e => e && (e.textContent = o))
                            }), document.getElementById("user-avatar").src = e.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(e.displayName || "A")}&background=14b8a6&color=fff`, document.getElementById("user-profile").classList.remove("hidden"), document.getElementById("logout-btn").addEventListener("click", e => {
                                e.preventDefault(), t.signOut().then(() => window.location.href = "index.html")
                            }),
                                async function (e) {
                                    try {
                                        console.log("[ProfileCheck] Checking profile for:", e.uid);
                                        const t = await o.collection("users").doc(e.uid).get();

                                        if (t.exists) {
                                            const data = t.data();
                                            console.log("[ProfileCheck] Exists:", true, "Completed:", data.profileCompleted);
                                            if (data.profileCompleted === true) {
                                                checkUserAccess(e.uid); // Load course content
                                            } else {
                                                console.warn("[ProfileCheck] Profile incomplete. Opening modal.");
                                                z(!0); // Open modal to complete profile
                                            }
                                        } else {
                                            console.warn("[ProfileCheck] Doc does not exist. Opening modal.");
                                            z(!0); // Doc doesn't exist, treat as new user
                                        }
                                    } catch (error) {
                                        console.error("[ProfileCheck] Error verificando perfil:", error);
                                        // NO abrir el modal autom√°ticamente si hay error de conexi√≥n/permisos
                                        // Esto evita el loop infinito si el usuario no tiene permisos de lectura
                                        document.getElementById("form-status").textContent = "Error cargando tu perfil. Por favor recarga la p√°gina. (Conexi√≥n/Permisos)";
                                        document.getElementById("form-status").classList.remove("hidden");
                                        // Opcional: Mostrar un estado de error m√°s global
                                    }
                                }(e), k(e, "waitlist-btn", "waitingList_avanzado", {
                                    default: "Unirme a la lista de espera",
                                    alreadyIn: "¬°Ya est√°s en la lista!",
                                    adding: "Agregando...",
                                    success: "¬°Inscrito con √©xito!",
                                    error: "Error, intenta de nuevo",
                                    defaultColor: "bg-blue-600",
                                    hoverColor: "hover:bg-blue-700",
                                    successColor: "bg-green-500",
                                    errorColor: "bg-red-500"
                                }), k(e, "reserve-btn", "preferentialReservations", {
                                    default: "Reservar cupo preferente",
                                    alreadyIn: "¬°Ya tienes tu cupo!",
                                    adding: "Reservando...",
                                    success: "¬°Cupo reservado!",
                                    error: "Error, intenta de nuevo",
                                    defaultColor: "bg-indigo-600",
                                    hoverColor: "hover:bg-indigo-700",
                                    successColor: "bg-green-500",
                                    errorColor: "bg-red-500"
                                });
                            // Legacy access check IIFE removed to prevent conflicts with checkUserAccess
                        } else window.location.href = "acceso.html"
                    }), window.downloadPromptsPDF = async function (e) { const o = e ? e.currentTarget : null; let a = ""; o && (a = o.innerHTML, o.disabled = !0, o.innerHTML = "‚è≥ Generando y Descargando PDF...", o.classList.add("cursor-wait", "opacity-75")), n.logEvent("file_download", { file_extension: "pdf", file_name: "Maestro_Prompts_100_AGIA", link_url: window.location.href }); try { const e = t.currentUser; if (!e) return void (window.location.href = "acceso.html"); console.log("üîç DEBUG - casesData existe?:", void 0 !== window.casesData), console.log("üîç DEBUG - Cantidad inicial:", window.casesData?.length || 0), console.log("üì• Cargando prompts de forma segura..."), o && (o.innerHTML = "‚è≥ Descargando datos seguros..."); const n = await async function () { try { const e = firebase.functions().httpsCallable("getPromptsData"), t = await e(); return !!t.data.success && (window.casesData = t.data.data, console.log("‚úÖ Prompts cargados de forma segura:", window.casesData.length), !0) } catch (e) { return console.error("Error al cargar prompts:", e), "functions/permission-denied" === e.code ? (alert("‚ö†Ô∏è Acceso Premium Requerido\n\nPara acceder a los prompts necesitas estar inscrito en el curso.\n\n¬øDeseas inscribirte ahora?"), window.location.href = "landing-nuevo.html#pricing") : "functions/unauthenticated" === e.code ? window.location.href = "acceso.html" : alert("Error al cargar los datos. Por favor intenta nuevamente."), !1 } }(); if (!n) throw new Error("No se pudieron cargar los datos"); if (o && (o.innerHTML = "‚è≥ Creando PDF..."), !n) return void console.error("‚ùå No se pudieron cargar los prompts"); console.log("‚úÖ Datos cargados, cantidad final:", window.casesData.length); const { jsPDF: a } = window.jspdf, l = new a, c = l.internal.pageSize.getWidth(), d = l.internal.pageSize.getHeight(), u = 20, m = c - 40, p = [20, 184, 166], g = [251, 191, 36], h = [30, 41, 59], f = [148, 163, 184]; l.setFillColor(255, 255, 255), l.rect(0, 0, c, d, "F"); try { const e = new Image; e.crossOrigin = "Anonymous", e.src = "Logo_AGIA.png", await new Promise((t, o) => { e.onload = t, e.onerror = () => { e.src = "Logo_AGIA.jpg", e.onload = t, e.onerror = o }, setTimeout(o, 5e3) }); const t = 100, o = t * (e.height / e.width), n = (c - t) / 2, a = 30; l.addImage(e, e.src.endsWith(".png") ? "PNG" : "JPEG", n, a, t, o); var s = Math.max(a + o + 20, 140), r = [30, 41, 59], i = [71, 85, 105] } catch (e) { console.warn("No se pudo cargar el logo:", e); s = 60, r = [30, 41, 59], i = [71, 85, 105] } l.setTextColor(...r), l.setFontSize(36), l.setFont("helvetica", "bold"), l.text("Maestro Prompts", c / 2, s, { align: "center" }), l.setFontSize(14), l.setFont("helvetica", "normal"), l.setTextColor(...i), l.text("100 Prompts Optimizados - Colecci√≥n AGIA", c / 2, s + 12, { align: "center" }), l.setFillColor(...g), l.roundedRect(c / 2 - 35, s + 22, 70, 10, 3, 3, "F"), l.setTextColor(...r), l.setFontSize(9), l.setFont("helvetica", "bold"), l.text("EXCLUSIVE PREMIUM ACCESS", c / 2, s + 28.5, { align: "center" }); const v = s + 50; l.setLineWidth(.5), l.line(c / 2 - 20, v - 10, c / 2 + 20, v - 10), l.setTextColor(...r), l.setFontSize(11), l.setFont("helvetica", "bold"); const x = e.displayName || e.email.split("@")[0]; l.text(x, c / 2, v, { align: "center" }), l.setFontSize(10), l.setFont("helvetica", "normal"), l.setTextColor(...i), l.text(e.email, c / 2, v + 6, { align: "center" }), l.text(`Generado el ${(new Date).toLocaleDateString("es-CL", { year: "numeric", month: "long", day: "numeric" })}`, c / 2, v + 12, { align: "center" }), l.setFontSize(10), l.setTextColor(100, 100, 100), l.setFont("helvetica", "normal"); const y = v + 35; l.text(l.splitTextToSize("Esta colecci√≥n contiene 100 prompts optimizados con la metodolog√≠a AGIA. Cada prompt dise√±ado para maximizar respuestas de ChatGPT, Claude, Gemini.", m - 20), u + 10, y), l.setFontSize(8), l.setTextColor(120, 120, 120), l.setFont("helvetica", "italic"); const C = l.splitTextToSize("Importante: Los resultados generados por IA pueden contener errores o imprecisiones. Siempre revise y valide la informaci√≥n antes de utilizarla en contextos cr√≠ticos.", m - 20); l.text(C, c / 2, d - 25, { align: "center", maxWidth: m - 20 }), l.setFontSize(9), l.setTextColor(...f), l.setFont("helvetica", "normal"), l.text("aulagenia.cl | Todos los derechos reservados", c / 2, d - 15, { align: "center" }), l.addPage(); let b = u; l.setFillColor(245, 247, 250), l.rect(0, 0, c, 25, "F"), l.setTextColor(...h), l.setFontSize(18), l.setFont("helvetica", "bold"), l.text("√çndice de Contenidos", u, 18), b = 35; const w = {}; casesData.forEach(e => { w[e.category] || (w[e.category] = []), w[e.category].push(e) }), l.setFontSize(10), l.setFont("helvetica", "normal"), Object.keys(w).forEach((e, t) => { b > d - 30 && (l.addPage(), b = u), l.setTextColor(...p), l.setFont("helvetica", "bold"), l.text(`${t + 1}. ${e}`, u, b), b += 6, l.setTextColor(80, 80, 80), l.setFont("helvetica", "normal"), w[e].forEach((e, t) => { b > d - 20 && (l.addPage(), b = u); const o = casesData.findIndex(t => t.id === e.id) + 1; l.text(`   - Prompt #${o}: ${e.title}`, u + 5, b), b += 5 }), b += 3 }); for (let e = 0; e < casesData.length; e++) { const t = casesData[e]; l.addPage(), b = u, l.setFillColor(...p), l.rect(0, 0, c, 15, "F"), l.setFontSize(10), l.setTextColor(255, 255, 255), l.setFont("helvetica", "bold"), l.text(`PROMPT #${e + 1}`, u, 10), l.text(`${e + 1}/${casesData.length}`, c - u, 10, { align: "right" }), b = 25, l.setFontSize(16), l.setFont("helvetica", "bold"), l.setTextColor(...h); const o = l.splitTextToSize(t.title, m); l.text(o, u, b), b += 7 * o.length + 3, l.setFillColor(250, 250, 250), l.roundedRect(u, b, 60, 8, 2, 2, "F"), l.setFontSize(8), l.setTextColor(...p), l.setFont("helvetica", "bold"), l.text(t.category, u + 2, b + 5.5); const n = t.metadata?.score ? `${Math.round(t.metadata.score / 5)} min` : "15 min"; if (l.setFillColor(255, 250, 230), l.roundedRect(u + 65, b, 30, 8, 2, 2, "F"), l.setTextColor(180, 140, 0), l.text(`${n}`, u + 67, b + 5.5), b += 13, t.problem) { l.setFontSize(9), l.setFont("helvetica", "italic"), l.setTextColor(100, 100, 100); const e = l.splitTextToSize(t.problem, m); l.text(e, u, b), b += 4 * e.length + 6 } l.setDrawColor(220, 220, 220), l.setLineWidth(.5), l.line(u, b, c - u, b), b += 8, l.setFillColor(245, 245, 250), l.roundedRect(u, b, m, 8, 2, 2, "F"), l.setFontSize(9), l.setTextColor(100, 100, 150), l.setFont("helvetica", "bold"), l.text("ROL", u + 3, b + 5.5), b += 12; const a = t.agiaPromptTagged.split("\n")[0].replace(/^(Eres|Actuas como|Tu rol es)/i, "").trim(); l.setFontSize(8.5), l.setFont("helvetica", "normal"), l.setTextColor(60, 60, 60); const s = l.splitTextToSize(a, m); for (let e = 0; e < Math.min(s.length, 3); e++)l.text(s[e], u, b), b += 3.5; b += 5, l.setFillColor(232, 245, 233), l.roundedRect(u, b, m, 8, 2, 2, "F"), l.setFontSize(9), l.setTextColor(0, 128, 0), l.setFont("helvetica", "bold"), l.text("PROMPT OPTIMIZADO (METODOLOGIA AGIA)", u + 3, b + 5.5), b += 12; const r = t.agiaPromptTagged.replace(/\*\*/g, "").replace(/[\u{1F300}-\u{1F9FF}]/gu, "").replace(/[üìéüìå‚úÖ‚ö°üî¥üü°üü¢‚ùå‚è±üöÄ]/g, "").replace(/\\n/g, "\n").trim(); l.setFontSize(8.5), l.setFont("helvetica", "normal"), l.setTextColor(40, 40, 40); const i = l.splitTextToSize(r, m); for (let t = 0; t < i.length; t++)b > d - 25 && (l.setFontSize(8), l.setTextColor(...f), l.text("aulagenia.cl", c / 2, d - 10, { align: "center" }), l.addPage(), b = u + 10, l.setFillColor(250, 250, 250), l.rect(0, 0, c, 8, "F"), l.setFontSize(8), l.setTextColor(100, 100, 100), l.setFont("helvetica", "italic"), l.text(`Prompt #${e + 1} (continuacion)`, u, 6)), l.text(i[t], u, b), b += 3.5; if (b += 8, b > d - 60 && (l.addPage(), b = u), l.setDrawColor(220, 220, 220), l.setLineWidth(.5), l.line(u, b, c - u, b), b += 8, t.suggestedAI && (l.setFillColor(239, 246, 255), l.roundedRect(u, b, m, 10, 2, 2, "F"), l.setFontSize(8), l.setTextColor(37, 99, 235), l.setFont("helvetica", "bold"), l.text("‚Ä¢ MODELO IDEAL", u + 3, b + 4), l.setFontSize(8), l.setFont("helvetica", "normal"), l.setTextColor(40, 40, 40), l.text(t.suggestedAI, u + 3, b + 8), b += 12), t.metadata?.technique || t.exampleTip) { l.setFillColor(255, 251, 235), l.roundedRect(u, b, m, 10, 2, 2, "F"), l.setFontSize(8), l.setTextColor(217, 119, 6), l.setFont("helvetica", "bold"), l.text("‚Ä¢ ESTRATEGIA", u + 3, b + 4), l.setFontSize(8), l.setFont("helvetica", "normal"), l.setTextColor(40, 40, 40); const e = t.metadata?.technique || t.exampleTip || "", o = l.splitTextToSize(e, m - 6); l.text(o, u + 3, b + 8), b += Math.max(12, 6 + 3 * o.length) } if (t.validationTip) { l.setFillColor(240, 253, 244), l.roundedRect(u, b, m, 10, 2, 2, "F"), l.setFontSize(8), l.setTextColor(22, 163, 74), l.setFont("helvetica", "bold"), l.text("‚Ä¢ VALIDACI√ìN", u + 3, b + 4), l.setFontSize(8), l.setFont("helvetica", "normal"), l.setTextColor(40, 40, 40); const e = l.splitTextToSize(t.validationTip, m - 6); l.text(e, u + 3, b + 8), b += Math.max(12, 6 + 3 * e.length) } l.setFontSize(8), l.setTextColor(...f), l.text("aulagenia.cl", c / 2, d - 10, { align: "center" }) } l.addPage(), l.setFillColor(...p), l.rect(0, 0, c, d, "F"), l.setTextColor(255, 255, 255), l.setFontSize(28), l.setFont("helvetica", "bold"), l.text("¬°Gracias!", c / 2, 80, { align: "center" }), l.setFontSize(12), l.setFont("helvetica", "normal"), l.text(l.splitTextToSize("Esperamos que estos 100 prompts optimizados te ayuden a aprovechar al m√°ximo la inteligencia artificial.", m - 40), c / 2, 100, { align: "center" }), l.setFontSize(14), l.setFont("helvetica", "bold"), l.text("¬øNecesitas ayuda?", c / 2, 130, { align: "center" }), l.setFontSize(11), l.setFont("helvetica", "normal"), l.text("Cont√°ctanos en: contacto@aulagenia.cl", c / 2, 145, { align: "center" }), l.text("Vis√≠tanos en: aulagenia.cl", c / 2, 155, { align: "center" }), l.save(`Maestro_Prompts_100_AGIA_${(new Date).toISOString().split("T")[0]}.pdf`), console.log("PDF descargado exitosamente") } catch (e) { console.error("Error PDF:", e), alert("Si el PDF no descarga, aseg√∫rate de permitir ventanas emergentes.") } finally { o && (o.disabled = !1, o.innerHTML = a, o.classList.remove("cursor-wait", "opacity-75")) } }, t.onAuthStateChanged(async e => { if (e) { const t = o.collection("users").doc(e.uid), n = await t.get(); if (n.exists) { const e = n.data(), t = e.enrollments && (!0 === e.enrollments["ia-aplicada-esencial"] || !0 === e.enrollments["inteligencia-aplicada"]), o = localStorage.getItem("pdfDownloaded"); t && !o && "undefined" != typeof casesData && setTimeout(() => { downloadPromptsPDF(), localStorage.setItem("pdfDownloaded", "true") }, 2e3) } } }), lucide.createIcons()

                    // Old checkUserAccess removed


                    function unlockCourseCard(card, courseId, uid) {
                        n.logEvent("unlock_content", { content_type: "course", item_id: courseId, method: "enrollment" });

                        // Progress Listener
                        const progRef = o.collection("userProgress").doc(uid);
                        progRef.onSnapshot(snap => {
                            let completed = 0;
                            const courseConfig = u[courseId];
                            const total = courseConfig ? courseConfig.totalLessons : 0;

                            if (snap.exists && courseConfig) {
                                const progressData = snap.data()[courseId];
                                if (progressData && Array.isArray(progressData.completedLessons)) {
                                    const validSet = new Set();
                                    courseConfig.modules.forEach(m => m.lessons.forEach(l => validSet.add(l.id)));
                                    const userSet = new Set(progressData.completedLessons);
                                    let count = 0;
                                    userSet.forEach(lId => { if (validSet.has(lId)) count++; });
                                    completed = count;
                                }
                            }

                            const percent = total > 0 ? Math.min(Math.round(completed / total * 100), 100) : 0;

                            // Update UI
                            const tag = card.querySelector(".tag");
                            const percentEl = card.querySelector(".percent");
                            const fill = card.querySelector(".fill");
                            const footer = card.querySelector(".card-footer");
                            const progCont = card.querySelector(".progress-container");

                            progCont.classList.remove("hidden");
                            percentEl.textContent = `${percent}%`;
                            fill.style.width = `${percent}%`;

                            const linkProps = `campus-curso-ia.html?course=${courseId}`;

                            if (percent >= 100) {
                                tag.textContent = "Completado";
                                tag.className = "tag inline-block text-xs font-semibold uppercase tracking-wider text-green-600 bg-green-100 px-2 py-1 rounded-full";
                                fill.style.backgroundColor = "var(--brand-green)";
                                footer.innerHTML = `<div class="space-y-3"><a href="portal-certificacion.html" class="flex items-center justify-center gap-2 w-full text-center bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-5 rounded-lg transition-colors"><i data-lucide="award" class="h-5 w-5"></i><span>Ver Certificado</span></a><a href="${linkProps}" class="block text-sm text-gray-500 hover:text-teal-600 font-semibold transition-colors text-center">Repasar Curso</a></div>`;
                                lucide.createIcons();
                            } else {
                                tag.textContent = "En progreso";
                                tag.className = "tag inline-block text-xs font-semibold uppercase tracking-wider text-teal-600 bg-teal-100 px-2 py-1 rounded-full";
                                fill.style.backgroundColor = "var(--brand-teal)";
                                footer.innerHTML = `<a href="${linkProps}" class="course-action-btn block text-center bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-5 rounded-lg transition-colors">Continuar aprendiendo</a>`;
                            }
                        });
                    }

                    function unlockPromptsCard() {
                        const promptsActions = document.getElementById("prompts-actions");
                        if (promptsActions) {
                            promptsActions.innerHTML = `
                                <a href="maestro-prompts-app.html" 
                                   class="block text-center bg-gradient-to-r from-teal-500 to-emerald-600 hover:from-teal-600 hover:to-emerald-700 text-white font-black py-3 px-5 rounded-xl shadow-md hover:shadow-lg transition-all transform hover:-translate-y-0.5 mb-3 border border-teal-400">
                                    üöÄ Ingresar a la Herramienta
                                </a>
                                <a href="https://firebasestorage.googleapis.com/v0/b/aulagenia.appspot.com/o/resources%2F100-prompts-maestros.pdf?alt=media" target="_blank"
                                   class="block w-full text-center bg-white border-2 border-slate-200 hover:border-teal-500 text-slate-600 hover:text-teal-600 font-bold py-3 px-5 rounded-xl transition-all">
                                    üì• Descargar PDF
                                </a>
                            `;
                            const promptsCard = document.getElementById("prompts-card");
                            if (promptsCard) {
                                promptsCard.classList.remove("border-gray-200");
                                promptsCard.classList.add("border-teal-400", "ring-4", "ring-teal-50");
                            }
                        }
                    }

                    function setupLockedCard(card, title, buttonText, onClickAction) {
                        const tag = card.querySelector(".tag");
                        const h3 = card.querySelector("h3");
                        const btn = card.querySelector(".course-action-btn");
                        const progressContainer = card.querySelector(".progress-container");

                        if (progressContainer) progressContainer.classList.add("hidden");

                        if (h3 && title) h3.textContent = title;

                        if (tag) {
                            tag.textContent = "Requiere Inscripci√≥n";
                            tag.className = "tag inline-block text-xs font-semibold uppercase tracking-wider text-yellow-700 bg-yellow-100 px-2 py-1 rounded-full";
                        }

                        if (btn) {
                            btn.textContent = buttonText;
                            btn.innerHTML = buttonText; // Force update
                            btn.classList.remove("cursor-wait", "bg-gray-400", "bg-slate-400");
                            btn.classList.add("bg-teal-600", "hover:bg-teal-700", "text-white");
                            btn.setAttribute("onclick", ""); // Remove implementation attribute handlers

                            // Clone to remove old listeners
                            const newBtn = btn.cloneNode(true);
                            btn.parentNode.replaceChild(newBtn, btn);

                            newBtn.addEventListener("click", async (e) => {
                                e.preventDefault();
                                if (onClickAction) onClickAction();
                            });
                        }
                    }

                    // HELPER: Unlock Course Card
                    function unlockCourseCard(card, courseId, uid) {
                        const tag = card.querySelector(".tag");
                        const btn = card.querySelector(".course-action-btn");
                        const progressContainer = card.querySelector(".progress-container");
                        const percentEl = card.querySelector(".percent");
                        const fill = card.querySelector(".fill");
                        const footer = card.querySelector(".card-footer");

                        // Initial Unlock State
                        progressContainer.classList.remove("hidden");

                        // Set Link
                        const linkProps = `campus-curso-ia.html?course=${courseId}`;
                        btn.href = linkProps;
                        btn.onclick = null; // Remove previous handlers
                        btn.textContent = "Continuar aprendiendo";
                        btn.classList.remove("cursor-wait", "bg-gray-400", "bg-slate-400");
                        btn.classList.add("bg-teal-500", "hover:bg-teal-600", "text-white");

                        // Remove old listeners by cloning
                        const newBtn = btn.cloneNode(true);
                        btn.parentNode.replaceChild(newBtn, btn);

                        newBtn.href = linkProps; // Re-apply href
                        newBtn.addEventListener("click", () => {
                            // n.logEvent("select_content", { content_type: "course", item_id: courseId });
                        });

                        // Listen to Progress
                        const progressRef = o.collection("userProgress").doc(uid);
                        progressRef.onSnapshot(snap => {
                            let completed = 0;
                            const courseConfig = u[courseId];
                            const total = courseConfig ? courseConfig.totalLessons : 0;

                            if (snap.exists && courseConfig) {
                                const progressData = snap.data()[courseId];
                                if (progressData && Array.isArray(progressData.completedLessons)) {
                                    const validSet = new Set();
                                    courseConfig.modules.forEach(m => m.lessons.forEach(l => validSet.add(l.id)));
                                    const userSet = new Set(progressData.completedLessons);
                                    let count = 0;
                                    userSet.forEach(lId => { if (validSet.has(lId)) count++; });
                                    completed = count;
                                }
                            }

                            const percent = total > 0 ? Math.min(Math.round(completed / total * 100), 100) : 0;

                            percentEl.textContent = `${percent}%`;
                            fill.style.width = `${percent}%`;

                            if (percent >= 100) {
                                tag.textContent = "Completado";
                                tag.className = "tag inline-block text-xs font-semibold uppercase tracking-wider text-green-600 bg-green-100 px-2 py-1 rounded-full";
                                fill.style.backgroundColor = "var(--brand-green)";
                                footer.innerHTML = `<div class="space-y-3"><a href="portal-certificacion.html" class="flex items-center justify-center gap-2 w-full text-center bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-5 rounded-lg transition-colors"><i data-lucide="award" class="h-5 w-5"></i><span>Ver Certificado</span></a><a href="${linkProps}" class="block text-sm text-gray-500 hover:text-teal-600 font-semibold transition-colors text-center">Repasar Curso</a></div>`;
                                lucide.createIcons();
                            } else {
                                tag.textContent = "En progreso";
                                tag.className = "tag inline-block text-xs font-semibold uppercase tracking-wider text-teal-600 bg-teal-100 px-2 py-1 rounded-full";
                                fill.style.backgroundColor = "var(--brand-teal)";
                            }
                        });
                    }

                    // HELPER: Unlock Prompts Card
                    function unlockPromptsCard() {
                        const promptsActions = document.getElementById("prompts-actions");
                        if (promptsActions) {
                            promptsActions.innerHTML = `
                                <a href="maestro-prompts-app.html" style="background-color: #0d9488 !important;"
                                   class="block text-center bg-gradient-to-r from-teal-500 to-emerald-600 hover:from-teal-600 hover:to-emerald-700 text-white font-black py-3 px-5 rounded-xl shadow-md hover:shadow-lg transition-all transform hover:-translate-y-0.5 mb-3 border border-teal-400">
                                    üöÄ Ingresar a la Herramienta ‚ú®
                                </a>
                                <a href="https://firebasestorage.googleapis.com/v0/b/aulagenia.appspot.com/o/resources%2F100-prompts-maestros.pdf?alt=media" target="_blank"
                                   class="block w-full text-center bg-white border-2 border-slate-200 hover:border-teal-500 text-slate-600 hover:text-teal-600 font-bold py-3 px-5 rounded-xl transition-all">
                                    üì• Descargar PDF ‚ú®
                                </a>
                            `;

                            // Make card colorful to indicate active state
                            const promptsCard = document.getElementById("prompts-card");
                            if (promptsCard) {
                                promptsCard.classList.remove("border-gray-200");
                                promptsCard.classList.add("border-teal-400", "ring-4", "ring-teal-50");
                            }
                        }
                    }

                    // UPGRADE-AWARE ACCESS CHECK (Overrides previous definition)
                    function checkUserAccess(uid) {
                        const userRef = o.collection("users").doc(uid);
                        const allowRef = o.collection("allowlist").doc(t.currentUser.email);

                        Promise.all([allowRef.get(), userRef.get()]).then(([allowSnap, userSnap]) => {
                            const enrollments = userSnap.exists && userSnap.data().enrollments ? userSnap.data().enrollments : {};
                            const allowCourses = (allowSnap.exists && allowSnap.data().active) ? (allowSnap.data().courses || []) : [];

                            // Determine Access Status
                            const hasStarter = enrollments["ia-aplicada-starter"] || allowCourses.includes("ia-aplicada-starter") || enrollments["ia-aplicada-esencial"];
                            const hasEsencial = enrollments["ia-aplicada-esencial"] || allowCourses.includes("ia-aplicada-esencial") || enrollments["inteligencia-aplicada"];

                            let anyAccess = hasStarter || hasEsencial;

                            // 1. Handle STARTER Card
                            const starterCard = document.querySelector(`article[data-course-id="ia-aplicada-starter"]`);
                            if (starterCard) {
                                if (hasStarter) {
                                    unlockCourseCard(starterCard, "ia-aplicada-starter", uid);
                                } else {
                                    setupLockedCard(starterCard, "IA Aplicada ¬∑ Starter", "Inscribirme por US$5", () => buyCourse("ia-aplicada-starter", "LANZAMIENTO"));
                                }
                            }

                            // 2. Handle ESENCIAL Card
                            const esencialCard = document.querySelector(`article[data-course-id="ia-aplicada-esencial"]`);
                            if (esencialCard) {
                                if (hasEsencial) {
                                    unlockCourseCard(esencialCard, "ia-aplicada-esencial", uid);
                                } else {
                                    // Logic for Upgrade vs Full Purchase
                                    if (hasStarter) {
                                        // Upgrade Path
                                        setupLockedCard(esencialCard, "IA Aplicada ¬∑ Esencial", "Mejorar a Esencial (US$15)", () => buyCourse("ia-aplicada-esencial", "UPGRADESTARTER"));
                                    } else {
                                        // Full Purchase Path
                                        setupLockedCard(esencialCard, "IA Aplicada ¬∑ Esencial", "Inscribirme por US$20", () => buyCourse("ia-aplicada-esencial", "FUNDADOR"));
                                    }
                                }
                            }

                            // Handle Prompts Card
                            if (anyAccess) {
                                unlockPromptsCard();
                            }

                        }).catch(err => {
                            console.error("Error verifying access:", err);
                        });
                    }

                })</script>
        </section>
    </main>
</body>

</html>
