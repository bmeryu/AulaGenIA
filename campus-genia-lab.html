<!DOCTYPE html>
<html lang="es-CL">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <title>Campus GenIA Lab - Aula GenIA</title>
    <meta name="description" content="Explora el Campus GenIA Lab, el entorno de aprendizaje exclusivo de Aula GenIA para experimentar con herramientas de IA y construir tu propio proyecto." />
    <meta name="keywords" content="campus virtual, aprendizaje IA, proyectos IA, certificados IA, Aula GenIA" />
    <link rel="canonical" href="https://aulagenia.cl/comunidad.html" />
    <link rel="icon" href="favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="https://aulagenia.cl/Logo_AGIA.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --brand-teal: #14b8a6;
            --brand-blue: #3b82f6;
        }
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f8fafc;
        }
        .gradient-text {
            background: linear-gradient(90deg, var(--brand-teal), var(--brand-blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        textarea::placeholder {
            color: #9ca3af;
        }
        .comment-form {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }
        .comment-form.active {
            max-height: 500px; /* Suficiente para el form */
        }
        .category-link.active {
            background-color: #f0fdfa; /* teal-50 */
            color: #0d9488; /* teal-600 */
            font-weight: 600;
        }
        .delete-button {
            opacity: 0.5;
            transition: opacity 0.2s;
        }
        .delete-button:hover {
            opacity: 1;
            color: #ef4444; /* red-500 */
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- =========== HEADER / NAVEGACIÃ“N =========== -->
    <header class="bg-white/80 backdrop-blur-lg sticky top-0 z-50 shadow-sm">
        <nav class="container mx-auto px-6 py-3 flex justify-between items-center">
            <a href="index.html" class="flex items-center" aria-label="PÃ¡gina de inicio de Aula GenIA">
                <img src="https://aulagenia.cl/Logo_AGIA.png" alt="Logo de Aula GenIA" class="h-12 w-auto">
            </a>
            <div class="flex items-center gap-2 sm:gap-4">
                <a href="quienes-somos.html" class="text-gray-700 font-semibold border-2 border-gray-300 rounded-full px-3 text-xs py-2 sm:px-5 sm:text-sm hover:bg-gray-100 hover:border-gray-400 transition-colors duration-300 hidden md:flex items-center">
                    QuiÃ©nes Somos
                </a>
                <a href="cursos.html" class="text-teal-600 font-semibold border-2 border-teal-500 rounded-full px-3 text-xs py-2 sm:px-5 sm:text-sm hover:bg-teal-500 hover:text-white transition-colors duration-300 flex items-center">
                    Ver Cursos
                </a>
                <div id="auth-container">
                    <a href="acceso.html" class="cta-button bg-gray-900 text-white font-bold rounded-full hover:bg-gray-700 px-4 py-1.5 sm:px-6 sm:py-2 flex flex-col items-center justify-center">
                        <span class="text-sm sm:text-base leading-tight">ðŸ”“ Acceso</span>
                        <span class="text-[9px] sm:text-[10px] font-normal opacity-75 leading-tight">Inicia tu viaje</span>
                    </a>
                </div>
            </div>
        </nav>
    </header>

    <!-- =========== CONTENIDO PRINCIPAL =========== -->
    <main>
        <section class="container mx-auto px-6 py-16 md:py-24 text-center">
            <div class="max-w-4xl mx-auto">
                <h1 class="text-4xl md:text-6xl font-black leading-tight mb-4">
                    Te damos la bienvenida al <span class="gradient-text">ðŸ§ª Campus GenIA Lab</span>
                </h1>
                <p class="text-lg md:text-xl text-gray-600 max-w-3xl mx-auto">
                    Es el entorno de aprendizaje exclusivo de Aula GenIA, donde cada estudiante puede experimentar, aplicar herramientas de inteligencia artificial y construir su propio proyecto final.
                </p>
            </div>
        </section>

        <section class="container mx-auto px-6 max-w-5xl pb-24">
            <div class="grid lg:grid-cols-3 gap-12">
                <div class="lg:col-span-2">
                    <h2 id="feed-title" class="text-2xl font-bold mb-6 border-b pb-3">Actividad Reciente en el Lab</h2>

                    <div id="create-post-container" class="hidden mb-8">
                        <div class="bg-white p-5 rounded-xl shadow-md">
                            <div class="flex items-start gap-4">
                                <img id="user-avatar" src="" alt="Tu avatar" class="w-12 h-12 rounded-full">
                                <div class="w-full">
                                    <form id="create-post-form">
                                        <textarea id="post-content" class="w-full p-3 border-gray-200 border rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition-shadow" rows="3" placeholder="Â¿QuÃ© estÃ¡s pensando?" required></textarea>
                                        <div class="flex justify-between items-center mt-3">
                                            <select id="post-category" class="text-sm border-gray-300 rounded-md focus:ring-teal-500 focus:border-teal-500" required>
                                                <option value="Discusiones">DiscusiÃ³n</option>
                                                <option value="Tutoriales">Tutorial</option>
                                                <option value="Proyectos">Proyecto</option>
                                            </select>
                                            <button type="submit" class="bg-teal-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-teal-600 transition-colors">Publicar</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="login-prompt" class="hidden mb-8">
                         <div class="bg-teal-50 border-l-4 border-teal-500 p-4 rounded-r-lg">
                            <div class="flex">
                                <div class="py-1"><i data-lucide="log-in" class="h-6 w-6 text-teal-500 mr-4"></i></div>
                                <div>
                                    <p class="font-bold text-teal-800">Ãšnete a la conversaciÃ³n</p>
                                    <p class="text-sm text-teal-700"><a href="acceso.html" class="underline font-semibold">Inicia sesiÃ³n</a> para publicar y comentar.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="post-feed" class="space-y-8">
                        <div id="feed-loader" class="text-center py-8">
                           <p class="text-gray-500">Cargando actividad...</p>
                        </div>
                    </div>
                </div>

                <aside>
                    <div class="bg-white p-6 rounded-xl shadow-md sticky top-28">
                        <h3 class="text-lg font-bold mb-4 border-b pb-2">CategorÃ­as</h3>
                        <ul id="category-list" class="space-y-1">
                            <li><a href="#" class="category-link flex items-center text-gray-700 hover:bg-gray-100 p-2 rounded-md" data-category="all"><i data-lucide="layout-grid" class="h-4 w-4 mr-2"></i>Ver Todas</a></li>
                            <li><a href="#" class="category-link flex items-center text-gray-700 hover:bg-gray-100 p-2 rounded-md" data-category="Tutoriales"><i data-lucide="book-open" class="h-4 w-4 mr-2 text-blue-500"></i>Tutoriales</a></li>
                            <li><a href="#" class="category-link flex items-center text-gray-700 hover:bg-gray-100 p-2 rounded-md" data-category="Discusiones"><i data-lucide="message-square" class="h-4 w-4 mr-2 text-green-500"></i>Discusiones</a></li>
                            <li><a href="#" class="category-link flex items-center text-gray-700 hover:bg-gray-100 p-2 rounded-md" data-category="Proyectos"><i data-lucide="lightbulb" class="h-4 w-4 mr-2 text-purple-500"></i>Proyectos</a></li>
                        </ul>
                        <div id="sidebar-cta-container" class="mt-6">
                             <a href="acceso.html" class="block w-full bg-teal-500 text-white text-center font-bold py-3 px-4 rounded-lg hover:bg-teal-600 transition-colors">
                                Ãšnete para Publicar
                            </a>
                        </div>
                    </div>
                </aside>
            </div>
        </section>
    </main>
    
    <footer class="bg-white border-t border-gray-200">
        <div class="container mx-auto px-6 py-8 text-center text-gray-600">
            <a href="index.html" class="flex items-center justify-center mb-2">
                <img src="https://aulagenia.cl/Logo_AGIA.png" alt="Logo de Aula GenIA al pie de pÃ¡gina" class="h-12 w-auto">
            </a>
            <p class="text-sm">&copy; 2024 - Todos los derechos reservados. Creado con ðŸ’™ y un poquito de IA.</p>
        </div>
    </footer>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js" defer></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js" defer></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js" defer></script>

    <script>
        lucide.createIcons();
        
        document.addEventListener('DOMContentLoaded', () => {
            const firebaseConfig = {
                 apiKey: "AIzaSyC9sVJwEfFdIN4VmSMooAoQLXYl5Mcu1yM", 
                 authDomain: "aulagenia.firebaseapp.com", 
                 projectId: "aulagenia", 
                 storageBucket: "aulagenia.appspot.com", 
                 messagingSenderId: "173328075630", 
                 appId: "1:173328075630:web:825606db4271ea1e66cf7f"
            };
            
            try { firebase.initializeApp(firebaseConfig); } catch(e) { console.warn("Firebase ya ha sido inicializado."); }

            const auth = firebase.auth();
            const db = firebase.firestore();

            const dom = {
                createPostContainer: document.getElementById('create-post-container'),
                loginPrompt: document.getElementById('login-prompt'),
                userAvatar: document.getElementById('user-avatar'),
                postContentTextarea: document.getElementById('post-content'),
                postCategorySelect: document.getElementById('post-category'),
                createPostForm: document.getElementById('create-post-form'),
                postFeed: document.getElementById('post-feed'),
                feedLoader: document.getElementById('feed-loader'),
                authContainer: document.getElementById('auth-container'),
                sidebarCtaContainer: document.getElementById('sidebar-cta-container'),
                categoryList: document.getElementById('category-list'),
                feedTitle: document.getElementById('feed-title')
            };
            
            let postsListener = null;
            let currentUser = null;
            let currentCategoryFilter = 'all';

            const categoryDetails = {
                'Tutoriales': { icon: 'book-open', color: 'text-blue-600' },
                'Discusiones': { icon: 'message-square', color: 'text-green-600' },
                'Proyectos': { icon: 'lightbulb', color: 'text-purple-600' }
            };

            function getRelativeTime(date) {
                const now = new Date();
                const seconds = Math.round((now - date) / 1000);
                if (seconds < 60) return `hace instantes`;
                const minutes = Math.round(seconds / 60);
                if (minutes < 60) return `hace ${minutes} min`;
                const hours = Math.round(minutes / 60);
                if (hours < 24) return `hace ${hours} h`;
                const days = Math.round(hours / 24);
                return `hace ${days} d`;
            }
            
            function loadPosts(category) {
                if (postsListener) postsListener();
                
                dom.postFeed.innerHTML = '';
                dom.feedLoader.classList.remove('hidden');

                let query = db.collection('labPosts');
                if (category && category !== 'all') {
                    query = query.where('category', '==', category);
                    dom.feedTitle.textContent = `Mostrando: ${category}`;
                } else {
                    dom.feedTitle.textContent = 'Actividad Reciente en el Lab';
                }

                postsListener = query.onSnapshot(snapshot => {
                    dom.feedLoader.classList.add('hidden');
                    if (snapshot.empty) {
                        dom.postFeed.innerHTML = `<p class="text-center text-gray-500">No hay publicaciones en esta categorÃ­a.</p>`;
                        return;
                    }
                    
                    const posts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    posts.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));

                    dom.postFeed.innerHTML = '';
                    posts.forEach(renderPost);
                    lucide.createIcons();
                }, err => {
                    console.error("Error al cargar posts:", err);
                    dom.feedLoader.classList.add('hidden');
                    dom.postFeed.innerHTML = `<p class="text-center text-red-500">Error al cargar la actividad.</p>`;
                });
            }

            function renderPost(postData) {
                const post = postData;
                const postId = post.id;
                const postDate = post.createdAt ? getRelativeTime(post.createdAt.toDate()) : 'Ahora mismo';
                const catInfo = categoryDetails[post.category] || categoryDetails['Discusiones'];
                const isAuthor = currentUser && currentUser.uid === post.authorId;

                const postElement = document.createElement('article');
                postElement.className = 'bg-white p-6 rounded-xl shadow-md';
                postElement.innerHTML = `
                    <div class="flex items-start gap-4">
                        <img src="${post.authorAvatar}" alt="Avatar de ${post.authorName}" class="w-10 h-10 rounded-full">
                        <div class="w-full">
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center gap-2">
                                    <p class="font-semibold text-sm">${post.authorName}</p>
                                    <span class="text-xs font-medium text-teal-700 bg-teal-100 px-2 py-0.5 rounded-full">${post.authorRole || 'Alumno'}</span>
                                </div>
                                <div class="flex items-center gap-3">
                                    <span class="text-xs text-gray-500">${postDate}</span>
                                    ${isAuthor ? `<button class="delete-button" data-type="post" data-post-id="${postId}"><i data-lucide="trash-2" class="h-4 w-4"></i></button>` : ''}
                                </div>
                            </div>
                            <div class="flex items-center gap-2 mb-2">
                                <i data-lucide="${catInfo.icon}" class="h-4 w-4 ${catInfo.color}"></i>
                                <span class="text-sm font-semibold ${catInfo.color}">${post.category}</span>
                            </div>
                            <p class="text-gray-700 whitespace-pre-wrap">${post.content}</p>
                            <div class="flex items-center text-gray-500 mt-4 text-sm gap-4">
                                <button class="comment-button flex items-center hover:text-teal-600" data-post-id="${postId}">
                                    <i data-lucide="message-square" class="h-4 w-4 mr-2"></i>
                                    <span>${post.commentsCount || 0} Comentarios</span>
                                </button>
                            </div>
                            <div class="mt-4 border-t border-gray-100 pt-4 comments-section">
                                <div id="comments-container-${postId}"></div>
                                <div id="comment-form-container-${postId}" class="comment-form"></div>
                            </div>
                        </div>
                    </div>`;
                
                dom.postFeed.appendChild(postElement);
                loadComments(postId);
            }

            function loadComments(postId) {
                const commentsContainer = document.getElementById(`comments-container-${postId}`);
                db.collection('labPosts').doc(postId).collection('comments').orderBy('createdAt', 'asc')
                  .onSnapshot(snapshot => {
                      commentsContainer.innerHTML = '';
                      snapshot.forEach(doc => {
                          const comment = doc.data();
                          const commentId = doc.id;
                          const commentDate = comment.createdAt ? getRelativeTime(comment.createdAt.toDate()) : '';
                          const isAuthor = currentUser && currentUser.uid === comment.authorId;
                          
                          const commentElement = document.createElement('div');
                          commentElement.className = 'flex items-start gap-3 mt-4';
                          commentElement.innerHTML = `
                            <img src="${comment.authorAvatar}" alt="Avatar de ${comment.authorName}" class="w-8 h-8 rounded-full">
                            <div class="bg-gray-100 rounded-lg p-3 text-sm w-full">
                                <div class="flex justify-between items-center">
                                    <p class="font-semibold text-gray-800">${comment.authorName}</p>
                                    <div class="flex items-center gap-3">
                                        <p class="text-xs text-gray-500">${commentDate}</p>
                                        ${isAuthor ? `<button class="delete-button" data-type="comment" data-post-id="${postId}" data-comment-id="${commentId}"><i data-lucide="trash-2" class="h-3 w-3"></i></button>` : ''}
                                    </div>
                                </div>
                                <p class="text-gray-700 mt-1">${comment.content}</p>
                            </div>
                          `;
                          commentsContainer.appendChild(commentElement);
                      });
                      lucide.createIcons();
                  });
            }
            
            function handleCommentForm(postId, user) {
                const container = document.getElementById(`comment-form-container-${postId}`);
                const isActive = container.classList.contains('active');
                if (isActive) {
                    container.innerHTML = '';
                    container.classList.remove('active');
                } else {
                    container.innerHTML = `
                        <form class="comment-submit-form flex items-start gap-3" data-post-id="${postId}">
                            <img src="${user.photoURL}" alt="Tu avatar" class="w-8 h-8 rounded-full">
                            <div class="w-full">
                                <textarea class="w-full p-2 border-gray-300 border rounded-lg text-sm" rows="2" placeholder="Escribe un comentario..." required></textarea>
                                <button type="submit" class="text-xs bg-teal-500 text-white font-semibold py-1 px-3 rounded-md hover:bg-teal-600 mt-2">Publicar</button>
                            </div>
                        </form>
                    `;
                    container.classList.add('active');
                    const form = container.querySelector('form');
                    form.addEventListener('submit', handleCommentSubmit);
                    form.querySelector('textarea').focus();
                }
            }
            
            async function handleCommentSubmit(e) {
                e.preventDefault();
                const postId = e.target.dataset.postId;
                const textarea = e.target.querySelector('textarea');
                const content = textarea.value.trim();
                if (!content || !currentUser) return;
                const newComment = { content, authorId: currentUser.uid, authorName: currentUser.displayName, authorAvatar: currentUser.photoURL, createdAt: firebase.firestore.FieldValue.serverTimestamp() };
                const postRef = db.collection('labPosts').doc(postId);
                const commentRef = postRef.collection('comments').doc();
                try {
                    await db.runTransaction(async (transaction) => {
                        const postDoc = await transaction.get(postRef);
                        if (!postDoc.exists) throw "El documento no existe!";
                        const newCount = (postDoc.data().commentsCount || 0) + 1;
                        transaction.update(postRef, { commentsCount: newCount });
                        transaction.set(commentRef, newComment);
                    });
                    textarea.value = '';
                    document.getElementById(`comment-form-container-${postId}`).classList.remove('active');
                } catch (error) { console.error("Error al publicar comentario: ", error); alert("No se pudo publicar el comentario."); }
            }

            async function handleDelete(e) {
                const button = e.target.closest('.delete-button');
                if (!button) return;

                const type = button.dataset.type;
                const postId = button.dataset.postId;
                const commentId = button.dataset.commentId;

                if (type === 'post') {
                    if (confirm('Â¿EstÃ¡s seguro de que quieres borrar esta publicaciÃ³n? Se eliminarÃ¡n todos sus comentarios.')) {
                        const postRef = db.collection('labPosts').doc(postId);
                        // Primero borrar subcolecciÃ³n de comentarios
                        const commentsSnapshot = await postRef.collection('comments').get();
                        const batch = db.batch();
                        commentsSnapshot.forEach(doc => batch.delete(doc.ref));
                        await batch.commit();
                        // Luego borrar el post
                        await postRef.delete();
                    }
                } else if (type === 'comment') {
                    if (confirm('Â¿EstÃ¡s seguro de que quieres borrar este comentario?')) {
                        const postRef = db.collection('labPosts').doc(postId);
                        const commentRef = postRef.collection('comments').doc(commentId);
                        try {
                            await db.runTransaction(async (transaction) => {
                                const postDoc = await transaction.get(postRef);
                                if (!postDoc.exists) throw "El post no existe";
                                const newCount = (postDoc.data().commentsCount || 1) - 1;
                                transaction.update(postRef, { commentsCount: newCount < 0 ? 0 : newCount });
                                transaction.delete(commentRef);
                            });
                        } catch (error) {
                            console.error("Error al borrar comentario: ", error);
                            alert("No se pudo borrar el comentario.");
                        }
                    }
                }
            }

            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = { uid: user.uid, displayName: user.displayName || 'Alumno', photoURL: user.photoURL || `https://placehold.co/48x48/14b8a6/FFFFFF?text=${(user.displayName || 'A').charAt(0).toUpperCase()}` };
                    dom.loginPrompt.classList.add('hidden');
                    dom.createPostContainer.classList.remove('hidden');
                    dom.userAvatar.src = currentUser.photoURL;
                    dom.postContentTextarea.placeholder = `Â¿QuÃ© estÃ¡s pensando, ${currentUser.displayName}?`;
                    dom.authContainer.innerHTML = `<a href="campus-curso-ia.html" class="text-teal-600 font-semibold border-2 border-teal-500 rounded-full px-5 text-sm py-2 hover:bg-teal-500 hover:text-white transition-colors duration-300 flex items-center">Mi Campus</a>`;
                    dom.sidebarCtaContainer.innerHTML = `<a href="campus-curso-ia.html" class="mt-8 block w-full bg-gray-800 text-white text-center font-bold py-3 px-4 rounded-lg hover:bg-gray-700 transition-colors">Ir a mi Curso</a>`;
                } else {
                    currentUser = null;
                    dom.createPostContainer.classList.add('hidden');
                    dom.loginPrompt.classList.remove('hidden');
                    dom.authContainer.innerHTML = `<a href="acceso.html" class="cta-button bg-gray-900 text-white font-bold rounded-full hover:bg-gray-700 px-4 py-1.5 sm:px-6 sm:py-2 flex flex-col items-center justify-center"><span class="text-sm sm:text-base leading-tight">ðŸ”“ Acceso</span><span class="text-[9px] sm:text-[10px] font-normal opacity-75 leading-tight">Inicia tu viaje</span></a>`;
                    dom.sidebarCtaContainer.innerHTML = `<a href="acceso.html" class="mt-8 block w-full bg-teal-500 text-white text-center font-bold py-3 px-4 rounded-lg hover:bg-teal-600 transition-colors">Ãšnete para Publicar</a>`;
                    dom.postFeed.innerHTML = '<p class="text-center text-gray-500 py-8">Inicia sesiÃ³n para ver y crear publicaciones.</p>';
                }
                loadPosts(currentCategoryFilter);
                lucide.createIcons();
            });

            dom.createPostForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const content = dom.postContentTextarea.value.trim();
                const category = dom.postCategorySelect.value;
                if (content && category && currentUser) {
                    db.collection('labPosts').add({
                        content, category, authorId: currentUser.uid, authorName: currentUser.displayName, authorAvatar: currentUser.photoURL, authorRole: 'Alumno', createdAt: firebase.firestore.FieldValue.serverTimestamp(), commentsCount: 0
                    }).then(() => {
                        dom.postContentTextarea.value = '';
                    }).catch(err => { console.error("Error al aÃ±adir la publicaciÃ³n: ", err); alert("Hubo un error al publicar."); });
                }
            });
            
            dom.postFeed.addEventListener('click', e => {
                const commentButton = e.target.closest('.comment-button');
                if (commentButton && currentUser) { handleCommentForm(commentButton.dataset.postId, currentUser); } 
                else if (commentButton && !currentUser) { alert('Debes iniciar sesiÃ³n para comentar.'); }
                
                handleDelete(e);
            });

            dom.categoryList.addEventListener('click', e => {
                e.preventDefault();
                const link = e.target.closest('.category-link');
                if (link) {
                    currentCategoryFilter = link.dataset.category;
                    dom.categoryList.querySelectorAll('.category-link').forEach(l => l.classList.remove('active'));
                    link.classList.add('active');
                    loadPosts(currentCategoryFilter);
                }
            });

            // Activar el filtro inicial
            dom.categoryList.querySelector('[data-category="all"]').classList.add('active');
        });
    </script>
</body>
</html>
