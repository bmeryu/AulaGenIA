<!DOCTYPE html>
<!-- 
  CAMPUS DASHBOARD · AULA GENIA v8.2 (Access Logic Update)
  -------------------------------------------------------------------
  - LOGIC UPDATE: Las "Power Tools" ahora se desbloquean si el usuario
    tiene acceso al curso "IA Aplicada · Esencial".
  - REDIRECT: El botón de desbloqueo ahora lleva a "aulagenia.cl/tool.html".
  - OPTIMIZATION: Verificación de permisos unificada para evitar doble lectura.
  -------------------------------------------------------------------
-->
<html lang="es-CL" class="scroll-smooth">

<head>
  <meta charset="UTF-8" />
  <title>Campus Virtual – Aula GenIA (Con Acceso)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="noindex, nofollow">
  <meta name="description" content="Dashboard de estudiante para acceder a cursos, recursos y comunidad de Aula GenIA.">
  <link rel="canonical" href="https://aulagenia.cl/campus.html">
  <link rel="icon" href="https://aulagenia.cl/favicon.ico" type="image/x-icon" />
  <link rel="apple-touch-icon" href="https://aulagenia.cl/Logo_AGIA.png">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;900&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@0.368.0/dist/umd/lucide.min.js"></script>
  <!-- jsPDF for PDF Generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- Prompts Database -->
  <script src="prompts_db.js"></script>

  <style>
    :root {
      --brand-teal: #14b8a6;
      --brand-green: #22c55e;
      --brand-purple: #7c3aed;
    }

    html {
      font-family: 'Poppins', sans-serif;
    }

    body {
      background-color: #f8fafc;
    }

    .card-hover {
      @apply transform transition-transform duration-300 hover:-translate-y-2 hover:shadow-xl;
    }

    /* Efecto brillo para tarjetas PRO */
    .pro-shine {
      position: relative;
      overflow: hidden;
    }

    .pro-shine::after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 50%;
      height: 100%;
      background: linear-gradient(to right, transparent, rgba(255, 255, 255, 0.2), transparent);
      transform: skewX(-25deg);
      animation: shine 6s infinite;
    }

    @keyframes shine {
      0% {
        left: -100%;
      }

      20% {
        left: 200%;
      }

      100% {
        left: 200%;
      }
    }

    #profile-modal {
      transition: all 0.3s ease-in-out;
    }

    .form-input-error {
      @apply border-red-500 ring-red-500;
    }

    .form-input-success {
      @apply border-green-500 ring-green-500;
    }

    .error-message {
      @apply text-red-600 text-xs mt-1;
    }

    label span.required {
      @apply text-red-500;
    }

    /* Custom slow pulse animation for PDF button */
    @keyframes pulse-slow {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.85;
      }
    }

    .animate-pulse-slow {
      animation: pulse-slow 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
  </style>
</head>

<body class="text-gray-800">

  <header class="bg-white shadow-sm sticky top-0 z-30">
    <nav class="container mx-auto px-6 py-4 flex items-center justify-between">
      <a href="/" class="flex items-center gap-2" aria-label="Ir al inicio de Aula GenIA">
        <img src="https://aulagenia.cl/Logo_AGIA.png" alt="Logo Aula GenIA" class="h-16 w-auto" />
      </a>
      <div id="user-profile" class="hidden sm:flex items-center gap-3 relative">
        <span id="user-name" class="font-semibold text-gray-700 truncate max-w-[15ch]"></span>
        <button id="avatar-button" aria-label="Abrir menú de perfil">
          <img id="user-avatar" alt="Avatar del usuario"
            class="w-10 h-10 rounded-full border-2 border-teal-500 cursor-pointer hover:opacity-90 transition-opacity" />
        </button>
        <button id="logout-btn" class="text-sm text-gray-500 hover:text-red-600 transition-colors">Cerrar
          sesión</button>
      </div>
    </nav>
  </header>

  <main class="container mx-auto px-6 py-12 max-w-7xl">
    <section class="mb-12">
      <h1 class="text-3xl md:text-4xl font-bold text-gray-900 leading-tight">¡Bienvenido de nuevo, <span
          id="welcome-name" class="whitespace-nowrap">Aprendiz</span>!</h1>
      <p class="text-lg text-gray-600 mt-2">Tu centro de comando para dominar la IA.</p>
    </section>

    <!-- SECCIÓN DE CURSOS (Clásica) -->
    <section aria-labelledby="courses-heading" class="mb-16">
      <h2 id="courses-heading" class="text-2xl font-bold border-b border-gray-300 pb-3 mb-6 flex items-center gap-2">
        <i data-lucide="graduation-cap" class="w-6 h-6 text-gray-400"></i> Mis Cursos
      </h2>
      <div class="grid gap-8 sm:grid-cols-2 lg:grid-cols-3">

        <!-- 1. Curso Principal (Activo) -->
        <article class="bg-white rounded-2xl shadow card-hover overflow-hidden flex flex-col"
          data-course-id="ia-aplicada-esencial">
          <div class="p-6 flex-grow">
            <span
              class="tag inline-block text-xs font-semibold uppercase tracking-wider text-gray-600 bg-gray-100 px-2 py-1 rounded-full">Cargando...</span>
            <h3 class="text-xl font-bold mt-4 mb-1">IA Aplicada · Esencial</h3>
            <p class="text-gray-600 text-sm mb-6">Acceso por 12 meses a los 4 módulos, con actualizaciones y
              certificado.</p>
            <div class="mb-2 progress-container hidden">
              <div class="flex justify-between text-sm font-medium text-gray-600 mb-1">
                <span>Progreso</span>
                <span class="percent">0%</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-2.5">
                <div class="fill h-2.5 rounded-full transition-all duration-500"
                  style="background-color: var(--brand-teal); width: 0%"></div>
              </div>
            </div>
          </div>
          <div class="card-footer bg-gray-50 px-6 py-4">
            <a href="#"
              class="course-action-btn block text-center bg-gray-400 text-white font-bold py-3 px-5 rounded-lg transition-colors cursor-wait">
              Verificando acceso...
            </a>
          </div>
        </article>

        <!-- 2. TOOL CARD: Generador Prompts (Premium) -->
        <article
          class="relative group rounded-2xl overflow-hidden shadow-lg transition-all duration-500 hover:shadow-2xl bg-white border border-teal-200 pro-shine flex flex-col">
          <!-- Banner Superior Visual -->
          <div class="h-32 bg-gradient-to-r from-teal-500 via-blue-600 to-indigo-600 relative overflow-hidden">
            <!-- Decorative patterns -->
            <div
              class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full blur-2xl transform translate-x-10 -translate-y-10">
            </div>
            <div
              class="absolute bottom-0 left-0 w-24 h-24 bg-yellow-400/20 rounded-full blur-xl transform -translate-x-5 translate-y-5">
            </div>

            <div class="absolute bottom-4 left-6">
              <div class="p-2.5 bg-white/90 backdrop-blur-sm rounded-xl inline-block shadow-lg">
                <i data-lucide="bot" class="h-6 w-6 text-blue-600"></i>
              </div>
            </div>
          </div>

          <div class="p-6 pt-2 flex-grow flex flex-col">
            <div class="flex justify-between items-start mb-2">
              <h3 class="text-xl font-bold text-gray-900 leading-tight">Generador Maestro de Prompts</h3>
              <span
                class="inline-block px-2 py-1 bg-green-100 text-green-700 text-xs font-bold rounded-full border border-green-200 flex-shrink-0 ml-2">
                <i data-lucide="check" class="h-3 w-3 inline mr-1"></i>Activo
              </span>
            </div>
            <p class="text-gray-600 text-sm mb-5 leading-relaxed">
              Crea prompts de nivel experto en segundos. Bóveda interactiva con <span
                class="font-bold text-teal-600">+100 estructuras probadas</span>.
            </p>
            <a href="maestro-prompts-app.html"
              class="mt-auto block text-center bg-gradient-to-r from-teal-500 to-blue-600 hover:from-teal-600 hover:to-blue-700 text-white font-bold py-3 px-5 rounded-xl shadow-md hover:shadow-lg transition-all transform hover:-translate-y-0.5 border border-white/20">
              ⚡ Acceder al Generador
            </a>
            <button id="manual-pdf-btn" onclick="downloadPromptsPDF()"
              class="mt-3 block w-full text-center bg-gradient-to-r from-teal-500 via-teal-600 to-cyan-600 hover:from-teal-600 hover:via-teal-700 hover:to-cyan-700 text-white font-black py-4 px-6 rounded-xl shadow-xl hover:shadow-2xl transition-all transform hover:scale-105 border-2 border-white/40 animate-pulse-slow relative overflow-hidden group">
              <span
                class="absolute inset-0 bg-gradient-to-r from-white/0 via-white/30 to-white/0 translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-700"></span>
              <span class="relative flex items-center justify-center gap-2 text-base">
                📥 DESCARGAR 100 PROMPTS PDF
                <span
                  class="inline-block px-2 py-0.5 bg-yellow-400 text-teal-900 text-xs font-black rounded-full animate-bounce">GRATIS</span>
              </span>
            </button>
          </div>
        </article>

        <!-- 3. UPSELL: Curso Avanzado -->
        <article class="bg-white rounded-2xl shadow card-hover overflow-hidden flex flex-col" id="programa-avanzado"
          data-course-id="programa-avanzado">
          <div class="p-6 flex-grow">
            <h3 class="text-xl font-bold mt-4 mb-2">Creador de <span class="text-blue-600">Magia</span></h3>
            <p class="font-semibold text-gray-500 text-sm mb-4">Programa Avanzado</p>
            <p class="text-gray-600 text-sm mb-6">Deja de copiar. Aprende a crear tus propias herramientas y asistentes
              inteligentes.</p>
          </div>
          <div class="bg-gray-50 px-6 py-4 mt-auto">
            <button id="waitlist-btn"
              class="w-full text-center bg-white border-2 border-blue-600 text-blue-600 hover:bg-blue-50 font-bold py-3 px-5 rounded-lg transition-colors flex items-center justify-center gap-2">
              <span id="waitlist-btn-text">Unirme a la lista de espera</span>
              <i id="waitlist-btn-spinner" data-lucide="loader-2" class="h-5 w-5 animate-spin hidden"></i>
            </button>
          </div>
        </article>

        <!-- 4. UPSELL: Laboratorio -->
        <article
          class="bg-white rounded-2xl shadow card-hover overflow-hidden flex flex-col opacity-75 hover:opacity-100 transition-opacity"
          data-course-id="laboratorio-experto">
          <div class="p-6 flex-grow">
            <h3 class="text-xl font-bold mt-4 mb-2">Mentoría <span class="text-indigo-600">Experta</span></h3>
            <p class="text-gray-600 text-sm mb-6">Acompañamiento 1 a 1 para tus proyectos más importantes.</p>
          </div>
          <div class="bg-gray-50 px-6 py-4 mt-auto">
            <button id="reserve-btn"
              class="w-full text-center text-gray-500 hover:text-indigo-600 font-bold py-3 px-5 transition-colors text-sm">
              <span id="reserve-btn-text">Consultar disponibilidad</span>
              <i id="reserve-btn-spinner" data-lucide="loader-2" class="h-5 w-5 animate-spin hidden"></i>
            </button>
          </div>
        </article>

      </div>

      <footer class="bg-white border-t mt-16 text-center text-gray-500 text-sm py-6">
        © 2025 Aula GenIA · Todos los derechos reservados.
      </footer>

      <!-- MODAL DE PERFIL (Sin cambios) -->
      <div id="profile-modal-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden z-40"></div>
      <div id="profile-modal" class="fixed inset-0 hidden z-50 flex items-center justify-center p-4">
        <div
          class="bg-white rounded-2xl shadow-2xl w-full max-w-lg flex flex-col transform transition-all scale-95 opacity-0">
          <div class="p-6 flex-shrink-0">
            <div class="flex justify-between items-start">
              <div>
                <h3 id="profile-modal-title" class="text-2xl font-bold text-gray-900">Editar Perfil</h3>
                <p id="profile-modal-subtitle" class="text-gray-600 mt-1">Mantén tus datos actualizados.</p>
              </div>
              <button id="close-profile-modal-btn" class="text-gray-400 hover:text-gray-600">&times;</button>
            </div>
          </div>

          <div class="px-6 pb-2 flex-grow overflow-y-auto">
            <form id="profile-form" class="space-y-3" novalidate>
              <div>
                <label for="profile-name-input" class="block text-sm font-medium text-gray-700 mb-1">Nombre Completo
                  <span class="required">*</span></label>
                <div class="relative">
                  <input type="text" id="profile-name-input" name="fullName"
                    class="w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 pr-10"
                    placeholder="Ej: Ada Lovelace">
                  <span id="name-status-icon" class="absolute inset-y-0 right-0 flex items-center pr-3"></span>
                </div>
                <p class="text-xs text-gray-500 mt-1">Este será el nombre en tu certificado.</p>
                <div id="name-error" class="error-message"></div>
              </div>
              <div>
                <label for="profile-rut-input" class="block text-sm font-medium text-gray-700 mb-1">RUT (Chile) <span
                    class="required">*</span></label>
                <div class="relative">
                  <input type="text" id="profile-rut-input" name="rut"
                    class="w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 pr-10"
                    placeholder="Ej: 12345678-9">
                  <span id="rut-status-icon" class="absolute inset-y-0 right-0 flex items-center pr-3"></span>
                </div>
                <p class="text-xs text-gray-500 mt-1">Requerido si tu país es Chile.</p>
                <div id="rut-error" class="error-message"></div>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <div>
                  <label for="profile-country-select" class="block text-sm font-medium text-gray-700 mb-1">País <span
                      class="required">*</span></label>
                  <div class="relative">
                    <select id="profile-country-select" name="country"
                      class="w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 appearance-none pr-10">
                      <option value="">Selecciona tu país</option>
                      <option value="CL">Chile</option>
                      <option value="AR">Argentina</option>
                      <option value="PE">Perú</option>
                      <option value="CO">Colombia</option>
                      <option value="MX">México</option>
                      <option value="ES">España</option>
                      <option value="US">Estados Unidos</option>
                      <option value="OT">Otro</option>
                    </select>
                    <span id="country-status-icon"
                      class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none"></span>
                  </div>
                  <div id="country-error" class="error-message"></div>
                </div>
                <div>
                  <label for="profile-job-input" class="block text-sm font-medium text-gray-700 mb-1">Cargo o
                    Profesión</label>
                  <input type="text" id="profile-job-input" name="jobTitle"
                    class="w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500"
                    placeholder="Ej: Estudiante">
                </div>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <div>
                  <label for="profile-gender-select" class="block text-sm font-medium text-gray-700 mb-1">Género</label>
                  <select id="profile-gender-select" name="gender"
                    class="w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500">
                    <option value="">Seleccionar...</option>
                    <option value="female">Femenino</option>
                    <option value="male">Masculino</option>
                    <option value="other">Otro</option>
                    <option value="prefer_not_to_say">Prefiero no decir</option>
                  </select>
                </div>
                <div>
                  <label for="profile-birthdate-input" class="block text-sm font-medium text-gray-700 mb-1">Fecha de
                    Nacimiento</label>
                  <input type="date" id="profile-birthdate-input" name="birthdate"
                    class="w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500">
                </div>
              </div>
              <div>
                <label for="profile-email-input" class="block text-sm font-medium text-gray-700 mb-1">Correo
                  Electrónico</label>
                <input type="email" id="profile-email-input"
                  class="w-full rounded-md border-gray-300 shadow-sm bg-gray-100 cursor-not-allowed" disabled>
              </div>
              <div id="form-status" class="text-center p-3 rounded-lg hidden"></div>
            </form>
          </div>
          <div class="p-6 pt-4 flex-shrink-0">
            <div class="flex justify-end gap-3 pt-4 border-t">
              <button type="button" id="cancel-profile-btn"
                class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors">Cancelar</button>
              <button type="submit" form="profile-form" id="save-profile-btn"
                class="bg-teal-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-600 transition-colors flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                <span id="save-btn-text">Guardar Cambios</span>
                <i id="save-spinner" data-lucide="loader-2" class="h-5 w-5 animate-spin hidden"></i>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal de Cupón -->
      <div id="coupon-modal"
        class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-md w-full p-8 shadow-2xl transform transition-all">
          <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-black text-gray-900">¿Tienes un cupón?</h3>
            <button onclick="closeCouponModal()" class="text-gray-400 hover:text-gray-600">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>

          <div class="mb-6">
            <label class="block text-sm font-bold text-gray-700 mb-2">Código de descuento (opcional)</label>
            <input type="text" id="modal-coupon-input" placeholder="Ingresa tu código"
              class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 uppercase font-mono text-lg"
              maxlength="20">
            <div id="modal-coupon-message" class="mt-2 text-sm font-medium hidden"></div>
          </div>

          <div id="modal-discount-summary" class="mb-6 p-4 bg-green-50 border-2 border-green-200 rounded-lg hidden">
            <div class="flex justify-between items-center mb-2">
              <span class="text-gray-600">Precio original:</span>
              <span class="text-gray-900 font-bold" id="modal-original-price"></span>
            </div>
            <div class="flex justify-between items-center mb-2">
              <span class="text-green-600 font-bold">Descuento (<span id="modal-discount-label"></span>):</span>
              <span class="text-green-600 font-bold text-xl" id="modal-discount-amount"></span>
            </div>
            <div class="flex justify-between items-center pt-2 border-t-2 border-green-300">
              <span class="text-gray-900 font-black text-lg">Total a pagar:</span>
              <span class="text-3xl font-black text-green-600" id="modal-final-price"></span>
            </div>
            <p class="mt-3 text-xs text-gray-500 italic">
              * El descuento se aplicará automáticamente en Mercado Pago. Si el cupón no se aplica correctamente,
              contáctanos antes de completar el pago.
            </p>
          </div>

          <div class="flex gap-3">
            <button onclick="proceedWithoutCoupon()"
              class="flex-1 px-6 py-3 border-2 border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-bold">
              Sin cupón
            </button>
            <button id="modal-apply-btn" onclick="applyModalCoupon()"
              class="flex-1 px-6 py-3 bg-teal-600 text-white rounded-lg hover:bg-teal-700 transition-colors font-bold">
              Aplicar y continuar
            </button>
          </div>
        </div>
      </div>

      <!-- Firebase SDKs -->
      <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js" defer></script>
      <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js" defer></script>
      <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js" defer></script>
      <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-functions-compat.js" defer></script>

      <script defer>


        document.addEventListener('DOMContentLoaded', () => {
          const firebaseConfig = { apiKey: "AIzaSyC9sVJwEfFdIN4VmSMooAoQLXYl5Mcu1yM", authDomain: "aulagenia.firebaseapp.com", projectId: "aulagenia", storageBucket: "aulagenia.appspot.com", messagingSenderId: "173328075630", appId: "1:173328075630:web:825606db4271ea1e66cf7f" };

          try {
            firebase.initializeApp(firebaseConfig);
          } catch (e) {
            console.warn("Firebase ya fue inicializado.");
          }

          const auth = firebase.auth();
          const db = firebase.firestore();

          // ============================================
          // LÓGICA DEL MODAL DE CUPÓN
          // ============================================
          let appliedCoupon = null;

          // Helper: Verificar si el usuario ya compró el curso
          async function checkUserPurchaseStatus(user) {
            if (!user) return { hasCourse: false, error: null };

            try {
              const userDoc = await db.collection('users').doc(user.uid).get();

              if (userDoc.exists) {
                const userData = userDoc.data();
                const hasCourse = userData.courses && userData.courses['ia-aplicada-esencial'];
                return { hasCourse: !!hasCourse, error: null };
              }
              return { hasCourse: false, error: null };
            } catch (error) {
              console.error('Error verificando estado del curso:', error);
              return { hasCourse: false, error };
            }
          }

          async function showCouponModal() {
            const user = auth.currentUser;

            if (!user) {
              sessionStorage.setItem('pendingAction', 'showCouponModal');
              window.location.href = 'acceso.html?redirect=campus.html';
              return;
            }

            const { hasCourse } = await checkUserPurchaseStatus(user);

            if (hasCourse) {
              alert('¡Ya estás inscrito en este curso! Puedes acceder al contenido desde esta página.');
              location.reload();
              return;
            }

            const modal = document.getElementById('coupon-modal');
            if (modal) {
              modal.classList.remove('hidden');
              modal.classList.add('flex');
            }
          }

          function closeCouponModal() {
            const modal = document.getElementById('coupon-modal');
            if (modal) {
              modal.classList.add('hidden');
              modal.classList.remove('flex');

              const input = document.getElementById('modal-coupon-input');
              if (input) input.value = '';
              const msg = document.getElementById('modal-coupon-message');
              if (msg) msg.classList.add('hidden');
              const summary = document.getElementById('modal-discount-summary');
              if (summary) summary.classList.add('hidden');

              const btn = document.getElementById('modal-apply-btn');
              if (btn) {
                btn.textContent = 'Aplicar y continuar';
                btn.onclick = applyModalCoupon;
                btn.disabled = false;
              }
            }
            appliedCoupon = null;
          }

          async function applyModalCoupon() {
            const couponInput = document.getElementById('modal-coupon-input');
            const couponCode = couponInput.value.trim().toUpperCase();

            if (!couponCode) {
              proceedWithoutCoupon();
              return;
            }

            const user = auth.currentUser;
            if (!user) {
              showModalMessage('Debes iniciar sesión primero', 'error');
              return;
            }

            const btn = document.getElementById('modal-apply-btn');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Validando...';

            try {
              const validateCoupon = firebase.functions().httpsCallable('validateCoupon');
              const result = await validateCoupon({
                couponCode: couponCode,
                courseId: 'ia-aplicada-esencial'
              });

              if (result.data.valid) {
                appliedCoupon = result.data;

                document.getElementById('modal-original-price').textContent = `$${result.data.originalPrice} USD`;

                const discountLabel = result.data.discountType === 'percentage'
                  ? `${result.data.discountValue}%`
                  : `$${result.data.discountValue} USD`;

                document.getElementById('modal-discount-label').textContent = discountLabel;
                document.getElementById('modal-discount-amount').textContent = `-$${result.data.discountAmount.toFixed(2)} USD`;
                document.getElementById('modal-final-price').textContent = `$${result.data.finalPrice.toFixed(2)} USD`;

                document.getElementById('modal-discount-summary').classList.remove('hidden');

                showModalMessage(`✅ Cupón aplicado: ${discountLabel} de descuento`, 'success');

                btn.textContent = 'Confirmar y Pagar';
                btn.onclick = proceedWithCoupon;
                btn.disabled = false;
              } else {
                showModalMessage('Cupón no válido', 'error');
                btn.textContent = originalText;
                btn.disabled = false;
              }

            } catch (error) {
              console.error('Error validating coupon:', error);
              let errorMessage = 'Cupón inválido';
              if (error.message) {
                if (error.message.includes('expirado')) errorMessage = 'Cupón expirado';
                else if (error.message.includes('agotado')) errorMessage = 'Cupón agotado';
                else if (error.message.includes('Ya usaste')) errorMessage = 'Ya usaste este cupón';
              }
              showModalMessage(errorMessage, 'error');
              btn.textContent = originalText;
              btn.disabled = false;
            }
          }

          function showModalMessage(message, type) {
            const messageEl = document.getElementById('modal-coupon-message');
            if (messageEl) {
              messageEl.textContent = message;
              messageEl.className = `mt-2 text-sm font-medium ${type === 'error' ? 'text-red-600' : 'text-green-600'}`;
              messageEl.classList.remove('hidden');
            }
          }

          async function proceedWithoutCoupon() {
            appliedCoupon = null;
            const modal = document.getElementById('coupon-modal');
            if (modal) modal.classList.add('hidden');

            await handlePurchase();
          }

          async function proceedWithCoupon() {
            const modal = document.getElementById('coupon-modal');
            if (modal) modal.classList.add('hidden');

            await handlePurchase();
          }

          async function handlePurchase() {
            const user = auth.currentUser;

            if (!user) {
              sessionStorage.setItem('pendingPurchase', JSON.stringify({
                courseId: 'ia-aplicada-esencial',
                couponId: appliedCoupon ? appliedCoupon.couponId : null
              }));
              window.location.href = 'acceso.html?action=buy';
              return;
            }

            try {
              const createPreference = firebase.functions().httpsCallable('createMercadoPagoPreference');
              const result = await createPreference({
                courseId: 'ia-aplicada-esencial',
                couponId: appliedCoupon ? appliedCoupon.couponId : null
              });

              if (result.data && result.data.init_point) {
                window.location.href = result.data.init_point;
              } else {
                throw new Error("Respuesta inválida del servidor de pagos");
              }

            } catch (error) {
              console.error('Error de pago:', error);
              alert('Hubo un error al iniciar el pago. Por favor intenta nuevamente.');
            }
          }

          // Exponer funciones globalmente
          window.showCouponModal = showCouponModal;
          window.closeCouponModal = closeCouponModal;
          window.applyModalCoupon = applyModalCoupon;
          window.proceedWithoutCoupon = proceedWithoutCoupon;
          window.proceedWithCoupon = proceedWithCoupon;


          const COURSE_CONFIG = {
            'ia-aplicada-esencial': {
              title: 'IA Aplicada · Esencial',
              totalLessons: 20,
              modules: [
                { title: 'Módulo 1: ¿Qué es la Inteligencia Artificial?', lessons: [{ id: '1-1' }, { id: '1-2' }, { id: '1-3' }, { id: 'q-1' }] },
                { title: 'Módulo 2: La IA para ti, en tu día a día', lessons: [{ id: '2-1' }, { id: '2-2' }, { id: '2-3' }, { id: '2-taller' }, { id: 'q-2' }] },
                { title: 'Módulo 3: Preparando tus herramientas', lessons: [{ id: '3-1' }, { id: '3-2' }, { id: '3-3' }, { id: 'q-3' }] },
                { title: 'Módulo 4: Arquitectura de Ideas', lessons: [{ id: '4-1' }, { id: '4-2' }, { id: 'q-4' }] },
                { title: 'Módulo 5: Estrategias Avanzadas', lessons: [{ id: '5-1' }, { id: '5-2' }, { id: '5-3' }] },
                { title: 'Final del Camino: Certificación', lessons: [{ id: 'final-exam' }] }
              ]
            }
          };

          const ESSENTIAL_COURSE_ID = 'ia-aplicada-esencial';

          const profileModalOverlay = document.getElementById('profile-modal-overlay');
          const profileModal = document.getElementById('profile-modal');
          const avatarButton = document.getElementById('avatar-button');
          const cancelProfileBtn = document.getElementById('cancel-profile-btn');
          const closeProfileBtn = document.getElementById('close-profile-modal-btn');
          const profileForm = document.getElementById('profile-form');
          const profileNameInput = document.getElementById('profile-name-input');
          const profileRutInput = document.getElementById('profile-rut-input');
          const profileEmailInput = document.getElementById('profile-email-input');
          const profileJobInput = document.getElementById('profile-job-input');
          const profileCountrySelect = document.getElementById('profile-country-select');
          const profileGenderSelect = document.getElementById('profile-gender-select');
          const profileBirthdateInput = document.getElementById('profile-birthdate-input');
          const modalTitle = document.getElementById('profile-modal-title');
          const modalSubtitle = document.getElementById('profile-modal-subtitle');
          const formStatus = document.getElementById('form-status');
          const saveBtn = document.getElementById('save-profile-btn');
          const saveBtnText = document.getElementById('save-btn-text');
          const saveSpinner = document.getElementById('save-spinner');

          async function showProfileModal(isMandatory = false) {
            profileForm.reset();
            const user = auth.currentUser;
            if (!user) return;

            profileEmailInput.value = user.email || '';
            const userDocRef = db.collection('users').doc(user.uid);
            try {
              const doc = await userDocRef.get();
              const dbData = doc.exists ? doc.data() : {};
              const isProfileCompleted = dbData.profileCompleted === true;

              if (profileNameInput) profileNameInput.value = isProfileCompleted ? (dbData.displayName || '') : (user.displayName || '');
              if (profileRutInput) profileRutInput.value = dbData.rut || '';
              if (profileJobInput) profileJobInput.value = dbData.jobTitle || '';
              if (profileCountrySelect) profileCountrySelect.value = dbData.country || '';
              if (profileGenderSelect) profileGenderSelect.value = dbData.gender || '';
              if (profileBirthdateInput) profileBirthdateInput.value = dbData.birthdate || '';
            } catch (error) {
              console.error("Error al cargar datos del perfil:", error);
            }

            checkAllFieldsAndToggleButtonState();

            if (isMandatory) {
              modalTitle.textContent = '¡Completa tu perfil para continuar!';
              modalSubtitle.textContent = 'Necesitamos estos datos para generar tus certificados correctamente.';
              cancelProfileBtn.classList.add('hidden');
              closeProfileBtn.classList.add('hidden');
              profileModalOverlay.removeEventListener('click', hideProfileModal);
            } else {
              modalTitle.textContent = 'Editar Perfil';
              modalSubtitle.textContent = 'Mantén tus datos actualizados.';
              cancelProfileBtn.classList.remove('hidden');
              closeProfileBtn.classList.remove('hidden');
              profileModalOverlay.addEventListener('click', hideProfileModal);
            }

            formStatus.classList.add('hidden');
            profileModalOverlay.classList.remove('hidden');
            profileModal.classList.remove('hidden');
            setTimeout(() => {
              const inner = profileModal.querySelector('div.bg-white');
              if (inner) inner.classList.remove('scale-95', 'opacity-0');
            }, 10);
          }

          function hideProfileModal() {
            const inner = profileModal.querySelector('div.bg-white');
            if (inner) inner.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
              profileModalOverlay.classList.add('hidden');
              profileModal.classList.add('hidden');
              if (inner) inner.classList.remove('scale-95', 'opacity-0');
            }, 300);
          }

          avatarButton.addEventListener('click', () => showProfileModal(false));
          cancelProfileBtn.addEventListener('click', hideProfileModal);
          closeProfileBtn.addEventListener('click', hideProfileModal);

          // --- INICIO: LÓGICA DE VALIDACIÓN ---
          function validateRut(rut) {
            rut = rut.replace(/\./g, '').replace(/-/g, '').trim().toLowerCase();
            const rutBody = rut.slice(0, -1);
            let dv = rut.slice(-1);
            if (!/^[0-9]+[0-9kK]{1}$/.test(rut)) return false;
            let sum = 0;
            let multiple = 2;
            for (let i = rutBody.length - 1; i >= 0; i--) {
              sum += rutBody.charAt(i) * multiple;
              if (multiple < 7) multiple++;
              else multiple = 2;
            }
            const calculatedDv = 11 - (sum % 11);
            const expectedDv = (calculatedDv === 11) ? '0' : (calculatedDv === 10) ? 'k' : calculatedDv.toString();
            return dv === expectedDv;
          }

          function setFieldState(field, state, message = '') {
            const inputEl = document.getElementById(`profile-${field}-input`) || document.getElementById(`profile-${field}-select`);
            const errorEl = document.getElementById(`${field}-error`);
            const iconEl = document.getElementById(`${field}-status-icon`);

            if (!inputEl) return;

            inputEl.classList.remove('form-input-error', 'form-input-success');
            if (errorEl) errorEl.textContent = '';
            if (iconEl) iconEl.innerHTML = '';

            if (state === 'error') {
              inputEl.classList.add('form-input-error');
              if (errorEl) errorEl.textContent = message;
              if (iconEl) iconEl.innerHTML = `<i data-lucide="alert-circle" class="h-5 w-5 text-red-500"></i>`;
            } else if (state === 'success') {
              inputEl.classList.add('form-input-success');
              if (iconEl) iconEl.innerHTML = `<i data-lucide="check-circle" class="h-5 w-5 text-green-500"></i>`;
            }

            if (iconEl && iconEl.innerHTML) {
              lucide.createIcons({ nodes: [iconEl.querySelector('i')] });
            }
          }

          function validateName() {
            if (profileNameInput.value.trim().length < 3 || !profileNameInput.value.includes(' ')) {
              setFieldState('name', 'error', 'Ingresa tu nombre y apellido completo.');
              return false;
            }
            setFieldState('name', 'success');
            return true;
          }

          function validateCountry() {
            if (profileCountrySelect.value === '') {
              setFieldState('country', 'error', 'Selecciona tu país de residencia.');
              return false;
            }
            setFieldState('country', 'success');
            return true;
          }

          function validateRutField() {
            if (profileCountrySelect.value === 'CL') {
              if (!validateRut(profileRutInput.value)) {
                setFieldState('rut', 'error', 'El RUT ingresado no es válido.');
                return false;
              }
              setFieldState('rut', 'success');
            } else {
              setFieldState('rut', 'neutral');
            }
            return true;
          }

          function checkAllFieldsAndToggleButtonState() {
            const isNameValid = validateName();
            const isCountryValid = validateCountry();
            const isRutValid = validateRutField();
            const isFormValid = isNameValid && isCountryValid && (profileCountrySelect.value !== 'CL' || isRutValid);
            saveBtn.disabled = !isFormValid;
          }

          profileNameInput.addEventListener('input', checkAllFieldsAndToggleButtonState);
          profileRutInput.addEventListener('input', checkAllFieldsAndToggleButtonState);
          profileCountrySelect.addEventListener('change', checkAllFieldsAndToggleButtonState);

          profileForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            checkAllFieldsAndToggleButtonState();
            if (saveBtn.disabled) {
              formStatus.className = 'text-center p-3 rounded-lg bg-yellow-100 text-yellow-700';
              formStatus.textContent = 'Por favor, corrige los campos marcados en rojo.';
              formStatus.classList.remove('hidden');
              return;
            }

            saveBtn.disabled = true;
            saveBtnText.textContent = 'Guardando...';
            saveSpinner.classList.remove('hidden');
            formStatus.classList.add('hidden');

            const user = auth.currentUser;
            const newName = profileNameInput.value.trim();
            const userDocRef = db.collection('users').doc(user.uid);

            try {
              if (newName !== user.displayName) {
                await user.updateProfile({ displayName: newName });
              }
              await userDocRef.set({
                displayName: newName,
                email: user.email,
                rut: profileRutInput.value.trim(),
                jobTitle: profileJobInput.value.trim(),
                country: profileCountrySelect.value,
                gender: profileGenderSelect.value,
                birthdate: profileBirthdateInput.value,
                profileCompleted: true
              }, { merge: true });

              document.querySelectorAll('#user-name, #welcome-name').forEach(el => el && (el.textContent = newName));
              formStatus.className = 'text-center p-3 rounded-lg bg-green-100 text-green-700';
              formStatus.textContent = '¡Perfil actualizado con éxito!';
              formStatus.classList.remove('hidden');

              setTimeout(() => {
                hideProfileModal();
                listenForCourseProgress(user.uid);
              }, 1500);

            } catch (error) {
              console.error("Error al guardar perfil:", error);
              formStatus.className = 'text-center p-3 rounded-lg bg-red-100 text-red-700';
              formStatus.textContent = 'Hubo un error al guardar. Inténtalo de nuevo.';
              formStatus.classList.remove('hidden');
            } finally {
              saveBtnText.textContent = 'Guardar Cambios';
              saveSpinner.classList.add('hidden');
            }
          });
          // --- FIN: LÓGICA DE VALIDACIÓN ---

          function updateCardForEnrolledUser(card, progress, courseId) {
            const tagEl = card.querySelector('.tag');
            const percentEl = card.querySelector('.percent');
            const fillEl = card.querySelector('.fill');
            const footerEl = card.querySelector('.card-footer');
            const progressContainer = card.querySelector('.progress-container');
            const actionBtn = card.querySelector('.course-action-btn');

            progressContainer.classList.remove('hidden');
            percentEl.textContent = `${progress}%`;
            fillEl.style.width = `${progress}%`;

            const courseUrl = `campus-curso-ia.html?course=${courseId}`;

            actionBtn.href = courseUrl;
            actionBtn.classList.remove('cursor-wait', 'bg-gray-400', 'bg-slate-400');
            actionBtn.classList.add('bg-teal-500', 'hover:bg-teal-600');

            if (progress >= 100) {
              tagEl.textContent = 'Completado';
              tagEl.className = 'tag inline-block text-xs font-semibold uppercase tracking-wider text-green-600 bg-green-100 px-2 py-1 rounded-full';
              fillEl.style.backgroundColor = 'var(--brand-green)';
              footerEl.innerHTML = `<div class="space-y-3"><a href="portal-certificacion.html" class="flex items-center justify-center gap-2 w-full text-center bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-5 rounded-lg transition-colors"><i data-lucide="award" class="h-5 w-5"></i><span>Ver Certificado</span></a><a href="${courseUrl}" class="block text-sm text-gray-500 hover:text-teal-600 font-semibold transition-colors text-center">Repasar Curso</a></div>`;
            } else {
              tagEl.textContent = 'En progreso';
              tagEl.className = 'tag inline-block text-xs font-semibold uppercase tracking-wider text-teal-600 bg-teal-100 px-2 py-1 rounded-full';
              fillEl.style.backgroundColor = 'var(--brand-teal)';
              actionBtn.textContent = 'Continuar aprendiendo';
            }
            lucide.createIcons();
          }

          function updateCardForUnenrolledUser(card) {
            const tagEl = card.querySelector('.tag');
            const actionBtn = card.querySelector('.course-action-btn');
            const courseId = card.dataset.courseId;

            tagEl.textContent = 'Requiere Inscripción';
            tagEl.className = 'tag inline-block text-xs font-semibold uppercase tracking-wider text-yellow-700 bg-yellow-100 px-2 py-1 rounded-full';
            actionBtn.textContent = 'Inscríbete para Activar';
            actionBtn.href = "#";
            actionBtn.classList.remove('cursor-wait', 'bg-gray-400');
            actionBtn.classList.add('bg-slate-400', 'hover:bg-slate-500');

            const newBtn = actionBtn.cloneNode(true);
            actionBtn.parentNode.replaceChild(newBtn, actionBtn);

            newBtn.addEventListener('click', async (e) => {
              e.preventDefault();
              // Llamar al modal de cupón en lugar de ir directo al pago
              showCouponModal();
            });
          }

          function listenForCourseProgress(userId) {
            const courseId = ESSENTIAL_COURSE_ID;
            let courseCard = document.querySelector(`[data-course-id="${courseId}"]`);

            if (!courseCard) return;

            const user = auth.currentUser;
            if (!user || !user.email) {
              updateCardForUnenrolledUser(courseCard);
              return;
            }

            const allowlistRef = db.collection('allowlist').doc(user.email);
            const userRef = db.collection('users').doc(userId);
            const progressRef = db.collection('userProgress').doc(userId);

            Promise.all([allowlistRef.get(), userRef.get()]).then(([allowlistDoc, userDoc]) => {
              let isWhitelisted = false;
              if (allowlistDoc.exists) {
                const data = allowlistDoc.data();
                const allowedCourses = data.courses || [];

                let hasAllowedCourse = allowedCourses.includes(courseId);
                if (courseId === 'ia-aplicada-esencial' && !hasAllowedCourse) {
                  hasAllowedCourse = allowedCourses.includes('programa-esencial');
                }

                if (data.active === true && hasAllowedCourse) {
                  isWhitelisted = true;
                }
              }

              let isEnrolled = false;
              if (userDoc.exists) {
                const userData = userDoc.data();
                const oldEssentialCourseId = 'inteligencia-aplicada';
                if (userData.enrollments && (userData.enrollments[courseId] === true || userData.enrollments[oldEssentialCourseId] === true)) {
                  isEnrolled = true;
                }
              }

              const hasAccess = isWhitelisted || isEnrolled;

              if (hasAccess) {
                // Lógica de progreso del curso
                progressRef.onSnapshot(doc => {
                  let completedCount = 0;
                  if (doc.exists) {
                    const data = doc.data();
                    const courseProgress = data[courseId];
                    if (courseProgress && Array.isArray(courseProgress.completedLessons)) {
                      completedCount = new Set(courseProgress.completedLessons).size;
                    }
                  }

                  const courseConfig = COURSE_CONFIG[courseId];
                  const totalLessons = courseConfig ? courseConfig.totalLessons : 0;
                  const percentage = totalLessons > 0 ? Math.min(Math.round((completedCount / totalLessons) * 100), 100) : 0;
                  updateCardForEnrolledUser(courseCard, percentage, courseId);
                });
              } else {
                updateCardForUnenrolledUser(courseCard);
              }
            }).catch(error => {
              console.error(`Error verificando acceso:`, error);
              updateCardForUnenrolledUser(courseCard);
            });
          }

          async function setupDynamicButton(user, buttonId, collectionName, buttonStates) {
            const btn = document.getElementById(buttonId);
            if (!btn) return;

            const btnText = document.getElementById(`${buttonId}-text`);
            const btnSpinner = document.getElementById(`${buttonId}-spinner`);

            const docRef = db.collection(collectionName).doc(user.uid);
            try {
              const doc = await docRef.get();
              if (doc.exists) {
                btnText.textContent = buttonStates.alreadyIn;
                btn.disabled = true;
                btn.classList.add('bg-gray-400', 'cursor-not-allowed');
                btn.classList.remove(buttonStates.defaultColor, buttonStates.hoverColor);
                return;
              }
            } catch (e) { console.error(e); }

            btn.addEventListener('click', async () => {
              btn.disabled = true;
              btnText.textContent = buttonStates.adding;
              btnSpinner.classList.remove('hidden');

              try {
                const userName = user.displayName || 'Alumno sin nombre';
                await docRef.set({
                  email: user.email,
                  displayName: userName,
                  uid: user.uid,
                  timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                btnText.textContent = buttonStates.success;
                btn.classList.remove(buttonStates.defaultColor, buttonStates.hoverColor);
                btn.classList.add(buttonStates.successColor);

              } catch (error) {
                btnText.textContent = buttonStates.error;
                btn.classList.remove(buttonStates.defaultColor, buttonStates.hoverColor);
                btn.classList.add(buttonStates.errorColor);
                setTimeout(() => {
                  btn.disabled = false;
                  btnText.textContent = buttonStates.default;
                  btn.classList.remove(buttonStates.errorColor);
                  btn.classList.add(buttonStates.defaultColor, buttonStates.hoverColor);
                }, 3000);
              } finally {
                btnSpinner.classList.add('hidden');
              }
            });
          }

          auth.onAuthStateChanged(user => {
            if (user) {
              db.collection('users').doc(user.uid).get().then(doc => {
                const userData = doc.exists ? doc.data() : {};
                const name = userData.displayName || user.displayName || 'Alumno';
                document.querySelectorAll('#user-name, #welcome-name').forEach(el => el && (el.textContent = name));
              });

              document.getElementById('user-avatar').src = user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.displayName || 'A')}&background=14b8a6&color=fff`;
              document.getElementById('user-profile').classList.remove('hidden');

              document.getElementById('logout-btn').addEventListener('click', e => {
                e.preventDefault();
                auth.signOut().then(() => window.location.href = 'index.html');
              });

              async function initializeUserSession(user) {
                try {
                  const userDoc = await db.collection('users').doc(user.uid).get();
                  const isProfileComplete = userDoc.exists && userDoc.data().profileCompleted === true;

                  if (!isProfileComplete) {
                    showProfileModal(true);
                  } else {
                    listenForCourseProgress(user.uid);
                  }
                } catch (error) {
                  console.error("Error verificando el estado del perfil:", error);
                  showProfileModal(true);
                }
              }

              initializeUserSession(user);

              setupDynamicButton(user, 'waitlist-btn', 'waitingList_avanzado', {
                default: 'Unirme a la lista de espera',
                alreadyIn: '¡Ya estás en la lista!',
                adding: 'Agregando...',
                success: '¡Inscrito con éxito!',
                error: 'Error, intenta de nuevo',
                defaultColor: 'bg-blue-600',
                hoverColor: 'hover:bg-blue-700',
                successColor: 'bg-green-500',
                errorColor: 'bg-red-500'
              });

              setupDynamicButton(user, 'reserve-btn', 'preferentialReservations', {
                default: 'Reservar cupo preferente',
                alreadyIn: '¡Ya tienes tu cupo!',
                adding: 'Reservando...',
                success: '¡Cupo reservado!',
                error: 'Error, intenta de nuevo',
                defaultColor: 'bg-indigo-600',
                hoverColor: 'hover:bg-indigo-700',
                successColor: 'bg-green-500',
                errorColor: 'bg-red-500'
              });

            } else {
              window.location.href = 'acceso.html';
            }
          });

          // ================================================
          // FUNCIÓN DESCARGA PDF - 100 PROMPTS MAESTROS
          // ================================================
          // ================================================
          // FUNCIÓN DESCARGA PDF - 100 PROMPTS MAESTROS
          // ================================================
          window.downloadPromptsPDF = async function () {
            try {
              const user = auth.currentUser;
              if (!user || typeof casesData === 'undefined') {
                if (!user) {
                  window.location.href = 'acceso.html';
                }
                return;
              }


              const { jsPDF } = window.jspdf;
              const doc = new jsPDF();
              const pw = doc.internal.pageSize.getWidth(), ph = doc.internal.pageSize.getHeight(), m = 20, mw = pw - 40;
              const teal = [20, 184, 166], yellow = [251, 191, 36], dark = [30, 41, 59], light = [148, 163, 184];

              // PORTADA
              doc.setFillColor(...teal); doc.rect(0, 0, pw, 80, 'F');

              // Logo Aula GenIA (más grande)
              try {
                const logoImg = new Image();
                logoImg.src = 'https://aulagenia.cl/Logo_AGIA.png';
                logoImg.crossOrigin = 'Anonymous';
                await new Promise((resolve, reject) => {
                  logoImg.onload = resolve;
                  logoImg.onerror = reject;
                });
                // Add logo centered at top - tamaño aumentado 50x50
                doc.addImage(logoImg, 'PNG', pw / 2 - 25, 8, 50, 50);
              } catch (e) {
                console.warn('No se pudo cargar el logo, continuando sin él:', e);
              }

              doc.setTextColor(255, 255, 255); doc.setFontSize(32); doc.setFont('helvetica', 'bold');
              doc.text('Maestro Prompts', pw / 2, 70, { align: 'center' });
              doc.setFontSize(16); doc.setFont('helvetica', 'normal');
              doc.text('100 Prompts Optimizados AGIA', pw / 2, 85, { align: 'center' });
              doc.setFillColor(...yellow); doc.roundedRect(pw / 2 - 35, 93, 70, 12, 3, 3, 'F');
              doc.setTextColor(...dark); doc.setFontSize(10); doc.setFont('helvetica', 'bold');
              doc.text('EXCLUSIVE PREMIUM', pw / 2, 101, { align: 'center' });
              doc.setTextColor(...dark); doc.setFontSize(24); doc.setFont('helvetica', 'bold');
              doc.text('Aula GenIA', pw / 2, 125, { align: 'center' });
              doc.setFontSize(11); doc.setFont('helvetica', 'normal'); doc.setTextColor(...light);
              const uname = user.displayName || user.email.split('@')[0];
              doc.text(`Generado para: ${uname}`, pw / 2, 138, { align: 'center' });
              doc.text(`Email: ${user.email}`, pw / 2, 148, { align: 'center' });
              doc.text(`Fecha de descarga: ${new Date().toLocaleDateString('es-CL', { year: 'numeric', month: 'long', day: 'numeric' })}`, pw / 2, 158, { align: 'center' });
              doc.setDrawColor(...teal); doc.setLineWidth(1); doc.line(pw / 2 - 40, 168, pw / 2 + 40, 168);
              doc.setFontSize(10); doc.setTextColor(100, 100, 100); doc.setFont('helvetica', 'normal');
              doc.text(doc.splitTextToSize('Esta colección contiene 100 prompts optimizados con la metodología AGIA. Cada prompt diseñado para maximizar respuestas de ChatGPT, Claude, Gemini.', mw - 20), m + 10, 178);

              // Disclaimer legal profesional
              doc.setFontSize(7); doc.setTextColor(120, 120, 120); doc.setFont('helvetica', 'italic');
              const disclaimer = doc.splitTextToSize('Los prompts incluidos son herramientas de apoyo. Las respuestas generadas por modelos de IA pueden contener inexactitudes. Se recomienda validar toda información crítica con fuentes confiables y supervisión profesional cuando corresponda.', mw - 30);
              doc.text(disclaimer, pw / 2, ph - 25, { align: 'center', maxWidth: mw - 30 });

              doc.setFontSize(9); doc.setTextColor(...light);
              doc.text('aulagenia.cl | Todos los derechos reservados', pw / 2, ph - 10, { align: 'center' });

              // ÍNDICE
              doc.addPage(); let cy = m;
              doc.setFillColor(245, 247, 250); doc.rect(0, 0, pw, 25, 'F');
              doc.setTextColor(...dark); doc.setFontSize(18); doc.setFont('helvetica', 'bold');
              doc.text('Indice de Contenidos', m, 18); cy = 35;
              const cats = {}; casesData.forEach(p => { if (!cats[p.category]) cats[p.category] = []; cats[p.category].push(p); });
              doc.setFontSize(10); doc.setFont('helvetica', 'normal');
              Object.keys(cats).forEach((cat, idx) => {
                if (cy > ph - 30) { doc.addPage(); cy = m; }
                doc.setTextColor(...teal); doc.setFont('helvetica', 'bold');
                doc.text(`${idx + 1}. ${cat}`, m, cy); cy += 6;
                doc.setTextColor(80, 80, 80); doc.setFont('helvetica', 'normal');
                cats[cat].forEach((p, idx) => {
                  if (cy > ph - 20) { doc.addPage(); cy = m; }
                  const promptNum = casesData.findIndex(prompt => prompt.id === p.id) + 1;
                  doc.text(`   - Prompt #${promptNum}: ${p.title}`, m + 5, cy); cy += 5;
                });
                cy += 3;
              });

              // PROMPTS
              for (let i = 0; i < casesData.length; i++) {
                const p = casesData[i]; doc.addPage(); cy = m;
                doc.setFillColor(...teal); doc.rect(0, 0, pw, 15, 'F');
                doc.setFontSize(10); doc.setTextColor(255, 255, 255); doc.setFont('helvetica', 'bold');
                doc.text(`PROMPT #${i + 1}`, m, 10);
                doc.text(`${i + 1}/${casesData.length}`, pw - m, 10, { align: 'right' }); cy = 25;
                doc.setFontSize(16); doc.setFont('helvetica', 'bold'); doc.setTextColor(...dark);
                const tl = doc.splitTextToSize(p.title, mw); doc.text(tl, m, cy); cy += tl.length * 7 + 3;
                doc.setFillColor(250, 250, 250); doc.roundedRect(m, cy, 60, 8, 2, 2, 'F');
                doc.setFontSize(8); doc.setTextColor(...teal); doc.setFont('helvetica', 'bold');
                doc.text(p.category, m + 2, cy + 5.5);
                const ts = p.metadata?.score ? `${Math.round(p.metadata.score / 5)} min` : '15 min';
                doc.setFillColor(255, 250, 230); doc.roundedRect(m + 65, cy, 30, 8, 2, 2, 'F');
                doc.setTextColor(180, 140, 0); doc.text(`${ts}`, m + 67, cy + 5.5); cy += 13;
                if (p.problem) {
                  doc.setFontSize(9); doc.setFont('helvetica', 'italic'); doc.setTextColor(100, 100, 100);
                  const pl = doc.splitTextToSize(p.problem, mw); doc.text(pl, m, cy); cy += pl.length * 4 + 6;
                }
                doc.setDrawColor(220, 220, 220); doc.setLineWidth(0.5); doc.line(m, cy, pw - m, cy); cy += 8;

                // ROL - Agregar antes del prompt optimizado
                doc.setFillColor(245, 245, 250); doc.roundedRect(m, cy, mw, 8, 2, 2, 'F');
                doc.setFontSize(9); doc.setTextColor(100, 100, 150); doc.setFont('helvetica', 'bold');
                doc.text('ROL', m + 3, cy + 5.5); cy += 12;
                const rolText = p.agiaPromptTagged.split('\n')[0].replace(/^(Eres|Actuas como|Tu rol es)/i, '').trim();
                doc.setFontSize(8.5); doc.setFont('helvetica', 'normal'); doc.setTextColor(60, 60, 60);
                const rolLines = doc.splitTextToSize(rolText, mw);
                for (let ri = 0; ri < Math.min(rolLines.length, 3); ri++) {
                  doc.text(rolLines[ri], m, cy); cy += 3.5;
                }
                cy += 5;

                doc.setFillColor(232, 245, 233); doc.roundedRect(m, cy, mw, 8, 2, 2, 'F');
                doc.setFontSize(9); doc.setTextColor(0, 128, 0); doc.setFont('helvetica', 'bold');
                doc.text('PROMPT OPTIMIZADO (METODOLOGIA AGIA)', m + 3, cy + 5.5); cy += 12;
                const clean = p.agiaPromptTagged.replace(/\*\*/g, '').replace(/[\u{1F300}-\u{1F9FF}]/gu, '').replace(/[📎📌✅⚡🔴🟡🟢❌⏱🚀]/g, '').replace(/\\n/g, '\n').trim();
                doc.setFontSize(8.5); doc.setFont('helvetica', 'normal'); doc.setTextColor(40, 40, 40);
                const promptLines = doc.splitTextToSize(clean, mw);
                for (let li = 0; li < promptLines.length; li++) {
                  if (cy > ph - 25) {
                    doc.setFontSize(8); doc.setTextColor(...light);
                    doc.text('aulagenia.cl', pw / 2, ph - 10, { align: 'center' });
                    doc.addPage(); cy = m + 10;
                    doc.setFillColor(250, 250, 250); doc.rect(0, 0, pw, 8, 'F');
                    doc.setFontSize(8); doc.setTextColor(100, 100, 100); doc.setFont('helvetica', 'italic');
                    doc.text(`Prompt #${i + 1} (continuacion)`, m, 6);
                  }
                  doc.text(promptLines[li], m, cy); cy += 3.5;
                }

                // METADATOS: Modelo Ideal, Estrategia, Validación
                cy += 8;
                if (cy > ph - 60) { doc.addPage(); cy = m; }

                // Separador
                doc.setDrawColor(220, 220, 220); doc.setLineWidth(0.5); doc.line(m, cy, pw - m, cy); cy += 8;

                // Modelo Ideal
                if (p.suggestedAI) {
                  doc.setFillColor(239, 246, 255); doc.roundedRect(m, cy, mw, 10, 2, 2, 'F');
                  doc.setFontSize(8); doc.setTextColor(37, 99, 235); doc.setFont('helvetica', 'bold');
                  doc.text('\u2022 MODELO IDEAL', m + 3, cy + 4);
                  doc.setFontSize(8); doc.setFont('helvetica', 'normal'); doc.setTextColor(40, 40, 40);
                  doc.text(p.suggestedAI, m + 3, cy + 8);
                  cy += 12;
                }

                // Estrategia
                if (p.metadata?.technique || p.exampleTip) {
                  doc.setFillColor(255, 251, 235); doc.roundedRect(m, cy, mw, 10, 2, 2, 'F');
                  doc.setFontSize(8); doc.setTextColor(217, 119, 6); doc.setFont('helvetica', 'bold');
                  doc.text('\u2022 ESTRATEGIA', m + 3, cy + 4);
                  doc.setFontSize(8); doc.setFont('helvetica', 'normal'); doc.setTextColor(40, 40, 40);
                  const strategy = p.metadata?.technique || p.exampleTip || '';
                  const strategyLines = doc.splitTextToSize(strategy, mw - 6);
                  doc.text(strategyLines, m + 3, cy + 8);
                  cy += Math.max(12, 6 + strategyLines.length * 3);
                }

                // Validación
                if (p.validationTip) {
                  doc.setFillColor(240, 253, 244); doc.roundedRect(m, cy, mw, 10, 2, 2, 'F');
                  doc.setFontSize(8); doc.setTextColor(22, 163, 74); doc.setFont('helvetica', 'bold');
                  doc.text('\u2022 VALIDACION', m + 3, cy + 4);
                  doc.setFontSize(8); doc.setFont('helvetica', 'normal'); doc.setTextColor(40, 40, 40);
                  const validationLines = doc.splitTextToSize(p.validationTip, mw - 6);
                  doc.text(validationLines, m + 3, cy + 8);
                  cy += Math.max(12, 6 + validationLines.length * 3);
                }

                doc.setFontSize(8); doc.setTextColor(...light);
                doc.text('aulagenia.cl', pw / 2, ph - 10, { align: 'center' });
              }

              // FINAL
              doc.addPage();
              doc.setFillColor(...teal); doc.rect(0, 0, pw, ph, 'F');
              doc.setTextColor(255, 255, 255); doc.setFontSize(28); doc.setFont('helvetica', 'bold');
              doc.text('Gracias!', pw / 2, 80, { align: 'center' });
              doc.setFontSize(12); doc.setFont('helvetica', 'normal');
              doc.text(doc.splitTextToSize('Esperamos que estos 100 prompts optimizados te ayuden a aprovechar al máximo la inteligencia artificial.', mw - 40), pw / 2, 100, { align: 'center' });
              doc.setFontSize(14); doc.setFont('helvetica', 'bold');
              doc.text('Necesitas ayuda?', pw / 2, 130, { align: 'center' });
              doc.setFontSize(11); doc.setFont('helvetica', 'normal');
              doc.text('Contactanos en: contacto@aulagenia.cl', pw / 2, 145, { align: 'center' });
              doc.text('Visitanos en: aulagenia.cl', pw / 2, 155, { align: 'center' });

              doc.save(`Maestro_Prompts_100_AGIA_${new Date().toISOString().split('T')[0]}.pdf`);
              console.log('PDF descargado exitosamente');
            } catch (e) { console.error('Error PDF:', e); }
          }

          // DESCARGA AUTOMÁTICA AL INSCRIBIRSE
          auth.onAuthStateChanged(async (user) => {
            if (user) {
              const userRef = db.collection('users').doc(user.uid);
              const userDoc = await userRef.get();
              if (userDoc.exists) {
                const userData = userDoc.data();
                const isEnrolled = userData.enrollments &&
                  (userData.enrollments['ia-aplicada-esencial'] === true ||
                    userData.enrollments['inteligencia-aplicada'] === true);

                // Descargar PDF solo UNA VEZ después de inscribirse
                const downloaded = localStorage.getItem('pdfDownloaded');
                if (isEnrolled && !downloaded && typeof casesData !== 'undefined') {
                  setTimeout(() => {
                    downloadPromptsPDF();
                    localStorage.setItem('pdfDownloaded', 'true');
                  }, 2000);
                }
              }
            }
          });

          lucide.createIcons();
        });
      </script>
</body>

</html>