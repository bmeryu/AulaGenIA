<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AGIA Generator 3.0 | B√≥veda Maestra (High Ticket UX)</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Crypto JS Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <!-- Confetti Library -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <!-- FIREBASE SDKs (v8 compat for consistency with access page) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <!-- Google Fonts -->
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0">
    <link
        href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">

    <style>
        :root {
            --primary: #4f46e5;
            --bg-canvas: #f8fafc;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-canvas);
            color: #1e293b;
            -webkit-font-smoothing: antialiased;
        }

        .font-mono {
            font-family: 'JetBrains Mono', monospace;
        }

        .custom-scroll::-webkit-scrollbar {
            width: 5px;
            height: 5px;
        }

        .custom-scroll::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        .custom-scroll::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px) scale(0.99);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .fade-in {
            animation: fadeIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        /* Interactive Legend Effects */
        .hl-tag {
            display: inline-flex;
            align-items: center;
            padding: 1px 6px;
            border-radius: 4px;
            margin: 0 2px;
            font-weight: 700;
            font-size: 0.9em;
            cursor: default;
            border: 1px solid transparent;
            transition: all 0.2s ease;
        }

        .hl-rol {
            color: #1e40af;
            background: #eff6ff;
            border-color: #dbeafe;
        }

        .hl-contexto {
            color: #065f46;
            background: #ecfdf5;
            border-color: #d1fae5;
        }

        .hl-meta {
            color: #854d0e;
            background: #fffbeb;
            border-color: #fef3c7;
        }

        .hl-restricciones {
            color: #991b1b;
            background: #fef2f2;
            border-color: #fee2e2;
        }

        .hl-formato {
            color: #6b21a8;
            background: #faf5ff;
            border-color: #f3e8ff;
        }

        /* Dimming effect for non-hovered items */
        .dimmed {
            opacity: 0.3;
            filter: grayscale(0.5);
        }

        .highlighted {
            transform: scale(1.05);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            z-index: 10;
            position: relative;
        }

        .var-highlight {
            background-color: #e0f2fe;
            border-bottom: 2px solid #0284c7;
            color: #0c4a6e;
            font-weight: 700;
            padding: 0 4px;
            border-radius: 4px;
        }

        .var-highlight-bad {
            background-color: #f1f5f9;
            border-bottom: 2px dotted #94a3b8;
            color: #64748b;
            font-weight: 600;
            padding: 0 2px;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        /* Blur Content Logic */
        .blur-prompt {
            filter: blur(8px);
            user-select: none;
            pointer-events: none;
            opacity: 0.5;
            transition: all 0.5s ease;
        }

        /* Magic Switch Animation */
        .switch-toggle {
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        /* Attention Animation for Magic Switch */
        @keyframes subtle-bounce {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(3px);
            }
        }

        .motivate-click {
            animation: subtle-bounce 2s infinite;
        }

        @keyframes pulse-ring {
            0% {
                box-shadow: 0 0 0 0 rgba(79, 70, 229, 0.4);
            }

            70% {
                box-shadow: 0 0 0 6px rgba(79, 70, 229, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(79, 70, 229, 0);
            }
        }

        .pulse-attention {
            animation: pulse-ring 2s infinite;
        }

        /* Search Glow Animation */
        .search-container:focus-within {
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1);
            border-color: #818cf8;
        }
    </style>
</head>

<body class="h-screen flex flex-col overflow-hidden text-slate-800 bg-slate-50">

    <!-- NAVBAR from index.html -->
    <header class="bg-white/80 backdrop-blur-lg sticky top-0 z-[60] shadow-sm">
        <nav class="container mx-auto px-6 py-3 flex justify-between items-center">
            <a href="index.html" class="flex items-center" aria-label="P√°gina de inicio de Aula GenIA">
                <img src="https://aulagenia.cl/Logo_AGIA_big.png" alt="Logo de Aula GenIA" class="h-20 w-auto">
            </a>
            <div class="flex items-center gap-2 sm:gap-4">
                <a href="quienes-somos.html"
                    class="text-gray-700 font-semibold border-2 border-gray-300 rounded-full px-3 text-xs py-2 sm:px-5 sm:text-sm hover:bg-gray-100 hover:border-gray-400 transition-colors duration-300 hidden lg:flex items-center">
                    Qui√©nes Somos
                </a>
                <a href="cursos.html"
                    class="text-teal-600 font-semibold border-2 border-teal-500 rounded-full px-3 text-xs py-2 sm:px-5 sm:text-sm hover:bg-teal-500 hover:text-white transition-colors duration-300 hidden md:flex items-center">
                    Ver Cursos
                </a>
                <a href="acceso.html"
                    class="cta-button bg-gray-900 text-white font-bold rounded-full hover:bg-gray-700 px-4 py-1.5 sm:px-6 sm:py-2 flex flex-col items-center justify-center">
                    <span class="text-sm sm:text-base leading-tight">üîì Acceso</span>
                    <span class="text-[9px] sm:text-[10px] font-normal opacity-75 leading-tight">Inicia tu viaje</span>
                </a>
            </div>
        </nav>
    </header>

    <!-- LOADING OVERLAY -->
    <div id="system-status-overlay"
        class="fixed inset-0 z-[100] bg-white/90 backdrop-blur-xl flex flex-col items-center justify-center p-6 text-center transition-opacity duration-500">
        <div
            class="bg-white p-8 rounded-[2rem] shadow-2xl shadow-slate-200 border border-slate-100 max-w-md w-full animate-in zoom-in duration-300">
            <div id="status-icon"
                class="w-12 h-12 bg-white border border-slate-100 text-indigo-600 rounded-xl flex items-center justify-center mx-auto mb-4 shadow-sm">
                <span class="material-symbols-rounded text-2xl animate-spin">sync</span>
            </div>
            <h2 id="status-title" class="text-lg font-extrabold text-slate-900 mb-1">Conectando B√≥veda...</h2>
            <p id="status-desc" class="text-xs text-slate-500 mb-6">Sincronizando recursos de inteligencia.</p>
            <div
                class="bg-slate-50 p-3 rounded-lg text-left text-[10px] font-mono text-slate-500 overflow-hidden border border-slate-100">
                <p>> System: <span class="text-indigo-600 font-semibold">Secure Vault Connected</span></p>
                <p>> Status: <span id="status-code" class="text-slate-600 font-bold">FETCHING...</span></p>
            </div>
            <button id="retry-btn" onclick="window.location.reload()"
                class="hidden w-full mt-4 py-2 bg-slate-900 text-white rounded-lg font-bold text-xs">Reintentar</button>
        </div>
    </div>

    <!-- HEADER -->
    <header class="bg-white border-b border-slate-200 z-30 flex-none h-14">
        <div class="h-full px-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div>
                    <h1 class="text-sm font-extrabold text-slate-900 leading-none">AGIA Generator <span
                            class="text-indigo-600">3.0</span></h1>
                    <p class="text-[9px] text-slate-400 font-bold tracking-widest uppercase">Powered by Aula GenIA</p>
                </div>
            </div>

            <div class="hidden md:flex flex-1 mx-6 space-x-1 overflow-x-auto no-scrollbar mask-gradient-r"
                id="category-nav"></div>

            <div class="flex gap-2 items-center">
                <!-- Global Lock Simulator (Test Mode) -->

                <button onclick="window.print()"
                    class="p-2 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-all"
                    title="Imprimir / Guardar PDF">
                    <span class="material-symbols-rounded">print</span>
                </button>
                <button onclick="triggerUnlockPayment()"
                    class="bg-slate-900 hover:bg-slate-800 text-white px-3 py-1.5 rounded-lg text-xs font-bold shadow-md flex items-center gap-1.5 transition-transform hover:-translate-y-0.5">
                    <span class="material-symbols-rounded text-sm text-yellow-400">lock_open</span>
                    <span class="hidden sm:inline">Desbloquear</span>
                </button>
            </div>
        </div>
    </header>

    <!-- TOP BANNER PROMO (Horizontal Full Width) -->
    <div
        class="bg-gradient-to-r from-teal-900 via-slate-900 to-teal-900 border-b border-teal-500/30 shadow-md relative overflow-hidden flex-none z-40">
        <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-10">
        </div>
        <div class="container mx-auto px-4 py-2 flex items-center justify-between relative z-10">

            <div class="flex items-center gap-3 sm:gap-4 overflow-hidden">
                <div class="flex items-center gap-2 shrink-0">
                    <span
                        class="bg-yellow-400 text-yellow-900 text-[9px] font-black px-1.5 py-0.5 rounded uppercase tracking-wider shadow-sm animate-pulse">Pro</span>
                    <h4 class="text-white font-bold text-xs truncate hidden sm:block">Pide lo que necesitas</h4>
                </div>

                <div class="h-3 w-px bg-white/10 hidden sm:block"></div>

                <p class="text-[10px] sm:text-xs text-teal-100 font-medium truncate">
                    <span class="hidden md:inline">¬øQuieres dominar la ingenier√≠a de prompts y crear herramientas a
                        medida?</span>
                    <span class="md:hidden">Aprende a crear tus propias herramientas AI</span>
                </p>
            </div>

            <a href="landing-nuevo.html"
                class="shrink-0 bg-teal-500 hover:bg-teal-400 text-white text-[10px] uppercase font-bold px-3 py-1.5 sm:px-4 sm:py-1.5 rounded-lg transition-all shadow-lg hover:shadow-teal-500/30 whitespace-nowrap flex items-center gap-1">
                <span>Ver M√©todo</span>
                <span class="material-symbols-rounded text-sm">arrow_forward</span>
            </a>
        </div>
    </div>

    <!-- APP LAYOUT -->
    <div class="flex flex-1 overflow-hidden w-full relative bg-slate-50">

        <!-- SIDEBAR -->
        <aside
            class="w-full md:w-72 lg:w-80 flex flex-col bg-white border-r border-slate-200 z-20 flex-none absolute md:relative h-full transform -translate-x-full md:translate-x-0 transition-transform duration-300"
            id="sidebar">

            <!-- BUSCADOR CORREGIDO (Limpio y Elegante) -->
            <div class="px-5 pt-5 pb-3 border-b border-slate-100">
                <div class="relative group">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <span class="material-symbols-rounded text-indigo-500 text-xl">search</span>
                    </div>
                    <input type="text" id="searchInput"
                        class="w-full pl-10 pr-4 py-3 bg-white border-2 border-slate-100 rounded-xl text-sm font-medium focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/10 outline-none transition-all placeholder:text-slate-400 text-slate-700 shadow-sm search-container"
                        placeholder="¬øQu√© desaf√≠o tienes hoy?" onkeyup="filterCases()">
                </div>
                <!-- Search Feedback -->
                <div id="search-stats" class="hidden mt-2 px-1 flex justify-between items-center animate-pulse">
                    <span class="text-[10px] uppercase font-bold text-indigo-500 tracking-wider">Buscando...</span>
                    <span class="text-[10px] font-bold text-slate-400" id="results-count"></span>
                </div>
            </div>

            <!-- Case list starts directly after search -->

            <div class="flex-1 overflow-y-auto custom-scroll p-3 space-y-1" id="case-list"></div>
            <div
                class="p-3 border-t border-slate-100 bg-slate-50/50 text-[10px] text-slate-400 flex justify-between px-4 font-medium">
                <span>Estado: Online</span>
                <span>Casos: <span id="total-display" class="text-slate-700 font-bold">0</span></span>
            </div>

        </aside>

        <!-- WORKSPACE -->
        <main class="flex-1 flex flex-col overflow-hidden relative w-full h-full bg-slate-100/50">
            <div id="workspace-empty" class="hidden flex-col items-center justify-center h-full text-center p-8">
                <div
                    class="w-24 h-24 bg-white rounded-full flex items-center justify-center mb-4 shadow-xl text-indigo-200">
                    <span class="material-symbols-rounded text-5xl">compare_arrows</span>
                </div>
                <h3 class="text-lg font-bold text-slate-800">Selecciona un caso</h3>
                <p class="text-xs text-slate-500">Comienza tu comparativa en el men√∫ lateral.</p>
            </div>

            <div id="case-detail" class="flex flex-col h-full w-full p-3 gap-2 overflow-hidden max-w-5xl mx-auto">

                <!-- COMPACT SINGLE-LINE HEADER -->
                <div
                    class="flex-none flex items-center justify-between gap-3 bg-white rounded-xl px-4 py-2 border border-slate-200 shadow-sm">
                    <!-- Left: Category + Title -->
                    <div class="flex items-center gap-3 min-w-0 flex-1">
                        <span id="detail-category-badge"
                            class="flex-none text-[9px] font-bold uppercase tracking-wider px-2 py-0.5 rounded border bg-indigo-50 text-indigo-600 border-indigo-100">CAT</span>
                        <div class="min-w-0">
                            <h2 id="detail-title" class="text-lg font-bold text-slate-900 truncate">T√≠tulo del Caso</h2>
                            <p id="detail-problem" class="text-[11px] text-slate-500 truncate hidden md:block"></p>
                        </div>
                        <!-- AI SUGGESTION (hidden by default) -->
                        <div id="ai-suggestion-badge"
                            class="hidden text-[9px] font-bold uppercase px-2 py-0.5 rounded-full bg-slate-800 text-white items-center gap-1 flex-none">
                            <span class="material-symbols-rounded text-[10px] text-yellow-400">star</span>
                            <span id="ai-name" class="text-yellow-400">CHATGPT</span>
                        </div>
                    </div>

                    <!-- Right: Switch + Badge + Copy (all in one line) -->
                    <div class="flex items-center gap-2 flex-none">
                        <!-- Mode Switch (Compact) -->
                        <div class="relative bg-slate-100 rounded-lg p-0.5 flex items-center">
                            <button onclick="setMode('basic')"
                                class="relative z-10 px-3 py-1.5 text-[10px] font-bold transition-colors duration-200 rounded-md flex items-center gap-1"
                                id="btn-basic">
                                <span class="material-symbols-rounded text-xs">cancel</span> B√°sico
                            </button>
                            <button onclick="setMode('agia')"
                                class="relative z-10 px-3 py-1.5 text-[10px] font-bold transition-colors duration-200 rounded-md flex items-center gap-1"
                                id="btn-agia">
                                <span class="material-symbols-rounded text-xs">verified</span> Maestro
                            </button>
                        </div>

                        <!-- Time Badge -->
                        <span id="benefit-badge"
                            class="text-[9px] font-bold px-2 py-1 rounded-md border flex items-center gap-1 bg-emerald-50 text-emerald-600 border-emerald-100">
                            <span class="material-symbols-rounded text-xs">bolt</span> ~15 min
                        </span>

                        <!-- Copy Button -->
                        <button onclick="copyPrompt()" id="copy-btn"
                            class="text-[10px] font-bold px-3 py-1.5 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white flex items-center gap-1.5 transition-all shadow-sm">
                            <span class="material-symbols-rounded text-sm">content_copy</span> Copiar
                        </button>
                    </div>
                </div>

                <!-- MAIN CONTENT CARD (No extra switch header needed) -->
                <div class="flex-1 bg-white rounded-xl border border-slate-200 shadow-lg flex flex-col overflow-hidden"
                    id="main-card-container">

                    <!-- CONTENT AREA -->
                    <div id="detail-scroll-container" class="flex-1 overflow-y-auto custom-scroll relative bg-white">

                        <!-- BASIC CONTENT -->
                        <div id="content-basic" class="p-6 md:p-8 space-y-6 fade-in">
                            <div class="bg-slate-50 border border-slate-200 rounded-xl p-6 relative overflow-hidden">
                                <div
                                    class="absolute top-0 right-0 bg-red-100 text-red-700 text-[10px] font-bold px-3 py-1 rounded-bl-xl uppercase tracking-wider border-l border-b border-red-200">
                                    ‚ùå Prompt Deficiente</div>
                                <div id="bad-prompt-rendered"
                                    class="font-mono text-sm text-slate-600 italic leading-relaxed"></div>
                            </div>

                            <!-- Resultado del Prompt B√°sico -->
                            <div class="border-l-4 border-amber-300 bg-amber-50/50 p-4 rounded-r-lg">
                                <label
                                    class="text-[10px] font-bold text-amber-600 uppercase mb-2 block tracking-wider flex items-center gap-1">
                                    <span class="material-symbols-rounded text-sm">chat</span> Resultado T√≠pico de la IA
                                </label>
                                <div id="bad-result-preview" class="text-sm text-slate-600 leading-relaxed italic">
                                </div>
                            </div>

                            <!-- Diagn√≥stico del Fallo -->
                            <div class="border-l-4 border-red-300 bg-red-50/50 p-4 rounded-r-lg">
                                <label
                                    class="text-[10px] font-bold text-red-500 uppercase mb-2 block tracking-wider flex items-center gap-1">
                                    <span class="material-symbols-rounded text-sm">bug_report</span> ¬øPor qu√© falla este
                                    prompt?
                                </label>
                                <div id="bad-response-analysis" class="text-sm text-slate-600 leading-relaxed"></div>
                            </div>
                        </div>

                        <!-- AGIA MASTER CONTENT (AULAGENIA COLOR THEME) -->
                        <div id="content-agia" class="hidden p-0 fade-in flex flex-col h-full">

                            <!-- Prompt Box Container -->
                            <div
                                class="relative bg-slate-800 rounded-xl p-4 md:p-6 border border-slate-700 flex-none group/expand">
                                <!-- Prompt Text with Blur Wrapper -->
                                <div id="prompt-blur-wrapper" class="transition-all duration-500 relative">
                                    <div class="flex justify-between items-center mb-4">
                                        <label
                                            class="text-[10px] font-bold text-white/80 uppercase tracking-widest flex items-center gap-1.5">
                                            <span
                                                class="material-symbols-rounded text-sm text-yellow-400">auto_awesome</span>
                                            Prompt Maestro
                                        </label>
                                        <!-- Dynamic Benefit Badge -->
                                        <span id="benefit-badge"
                                            class="text-[10px] font-bold px-2.5 py-1 rounded-md border flex items-center gap-1.5 shadow-sm">
                                            <span class="material-symbols-rounded text-sm">bolt</span> Loading...
                                        </span>
                                    </div>

                                    <!-- INLINE HIGHLIGHTS AGIA PROMPT (Dark theme) -->
                                    <div id="agia-sections-container" class="leading-loose text-[14px] text-white/90">
                                        <!-- Sections will be rendered dynamically by JS -->
                                    </div>

                                    <!-- Hidden original for copy functionality -->
                                    <div id="detail-prompt-rendered" class="hidden"></div>
                                </div>

                                <!-- BLOCKED TEASER OVERLAY (Centered on prompt) -->
                                <div id="locked-teaser"
                                    class="hidden absolute inset-0 z-30 flex flex-col items-center justify-center transition-all duration-500 backdrop-blur-[2px] bg-white/60">
                                    <div
                                        class="bg-white/90 backdrop-blur-xl p-8 rounded-2xl border border-slate-200 shadow-2xl max-w-sm text-center transform hover:scale-[1.02] transition-transform">
                                        <div
                                            class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4 shadow-inner">
                                            <span class="material-symbols-rounded text-3xl text-slate-400">lock</span>
                                        </div>
                                        <h3 class="text-xl font-bold text-slate-800 mb-2">Contenido Protegido</h3>
                                        <p class="text-slate-500 text-sm mb-6 leading-relaxed">
                                            Esta f√≥rmula maestra es exclusiva para miembros de la comunidad AGIA.
                                        </p>

                                        <a href="acceso.html?redirect=maestro-prompts-app.html"
                                            class="inline-flex items-center justify-center w-full gap-2 px-6 py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-xl transition-all shadow-lg hover:shadow-indigo-200">
                                            <span class="material-symbols-rounded text-lg">login</span>
                                            Iniciar Sesi√≥n para Acceder
                                        </a>
                                        <p class="text-[10px] text-slate-400 mt-4">
                                            ¬øYa tienes cuenta? Tu sesi√≥n se detectar√° autom√°ticamente.
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <!-- Footer Actions & Legend -->
                            <div class="p-6 md:p-8 bg-white flex-1 flex flex-col gap-6 pb-24">

                                <!-- Result (MOVED UP FOR BETTER VISIBILITY) -->
                                <div
                                    class="relative bg-white border border-indigo-100 rounded-xl p-5 shadow-[0_2px_15px_rgba(79,70,229,0.05)]">
                                    <div
                                        class="absolute -top-3 left-4 bg-indigo-50 text-indigo-700 text-[10px] font-black uppercase tracking-widest px-3 py-1 rounded-full border border-indigo-100 flex items-center gap-1">
                                        <span class="material-symbols-rounded text-sm">auto_awesome</span> Resultado
                                        Esperado
                                    </div>
                                    <div id="good-result-preview"
                                        class="text-sm text-slate-600 leading-relaxed font-medium mt-2"></div>

                                    <!-- Result Teaser Label if Locked -->
                                    <div id="result-teaser-label"
                                        class="hidden absolute top-3 right-3 bg-yellow-100 text-yellow-800 text-[9px] font-bold px-2 py-0.5 rounded border border-yellow-200 shadow-sm flex items-center gap-1">
                                        <span class="material-symbols-rounded text-[10px]">visibility</span> MUESTRA
                                        GRATIS
                                    </div>
                                </div>

                                <!-- MODELO AGIA INTERACTIVO (LEGEND) -->
                                <div>
                                    <div class="flex items-center justify-between mb-3">
                                        <h4
                                            class="text-[10px] font-black uppercase tracking-widest text-slate-400 flex items-center gap-1.5">
                                            <span
                                                class="material-symbols-rounded text-indigo-500 text-sm">model_training</span>
                                            Modelo AGIA (Hover)
                                        </h4>
                                        <span class="text-[9px] text-slate-300 italic">Pasa el mouse para
                                            aprender</span>
                                    </div>
                                    <div id="interactive-legend" class="flex flex-wrap gap-2 select-none">

                                        <!-- ROL -->
                                        <span
                                            class="legend-item group relative cursor-help text-[10px] px-2.5 py-1.5 bg-blue-50 border border-blue-100 rounded-lg text-blue-700 hover:bg-blue-100 hover:border-blue-300 hover:text-blue-800 transition-all shadow-sm font-bold flex items-center gap-1"
                                            data-type="r">
                                            <span class="w-1.5 h-1.5 rounded-full bg-blue-500"></span> Rol

                                            <!-- Tooltip -->
                                            <div
                                                class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-48 p-3 bg-slate-900/95 backdrop-blur text-white text-[10px] rounded-xl shadow-xl opacity-0 group-hover:opacity-100 transition-all duration-300 pointer-events-none z-50 transform group-hover:-translate-y-1 border border-slate-700 text-center scale-95 group-hover:scale-100 origin-bottom">
                                                <div
                                                    class="w-8 h-8 bg-blue-500/20 text-blue-300 rounded-full flex items-center justify-center mx-auto mb-2">
                                                    <span class="material-symbols-rounded text-lg">person</span>
                                                </div>
                                                <strong class="block text-blue-200 text-xs mb-1">üé≠ El Actor</strong>
                                                <p class="leading-snug text-slate-300">Define "qui√©n" ejecuta la acci√≥n.
                                                    Asigna identidad y expertise a la IA.</p>
                                                <div
                                                    class="absolute -bottom-1 left-1/2 -translate-x-1/2 w-2.5 h-2.5 bg-slate-900 rotate-45 border-r border-b border-slate-700">
                                                </div>
                                            </div>
                                        </span>

                                        <!-- CONTEXTO -->
                                        <span
                                            class="legend-item group relative cursor-help text-[10px] px-2.5 py-1.5 bg-emerald-50 border border-emerald-100 rounded-lg text-emerald-700 hover:bg-emerald-100 hover:border-emerald-300 hover:text-emerald-800 transition-all shadow-sm font-bold flex items-center gap-1"
                                            data-type="c">
                                            <span class="w-1.5 h-1.5 rounded-full bg-emerald-500"></span> Contexto

                                            <div
                                                class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-48 p-3 bg-slate-900/95 backdrop-blur text-white text-[10px] rounded-xl shadow-xl opacity-0 group-hover:opacity-100 transition-all duration-300 pointer-events-none z-50 transform group-hover:-translate-y-1 border border-slate-700 text-center scale-95 group-hover:scale-100 origin-bottom">
                                                <div
                                                    class="w-8 h-8 bg-emerald-500/20 text-emerald-300 rounded-full flex items-center justify-center mx-auto mb-2">
                                                    <span class="material-symbols-rounded text-lg">map</span>
                                                </div>
                                                <strong class="block text-emerald-200 text-xs mb-1">üåç El
                                                    Escenario</strong>
                                                <p class="leading-snug text-slate-300">Antecedentes y datos necesarios.
                                                    Sit√∫a a la IA en la realidad del problema.</p>
                                                <div
                                                    class="absolute -bottom-1 left-1/2 -translate-x-1/2 w-2.5 h-2.5 bg-slate-900 rotate-45 border-r border-b border-slate-700">
                                                </div>
                                            </div>
                                        </span>

                                        <!-- META -->
                                        <span
                                            class="legend-item group relative cursor-help text-[10px] px-2.5 py-1.5 bg-amber-50 border border-amber-100 rounded-lg text-amber-700 hover:bg-amber-100 hover:border-amber-300 hover:text-amber-800 transition-all shadow-sm font-bold flex items-center gap-1"
                                            data-type="m">
                                            <span class="w-1.5 h-1.5 rounded-full bg-amber-500"></span> Meta

                                            <div
                                                class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-48 p-3 bg-slate-900/95 backdrop-blur text-white text-[10px] rounded-xl shadow-xl opacity-0 group-hover:opacity-100 transition-all duration-300 pointer-events-none z-50 transform group-hover:-translate-y-1 border border-slate-700 text-center scale-95 group-hover:scale-100 origin-bottom">
                                                <div
                                                    class="w-8 h-8 bg-amber-500/20 text-amber-300 rounded-full flex items-center justify-center mx-auto mb-2">
                                                    <span class="material-symbols-rounded text-lg">flag</span>
                                                </div>
                                                <strong class="block text-amber-200 text-xs mb-1">üéØ El
                                                    Objetivo</strong>
                                                <p class="leading-snug text-slate-300">Qu√© quieres lograr exactamente.
                                                    El verbo de acci√≥n principal.</p>
                                                <div
                                                    class="absolute -bottom-1 left-1/2 -translate-x-1/2 w-2.5 h-2.5 bg-slate-900 rotate-45 border-r border-b border-slate-700">
                                                </div>
                                            </div>
                                        </span>

                                        <!-- RESTRICCIONES -->
                                        <span
                                            class="legend-item group relative cursor-help text-[10px] px-2.5 py-1.5 bg-red-50 border border-red-100 rounded-lg text-red-700 hover:bg-red-100 hover:border-red-300 hover:text-red-800 transition-all shadow-sm font-bold flex items-center gap-1"
                                            data-type="l">
                                            <span class="w-1.5 h-1.5 rounded-full bg-red-500"></span> Restr.

                                            <div
                                                class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-48 p-3 bg-slate-900/95 backdrop-blur text-white text-[10px] rounded-xl shadow-xl opacity-0 group-hover:opacity-100 transition-all duration-300 pointer-events-none z-50 transform group-hover:-translate-y-1 border border-slate-700 text-center scale-95 group-hover:scale-100 origin-bottom">
                                                <div
                                                    class="w-8 h-8 bg-red-500/20 text-red-300 rounded-full flex items-center justify-center mx-auto mb-2">
                                                    <span class="material-symbols-rounded text-lg">block</span>
                                                </div>
                                                <strong class="block text-red-200 text-xs mb-1">üöß Los L√≠mites</strong>
                                                <p class="leading-snug text-slate-300">Lo que NO quieres. Reglas de
                                                    seguridad, tono o longitud.</p>
                                                <div
                                                    class="absolute -bottom-1 left-1/2 -translate-x-1/2 w-2.5 h-2.5 bg-slate-900 rotate-45 border-r border-b border-slate-700">
                                                </div>
                                            </div>
                                        </span>

                                        <!-- FORMATO -->
                                        <span
                                            class="legend-item group relative cursor-help text-[10px] px-2.5 py-1.5 bg-purple-50 border border-purple-100 rounded-lg text-purple-700 hover:bg-purple-100 hover:border-purple-300 hover:text-purple-800 transition-all shadow-sm font-bold flex items-center gap-1"
                                            data-type="f">
                                            <span class="w-1.5 h-1.5 rounded-full bg-purple-500"></span> Formato

                                            <div
                                                class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-48 p-3 bg-slate-900/95 backdrop-blur text-white text-[10px] rounded-xl shadow-xl opacity-0 group-hover:opacity-100 transition-all duration-300 pointer-events-none z-50 transform group-hover:-translate-y-1 border border-slate-700 text-center scale-95 group-hover:scale-100 origin-bottom">
                                                <div
                                                    class="w-8 h-8 bg-purple-500/20 text-purple-300 rounded-full flex items-center justify-center mx-auto mb-2">
                                                    <span class="material-symbols-rounded text-lg">output</span>
                                                </div>
                                                <strong class="block text-purple-200 text-xs mb-1">üì¶ La
                                                    Entrega</strong>
                                                <p class="leading-snug text-slate-300">C√≥mo quieres ver la respuesta:
                                                    Tabla, C√≥digo, Lista o Texto.</p>
                                                <div
                                                    class="absolute -bottom-1 left-1/2 -translate-x-1/2 w-2.5 h-2.5 bg-slate-900 rotate-45 border-r border-b border-slate-700">
                                                </div>
                                            </div>
                                        </span>

                                    </div>
                                </div>

                                <!-- Tech Specs -->
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div id="tip-container"
                                        class="hidden bg-amber-50 rounded-xl p-4 border border-amber-100/50">
                                        <div class="flex items-center gap-2 mb-1.5 text-amber-700"><span
                                                class="material-symbols-rounded text-lg">lightbulb</span><span
                                                class="text-[10px] font-black uppercase tracking-wider">üß†
                                                T√©cnica</span></div>
                                        <p id="detail-example-tip"
                                            class="text-xs text-amber-900 leading-snug font-medium"></p>
                                    </div>
                                    <div id="validation-container"
                                        class="hidden bg-emerald-50 rounded-xl p-4 border border-emerald-100/50">
                                        <div class="flex items-center gap-2 mb-1.5 text-emerald-700"><span
                                                class="material-symbols-rounded text-lg">fact_check</span><span
                                                class="text-[10px] font-black uppercase tracking-wider">‚úÖ Validaci√≥n del
                                                Usuario</span></div>
                                        <p id="detail-validation-tip"
                                            class="text-xs text-emerald-900 leading-snug font-medium"></p>
                                    </div>
                                </div>
                            </div>

                            <!-- ACTION BAR (Fixed Bottom for Master) -->
                            <div
                                class="sticky bottom-0 bg-white border-t border-slate-100 p-4 flex justify-between items-center z-20 shadow-[0_-4px_20px_rgba(0,0,0,0.02)]">
                                <!-- HIGHLIGHTED SOCIAL PROOF -->
                                <div
                                    class="flex items-center gap-2 bg-orange-50 px-3 py-1.5 rounded-full border border-orange-100 shadow-sm animate-pulse">
                                    <span
                                        class="material-symbols-rounded text-orange-500 text-base">local_fire_department</span>
                                    <span id="social-proof-text" class="text-[10px] font-bold text-orange-800">Usado
                                        <span id="social-counter" class="text-orange-600 text-xs">...</span> veces en la
                                        √∫ltima hora</span>
                                </div>
                                <button id="copy-btn" onclick="copyPrompt()"
                                    class="bg-indigo-600 hover:bg-indigo-700 text-white pl-5 pr-6 py-2.5 rounded-xl font-bold shadow-lg shadow-indigo-200/50 text-xs flex items-center gap-2 transform transition-all hover:-translate-y-0.5 active:translate-y-0">
                                    <span class="material-symbols-rounded text-lg">content_copy</span> COPIAR PROMPT
                                </button>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- MODALS & TOAST -->
    <div id="toast" class="fixed bottom-10 right-10 z-[70] transform translate-x-full transition-all duration-500">
    </div>
    <!-- MOVED TO RIGHT to avoid Sidebar Overlap -->
    <div id="sales-toast"
        class="fixed bottom-24 right-6 z-[50] pointer-events-none md:pointer-events-auto transition-all duration-500 translate-y-24 opacity-0">
    </div>

    <div id="tutorial-modal" class="hidden fixed inset-0 z-[90] flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-slate-900/80 backdrop-blur-sm transition-opacity" onclick="closeTutorial()">
        </div>
        <div
            class="relative bg-white rounded-2xl shadow-2xl max-w-4xl w-full overflow-hidden animate-in zoom-in duration-200">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                <h3 class="font-bold text-lg text-indigo-900">Protocolo de Aprendizaje: Las 3 C</h3>
                <button onclick="closeTutorial()" class="text-slate-400 hover:text-slate-600"><span
                        class="material-symbols-rounded">close</span></button>
            </div>
            <div class="p-6 overflow-y-auto max-h-[75vh]">
                <div
                    class="w-full max-w-[320px] mx-auto aspect-video bg-slate-100 rounded-xl mb-8 flex items-center justify-center text-slate-300 relative group cursor-pointer overflow-hidden shadow-inner border border-slate-200">
                    <div
                        class="absolute inset-0 bg-[url('https://images.unsplash.com/photo-1611162617474-5b21e879e113?q=80&w=1000&auto=format&fit=crop')] bg-cover bg-center opacity-50">
                    </div>
                    <span
                        class="material-symbols-rounded text-5xl relative z-10 bg-white/20 p-4 rounded-full backdrop-blur text-white shadow-xl group-hover:scale-110 transition-transform">play_arrow</span>
                </div>

                <!-- 3C PROTOCOL GRID (UPDATED: Interactive Cards) -->
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 text-center">
                    <div
                        class="group p-6 bg-white border border-slate-100 rounded-2xl shadow-sm hover:shadow-xl hover:border-indigo-200 hover:-translate-y-2 transition-all duration-300 cursor-default relative overflow-hidden">
                        <div
                            class="absolute inset-0 bg-gradient-to-br from-indigo-50/50 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                        </div>
                        <div class="relative z-10">
                            <div
                                class="w-14 h-14 bg-indigo-50 text-indigo-600 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-sm group-hover:scale-110 group-hover:rotate-3 transition-transform duration-300 group-hover:bg-white group-hover:text-indigo-700">
                                <span class="material-symbols-rounded text-2xl">psychology</span>
                            </div>
                            <div class="font-black text-indigo-800 text-lg mb-2">1. Confrontar</div>
                            <p class="text-xs text-slate-500 leading-relaxed group-hover:text-slate-700">Antes de ver la
                                soluci√≥n, preg√∫ntate: <strong>"¬øQu√© le pedir√≠a yo a la IA?"</strong>. Intenta resolverlo
                                mentalmente.</p>
                        </div>
                    </div>

                    <div
                        class="group p-6 bg-white border border-slate-100 rounded-2xl shadow-sm hover:shadow-xl hover:border-emerald-200 hover:-translate-y-2 transition-all duration-300 cursor-default relative overflow-hidden">
                        <div
                            class="absolute inset-0 bg-gradient-to-br from-emerald-50/50 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                        </div>
                        <div class="relative z-10">
                            <div
                                class="w-14 h-14 bg-emerald-50 text-emerald-600 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-sm group-hover:scale-110 group-hover:-rotate-3 transition-transform duration-300 group-hover:bg-white group-hover:text-emerald-700">
                                <span class="material-symbols-rounded text-2xl">manage_search</span>
                            </div>
                            <div class="font-black text-emerald-800 text-lg mb-2">2. Comprender</div>
                            <p class="text-xs text-slate-500 leading-relaxed group-hover:text-slate-700">Analiza el
                                Prompt Maestro. Identifica los <strong>5 ingredientes clave</strong>: Rol, Contexto,
                                Meta, Restricciones y Formato.</p>
                        </div>
                    </div>

                    <div
                        class="group p-6 bg-white border border-slate-100 rounded-2xl shadow-sm hover:shadow-xl hover:border-amber-200 hover:-translate-y-2 transition-all duration-300 cursor-default relative overflow-hidden">
                        <div
                            class="absolute inset-0 bg-gradient-to-br from-amber-50/50 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                        </div>
                        <div class="relative z-10">
                            <div
                                class="w-14 h-14 bg-amber-50 text-amber-600 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-sm group-hover:scale-110 group-hover:rotate-3 transition-transform duration-300 group-hover:bg-white group-hover:text-amber-700">
                                <span class="material-symbols-rounded text-2xl">handshake</span>
                            </div>
                            <div class="font-black text-amber-800 text-lg mb-2">3. Colaborar</div>
                            <p class="text-xs text-slate-500 leading-relaxed group-hover:text-slate-700">¬°Acci√≥n! Copia
                                la estructura maestra y <strong>sustituye los datos</strong> por tu problema real del
                                d√≠a a d√≠a.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="paywall-modal" class="hidden fixed inset-0 z-[90] flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-slate-900/90 backdrop-blur-sm transition-opacity" onclick="closePaywall()">
        </div>
        <div
            class="relative bg-white rounded-2xl shadow-2xl max-w-sm w-full p-8 text-center animate-in zoom-in duration-200">
            <div
                class="w-12 h-12 bg-yellow-400 rounded-full flex items-center justify-center mx-auto mb-4 font-black text-xl shadow-lg">
                %</div>
            <h3 class="text-xl font-black text-slate-900 mb-2">Oferta Limitada</h3>
            <p class="text-xs text-slate-500 mb-6">Acceso total a la B√≥veda + Curso AGIA.</p>
            <button id="unlock-btn-modal" onclick="triggerUnlockPayment()"
                class="w-full bg-slate-900 text-white py-3 rounded-xl font-bold text-sm shadow-xl hover:scale-105 transition-transform">Desbloquear
                por $20 USD</button>
            <button onclick="closePaywall()" class="mt-3 text-xs text-slate-400 hover:text-slate-600">No
                gracias</button>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-functions-compat.js"></script>

    <script>
        // Firebase Config (Same as landing)
        const firebaseConfig = { apiKey: "AIzaSyC9sVJwEfFdIN4VmSMooAoQLXYl5Mcu1yM", authDomain: "aulagenia.firebaseapp.com", projectId: "aulagenia", storageBucket: "aulagenia.appspot.com", messagingSenderId: "173328075630", appId: "1:173328075630:web:825606db4271ea1e66cf7f" };
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const functions = firebase.functions();

        window.triggerUnlockPayment = async function () {
            const btn = document.getElementById('unlock-btn-modal');
            const user = auth.currentUser;

            if (!user) {
                console.log("User not logged in. Redirecting...");
                // Redirect to Login, return to THIS page with action=buy
                window.location.href = "acceso.html?redirect=maestro-prompts-app.html?action=buy";
                return;
            }

            // Logged in
            if (btn) {
                btn.disabled = true;
                btn.textContent = "Generando...";
            }

            try {
                const createPreference = functions.httpsCallable('createMercadoPagoPreference');
                const result = await createPreference({ courseId: 'ia-aplicada-esencial' }); // Correct ID

                if (result.data && result.data.init_point) {
                    window.location.href = result.data.init_point;
                } else {
                    throw new Error("No payment link returned");
                }
            } catch (error) {
                console.error("Payment Error:", error);
                alert("Error al generar pago. Intenta m√°s tarde.");
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = "Desbloquear por $20 USD";
                }
            }
        };

        // Auto-trigger on return
        document.addEventListener('DOMContentLoaded', () => {
            auth.onAuthStateChanged(user => {
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('action') === 'buy' && user) {
                    // Open modal if closed
                    const modal = document.getElementById('paywall-modal');
                    if (modal) modal.classList.remove('hidden');

                    triggerUnlockPayment();
                }
            });
        });
    </script>

    <script type="module">
        let casesData = [];
        // Se asume que el archivo prompts_db.js est√° en la misma ubicaci√≥n
        const externalDBUrl = './prompts_db.js';



        // UI Elements
        const statusOverlay = document.getElementById('system-status-overlay');
        const statusIcon = document.getElementById('status-icon');
        const statusTitle = document.getElementById('status-title');
        const statusDesc = document.getElementById('status-desc');
        const statusCode = document.getElementById('status-code');
        const retryBtn = document.getElementById('retry-btn');

        function showSystemError(err) {
            statusOverlay.classList.remove('hidden');
            statusOverlay.classList.add('flex');
            statusIcon.innerHTML = '<span class="material-symbols-rounded text-3xl text-red-500">error</span>';
            statusIcon.className = "w-16 h-16 bg-white border border-red-100 text-red-600 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-sm";
            statusTitle.innerText = "Error de Conexi√≥n";

            if (err.message.includes("Failed to fetch") || err.message.includes("NetworkError")) {
                statusDesc.innerText = "No pudimos conectar con el servidor de AulaGenia. Verifica tu conexi√≥n o que prompts_db.js exista.";
                statusCode.innerText = "NETWORK_ERROR";
            } else {
                statusDesc.innerText = "Error al procesar la base de datos de prompts.";
                statusCode.innerText = "DATA_ERROR: " + err.message;
            }
            statusCode.className = "text-red-500 font-bold";
            retryBtn.classList.remove('hidden');
        }

        async function loadDatabase() {
            try {
                // Import din√°mico del m√≥dulo
                const module = await import(externalDBUrl);
                if (module && module.default && Array.isArray(module.default)) {
                    casesData = module.default;
                    setTimeout(() => {
                        statusOverlay.classList.add('hidden');
                        initApp();
                    }, 800);
                } else {
                    throw new Error("Formato de base de datos inv√°lido.");
                }
            } catch (err) {
                console.error("System Error:", err);
                showSystemError(err);
            }
        }

        loadDatabase();

        const config = {
            categories: {
                "Productividad Ninja": { label: "Productividad", color: "emerald", icon: "rocket_launch" },
                "Ventas & Persuasi√≥n": { label: "Ventas", color: "rose", icon: "campaign" },
                "Contenido & Redes": { label: "Marketing", color: "fuchsia", icon: "share" },
                "Finanzas Inteligentes": { label: "Finanzas", color: "amber", icon: "payments" },
                "Legal & Formalizaci√≥n": { label: "Legal", color: "slate", icon: "gavel" },
                "Estrategia & Lanzamiento": { label: "Estrategia", color: "violet", icon: "flag" },
                "Dise√±o & Arte Digital": { label: "Dise√±o", color: "pink", icon: "palette" },
                "Operaciones & Procesos": { label: "Operaciones", color: "cyan", icon: "settings_suggest" },
                "Liderazgo & Equipos": { label: "Liderazgo", color: "blue", icon: "groups" },
                "Tecnolog√≠a & Herramientas": { label: "Tecnolog√≠a", color: "indigo", icon: "terminal" },
                "Otros / An√°lisis": { label: "An√°lisis", color: "gray", icon: "analytics" }
            }
        };

        // Global References
        let currentPromptTemplate = "";
        let currentBadPromptTemplate = "";
        let currentVariables = {};
        let currentDifficulty = 'beginner';
        let currentViewMode = 'basic'; // 'basic' or 'agia'
        let currentCaseId = null;
        let isVaultUnlocked = false;

        // Initialize Firebase (Reuse global instance if available, or init)
        const auth = firebase.auth();

        // SECURITY: Key is constructed at runtime to prevent static analysis exposure
        // "AGIA2025" -> Obfuscated construction
        function getEncryptionKey() {
            return [65, 71, 73, 65, 50, 48, 50, 53].map(c => String.fromCharCode(c)).join('');
        }

        // Helper: Simple SHA-256 for client-side check
        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        function initApp() {
            // Expose globals
            window.loadCase = loadCase;
            window.filterCases = filterCases;
            window.filterByCategory = filterByCategory;
            window.copyPrompt = copyPrompt;
            window.openPaywall = openPaywall;
            window.closePaywall = closePaywall;
            window.showTutorial = showTutorial;
            window.closeTutorial = closeTutorial;
            window.downloadPDF = downloadPDF;
            window.setMode = setMode;
            // Removed: window.toggleGlobalLock, window.attemptUnlock

            renderCategories();
            renderList(casesData);

            // Auto-select first if available
            if (casesData.length > 0) {
                loadCase(casesData[0].id);
            }
            startCountdown();
            startSocialProof();
            setupLegendInteractions();

            // Listen for Auth State
            auth.onAuthStateChanged(user => {
                if (user) {
                    // console.log("Usuario autenticado:", user.email);
                    isVaultUnlocked = true;

                    const teaser = document.getElementById('locked-teaser');
                    if (teaser) {
                        teaser.classList.add('hidden');
                        teaser.classList.remove('flex');
                    }

                    // Reload current case to apply decryption
                    if (currentCaseId) loadCase(currentCaseId);
                } else {
                    // console.log("Usuario no autenticado.");
                    isVaultUnlocked = false;
                    // Force reload to show lock
                    if (currentCaseId) loadCase(currentCaseId);
                }
            });
        }

        function decryptPrompt(ciphertext) {
            try {
                if (!ciphertext) return "";
                if (!ciphertext.startsWith("U2F")) return ciphertext;

                const bytes = CryptoJS.AES.decrypt(ciphertext, getEncryptionKey());
                const originalText = bytes.toString(CryptoJS.enc.Utf8);
                return originalText || "Error: Corrupted Data";
            } catch (e) {
                console.error("Decryption failed", e);
                return "Error: Decryption Failed";
            }
        }


        function setMode(mode) {
            currentViewMode = mode;
            const btnBasic = document.getElementById('btn-basic');
            const btnAgia = document.getElementById('btn-agia');
            const contentBasic = document.getElementById('content-basic');
            const contentAgia = document.getElementById('content-agia');

            if (mode === 'basic') {
                contentBasic.classList.remove('hidden');
                contentAgia.classList.add('hidden');
                // Compact button styling
                btnBasic.classList.add('bg-slate-600', 'text-white');
                btnBasic.classList.remove('text-slate-600');
                btnAgia.classList.remove('bg-indigo-600', 'text-white');
                btnAgia.classList.add('text-slate-600');
            } else {
                contentBasic.classList.add('hidden');
                contentAgia.classList.remove('hidden');
                // Compact button styling
                btnBasic.classList.remove('bg-slate-600', 'text-white');
                btnBasic.classList.add('text-slate-600');
                btnAgia.classList.add('bg-indigo-600', 'text-white');
                btnAgia.classList.remove('text-slate-600');
            }
        }

        function loadCase(id) {
            currentCaseId = id;
            const c = casesData.find(x => x.id === id);
            if (!c) return;

            // Scroll to Top logic fix
            const scrollContainer = document.getElementById('detail-scroll-container');
            if (scrollContainer) scrollContainer.scrollTop = 0;

            // Determine effective lock state (Database OR User Session)
            const isLocked = c.locked || !isVaultUnlocked;

            currentDifficulty = c.difficulty || 'beginner';

            // Reset Social Proof Counter specific to prompt ID
            // Removed static formula ID * 0.2
            // Now logic is handled in the text randomizer below

            document.querySelectorAll('.case-item').forEach(el => {
                el.classList.remove('bg-indigo-50', 'border-indigo-100', 'text-indigo-700');
                el.classList.add('border-transparent', 'text-slate-600');
            });
            const activeItem = document.getElementById(`case-item-${id}`);
            if (activeItem) {
                activeItem.classList.remove('border-transparent', 'text-slate-600');
                activeItem.classList.add('bg-indigo-50', 'border-indigo-100', 'text-indigo-700');
            }

            document.getElementById('workspace-empty').classList.add('hidden');
            document.getElementById('case-detail').classList.remove('hidden');

            document.getElementById('detail-title').innerText = c.title;
            document.getElementById('detail-problem').innerText = c.problem;

            document.getElementById('bad-result-preview').innerHTML = c.badResponsePreview || '';
            document.getElementById('bad-response-analysis').innerHTML = c.badResponseAnalysis || '';
            document.getElementById('good-result-preview').innerHTML = formatPreviewTable(c.previewResponse);

            const cat = config.categories[c.category] || { label: 'General', color: 'slate' };
            const badge = document.getElementById('detail-category-badge');
            badge.innerText = cat.label;
            badge.className = `text-[9px] font-bold uppercase tracking-wider px-2 py-0.5 rounded border shadow-sm bg-white text-${cat.color}-600 border-${cat.color}-100`;

            const aiBadge = document.getElementById('ai-suggestion-badge');
            const aiName = document.getElementById('ai-name');
            if (c.suggestedAI) {
                let niceName = c.suggestedAI.toUpperCase();
                aiName.innerText = niceName;
                aiBadge.classList.remove('hidden');
                aiBadge.classList.add('flex');
            } else {
                aiBadge.classList.add('hidden');
                aiBadge.classList.remove('flex');
            }

            // Benefit Badge Logic
            const benefitBadge = document.getElementById('benefit-badge');
            if (benefitBadge) {
                if (currentDifficulty === 'beginner') {
                    benefitBadge.innerHTML = '<span class="material-symbols-rounded text-sm">bolt</span> Ahorro: ~15 min';
                    benefitBadge.className = "text-[10px] font-bold text-emerald-600 bg-emerald-50 px-2.5 py-1 rounded-md border border-emerald-100 flex items-center gap-1.5 shadow-sm";
                } else if (currentDifficulty === 'intermediate') {
                    benefitBadge.innerHTML = '<span class="material-symbols-rounded text-sm">rocket_launch</span> Ahorro: ~45 min';
                    benefitBadge.className = "text-[10px] font-bold text-amber-600 bg-amber-50 px-2.5 py-1 rounded-md border border-amber-100 flex items-center gap-1.5 shadow-sm";
                } else {
                    benefitBadge.innerHTML = '<span class="material-symbols-rounded text-sm">diamond</span> Ahorro: +2 Horas';
                    benefitBadge.className = "text-[10px] font-bold text-rose-600 bg-rose-50 px-2.5 py-1 rounded-md border border-rose-100 flex items-center gap-1.5 shadow-sm";
                }
            }

            const tipContainer = document.getElementById('tip-container');
            const validationContainer = document.getElementById('validation-container');
            const tipText = document.getElementById('detail-example-tip');
            const valText = document.getElementById('detail-validation-tip');

            if (c.exampleTip) { tipText.innerHTML = c.exampleTip; tipContainer.classList.remove('hidden'); } else { tipContainer.classList.add('hidden'); }
            if (c.validationTip) { valText.innerHTML = c.validationTip; validationContainer.classList.remove('hidden'); } else { validationContainer.classList.add('hidden'); }

            currentPromptTemplate = c.agiaPromptTagged;

            // Decrypt ONLY if unlocked
            if (isVaultUnlocked && currentPromptTemplate.startsWith("U2F")) {
                currentPromptTemplate = decryptPrompt(currentPromptTemplate);
            }

            currentBadPromptTemplate = c.badPromptDynamic || c.badPrompt;
            currentVariables = {};

            // Si est√° bloqueado, no intentamos parsear variables porque el texto es basura encriptada
            if (!currentPromptTemplate.startsWith("U2F")) {
                const regex = /{([a-z0-9_]+)\|([^}]+)}/g;
                let match;
                while ((match = regex.exec(currentPromptTemplate)) !== null) {
                    currentVariables[match[1]] = match[2];
                }
            }

            // Force Lock if content is encrypted and vault is locked
            const effectivelyLocked = isLocked || (!isVaultUnlocked && currentPromptTemplate.startsWith("U2F"));

            renderPrompts(effectivelyLocked);

            // L√≥gica de Bloqueo Visual (Teaser)
            const lockOverlay = document.getElementById('locked-teaser');
            const blurWrapper = document.getElementById('prompt-blur-wrapper');
            const copyBtn = document.getElementById('copy-btn');
            const resultTeaser = document.getElementById('result-teaser-label');
            const passwordInput = document.getElementById('vault-password');
            if (passwordInput) passwordInput.value = ""; // Clear password on new case load

            if (effectivelyLocked) {
                lockOverlay.classList.remove('hidden');
                blurWrapper.classList.add('blur-prompt');
                copyBtn.disabled = true;
                copyBtn.classList.add('opacity-50', 'cursor-not-allowed');
                copyBtn.innerHTML = '<span class="material-symbols-rounded text-lg">lock</span> BLOQUEADO';
                resultTeaser.classList.remove('hidden');
                resultTeaser.classList.add('flex');
            } else {
                lockOverlay.classList.add('hidden');
                blurWrapper.classList.remove('blur-prompt');
                copyBtn.disabled = false;
                copyBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                copyBtn.innerHTML = '<span class="material-symbols-rounded text-lg">content_copy</span> COPIAR PROMPT';
                resultTeaser.classList.add('hidden');
                resultTeaser.classList.remove('flex');
            }

            setupMagicHover();
            setMode(currentViewMode);

            // Social Proof Randomizer
            const socialText = document.getElementById('social-proof-text');
            if (socialText) {
                // Deterministic Randomness based on ID
                const base = Math.floor(c.id * 0.8);
                const variance = ((c.id * 7) % 30) * 5;
                const count = base + variance + 45; // Minimum ~125 range

                // Randomize phrasing slightly based on ID parity
                const templates = [
                    `Usado <span class="text-orange-600 text-xs">${count}</span> veces en la √∫ltima hora`,
                    `<span class="text-orange-600 text-xs">${count}</span> personas lo est√°n usando ahora`,
                    `Tendencia: <span class="text-orange-600 text-xs">${count}</span> usos recientes`
                ];
                const phraseIndex = c.id % templates.length;

                socialText.innerHTML = templates[phraseIndex];
            }
        }

        function downloadPDF() {
            // Calculate count of unlocked prompts to show value
            const total = casesData.length;
            const unlockedCount = casesData.filter(c => !(c.locked || globalLockMode)).length;

            const printContent = `
                <html>
                <head>
                    <title>B√≥veda de Prompts AGIA</title>
                    <style>
                        body { font-family: sans-serif; padding: 40px; color: #333; line-height: 1.6; }
                        h1 { text-align: center; color: #4f46e5; margin-bottom: 5px; }
                        .subtitle { text-align: center; font-size: 0.9em; color: #666; margin-bottom: 40px; }
                        .case { border: 1px solid #e2e8f0; padding: 20px; margin-bottom: 20px; page-break-inside: avoid; border-radius: 8px; }
                        .title { font-weight: 800; font-size: 1.2em; color: #1e293b; }
                        .meta { font-size: 0.75em; color: #64748b; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 700; }
                        .problem { font-style: italic; color: #475569; margin-bottom: 15px; font-size: 0.9em; }
                        .label { font-weight: bold; font-size: 0.8em; text-transform: uppercase; color: #4f46e5; margin-bottom: 5px; }
                        .prompt-box { background: #f8fafc; border: 1px solid #cbd5e1; padding: 15px; border-radius: 6px; font-family: 'Courier New', monospace; white-space: pre-wrap; font-size: 0.85em; color: #334155; }
                        .locked-box { background: #fef2f2; border: 1px dashed #fca5a5; color: #991b1b; text-align: center; font-style: italic; padding: 20px; display: flex; align-items: center; justify-content: center; gap: 10px; }
                        .watermark { text-align: center; margin-top: 50px; font-size: 0.8em; color: #cbd5e1; }
                    </style>
                </head>
                <body>
                    <h1>B√≥veda Maestra AGIA</h1>
                    <p class="subtitle">Reporte Generado el ${new Date().toLocaleDateString()} | ${unlockedCount}/${total} Desbloqueados</p>
                    
                    ${casesData.map(c => {
                // Check if individual case is locked or if global lock is enabled (now controlled by isVaultUnlocked)
                // If vault is NOT unlocked, treat as locked.
                const isLocked = c.locked || !isVaultUnlocked;

                const content = isLocked
                    ? `<div class="locked-box">üîí CONTENIDO EXCLUSIVO - Inicia sesi√≥n en AulaGenia para ver este contenido.</div>`
                    : `<div class="prompt-box">${c.agiaPromptTagged ? decryptPrompt(c.agiaPromptTagged).replace(/{[a-z]+\}|{\/[a-z]+\}/g, '') : ''}</div>`;

                return `
                            <div class="case">
                                <div class="title">${c.title}</div>
                                <div class="meta">${c.category} ‚Ä¢ ${c.difficulty}</div>
                                <p class="problem">"${c.problem}"</p>
                                <div class="label">Prompt Optimizado:</div>
                                ${content}
                            </div>
                        `;
            }).join('')}
                    
                    <div class="watermark">Generado por AGIA Generator 3.0</div>
                    <script>window.onload = function() { window.print(); }</sc`+ `ript>
                </body>
                </html>
            `;
            const win = window.open('', '_blank');
            win.document.write(printContent);
            win.document.close();
        }

        // Funci√≥n para escapar HTML y prevenir XSS
        function escapeHtml(text) {
            if (!text) return text;
            return String(text)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function renderPrompts(isLocked) {
            // Keep original behavior for hidden element (used for copy)
            let renderedAgia = escapeHtml(currentPromptTemplate);
            Object.keys(currentVariables).forEach(key => {
                const val = currentVariables[key] || "___";
                const safeVal = escapeHtml(val);
                const regex = new RegExp(`{${key}\\|[^}]+}`, 'g');
                renderedAgia = renderedAgia.replace(regex, `<span class="var-highlight">${safeVal}</span>`);
            });
            const tags = { r: 'rol', c: 'contexto', m: 'meta', l: 'restricciones', f: 'formato' };
            Object.keys(tags).forEach(t => {
                const className = `hl-${tags[t]}`;
                const regex = new RegExp(`{${t}}(.*?){/${t}}`, 'gs');
                renderedAgia = renderedAgia.replace(regex, `<span class="hl-tag ${className}" data-tag-type="${t}">$1</span>`);
            });
            renderedAgia = renderedAgia.replace(/\n/g, '<br>');
            document.getElementById('detail-prompt-rendered').innerHTML = renderedAgia;

            // NEW: Parse and render AGIA sections with colored badges
            renderAgiaSections(currentPromptTemplate);

            let renderedBad = escapeHtml(currentBadPromptTemplate);
            Object.keys(currentVariables).forEach(key => {
                const val = currentVariables[key] || "...";
                const safeVal = escapeHtml(val);
                const regex = new RegExp(`{${key}}`, 'g');
                renderedBad = renderedBad.replace(regex, `<span class="var-highlight-bad">${safeVal}</span>`);
            });
            document.getElementById('bad-prompt-rendered').innerHTML = `"${renderedBad}"`;
        }

        // NEW: Function to parse AGIA template and render with INLINE colored highlights
        function renderAgiaSections(template) {
            const container = document.getElementById('agia-sections-container');
            if (!container) return;

            // AGIA section configuration with highlight colors
            const sectionConfig = {
                'ROL': { bg: 'bg-blue-400', text: 'text-blue-950' },
                'CONTEXTO': { bg: 'bg-emerald-400', text: 'text-emerald-950' },
                'META': { bg: 'bg-yellow-300', text: 'text-yellow-950' },
                'RESTRICCIONES': { bg: 'bg-rose-300', text: 'text-rose-950' },
                'FORMATO': { bg: 'bg-violet-400', text: 'text-violet-950' }
            };

            // Parse the template to extract sections
            const lines = template.split('\n');
            const sections = {};
            let currentSection = null;
            let currentContent = [];

            lines.forEach(line => {
                const sectionMatch = line.match(/^(\d+)\.\s*(ROL|CONTEXTO|META|RESTRICCIONES|FORMATO):?\s*(.*)/i);
                if (sectionMatch) {
                    if (currentSection) {
                        sections[currentSection] = currentContent.join(' ').trim();
                    }
                    currentSection = sectionMatch[2].toUpperCase();
                    currentContent = [sectionMatch[3] || ''];
                } else if (currentSection) {
                    currentContent.push(line.trim());
                }
            });
            if (currentSection) {
                sections[currentSection] = currentContent.join(' ').trim();
            }

            // Build INLINE HTML with colored highlights
            let html = '';
            const sectionOrder = ['ROL', 'CONTEXTO', 'META', 'RESTRICCIONES', 'FORMATO'];

            sectionOrder.forEach(key => {
                const config = sectionConfig[key];
                let content = sections[key] || '';
                if (!content) return;

                content = content.replace(/\s+/g, ' ').trim();
                html += `<span class="inline ${config.bg} ${config.text} px-2 py-0.5 rounded font-medium mx-0.5 leading-8">${escapeHtml(content)}</span> `;
            });

            container.innerHTML = html || '<p class="text-slate-400 text-sm italic">No se pudo parsear el prompt</p>';
        }

        // New Logic: Bidirectional Magic Hover
        function setupMagicHover() {
            // Wait for DOM update
            setTimeout(() => {
                const promptSpans = document.querySelectorAll('#detail-prompt-rendered .hl-tag');
                const legendItems = document.querySelectorAll('.legend-item');

                // 1. Legend -> Prompt
                legendItems.forEach(item => {
                    item.addEventListener('mouseenter', () => {
                        const type = item.dataset.type;
                        // Highlight prompt spans
                        promptSpans.forEach(span => {
                            if (span.dataset.tagType === type) {
                                span.classList.add('highlighted');
                            } else {
                                span.classList.add('dimmed');
                            }
                        });
                        // Dim other legend items
                        legendItems.forEach(li => { if (li !== item) li.classList.add('dimmed'); });
                    });

                    item.addEventListener('mouseleave', () => {
                        promptSpans.forEach(span => {
                            span.classList.remove('highlighted', 'dimmed');
                        });
                        legendItems.forEach(li => li.classList.remove('dimmed'));
                    });
                });

                // 2. Prompt -> Legend
                promptSpans.forEach(span => {
                    span.addEventListener('mouseenter', () => {
                        const type = span.dataset.tagType;
                        // Highlight legend item
                        legendItems.forEach(li => {
                            if (li.dataset.type === type) {
                                li.classList.add('highlighted');
                            } else {
                                li.classList.add('dimmed');
                            }
                        });
                        // Dim other prompt spans
                        promptSpans.forEach(s => { if (s !== span) s.classList.add('dimmed'); });
                    });

                    span.addEventListener('mouseleave', () => {
                        legendItems.forEach(li => {
                            li.classList.remove('highlighted', 'dimmed');
                        });
                        promptSpans.forEach(s => s.classList.remove('dimmed'));
                    });
                });
            }, 100);
        }

        function setupLegendInteractions() {
            setupMagicHover();
        }

        function copyPrompt() {
            // Trigger Confetti Celebration!
            confetti({
                particleCount: 100,
                spread: 70,
                origin: { y: 0.6 }
            });

            // Increment Social Counter in Real-Time
            const socialCounter = document.getElementById('social-counter');
            if (socialCounter) {
                let currentCount = parseInt(socialCounter.innerText.replace(/,/g, ''));
                socialCounter.innerText = (currentCount + 1).toLocaleString();
            }

            const rawText = document.getElementById('detail-prompt-rendered').innerText;
            const textArea = document.createElement("textarea");
            textArea.value = rawText;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
            } catch (err) {
                console.error('Error al copiar:', err);
            }
            document.body.removeChild(textArea);

            // Dynamic Feedback based on Difficulty
            let msg = '¬°Copiado con √©xito!';
            let subMsg = 'Listo para pegar.';
            let icon = 'check_circle';
            let colorClass = 'text-green-400';

            if (currentDifficulty === 'beginner') {
                msg = '¬°Bien! Ahorraste ~15 min';
                subMsg = 'Equivalente a redactar un correo simple.';
                colorClass = 'text-emerald-400';
            } else if (currentDifficulty === 'intermediate') {
                msg = '¬°Excelente! Ahorraste ~45 min';
                subMsg = 'Tiempo valioso de an√°lisis ganado.';
                colorClass = 'text-amber-400';
                icon = 'bolt';
            } else if (currentDifficulty === 'advanced') {
                msg = '¬°IMPACTO TOTAL! Ahorraste +90 min';
                subMsg = 'Estrategia compleja lista en segundos.';
                colorClass = 'text-rose-400';
                icon = 'rocket_launch';
            }

            const toast = document.getElementById('toast');
            toast.innerHTML = `
                <div class="bg-slate-900 text-white px-5 py-4 rounded-xl shadow-2xl flex items-center gap-4 border border-slate-700">
                    <span class="material-symbols-rounded ${colorClass} text-2xl">${icon}</span>
                    <div>
                        <h4 class="font-bold text-sm text-white">${msg}</h4>
                        <p class="text-[11px] text-slate-400 mt-0.5">${subMsg}</p>
                    </div>
                </div>
            `;

            toast.classList.remove('translate-x-full');
            setTimeout(() => {
                toast.classList.add('translate-x-full');
            }, 4000);
        }

        function updateTotalCounter() {
            const totalEl = document.getElementById('total-display');
            if (totalEl) totalEl.innerText = casesData.length;
        }

        function renderCategories() {
            const nav = document.getElementById('category-nav');
            if (!nav) return;

            // Extract unique categories from the actual data
            const uniqueCategories = [...new Set(casesData.map(c => c.category))];

            nav.innerHTML = uniqueCategories.map(key => {
                const conf = config.categories[key] || { label: key, color: 'slate', icon: 'category' };
                // Count cases per category
                const count = casesData.filter(x => x.category === key).length;

                return `<button onclick="filterByCategory('${key}')" class="whitespace-nowrap px-3 py-1 rounded-lg text-[10px] font-bold bg-slate-50 border border-slate-200 text-slate-500 hover:border-indigo-300 hover:text-indigo-600 transition-all flex items-center gap-1.5 group">
                    <span class="material-symbols-rounded text-sm text-${conf.color}-500">${conf.icon}</span> 
                    ${key}
                    <span class="bg-${conf.color}-100 text-${conf.color}-700 text-[9px] px-1.5 py-0.5 rounded-full ml-1">${count}</span>
                </button>`;
            }).join('');
        }

        function filterByCategory(cat) {
            document.getElementById('searchInput').value = '';
            const filtered = casesData.filter(c => c.category === cat);
            renderList(filtered);
            if (filtered.length > 0) loadCase(filtered[0].id); // Auto-select first item
        }

        // Diccionario de Sin√≥nimos para B√∫squeda Inteligente
        const synonymMap = {
            "venta": ["vender", "marketing", "comercial", "lead", "cliente", "negocio", "ingreso", "dinero"],
            "marketing": ["publicidad", "anuncio", "redes", "social", "campa√±a", "promoci√≥n", "difusi√≥n"],
            "texto": ["redacci√≥n", "copy", "escribir", "blog", "art√≠culo", "guion", "email", "correo"],
            "imagen": ["foto", "dise√±o", "logo", "visual", "arte", "midjourney", "dall-e", "creativo"],
            "empresa": ["pyme", "emprendimiento", "negocio", "startup", "compa√±√≠a", "marca"],
            "legal": ["contrato", "abogado", "ley", "norma", "sii", "impuesto", "tributario"],
            "curso": ["educaci√≥n", "aprender", "taller", "clase", "ense√±ar", "formaci√≥n"],
            "ia": ["inteligencia", "gpt", "chatgpt", "midjourney", "claude", "bot", "automatizaci√≥n"],
            "idea": ["creatividad", "brainstorming", "invenci√≥n", "innovaci√≥n", "concepto"],
            "plan": ["estrategia", "calendario", "cronograma", "organizaci√≥n", "paso a paso"]
        };

        function filterCases() {
            const rawInput = document.getElementById('searchInput').value.toLowerCase().trim();
            if (!rawInput) {
                renderList(casesData);
                return;
            }

            // 1. Desglosar b√∫squeda en palabras clave
            const searchTerms = rawInput.split(/\s+/);

            // 2. Expandir con sin√≥nimos
            const expandedTerms = new Set(searchTerms);
            searchTerms.forEach(term => {
                // Buscar coincidencia parcial en claves del diccionario
                Object.keys(synonymMap).forEach(key => {
                    if (key.includes(term) || term.includes(key)) {
                        synonymMap[key].forEach(syn => expandedTerms.add(syn));
                    }
                });
            });

            // Convertir Set a Array para iterar
            const finalKeywords = Array.from(expandedTerms);

            const filtered = casesData.filter(c => {
                // Unir todo el texto buscable en un solo string para eficiencia
                const content = `${c.title} ${c.problem} ${c.category} ${c.badPrompt}`.toLowerCase();

                // L√≥gica OR: Si AL MENOS UNA de las palabras expandidas est√° presente
                // L√≥gica AND (opcional): Si TODAS las palabras originales (expandidas) est√°n presentes
                // Aqu√≠ usaremos OR para maximizar resultados (mayor recall)
                return finalKeywords.some(keyword => content.includes(keyword));
            });

            renderList(filtered, finalKeywords);

            // Update UI Stats
            const statsEl = document.getElementById('search-stats');
            const countEl = document.getElementById('results-count');

            if (rawInput.length > 0) {
                statsEl.classList.remove('hidden');
                statsEl.classList.add('flex');
                if (filtered.length === 0) {
                    countEl.innerText = "0 resultados";
                    countEl.className = "text-[10px] font-bold text-red-400";
                } else {
                    countEl.innerText = `${filtered.length} encontrados`;
                    countEl.className = "text-[10px] font-bold text-emerald-500";
                }
            } else {
                statsEl.classList.add('hidden');
                statsEl.classList.remove('flex');
            }
        }

        function highlightText(text, keywords) {
            if (!keywords || keywords.length === 0) return escapeHtml(text);
            let escapedText = escapeHtml(text);

            // Crear regex combinada para todas las keywords (case insensitive)
            // Ordenar por longitud descendente para evitar que una corta rompa una larga
            const sortedKeywords = [...keywords].sort((a, b) => b.length - a.length);
            const pattern = new RegExp(`(${sortedKeywords.join('|')})`, 'gi');

            return escapedText.replace(pattern, match =>
                `<span class="bg-yellow-200 text-yellow-900 font-bold px-0.5 rounded">${match}</span>`
            );
        }

        function getMatchContext(c, keywords) {
            // Buscar en campos secundarios si no est√° en t√≠tulo/categor√≠a
            const fields = [c.problem, c.badPrompt];
            for (let text of fields) {
                if (!text) continue;
                const lower = text.toLowerCase();
                const hit = keywords.find(k => lower.includes(k));
                if (hit) {
                    // Extraer fragmento
                    const idx = lower.indexOf(hit);
                    const start = Math.max(0, idx - 15);
                    const end = Math.min(text.length, idx + hit.length + 25);
                    let snippet = text.substring(start, end);
                    if (start > 0) snippet = "..." + snippet;
                    if (end < text.length) snippet = snippet + "...";
                    return highlightText(snippet, keywords);
                }
            }
            return null;
        }

        function renderList(cases, highlightKeywords = []) {
            const list = document.getElementById('case-list');
            document.getElementById('total-display').innerText = casesData.length;

            if (cases.length === 0) {
                list.innerHTML = '<div class="p-8 text-center text-xs text-slate-400 flex flex-col items-center"><span class="material-symbols-rounded text-2xl mb-2 opacity-50">search_off</span>Sin resultados.</div>';
                return;
            }

            list.innerHTML = cases.map(c => {
                let dotColor = 'bg-slate-300';
                let tooltip = 'Desconocido';
                if (c.difficulty === 'beginner') { dotColor = 'bg-emerald-400'; tooltip = 'B√°sico: 15 min'; }
                else if (c.difficulty === 'intermediate') { dotColor = 'bg-amber-400'; tooltip = 'Intermedio: 45 min'; }
                else if (c.difficulty === 'advanced') { dotColor = 'bg-rose-400'; tooltip = 'Avanzado: 90-120 min'; }

                // Procesar Highlighting
                const titleHtml = highlightText(c.title, highlightKeywords);
                const catHtml = highlightText(c.category, highlightKeywords);

                // Determinar si necesitamos mostrar contexto extra (si el match NO est√° en t√≠tulo ni categor√≠a)
                let contextHtml = '';
                if (highlightKeywords.length > 0) {
                    // Check simple si alguna keyword est√° en titulo o categoria (ignorando case)
                    const titleHit = highlightKeywords.some(k => c.title.toLowerCase().includes(k));
                    const catHit = highlightKeywords.some(k => c.category.toLowerCase().includes(k));

                    if (!titleHit && !catHit) {
                        const matchSnippet = getMatchContext(c, highlightKeywords);
                        if (matchSnippet) {
                            contextHtml = `<div class="mt-1.5 text-[10px] text-slate-500 bg-slate-50 p-1.5 rounded border border-slate-100 flex items-start gap-1">
                                <span class="material-symbols-rounded text-[10px] text-indigo-400 mt-0.5">manage_search</span>
                                <span class="leading-tight break-words has-highlights">${matchSnippet}</span>
                             </div>`;
                        }
                    }
                }

                return `
                <div id="case-item-${c.id}" onclick="loadCase(${c.id})" class="case-item group p-3 rounded-lg cursor-pointer hover:bg-slate-50 hover:shadow-sm transition-all border border-transparent hover:border-indigo-100 relative mb-1">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg bg-white border border-slate-100 flex items-center justify-center text-slate-400 group-hover:text-indigo-600 group-hover:bg-indigo-50 transition-colors shadow-sm shrink-0">
                            <span class="material-symbols-rounded text-[16px]">${c.locked ? 'lock' : c.icon}</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <h4 class="text-xs font-bold truncate transition-colors text-slate-700 group-hover:text-indigo-900">${titleHtml}</h4>
                            <div class="flex items-center gap-1.5 mt-0.5">
                                <span class="w-1.5 h-1.5 rounded-full ${dotColor}" title="${tooltip}"></span>
                                <span class="text-[10px] text-slate-400 capitalize truncate font-medium">${catHtml}</span>
                            </div>
                            ${contextHtml}
                        </div>
                    </div>
                </div>
            `}).join('');
        }

        function openPaywall() {
            // Also trigger confetti for unlocking!
            confetti({
                particleCount: 150,
                spread: 100,
                origin: { y: 0.6 },
                colors: ['#FFE400', '#FFBD00', '#E89400', '#FFCA6C', '#FDFFB8']
            });
            document.getElementById('paywall-modal').classList.remove('hidden');
        }
        function closePaywall() { document.getElementById('paywall-modal').classList.add('hidden'); }
        function showTutorial() { document.getElementById('tutorial-modal').classList.remove('hidden'); }
        function closeTutorial() { document.getElementById('tutorial-modal').classList.add('hidden'); }

        function startCountdown() {
            let minutes = 14; let seconds = 59;
            const el = document.getElementById('countdown');
            setInterval(() => {
                if (seconds === 0) { if (minutes === 0) return; minutes--; seconds = 59; } else { seconds--; }
                el.innerText = `${minutes}:${seconds < 10 ? '0' + seconds : seconds}`;
            }, 1000);
        }

        function startSocialProof() {
            const buyers = ["Carlos R.", "Ana M.", "StartUp Inc", "David L.", "Sofia P.", "Agencia Flow", "Mario B."];
            const locations = ["Madrid", "CDMX", "Santiago", "Bogot√°", "Lima", "Miami", "Barcelona", "Buenos Aires", "Medell√≠n"];
            const toast = document.getElementById('sales-toast');

            const showNotification = () => {
                const name = buyers[Math.floor(Math.random() * buyers.length)];
                const location = locations[Math.floor(Math.random() * locations.length)];
                const timeAgo = Math.random() > 0.7 ? "Hace instantes" : `Hace ${Math.floor(Math.random() * 10) + 1} min`;

                toast.innerHTML = `
                <div class="bg-white/95 backdrop-blur border border-slate-100 p-3 rounded-xl shadow-lg flex items-center gap-3 max-w-xs ring-1 ring-black/5 transform transition-all hover:scale-105 cursor-pointer" onclick="openPaywall()">
                    <div class="w-8 h-8 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white font-bold text-xs relative shadow-md shrink-0">
                        ${name.charAt(0)}
                        <span class="absolute bottom-0 right-0 w-2.5 h-2.5 bg-green-400 rounded-full border-2 border-white animate-pulse"></span>
                    </div>
                    <div>
                        <p class="text-xs text-slate-600 leading-tight"><span class="font-bold text-slate-900">${name}</span> compr√≥ Pack</p>
                        <p class="text-[9px] text-slate-400 font-bold mt-0.5 flex items-center gap-1">${timeAgo} ‚Ä¢ ${location}</p>
                    </div>
                </div>`;

                toast.classList.remove('opacity-0', 'translate-y-24');
                setTimeout(() => { toast.classList.add('opacity-0', 'translate-y-24'); }, 5000);
            };

            setTimeout(showNotification, 4000);
            const loop = () => {
                const nextTime = Math.floor(Math.random() * (35000 - 12000 + 1) + 12000);
                setTimeout(() => { showNotification(); loop(); }, nextTime);
            };
            loop();
        }

        // --- UTILIDAD DE FORMATEO VISUAL (Reparaci√≥n de Tablas Markdown) ---
        function formatPreviewTable(htmlContent) {
            if (!htmlContent) return "";

            // Si el contenido es corto o no tiene pipes escapados/reales, devolver original
            if (!htmlContent.includes("&#124;") && !htmlContent.includes("|")) return htmlContent;

            // 1. Normalizar contenido: quitar wrappers div y convertir <br> a \n
            let cleanText = htmlContent.replace(/<div[^>]*>/gi, "")
                .replace(/<\/div>/gi, "")
                .replace(/<br\s*\/?>/gi, "\n");

            // 2. Decodificar entidades de pipe
            cleanText = cleanText.replace(/&#124;/g, "|");

            // 3. Analizar l√≠neas para ver si es una tabla candidato
            const lines = cleanText.split('\n').filter(l => l.trim().length > 0);

            // Heur√≠stica: Si tiene pipes, intentamos renderizar como tabla
            // Buscamos al menos una l√≠nea con pipes separadores
            const hasPipes = lines.some(l => l.includes('|'));
            if (!hasPipes) return htmlContent;

            try {
                let tableHTML = '<div class="overflow-x-auto my-3 rounded-xl border border-slate-200 shadow-sm"><table class="w-full text-xs text-left border-collapse bg-white">';
                let inTbody = false;
                let headerProcessed = false;

                lines.forEach((line, index) => {
                    const trimmed = line.trim();
                    // Ignorar l√≠neas separadoras de markdown |---|---|
                    if (trimmed.match(/^\|?[\s-:]+\|[\s-:]+\|?$/) || trimmed.match(/^[\s-:]+\|[\s-:]+$/)) {
                        return;
                    }

                    // Separar celdas (ignorando pipes inicial/final si existen)
                    let cells = trimmed.split('|');
                    // Limpieza de celdas vac√≠as provocadas por pipes al inicio/final
                    if (trimmed.startsWith('|')) cells.shift();
                    if (trimmed.endsWith('|')) cells.pop();

                    if (cells.length === 0) return;

                    if (!headerProcessed) {
                        tableHTML += '<thead class="bg-indigo-50/80 text-indigo-900 font-bold border-b border-indigo-100"><tr>';
                        cells.forEach(c => tableHTML += `<th class="p-3 border-r border-indigo-100/50 last:border-0 whitespace-nowrap first:rounded-tl-lg last:rounded-tr-lg">${c.trim()}</th>`);
                        tableHTML += '</tr></thead><tbody class="divide-y divide-slate-100">';
                        inTbody = true;
                        headerProcessed = true;
                    } else {
                        tableHTML += '<tr class="hover:bg-slate-50 transition-colors group">';
                        cells.forEach(c => {
                            // Procesar formato interno b√°sico
                            let content = c.trim()
                                .replace(/&quot;/g, '"')
                                .replace(/<strong>/g, '<span class="font-bold text-slate-800">')
                                .replace(/<\/strong>/g, '</span>')
                                .replace(/\*\*(.*?)\*\*/g, '<span class="font-bold text-slate-800">$1</span>');

                            tableHTML += `<td class="p-3 border-r border-slate-100 last:border-0 align-top leading-relaxed text-slate-600 group-hover:text-slate-800">${content}</td>`;
                        });
                        tableHTML += '</tr>';
                    }
                });

                if (inTbody) tableHTML += '</tbody>';
                tableHTML += '</table></div>';

                // Si la tabla qued√≥ vac√≠a (fall√≥ el parseo), fallback al original
                if (!inTbody) return htmlContent;

                return tableHTML;

            } catch (e) {
                console.warn("Error formateando tabla:", e);
                return htmlContent; // Fallback seguro
            }
        }
    </script>

</body>

</html>