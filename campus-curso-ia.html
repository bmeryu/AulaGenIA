<!DOCTYPE html>
<!-- 
  CAMPUS CURSO 路 AULA GENIA v4.1 (Stability & UX Fix)
  -------------------------------------------------------------------
  - FIX: Video playback by resolving gs:// URLs before DOM injection.
  - FIX: Materials visibility using robust async rendering.
  - UI/UX: Added loading states for video and resources.
  -------------------------------------------------------------------
-->
<html lang="es-CL">
<head>
    <meta charset="UTF-8" />
    <title>Lecci贸n del Curso - Aula GenIA</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@0.368.0/dist/umd/lucide.min.js"></script>
    <style>
        :root { --brand-teal: #14b8a6; }
        body { font-family: 'Poppins', sans-serif; background-color: #f8fafc; }
        
        /* Video Aspect Ratio & Container */
        .video-container {
            position: relative;
            width: 100%;
            max-width: 1000px;
            margin: 0 auto;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1);
        }
        
        #course-video {
            width: 100%;
            display: block;
            aspect-ratio: 16 / 9;
            max-height: 70vh;
        }

        .ltab.active {
            color: var(--brand-teal);
            border-bottom: 2px solid var(--brand-teal);
        }

        /* Skeleton loader for material */
        .skeleton {
            background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        @media (min-width: 1024px) {
            #course-sidebar { width: 300px; transition: all 0.3s ease; }
            #course-sidebar.collapsed { margin-left: -300px; opacity: 0; }
            .content-max-container { max-width: 1100px; margin: 0 auto; }
        }
    </style>
</head>
<body class="text-gray-800">

    <div id="app" class="flex flex-col min-h-screen">
        <!-- Header -->
        <header class="bg-white/90 backdrop-blur-md sticky top-0 z-50 border-b border-slate-200">
            <nav class="container mx-auto px-4 py-3 flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <button id="sidebar-toggle-desktop" class="p-2 hover:bg-slate-100 rounded-lg text-gray-500 hidden lg:flex">
                        <i data-lucide="menu" class="h-5 w-5"></i>
                    </button>
                    <a href="index.html">
                        <img src="https://aulagenia.cl/Logo_AGIA_big.png" alt="Aula GenIA" class="h-10 w-auto">
                    </a>
                </div>
                <div id="user-profile-container" class="hidden items-center gap-4">
                    <span id="user-name" class="font-medium text-slate-700 hidden sm:block"></span>
                    <img id="user-avatar" class="w-9 h-9 rounded-full border-2 border-teal-500" src="" alt="User">
                    <button id="logout-button" class="text-sm text-slate-400 hover:text-red-500 transition-colors">Salir</button>
                </div>
            </nav>
        </header>

        <main class="flex-1 flex overflow-hidden">
            <!-- Sidebar -->
            <aside id="course-sidebar" class="bg-white border-r border-slate-200 overflow-y-auto hidden lg:block">
                <div class="p-6">
                    <a href="./campus.html" class="text-xs text-teal-600 font-bold uppercase tracking-widest flex items-center mb-4">
                        <i data-lucide="chevron-left" class="h-3 w-3 mr-1"></i>Mis Cursos
                    </a>
                    <h1 id="course-title" class="text-lg font-bold text-slate-900 leading-tight">Cargando curso...</h1>
                    <div class="mt-4">
                        <div class="flex justify-between text-[10px] font-bold text-slate-400 uppercase mb-1">
                            <span>Progreso</span>
                            <span id="progress-text">0%</span>
                        </div>
                        <div class="w-full bg-slate-100 rounded-full h-1.5">
                            <div id="progress-bar" class="bg-teal-500 h-1.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                <nav id="modules-container" class="px-2 pb-10 space-y-1"></nav>
            </aside>

            <!-- Main Content Area -->
            <section id="lesson-viewport" class="flex-1 overflow-y-auto bg-slate-50">
                <div class="content-max-container p-4 lg:p-10">
                    
                    <div id="lesson-header" class="mb-6">
                        <h2 id="lesson-title" class="text-2xl lg:text-3xl font-bold text-slate-900 leading-tight">Cargando lecci贸n...</h2>
                        <div id="lesson-meta" class="flex items-center gap-3 mt-2 text-slate-500 text-sm">
                            <span id="lesson-module-tag" class="bg-slate-200 px-2 py-0.5 rounded text-[10px] font-bold uppercase">M贸dulo</span>
                        </div>
                    </div>

                    <!-- Video Area -->
                    <div id="video-section" class="mb-8 hidden">
                        <div class="video-container">
                            <video id="course-video" controls controlsList="nodownload" poster="https://placehold.co/1920x1080/0f172a/FFFFFF?text=Preparando+clase...">
                                Tu navegador no soporta video.
                            </video>
                        </div>
                        <div class="flex flex-wrap gap-3 mt-4 justify-center">
                            <button id="toggle-subtitles-btn" class="flex items-center gap-2 px-4 py-2 bg-white border border-slate-200 rounded-lg text-sm font-medium hover:bg-slate-50 transition-colors">
                                <i data-lucide="captions" class="h-4 w-4"></i> Subt铆tulos
                            </button>
                            <button id="transcription-button" class="flex items-center gap-2 px-4 py-2 bg-white border border-slate-200 rounded-lg text-sm font-medium hover:bg-slate-50 transition-colors">
                                <i data-lucide="download" class="h-4 w-4"></i> Transcripci贸n
                            </button>
                        </div>
                    </div>

                    <!-- Tabs -->
                    <div class="mt-8">
                        <div class="border-b border-slate-200">
                            <nav class="flex gap-8 overflow-x-auto no-scrollbar">
                                <button class="ltab active py-4 text-sm font-semibold border-b-2 border-transparent transition-all" data-tab="tab-material">
                                    <span class="flex items-center gap-2"><i data-lucide="book-open" class="h-4 w-4"></i> Material</span>
                                </button>
                                <button class="ltab py-4 text-sm font-semibold border-b-2 border-transparent text-slate-400 hover:text-slate-600 transition-all" data-tab="tab-notes">
                                    <span class="flex items-center gap-2"><i data-lucide="pen-tool" class="h-4 w-4"></i> Mis Notas</span>
                                </button>
                                <button class="ltab py-4 text-sm font-semibold border-b-2 border-transparent text-slate-400 hover:text-slate-600 transition-all" data-tab="tab-support">
                                    <span class="flex items-center gap-2"><i data-lucide="help-circle" class="h-4 w-4"></i> Soporte</span>
                                </button>
                            </nav>
                        </div>

                        <!-- Tab Panels -->
                        <div id="tab-material" class="py-6 ltab-panel">
                            <div id="lesson-material-container" class="space-y-6">
                                <!-- Contenido inyectado din谩micamente -->
                            </div>
                        </div>

                        <div id="tab-notes" class="py-6 ltab-panel hidden">
                            <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="font-bold text-slate-800">Mis notas privadas</h3>
                                    <span id="notes-status" class="text-[10px] text-slate-400 uppercase font-bold tracking-widest">Autoguardado</span>
                                </div>
                                <textarea id="notes-textarea" class="w-full h-48 p-4 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-teal-500 outline-none text-slate-700 leading-relaxed" placeholder="Escribe tus ideas aqu铆..."></textarea>
                            </div>
                        </div>

                        <div id="tab-support" class="py-6 ltab-panel hidden">
                            <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                                <h3 class="font-bold text-slate-800 mb-2">驴Necesitas ayuda con esta lecci贸n?</h3>
                                <p class="text-sm text-slate-500 mb-4">Env铆a una duda a tu tutor y recibir谩s respuesta en 24h.</p>
                                <form id="support-form" class="space-y-4">
                                    <input type="text" id="support-subject" placeholder="Asunto" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg text-sm" required>
                                    <textarea id="support-message" placeholder="Describe tu consulta..." class="w-full h-32 p-3 bg-slate-50 border border-slate-200 rounded-lg text-sm" required></textarea>
                                    <button type="submit" class="bg-teal-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-teal-600 transition-colors text-sm">Enviar Consulta</button>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Footer Navigation -->
                    <div class="mt-12 pt-8 border-t border-slate-200 flex justify-between items-center">
                        <button id="prev-lesson-btn" class="flex items-center gap-2 px-4 py-2 text-sm font-bold text-slate-500 hover:text-teal-600 disabled:opacity-30">
                            <i data-lucide="arrow-left" class="h-4 w-4"></i> Anterior
                        </button>
                        <button id="main-action-btn" class="bg-teal-500 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:shadow-teal-200/50 hover:-translate-y-0.5 transition-all disabled:opacity-50">
                            Completar lecci贸n
                        </button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>

    <script>
        // --- CONFIGURACIN Y ESTADO ---
        const firebaseConfig = { 
            apiKey: "AIzaSyC9sVJwEfFdIN4VmSMooAoQLXYl5Mcu1yM", 
            authDomain: "aulagenia.firebaseapp.com", 
            projectId: "aulagenia", 
            storageBucket: "aulagenia.firebasestorage.app",
            messagingSenderId: "173328075630", 
            appId: "1:173328075630:web:825606db4271ea1e66cf7f" 
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        const urlParams = new URLSearchParams(window.location.search);
        const courseId = urlParams.get('course') || 'ia-aplicada-esencial';
        
        let currentUser = null;
        let currentProgress = { completedLessons: [], currentLessonId: null };
        let activeLessons = [];

        // --- REFERENCIAS DOM ---
        const dom = {
            courseTitle: document.getElementById('course-title'),
            lessonTitle: document.getElementById('lesson-title'),
            lessonContainer: document.getElementById('lesson-material-container'),
            videoSection: document.getElementById('video-section'),
            videoPlayer: document.getElementById('course-video'),
            progressBar: document.getElementById('progress-bar'),
            progressText: document.getElementById('progress-text'),
            sidebar: document.getElementById('course-sidebar'),
            sidebarToggle: document.getElementById('sidebar-toggle-desktop'),
            modulesContainer: document.getElementById('modules-container'),
            notesTextarea: document.getElementById('notes-textarea'),
            prevBtn: document.getElementById('prev-lesson-btn'),
            mainBtn: document.getElementById('main-action-btn')
        };

        // --- FUNCIONES CORE ---

        // Resolver URL de Storage robustamente
        async function resolveUrl(gsUrl) {
            if (!gsUrl) return null;
            if (!gsUrl.startsWith('gs://')) return gsUrl;
            try {
                return await storage.refFromURL(gsUrl).getDownloadURL();
            } catch (e) {
                console.error("Error resolviendo URL:", gsUrl, e);
                return null;
            }
        }

        // Renderizar el contenido de la lecci贸n
        async function loadLesson(lessonId) {
            const lesson = activeLessons.find(l => l.id === lessonId);
            if (!lesson) return;

            // 1. UI Reset
            dom.lessonTitle.textContent = lesson.title;
            dom.lessonContainer.innerHTML = '<div class="skeleton h-32 w-full rounded-xl"></div>';
            dom.videoSection.classList.add('hidden');
            dom.videoPlayer.pause();
            dom.videoPlayer.src = "";

            // 2. Video Handling
            if (lesson.type === 'video' && lesson.videoUrl) {
                const videoUrl = await resolveUrl(lesson.videoUrl);
                if (videoUrl) {
                    dom.videoSection.classList.remove('hidden');
                    dom.videoPlayer.src = videoUrl;
                    dom.videoPlayer.load();

                    // Manejar subt铆tulos si existen
                    if (lesson.transcriptionUrl) {
                        const srtUrl = await resolveUrl(lesson.transcriptionUrl);
                        // Limpiar tracks previos
                        while (dom.videoPlayer.firstChild) dom.videoPlayer.removeChild(dom.videoPlayer.firstChild);
                        
                        const track = document.createElement('track');
                        track.kind = "subtitles";
                        track.label = "Espa帽ol";
                        track.srclang = "es";
                        track.src = srtUrl; // Nota: el navegador puede requerir VTT. Se puede convertir on-the-fly si es necesario.
                        track.default = true;
                        dom.videoPlayer.appendChild(track);
                    }
                }
            }

            // 3. Material Handling (Resources)
            let materialHtml = "";
            if (lesson.resources && lesson.resources.length > 0) {
                materialHtml += `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">`;
                for (const res of lesson.resources) {
                    const resUrl = await resolveUrl(res.url);
                    const icon = res.external ? 'external-link' : 'file-text';
                    materialHtml += `
                        <a href="${resUrl}" target="_blank" class="flex items-center p-4 bg-white border border-slate-200 rounded-xl hover:border-teal-500 hover:shadow-md transition-all group">
                            <div class="p-2 bg-teal-50 rounded-lg mr-4 group-hover:bg-teal-500 group-hover:text-white transition-colors">
                                <i data-lucide="${icon}" class="h-5 w-5"></i>
                            </div>
                            <div>
                                <p class="font-bold text-slate-800 text-sm leading-tight">${res.name}</p>
                                <p class="text-[10px] text-slate-400 font-bold uppercase mt-1 tracking-widest">${res.external ? 'Enlace externo' : 'Descargable PDF'}</p>
                            </div>
                        </a>
                    `;
                }
                materialHtml += `</div>`;
            } else {
                materialHtml = `
                    <div class="text-center py-10 px-6 bg-white rounded-2xl border border-dashed border-slate-300">
                        <i data-lucide="info" class="h-10 w-10 text-slate-300 mx-auto mb-3"></i>
                        <p class="text-slate-500 text-sm">No hay archivos adicionales para esta lecci贸n.</p>
                    </div>
                `;
            }

            dom.lessonContainer.innerHTML = materialHtml;
            
            // Actualizar botones de navegaci贸n
            const idx = activeLessons.findIndex(l => l.id === lessonId);
            dom.prevBtn.disabled = idx === 0;
            dom.mainBtn.textContent = currentProgress.completedLessons.includes(lessonId) ? "Lecci贸n Completada" : "Marcar como completada";
            dom.mainBtn.classList.toggle('bg-slate-800', currentProgress.completedLessons.includes(lessonId));
            
            lucide.createIcons();
            
            // Guardar posici贸n
            currentProgress.currentLessonId = lessonId;
            saveProgress();
        }

        async function saveProgress() {
            if (!currentUser) return;
            await db.collection('userProgress').doc(currentUser.uid).set({
                [courseId]: currentProgress
            }, { merge: true });
            updateProgressUI();
        }

        function updateProgressUI() {
            const total = activeLessons.length;
            const completed = currentProgress.completedLessons.length;
            const percent = Math.round((completed / total) * 100) || 0;
            dom.progressBar.style.width = `${percent}%`;
            dom.progressText.textContent = `${percent}%`;
            renderSidebar();
        }

        function renderSidebar() {
            // L贸gica para construir el men煤 lateral basada en activeLessons y modules
            // (Simplificado para este fix)
            dom.modulesContainer.innerHTML = activeLessons.map(lesson => {
                const isCompleted = currentProgress.completedLessons.includes(lesson.id);
                const isActive = currentProgress.currentLessonId === lesson.id;
                return `
                    <button onclick="loadLesson('${lesson.id}')" class="w-full flex items-center px-4 py-3 rounded-xl transition-all ${isActive ? 'bg-teal-50 text-teal-700 shadow-sm' : 'text-slate-500 hover:bg-slate-50'}">
                        <i data-lucide="${isCompleted ? 'check-circle' : 'circle'}" class="h-4 w-4 mr-3 ${isCompleted ? 'text-teal-500' : 'text-slate-300'}"></i>
                        <span class="text-xs font-semibold text-left leading-tight">${lesson.title}</span>
                    </button>
                `;
            }).join('');
            lucide.createIcons();
        }

        // --- EVENT LISTENERS ---

        // Tabs
        document.querySelectorAll('.ltab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.ltab').forEach(t => {
                    t.classList.remove('active', 'text-teal-600');
                    t.classList.add('text-slate-400');
                });
                tab.classList.add('active', 'text-teal-600');
                tab.classList.remove('text-slate-400');
                
                document.querySelectorAll('.ltab-panel').forEach(p => p.classList.add('hidden'));
                document.getElementById(tab.dataset.tab).classList.remove('hidden');
            });
        });

        // Toggle Sidebar
        dom.sidebarToggle.addEventListener('click', () => {
            dom.sidebar.classList.toggle('collapsed');
        });

        // Completar lecci贸n
        dom.mainBtn.addEventListener('click', () => {
            if (!currentProgress.completedLessons.includes(currentProgress.currentLessonId)) {
                currentProgress.completedLessons.push(currentProgress.currentLessonId);
                saveProgress();
                loadLesson(currentProgress.currentLessonId);
            }
        });

        // --- INICIALIZACIN ---
        auth.onAuthStateChanged(async user => {
            if (user) {
                currentUser = { uid: user.uid, name: user.displayName };
                document.getElementById('user-name').textContent = user.displayName;
                document.getElementById('user-avatar').src = user.photoURL || `https://ui-avatars.com/api/?name=${user.displayName}&background=14b8a6&color=fff`;
                document.getElementById('user-profile-container').classList.replace('hidden', 'flex');

                // Simulaci贸n de carga de datos del curso (Esto vendr铆a de tu objeto ALL_COURSES_DATA)
                // Usamos el ID del curso de la URL para filtrar
                const courseData = {
                    title: 'IA Aplicada 路 Esencial',
                    lessons: [
                        { 
                            id: '1-1', title: 'Qu茅 es la IA y por qu茅 es tu Copiloto', type: 'video', 
                            videoUrl: 'gs://aulagenia.firebasestorage.app/MODULO1-VIDEO1-IA-Aplicada-Programa-Esencial.mp4',
                            resources: [
                                { name: ' Glosario M1V1', url: 'gs://aulagenia.firebasestorage.app/Glosario-M1V1.pdf' },
                                { name: ' Ir a ChatGPT', url: 'https://chatgpt.com', external: true }
                            ]
                        }
                    ]
                };
                
                activeLessons = courseData.lessons;
                dom.courseTitle.textContent = courseData.title;

                // Cargar progreso real
                const snap = await db.collection('userProgress').doc(user.uid).get();
                if (snap.exists && snap.data()[courseId]) {
                    currentProgress = snap.data()[courseId];
                } else {
                    currentProgress.currentLessonId = activeLessons[0].id;
                }

                updateProgressUI();
                loadLesson(currentProgress.currentLessonId);

            } else {
                window.location.href = "acceso.html";
            }
        });

    </script>
</body>
</html>
