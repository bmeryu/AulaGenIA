<!DOCTYPE html>
<!-- 
  CAMPUS CURSO · AULA GENIA v3.7.1 (Quiz Review Mode)
  -------------------------------------------------------------------
  - ANALYST UPGRADE: Lógica de revisión de quizzes implementada.
  - FEATURE: Mantenido el bloqueo de módulos y quizzes.
  - NEW FEATURE: Una vez que un quiz es completado exitosamente, entra en 
    modo "revisión".
  - UX: Al revisitar un quiz completado, se muestran las respuestas 
    correctas de forma estática y no se puede volver a intentar, 
    reforzando el aprendizaje.
  - LOGIC: La función renderLessonContent ahora verifica si el ID de un 
    quiz ya está en el progreso del usuario antes de renderizarlo en modo
    interactivo o de revisión.
  -------------------------------------------------------------------
-->
<html lang="es-CL">
<head>
    <meta charset="UTF-8" />
    <title>Lección del Curso - Aula GenIA (Perfil Unificado)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="noindex, nofollow">
    <meta name="description" content="Continúa tu aprendizaje en el curso de Inteligencia Artificial Aplicada a Negocios.">
    <link rel="canonical" href="https://aulagenia.cl/campus-curso-ia.html">
    <link rel="icon" href="https://aulagenia.cl/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="https://aulagenia.cl/Logo_AGIA.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@0.368.0/dist/umd/lucide.min.js"></script>
    <style>
        :root { --brand-teal: #14b8a6; }
        body { font-family: 'Poppins', sans-serif; background-color: #f8fafc; }
        #profile-modal, .toast-notification, #completion-modal { transition: all 0.3s ease-in-out; }
        label span.required { color: #ef4444; }
        .form-input-error { @apply border-red-500 ring-red-500; }
        .error-message { @apply text-red-600 text-xs mt-1; }
        .toast-notification { position: fixed; top: 20px; right: 20px; transform: translateX(120%); z-index: 1000; }
        .toast-notification.show { transform: translateX(0); }
        #completion-modal.show > div { transform: scale(1); opacity: 1; }
        .quiz-option { transition: all 0.2s ease-in-out; }
        .quiz-option.selected { border-color: var(--brand-teal); background-color: #f0fdfa; box-shadow: 0 0 0 2px var(--brand-teal); }
        .quiz-option.correct { border-color: #22c55e; background-color: #f0fdf4; }
        .quiz-option.incorrect { border-color: #ef4444; background-color: #fef2f2; }
        
        .ltab.active {
            color: var(--brand-teal);
            border-bottom-color: var(--brand-teal);
        }
        .ltab-panel {
            @apply py-4;
        }

        #pdf-modal-overlay {
            transition: opacity 0.3s ease-in-out;
        }
        #pdf-modal-content {
            transition: all 0.3s ease-in-out;
        }
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        details[open] summary .arrow-down { transform: rotate(180deg); }
        .arrow-down { transition: transform 0.2s ease-in-out; }
        .accordion-content {
            display: none;
        }
        .accordion-content.open {
            display: block;
        }
    </style>
</head>
<body class="text-gray-800">

    <div id="app" class="flex flex-col min-h-screen">
        <header class="bg-white/80 backdrop-blur-lg sticky top-0 z-50 shadow-sm">
            <nav class="container mx-auto px-6 py-3 flex justify-between items-center">
                <a href="index.html" class="flex items-center" aria-label="Página de inicio de Aula GenIA">
                    <img src="https://aulagenia.cl/Logo_AGIA_big.png" alt="Logo de Aula GenIA" class="h-20 w-auto">
                </a>
                <div class="flex items-center gap-2 sm:gap-4">
                    <a href="quienes-somos.html" class="text-gray-700 font-semibold border-2 border-gray-300 rounded-full px-3 text-xs py-2 sm:px-5 sm:text-sm hover:bg-gray-100 hover:border-gray-400 transition-colors duration-300 hidden md:flex items-center">
                        Quiénes Somos
                    </a>
                    <a href="cursos.html" class="text-teal-600 font-semibold border-2 border-teal-500 rounded-full px-3 text-xs py-2 sm:px-5 sm:text-sm hover:bg-teal-500 hover:text-white transition-colors duration-300 flex items-center">
                        Ver Cursos
                    </a>
                    <div id="user-profile-container" class="hidden items-center gap-3 relative">
                        <span class="font-semibold text-gray-700 hidden sm:block" id="user-name"></span>
                        <div class="relative group">
                            <button id="avatar-button" aria-label="Abrir menú de perfil">
                                <img id="user-avatar" alt="Avatar del usuario" class="w-10 h-10 rounded-full border-2 border-teal-500 cursor-pointer group-hover:opacity-90 transition-opacity" />
                            </button>
                        </div>
                        <button id="logout-button" class="text-sm text-gray-500 hover:text-red-600 font-medium transition-colors">Cerrar sesión</button>
                    </div>
                </div>
            </nav>
        </header>

        <main class="flex-1 flex flex-col lg:flex-row overflow-hidden">
            <aside id="course-sidebar" class="w-full lg:w-80 xl:w-96 bg-white border-r border-slate-200 flex-shrink-0 overflow-y-auto">
                <div class="p-6">
                    <a href="./campus.html" class="text-sm text-teal-600 hover:text-teal-700 font-semibold flex items-center mb-4"><i data-lucide="arrow-left" class="h-4 w-4 mr-2"></i>Volver a Mis Cursos</a>
                    <h1 id="course-title" class="text-2xl font-bold text-gray-900">Cargando...</h1>
                    <div class="mt-4">
                        <div class="flex justify-between text-sm font-medium text-gray-600 mb-1"><span>Progreso</span><span id="progress-text">0%</span></div>
                        <div class="w-full bg-slate-200 rounded-full h-2.5"><div id="progress-bar" class="bg-teal-500 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div></div>
                    </div>
                </div>
                <nav id="modules-container" class="space-y-1 px-2 pb-6"></nav>
            </aside>

            <section id="lesson-content" class="flex-1 bg-slate-50 overflow-y-auto">
                <div class="p-6 md:p-8 lg:p-10">
                    <h2 id="lesson-title" class="text-3xl font-bold text-gray-900 mb-2">Cargando...</h2>
                    
                    <div id="learning-tabs" class="mt-8">
                        <div class="border-b border-slate-200 mb-4">
                            <nav class="-mb-px flex gap-6 text-sm font-medium overflow-x-auto">
                                <button class="ltab active px-2 py-2 border-b-2 border-transparent text-slate-500 hover:text-teal-600 whitespace-nowrap" data-tab="tab-material">
                                    <span class="inline-flex items-center gap-2"><i data-lucide="book-open" class="h-4 w-4"></i>Material</span>
                                </button>
                                <button class="ltab px-2 py-2 border-b-2 border-transparent text-slate-500 hover:text-teal-600 whitespace-nowrap" data-tab="tab-notes">
                                    <span class="inline-flex items-center gap-2"><i data-lucide="notebook-pen" class="h-4 w-4"></i>Notas</span>
                                </button>
                                <button class="ltab px-2 py-2 border-b-2 border-transparent text-slate-500 hover:text-teal-600 whitespace-nowrap" data-tab="tab-resources">
                                    <span class="inline-flex items-center gap-2"><i data-lucide="folder-down" class="h-4 w-4"></i>Recursos</span>
                                </button>
                                <button class="ltab px-2 py-2 border-b-2 border-transparent text-slate-500 hover:text-teal-600 whitespace-nowrap" data-tab="tab-tasks">
                                    <span class="inline-flex items-center gap-2"><i data-lucide="check-square" class="h-4 w-4"></i>Tareas</span>
                                </button>
                                <button class="ltab px-2 py-2 border-b-2 border-transparent text-slate-500 hover:text-teal-600 whitespace-nowrap" data-tab="tab-support">
                                    <span class="inline-flex items-center gap-2"><i data-lucide="message-square-heart" class="h-4 w-4"></i>Soporte y Tutoría</span>
                                </button>
                            </nav>
                        </div>

                        <div id="tab-material" class="ltab-panel">
                             <div id="lesson-material-container" class="mb-6"></div>
                        </div>

                        <div id="tab-notes" class="ltab-panel hidden">
                            <div class="grid gap-3">
                                <div class="flex items-center justify-between">
                                    <h3 class="text-lg font-semibold text-gray-900">Tus notas de esta lección</h3>
                                    <span id="notes-save-status" class="text-xs text-slate-500 transition-opacity">Sin cambios</span>
                                </div>
                                <textarea id="notes-textarea" class="w-full min-h-[160px] rounded-lg border border-slate-300 p-3 focus:outline-none focus:ring-2 focus:ring-teal-500" placeholder="Escribe aquí tus ideas, resúmenes o preguntas..."></textarea>
                                <div class="flex gap-3 text-xs text-slate-500">
                                    <span class="inline-flex items-center gap-1"><i data-lucide="cloud" class="h-4 w-4"></i>Guardado automático</span>
                                </div>
                            </div>
                        </div>

                        <div id="tab-resources" class="ltab-panel hidden">
                            <div class="space-y-4">
                                <h3 class="text-lg font-semibold text-gray-900">Recursos de la lección</h3>
                                <div id="resources-list" class="space-y-3"></div>
                                <div class="p-4 border-t border-slate-200 mt-6">
                                    <h4 class="text-base font-semibold text-gray-800 mb-2">Sube tus propios archivos</h4>
                                    <div class="flex items-center gap-3">
                                        <input id="resource-file-input" type="file" class="block w-full text-sm text-slate-700 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-teal-50 file:text-teal-700 hover:file:bg-teal-100" multiple />
                                        <button id="upload-resources-btn" class="px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700 disabled:opacity-50" disabled>
                                            <i data-lucide="upload" class="h-4 w-4"></i>
                                        </button>
                                    </div>
                                    <div id="upload-progress" class="hidden text-sm text-slate-600 mt-2"></div>
                                    <ul id="user-resource-list" class="mt-4 divide-y divide-slate-200 bg-white rounded-lg border border-slate-200"></ul>
                                </div>
                            </div>
                        </div>

                        <div id="tab-tasks" class="ltab-panel hidden">
                            <div class="space-y-4">
                                <h3 class="text-lg font-semibold text-gray-900">Checklist de práctica</h3>
                                <div class="flex gap-2">
                                    <input id="task-input" type="text" class="flex-1 rounded-lg border border-slate-300 p-2 focus:outline-none focus:ring-2 focus:ring-teal-500" placeholder="Ej: Probar un prompt en Gemini..." />
                                    <button id="add-task-btn" class="px-3 py-2 bg-slate-800 text-white rounded-lg hover:bg-slate-900">Agregar</button>
                                </div>
                                <ul id="task-list" class="space-y-2"></ul>
                                <p class="text-xs text-slate-500">Tus tareas quedan guardadas por lección.</p>
                            </div>
                        </div>

                        <div id="tab-support" class="ltab-panel hidden">
                            <div class="bg-white p-6 rounded-lg border border-slate-200">
                                <h3 class="text-xl font-bold text-gray-900">Habla con tu Tutor</h3>
                                <p class="text-gray-600 mt-1 mb-6">Estamos aquí para ayudarte a resolver cualquier duda. Describe tu consulta y un tutor de nuestro equipo te responderá directamente a tu correo en un plazo de 24 a 48 horas hábiles.</p>
                                
                                <form id="support-form">
                                    <div class="space-y-4">
                                        <div>
                                            <label for="support-subject" class="block text-sm font-medium text-gray-700 mb-1">Asunto</label>
                                            <input type="text" id="support-subject" name="subject" class="w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500" placeholder="Ej: Duda sobre el Módulo 2" required>
                                        </div>
                                        <div>
                                            <label for="support-message" class="block text-sm font-medium text-gray-700 mb-1">Tu mensaje</label>
                                            <textarea id="support-message" name="message" rows="5" class="w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500" placeholder="Describe tu pregunta o el feedback que necesitas aquí..." required></textarea>
                                        </div>
                                    </div>
                                    <div class="mt-6 flex justify-end">
                                        <button type="submit" id="support-submit-btn" class="bg-teal-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-teal-600 transition-colors flex items-center gap-2">
                                            <span id="support-btn-text">Enviar Consulta</span>
                                            <i id="support-spinner" data-lucide="loader-2" class="h-5 w-5 animate-spin hidden"></i>
                                        </button>
                                    </div>
                                </form>
                                <div id="support-form-status" class="mt-4 text-center"></div>
                            </div>
                        </div>

                    </div>

                    <div id="navigation-buttons" class="mt-8 pt-6 border-t border-slate-200 flex justify-between items-center">
                        <button id="prev-lesson-btn" class="px-4 py-2 text-sm font-semibold text-gray-700 bg-white border border-slate-300 rounded-lg shadow-sm hover:bg-slate-100 disabled:opacity-50 disabled:cursor-not-allowed">Lección Anterior</button>
                        <button id="main-action-btn" class="px-6 py-3 text-sm font-semibold text-white bg-teal-500 rounded-lg shadow-sm hover:bg-teal-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 disabled:opacity-50 disabled:cursor-not-allowed">Marcar como completada</button>
                    </div>
                </div>
            </section>
        </main>
        
        <footer class="bg-gray-100 border-t border-gray-200 mt-auto">
            <div class="container mx-auto px-6 py-8 text-center text-gray-600">
                <a href="index.html" class="flex items-center justify-center mb-4">
                    <img src="https://aulagenia.cl/Logo_AGIA_big.png" alt="Logo de Aula GenIA al pie de página" class="h-12 w-auto">
                </a>
                <div class="flex justify-center items-center gap-6 mb-4">
                    <a href="https://instagram.com" target="_blank" rel="noopener noreferrer" aria-label="Instagram de Aula GenIA" class="text-gray-500 hover:text-gray-800 transition-colors">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.85s-.011 3.584-.069 4.85c-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07s-3.584-.012-4.85-.07c-3.252-.148-4.771-1.691-4.919-4.919-.058-1.265-.069-1.645-.069-4.85s.011-3.584.069-4.85c.149-3.225 1.664-4.771 4.919-4.919C8.416 2.175 8.796 2.163 12 2.163zm0 1.802c-3.116 0-3.483.01-4.71.068-2.69.123-3.996 1.428-4.12 4.12C3.12 9.483 3.11 9.85 3.11 12s.01 2.517.068 3.74c.124 2.692 1.43 3.996 4.12 4.12 1.227.058 1.594.068 4.71.068s3.483-.01 4.71-.068c2.69-.124 3.996-1.428 4.12-4.12.058-1.223.068-1.594.068-4.71s-.01-2.517-.068-3.74c-.124-2.692-1.43-3.996-4.12-4.12C15.483 3.973 15.116 3.965 12 3.965zM12 8.25a3.75 3.75 0 100 7.5 3.75 3.75 0 000-7.5zm0 5.698a1.948 1.948 0 110-3.896 1.948 1.948 0 010 3.896zM16.838 7.162a.96.96 0 100 1.92.96.96 0 000-1.92z"/></svg>
                    </a>
                    <a href="https://linkedin.com" target="_blank" rel="noopener noreferrer" aria-label="LinkedIn de Aula GenIA" class="text-gray-500 hover:text-gray-800 transition-colors">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/></svg>
                    </a>
                </div>
                <div class="text-sm space-x-4">
                    <button id="open-faq-modal" class="hover:underline">Preguntas Frecuentes</button>
                    <span>&bull;</span>
                    <button id="open-cookies-modal" class="hover:underline">Política de Cookies</button>
                </div>
                <p class="text-sm mt-4">&copy; 2024 Aula GenIA - Todos los derechos reservados.</p>
            </div>
        </footer>
    </div>

    <!-- Modales y notificaciones -->
    <div id="profile-modal-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden z-40"></div>
    <div id="profile-modal" class="fixed inset-0 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg flex flex-col transform transition-all scale-95 opacity-0 max-h-[90vh]">
            <div class="p-8 flex-shrink-0">
                <div class="flex justify-between items-start">
                    <div>
                        <h3 id="profile-modal-title" class="text-2xl font-bold text-gray-900">Editar Perfil</h3>
                        <p id="profile-modal-subtitle" class="text-gray-600 mt-1">Mantén tus datos actualizados.</p>
                    </div>
                    <button id="close-profile-modal-btn" class="text-gray-400 hover:text-gray-600">&times;</button>
                </div>
            </div>
            
            <div class="px-8 pb-4 flex-grow overflow-y-auto">
                <form id="profile-form" class="space-y-4">
                    <div>
                        <label for="profile-name-input" class="block text-sm font-medium text-gray-700 mb-1">Nombre Completo <span class="required">*</span></label>
                        <input type="text" id="profile-name-input" name="fullName" class="w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500" placeholder="Ej: Ada Lovelace">
                        <p class="text-xs text-gray-500 mt-1"><strong>Importante:</strong> Este será el nombre que aparecerá en tu certificado.</p>
                        <div id="name-error" class="error-message"></div>
                    </div>
                    <div>
                        <label for="profile-rut-input" class="block text-sm font-medium text-gray-700 mb-1">RUT (Chile) <span class="required">*</span></label>
                        <input type="text" id="profile-rut-input" name="rut" class="w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500" placeholder="Ej: 12345678-9">
                        <p class="text-xs text-gray-500 mt-1">Requerido para la validez de tu certificado en Chile.</p>
                        <div id="rut-error" class="error-message"></div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="profile-gender-select" class="block text-sm font-medium text-gray-700 mb-1">Género</label>
                            <select id="profile-gender-select" name="gender" class="w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500">
                                <option value="">Seleccionar...</option>
                                <option value="female">Femenino</option>
                                <option value="male">Masculino</option>
                                <option value="other">Otro</option>
                                <option value="prefer_not-to-say">Prefiero no decir</option>
                            </select>
                        </div>
                        <div>
                            <label for="profile-birthdate-input" class="block text-sm font-medium text-gray-700 mb-1">Fecha de Nacimiento</label>
                            <input type="date" id="profile-birthdate-input" name="birthdate" class="w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500">
                        </div>
                    </div>
                    <div>
                        <label for="profile-email-input" class="block text-sm font-medium text-gray-700 mb-1">Correo Electrónico</label>
                        <input type="email" id="profile-email-input" class="w-full rounded-md border-gray-300 shadow-sm bg-gray-100 cursor-not-allowed" disabled>
                    </div>
                    <div>
                        <label for="profile-job-input" class="block text-sm font-medium text-gray-700 mb-1">Cargo o Profesión</label>
                        <input type="text" id="profile-job-input" name="jobTitle" class="w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500" placeholder="Ej: Estudiante, Desarrollador, etc.">
                    </div>
                    <div>
                        <label for="profile-country-select" class="block text-sm font-medium text-gray-700 mb-1">País <span class="required">*</span></label>
                        <select id="profile-country-select" name="country" class="w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500">
                            <option value="">Selecciona tu país</option>
                            <option value="CL">Chile</option>
                            <option value="AR">Argentina</option>
                            <option value="PE">Perú</option>
                            <option value="CO">Colombia</option>
                            <option value="MX">México</option>
                            <option value="ES">España</option>
                            <option value="US">Estados Unidos</option>
                            <option value="OT">Otro</option>
                        </select>
                        <div id="country-error" class="error-message"></div>
                    </div>
                    <div id="form-status" class="text-center p-3 rounded-lg hidden"></div>
                </form>
            </div>
            <div class="p-8 pt-4 flex-shrink-0">
                 <div class="flex justify-end gap-3 pt-4 border-t">
                    <button type="button" id="cancel-profile-btn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors">Cancelar</button>
                    <button type="submit" form="profile-form" id="save-profile-btn" class="bg-teal-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-600 transition-colors flex items-center gap-2">
                        <span id="save-btn-text">Guardar Cambios</span>
                        <i id="save-spinner" data-lucide="loader-2" class="h-5 w-5 animate-spin hidden"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div id="toast-notification" class="toast-notification bg-gray-800 text-white py-3 px-5 rounded-lg shadow-lg flex items-center gap-3"><i data-lucide="check-circle" class="text-teal-400"></i><span id="toast-message"></span></div><div id="badge-toast" class="toast-notification bg-gradient-to-br from-yellow-400 to-orange-500 text-white p-4 rounded-lg shadow-xl flex items-center gap-4"><i data-lucide="award" class="h-12 w-12 text-white"></i><div><h4 class="font-bold">¡Insignia Desbloqueada!</h4><p id="badge-message" class="text-sm"></p></div></div>
    
    <div id="completion-modal-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden z-40 opacity-0"></div>
    <div id="completion-modal" class="fixed inset-0 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-lg w-full text-center transform transition-all scale-95 opacity-0 duration-300">
            <i data-lucide="party-popper" class="mx-auto h-20 w-20 text-yellow-500"></i>
            <h2 class="text-3xl font-bold text-gray-900 mt-4">¡Felicitaciones, <span id="modal-user-name"></span>!</h2>
            <p class="text-gray-600 mt-2">Has completado exitosamente el curso "<span id="modal-course-name"></span>".</p>
            <div class="space-y-3 mt-6">
                <a id="certificate-link" href="#" class="hidden items-center justify-center gap-2 w-full text-center bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-5 rounded-lg transition-colors">
                    <i data-lucide="award" class="h-5 w-5"></i>
                    <span>Ver Certificado</span>
                </a>
                <button id="review-course-btn" class="block w-full text-sm text-gray-500 hover:text-teal-600 font-semibold transition-colors text-center py-2">Repasar Curso</button>
            </div>
            <button id="close-modal-btn" class="mt-8 w-full bg-gray-800 hover:bg-gray-900 text-white font-bold py-3 px-5 rounded-lg transition-colors">Volver al Campus</button>
        </div>
    </div>

    <div id="pdf-modal-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden z-40 opacity-0"></div>
    <div id="pdf-modal" class="fixed inset-0 hidden z-50 flex items-center justify-center p-4">
        <div id="pdf-modal-content" class="bg-white rounded-lg shadow-2xl w-full max-w-4xl h-full max-h-[90vh] flex flex-col transform transition-all scale-95 opacity-0">
            <header class="flex items-center justify-between p-4 border-b border-gray-200 flex-shrink-0">
                <h3 id="pdf-modal-title" class="text-lg font-semibold text-gray-800">Visor de Documentos</h3>
                <button id="pdf-modal-close-btn" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="h-6 w-6"></i>
                </button>
            </header>
            <div class="flex-grow p-2 bg-gray-200">
                <iframe id="pdf-iframe" class="w-full h-full border-0" src=""></iframe>
            </div>
        </div>
    </div>

    <div id="faq-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-[100] hidden">
        <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full relative p-6 md:p-8">
            <button id="close-faq-modal" aria-label="Cerrar modal" class="absolute top-4 right-4 bg-gray-100 rounded-full p-2 text-gray-700 hover:bg-gray-200 z-10">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <div class="text-center mb-8">
                <h2 class="text-3xl md:text-4xl font-bold">Preguntas Frecuentes</h2>
                <p class="text-gray-600 text-lg mt-2">Resolvemos tus dudas para que tomes la mejor decisión.</p>
            </div>
            <div class="space-y-4 max-h-[70vh] overflow-y-auto pr-4">
                <details class="bg-gray-50 p-6 rounded-lg group">
                    <summary class="flex justify-between items-center font-bold text-lg cursor-pointer">
                        ¿Necesito saber programar o tener experiencia previa?
                        <svg class="w-5 h-5 text-gray-500 arrow-down" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                        </svg>
                    </summary>
                    <p class="text-gray-600 mt-4">
                        ¡Para nada! Este curso está diseñado desde cero para principiantes.
                    </p>
                </details>
            </div>
        </div>
    </div>
    
    <div id="cookies-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-[100] hidden">
        <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full relative p-6 md:p-8">
            <button id="close-cookies-modal" aria-label="Cerrar modal" class="absolute top-4 right-4 bg-gray-100 rounded-full p-2 text-gray-700 hover:bg-gray-200 z-10">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <div class="prose lg:prose-xl max-h-[80vh] overflow-y-auto pr-4">
                <h1>Política de Cookies</h1>
                <p class="text-sm text-gray-500">Última actualización: 23 de agosto de 2025</p>
                <p>En Aula GenIA, utilizamos cookies y tecnologías similares…</p>
            </div>
        </div>
    </div>
    
    <!-- Firebase SDKs (sin defer) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-functions-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>

    <script defer>
        document.addEventListener('DOMContentLoaded', () => {
            const firebaseConfig = { 
                apiKey: "AIzaSyC9sVJwEfFdIN4VmSMooAoQLXYl5Mcu1yM", 
                authDomain: "aulagenia.firebaseapp.com", 
                projectId: "aulagenia", 
                storageBucket: "aulagenia.firebasestorage.app",
                messagingSenderId: "173328075630", 
                appId: "1:173328075630:web:825606db4271ea1e66cf7f" 
            };
            
            try { firebase.initializeApp(firebaseConfig); } catch(e) { console.warn("Firebase ya fue inicializado."); }

            const auth = firebase.auth();
            const db = firebase.firestore();
            const storage = firebase.storage();
            
            const baseUrl = window.location.origin + window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/'));
            const urlParams = new URLSearchParams(window.location.search);
            const courseId = urlParams.get('course');

            const ALL_COURSES_DATA = {
              'ia-aplicada-esencial': {
                title: 'IA Aplicada · Esencial',
                hasCertificate: true,
                modules: [
                  {
                    title: 'Módulo 0: Onboarding',
                    badge: 'Iniciado en IA',
                    lessons: [
                      { 
                        id: '0-1', 
                        title: 'Tu primer día con IA', 
                        type: 'video', 
                        videoUrl: 'gs://aulagenia.firebasestorage.app/ONBOARDING-IA-Aplicada-Programa-Esencial.mp4',
                        transcriptionUrl: 'gs://aulagenia.firebasestorage.app/ONBOARDING-IA-Aplicada-Programa-Esencial.srt',
                        resources: [
                          { name: 'Accede A ChatGPT.pdf', url: 'http://aulagenia.cl/Manual_Crear_Cuenta_ChatGPT_AulaGenIA_curso.pdf?alt=media' },
                          { name: 'Accede a Gemini.pdf', url: 'http://aulagenia.cl/Manual_Crear_Cuenta_Gemini_AulaGenIA_curso.pdf?alt=media' }
                        ]
                      },
                      { 
                        id: 'q-0', 
                        title: 'Quiz: Módulo 0', 
                        type: 'quiz', 
                        questions: [
                          { 
                            text: 'Según la analogía de las muñecas rusas explicada en el curso, ¿cuál de las siguientes afirmaciones es correcta?', 
                            options: [
                                'El Aprendizaje Profundo (AP) contiene a la Inteligencia Artificial (IA).', 
                                'La Inteligencia Artificial (IA) es la muñeca más grande que contiene al Aprendizaje Automático (AA) y al Aprendizaje Profundo (AP).', 
                                'El Aprendizaje Automático (AA) es independiente de la Inteligencia Artificial (IA).', 
                                'La Inteligencia Artificial (IA) y el Aprendizaje Profundo (AP) son lo mismo.'
                            ], 
                            correctAnswer: 1 
                          },
                          {
                            text: 'Una de las razones clave del auge actual de la IA es que aprende por "ensayo y error" volviéndose más inteligente sin instrucciones detalladas. ¿Cómo se llama este proceso?',
                            options: [
                                'Programación explícita.',
                                'Aprendizaje supervisado por humanos.',
                                'La IA aprende por sí misma.',
                                'Seguir "recetas" o reglas fijas.'
                            ],
                            correctAnswer: 2
                          },
                          {
                            text: 'Uno de los mitos desmentidos en el curso es que la IA es 100% infalible. ¿Qué se recomienda hacer siempre con los resultados que entrega?',
                            options: [
                                'Aceptarlos como una verdad absoluta.',
                                'Ignorarlos porque probablemente son falsos.',
                                'Revisar y verificar la información con tu propio conocimiento.',
                                'Usarlos solo si provienen de un modelo de pago.'
                            ],
                            correctAnswer: 2
                          }
                        ], 
                        resources: [] 
                      }
                    ]
                  },
                  {
                    title: 'Módulo 1: La IA en el día a día',
                    badge: 'Explorador Conceptual',
                    lessons: [
                      { 
                        id: '1-1', 
                        title: 'Casos de éxito reales', 
                        type: 'video', 
                        videoUrl: 'gs://aulagenia.firebasestorage.app/MODULO1-IA-Aplicada-Programa-Esencial.mp4',
                        transcriptionUrl: 'gs://aulagenia.firebasestorage.app/MODULO1-IA-Aplicada-Programa-Esencial.srt',
                        resources: [] 
                      },
                      { 
                        id: 'q-1', 
                        title: 'Quiz: Módulo 1', 
                        type: 'quiz', 
                        questions: [
                          { 
                            text: 'Cuando aplicaciones como Waze o Google Maps te sugieren la ruta más rápida analizando el tráfico en tiempo real, ¿qué función principal de la IA están utilizando?', 
                            options: [
                                'Traducción automática de idiomas.', 
                                'Reconocimiento facial.', 
                                'Análisis predictivo y optimización de rutas.', 
                                'Generación de listas de reproducción de música.'
                            ], 
                            correctAnswer: 2 
                          },
                          {
                            text: 'En el curso se menciona que la IA puede actuar como un "asistente personal" en tu salud. ¿Cuál de estos es un ejemplo práctico de ello?',
                            options: [
                                'Un reloj inteligente que monitoriza tu ritmo cardíaco y te da consejos.',
                                'Una calculadora para contar calorías.',
                                'Un recordatorio manual para tomar medicamentos.',
                                'Buscar síntomas en un motor de búsqueda general.'
                            ],
                            correctAnswer: 0
                          },
                          {
                            text: '¿Cómo utilizan empresas como Netflix o Amazon la IA para mejorar la experiencia del usuario, según lo explicado en el módulo?',
                            options: [
                                'Creando manualmente listas de productos populares.',
                                'Analizando tus gustos para ofrecerte recomendaciones personalizadas.',
                                'Haciendo más lento el sitio web para aumentar el tiempo de visita.',
                                'Mostrando anuncios de la competencia.'
                            ],
                            correctAnswer: 1
                          }
                        ], 
                        resources: [] 
                      }
                    ]
                  },
                  {
                    title: 'Módulo 2: Tu asistente con IA',
                    badge: 'Asistente IA Personal',
                    lessons: [
                      { 
                        id: '2-1', 
                        title: 'Crear tu objetivo SMART con IA', 
                        type: 'video', 
                        videoUrl: 'gs://aulagenia.firebasestorage.app/MODULO2-IA-Aplicada-Programa-Esencial.mp4',
                        transcriptionUrl: 'gs://aulagenia.firebasestorage.app/MODULO2-IA-Aplicada-Programa-Esencial.srt',
                        resources: [] 
                      },
                      { 
                        id: 'q-2', 
                        title: 'Quiz: Módulo 2', 
                        type: 'quiz', 
                        questions: [
                            { 
                                text: '¿Cuál de las siguientes herramientas de IA se destaca en el curso por su capacidad de integrarse directamente con tu ecosistema de Google (Drive, Gmail, Calendar)?', 
                                options: [
                                    'ChatGPT.', 
                                    'DeepSeek.', 
                                    'Gemini.', 
                                    'Midjourney.'
                                ], 
                                correctAnswer: 2 
                            },
                            {
                                text: 'Para obtener mejores resultados al interactuar con una IA como ChatGPT, ¿cuál de las siguientes prácticas se recomienda en el módulo?',
                                options: [
                                    'Hacer preguntas muy cortas y generales.',
                                    'Usar un lenguaje ambiguo para que la IA tenga más libertad.',
                                    'Ser claro, dar contexto, especificar el formato deseado y dar ejemplos.',
                                    'Escribir todo en mayúsculas para llamar su atención.'
                                ],
                                correctAnswer: 2
                            },
                            {
                                text: 'En el curso se comparan tres herramientas de IA. ¿Cuál de ellas se describe como especialmente útil para preguntas complejas, programación y análisis técnico?',
                                options: [
                                    'ChatGPT.',
                                    'Gemini.',
                                    'DeepSeek.',
                                    'Todas son idénticas en sus capacidades técnicas.'
                                ],
                                correctAnswer: 2
                            }
                        ], 
                        resources: [] 
                      }
                    ]
                  },
                  {
                    title: 'Módulo 3: Creando contenido con IA',
                    badge: 'Creativo IA',
                    lessons: [
                      { 
                        id: '3-1', 
                        title: 'Crear imágenes con DALL-E', 
                        type: 'video', 
                        videoUrl: 'gs://aulagenia.firebasestorage.app/MODULO3-IA-Aplicada-Programa-Esencial.mp4',
                        transcriptionUrl: 'gs://aulagenia.firebasestorage.app/MODULO3-IA-Aplicada-Programa-Esencial.srt',
                        resources: [] 
                      },
                      { 
                        id: 'q-3', 
                        title: 'Quiz: Módulo 3', 
                        type: 'quiz', 
                        questions: [
                            { 
                                text: '¿Cuál es uno de los errores más comunes al crear un prompt, según lo visto en el módulo?', 
                                options: [
                                    'Ser demasiado específico y dar muchos detalles.', 
                                    'Darle un rol a la IA (ej. "Actúa como un experto en marketing").', 
                                    'No darle suficiente información o contexto, haciendo una petición vaga.', 
                                    'Pedir la respuesta en un formato de tabla.'
                                ], 
                                correctAnswer: 2 
                            },
                            {
                                text: 'Si quieres que la IA te ayude a escribir un texto para convencer a tu jefe de una nueva idea, ¿qué elemento es crucial incluir en tu prompt?',
                                options: [
                                    'Un resumen neutral de los hechos.',
                                    'Una lista de datos técnicos sin interpretación.',
                                    'Destacar los beneficios para la empresa y un claro llamado a la acción.',
                                    'Usar un lenguaje infantil y muchos emojis.'
                                ],
                                correctAnswer: 2
                            },
                            {
                                text: 'Si necesitas que la IA genere una explicación sobre un tema complejo para un niño, ¿cómo deberías ajustar tu prompt?',
                                options: [
                                    'Usando terminología técnica y datos complejos.',
                                    'Pidiendo un texto largo y formal.',
                                    'Solicitando oraciones cortas, un lenguaje simple y ejemplos relacionados con sus intereses.',
                                    'No es posible ajustar el lenguaje de la IA para diferentes audiencias.'
                                ],
                                correctAnswer: 2
                            }
                        ], 
                        resources: [] 
                      }
                    ]
                  },
                  {
                    title: 'Módulo 4: Automatización de tareas',
                    badge: 'Experto en Automatización',
                    lessons: [
                      { 
                        id: '4-1', 
                        title: 'Automatizar correos con IA', 
                        type: 'video', 
                        videoUrl: 'gs://aulagenia.firebasestorage.app/MODULO4A-IA-Aplicada-Programa-Esencial.mp4',
                        transcriptionUrl: 'gs://aulagenia.firebasestorage.app/MODULO4A-IA-Aplicada-Programa-Esencial.srt',
                        resources: [] 
                      },
                      { 
                        id: '4-2', 
                        title: 'Automatización práctica extra', 
                        type: 'video', 
                        videoUrl: 'gs://aulagenia.firebasestorage.app/MODULO4B-IA-Aplicada-Programa-Esencial.mp4',
                        transcriptionUrl: 'gs://aulagenia.firebasestorage.app/MODULO4B-IA-Aplicada-Programa-Esencial.srt',
                        resources: [] 
                      },
                      { 
                        id: 'q-4', 
                        title: 'Quiz: Módulo 4', 
                        type: 'quiz', 
                        questions: [
                            { 
                                text: 'Según los ejemplos del curso, ¿cuál es una tarea repetitiva ideal para ser automatizada por la IA y así liberar tiempo para actividades más importantes?', 
                                options: [
                                    'Tener una conversación creativa para una nueva estrategia de negocio.', 
                                    'Tomar decisiones éticas complejas sobre un proyecto.', 
                                    'Responder preguntas frecuentes de clientes con respuestas estandarizadas.', 
                                    'Liderar una reunión de equipo.'
                                ], 
                                correctAnswer: 2 
                            },
                            {
                                text: 'Al integrar la IA para automatizar tareas, ¿cuál es el beneficio principal que se busca?',
                                options: [
                                    'Aumentar la complejidad de las tareas diarias.',
                                    'Reducir la necesidad de supervisión humana a cero.',
                                    'Incrementar la eficiencia, ahorrar tiempo y reducir errores en procesos monótonos.',
                                    'Hacer que el trabajo sea más lento pero más detallado.'
                                ],
                                correctAnswer: 2
                            },
                            {
                                text: 'Al automatizar tareas, ¿el objetivo es reemplazar completamente el juicio humano en todas las áreas?',
                                options: [
                                    'Sí, la meta es que la IA tome todas las decisiones.',
                                    'No, el objetivo es liberar a los humanos de tareas monótonas para que se enfoquen en actividades de mayor valor.',
                                    'Sí, porque la IA siempre es más precisa que un humano.',
                                    'No, la automatización solo sirve para escribir correos.'
                                ],
                                correctAnswer: 1
                            }
                        ], 
                        resources: [] 
                      }
                    ]
                  },
                  {
                    title: 'Módulo 5: Casos de uso avanzados',
                    badge: 'Maestro IA',
                    lessons: [
                      { 
                        id: '5-1', 
                        title: 'Integrar IA en tu negocio', 
                        type: 'video', 
                        videoUrl: 'gs://aulagenia.firebasestorage.app/MODULO5-IA-Aplicada-Programa-Esencial.mp4',
                        transcriptionUrl: 'gs://aulagenia.firebasestorage.app/MODULO5-IA-Aplicada-Programa-Esencial.srt',
                        resources: [] 
                      },
                      { 
                        id: 'q-5', 
                        title: 'Quiz: Módulo 5', 
                        type: 'quiz', 
                        questions: [
                            { 
                                text: 'En el módulo sobre creación de proyectos, se mencionan los principios de UX (Experiencia de Usuario). ¿Cuál de los siguientes NO es uno de los principios básicos de UX mencionados?', 
                                options: [
                                    'Claridad: El usuario debe entender el propósito del proyecto de inmediato.', 
                                    'Complejidad: El proyecto debe tener muchas funciones para parecer avanzado.', 
                                    'Simplicidad: Se deben eliminar pasos innecesarios.', 
                                    'Coherencia: Se debe mantener un estilo y tono constante.'
                                ], 
                                correctAnswer: 1 
                            },
                            {
                                text: '¿Qué herramienta se recomienda en el curso para generar imágenes artísticas y conceptuales a través de prompts detallados?',
                                options: [
                                    'Google Sites.',
                                    'Netlify.',
                                    'Midjourney.',
                                    'Google Forms.'
                                ],
                                correctAnswer: 2
                            },
                            {
                                text: '¿Cuál es el paso final y más importante después de crear tu proyecto con IA para recibir feedback y seguir mejorando?',
                                options: [
                                    'Guardarlo como un borrador final en tu computador.',
                                    'Borrar el proyecto para empezar uno nuevo de inmediato.',
                                    'Publicarlo y compartirlo con el mundo.',
                                    'Imprimir el código y archivarlo físicamente.'
                                ],
                                correctAnswer: 2
                            }
                        ], 
                        resources: [] 
                      }
                    ]
                  }
                ]
              }
            };

            const courseData = ALL_COURSES_DATA[courseId];
            const allLessons = courseData.modules.flatMap(m => m.lessons);
            let currentUser = null;
            let userProgress = { completedLessons: [], currentLessonId: allLessons.length > 0 ? allLessons[0].id : null, unlockedBadges: [] };
            let notesSaveTimer = null;
            let currentLessonVideo = null;
            let hasShownCompletionModal = false;

            const dom = {
                userName: document.getElementById('user-name'),
                userAvatar: document.getElementById('user-avatar'),
                userProfile: document.getElementById('user-profile-container'),
                logoutButton: document.getElementById('logout-button'),
                courseTitle: document.getElementById('course-title'),
                progressBar: document.getElementById('progress-bar'),
                progressText: document.getElementById('progress-text'),
                modulesContainer: document.getElementById('modules-container'),
                lessonTitle: document.getElementById('lesson-title'),
                lessonMaterialContainer: document.getElementById('lesson-material-container'),
                navigationButtons: document.getElementById('navigation-buttons'),
                prevBtn: document.getElementById('prev-lesson-btn'),
                mainActionBtn: document.getElementById('main-action-btn'),
                toast: document.getElementById('toast-notification'),
                toastMessage: document.getElementById('toast-message'),
                badgeToast: document.getElementById('badge-toast'),
                badgeMessage: document.getElementById('badge-message'),
                completionModalOverlay: document.getElementById('completion-modal-overlay'),
                completionModal: document.getElementById('completion-modal'),
                modalUserName: document.getElementById('modal-user-name'),
                modalCourseName: document.getElementById('modal-course-name'),
                certificateLink: document.getElementById('certificate-link'),
                reviewCourseBtn: document.getElementById('review-course-btn'),
                closeModalBtn: document.getElementById('close-modal-btn'),
                learningTabs: document.getElementById('learning-tabs'),
                notesTextarea: document.getElementById('notes-textarea'),
                notesSaveStatus: document.getElementById('notes-save-status'),
                resourceFileInput: document.getElementById('resource-file-input'),
                uploadResourcesBtn: document.getElementById('upload-resources-btn'),
                uploadProgress: document.getElementById('upload-progress'),
                resourcesList: document.getElementById('resources-list'),
                userResourceList: document.getElementById('user-resource-list'),
                taskInput: document.getElementById('task-input'),
                addTaskBtn: document.getElementById('add-task-btn'),
                taskList: document.getElementById('task-list'),
                tabMaterialPanel: document.getElementById('tab-material'),
                pdfModalOverlay: document.getElementById('pdf-modal-overlay'),
                pdfModal: document.getElementById('pdf-modal'),
                pdfModalContent: document.getElementById('pdf-modal-content'),
                pdfModalTitle: document.getElementById('pdf-modal-title'),
                pdfModalCloseBtn: document.getElementById('pdf-modal-close-btn'),
                pdfIframe: document.getElementById('pdf-iframe'),
                supportForm: document.getElementById('support-form'),
                supportSubmitBtn: document.getElementById('support-submit-btn'),
                supportBtnText: document.getElementById('support-btn-text'),
                supportSpinner: document.getElementById('support-spinner'),
                supportFormStatus: document.getElementById('support-form-status'),
            };

            function getIsCourseComplete() {
                if (allLessons.length === 0) return false;
                const uniqueCompleted = new Set(userProgress.completedLessons);
                return uniqueCompleted.size >= allLessons.length;
            }

            function getLessonInfo(lessonId) { for (let i = 0; i < courseData.modules.length; i++) { const module = courseData.modules[i]; const lessonIndex = module.lessons.findIndex(l => l.id === lessonId); if (lessonIndex !== -1) { return { lesson: module.lessons[lessonIndex], moduleIndex: i, module: module }; } } return null; }
            
            function refreshUI() { 
                if (!userProgress.currentLessonId && allLessons.length > 0) {
                    userProgress.currentLessonId = allLessons[0].id;
                }
                dom.courseTitle.textContent = courseData.title; 
                renderSidebar(); 
                const lessonInfo = getLessonInfo(userProgress.currentLessonId); 
                if (lessonInfo) { 
                    dom.lessonTitle.textContent = lessonInfo.lesson.title; 
                    renderLessonContent(lessonInfo.lesson); 
                    if (dom.prevBtn) dom.prevBtn.disabled = allLessons.findIndex(l => l.id === lessonInfo.lesson.id) === 0; 
                } 
                updateOverallProgress(); 
                updateMainActionButton(); 
                lucide.createIcons();
                // Invoca la nueva función aquí
                lockPostCompletionActions();
            }

            function renderSidebar() {
                const isCourseComplete = getIsCourseComplete();
                let isPreviousModuleComplete = true;
                if (!dom.modulesContainer) return;

                dom.modulesContainer.innerHTML = courseData.modules.map((module, moduleIndex) => {
                    const isModuleLocked = isCourseComplete ? false : (moduleIndex > 0 && !isPreviousModuleComplete);
                    
                    const lessonsHtml = module.lessons.map(lesson => {
                        const isCompleted = userProgress.completedLessons.includes(lesson.id);
                        const isActive = userProgress.currentLessonId === lesson.id;
                    
                        // ANALYST UPGRADE: Combined locking logic for modules and quizzes.
                        let isLocked = false;
                        if (!isCourseComplete) {
                            if (isModuleLocked) {
                                isLocked = true;
                            } else if (lesson.type === 'quiz') {
                                const otherLessonsInModule = module.lessons.filter(l => l.type !== 'quiz');
                                if (!otherLessonsInModule.every(l => userProgress.completedLessons.includes(l.id))) {
                                    isLocked = true;
                                }
                            }
                        }
                        
                        let linkClasses = 'text-gray-600 hover:bg-slate-100';
                        let statusIcon = isCompleted ? 'check-circle-2' : (lesson.type === 'quiz' ? 'help-circle' : 'circle');
                        let iconColor = isCompleted ? 'text-green-500' : 'text-slate-300';
                        
                        if (isLocked) {
                            linkClasses = 'text-gray-400 cursor-not-allowed opacity-70';
                            statusIcon = 'lock';
                            iconColor = 'text-slate-400';
                        } else if (isActive) {
                            linkClasses = 'bg-teal-50 text-teal-700 font-semibold';
                            statusIcon = 'play-circle';
                            iconColor = '';
                        }
                        
                        const typeIcon = { video: 'video', resource: 'file-text', quiz: 'edit-3' }[lesson.type] || 'file';
                        
                        return `<li class="lesson-item" data-lesson-id="${lesson.id}"><a href="#" class="flex items-center p-2 ml-2 rounded-md ${linkClasses}"><i data-lucide="${statusIcon}" class="h-5 w-5 mr-3 ${iconColor}"></i><span class="flex-1 text-sm">${lesson.title}</span><i data-lucide="${typeIcon}" class="h-4 w-4 ml-2 ${isLocked ? 'text-slate-400' : ''}"></i></a></li>`;
                    }).join('');

                    const accordionButtonClasses = isModuleLocked ? 'text-gray-400' : 'text-gray-800';
                    const accordionIcon = isModuleLocked ? 'lock' : 'chevron-down';
                    
                    const moduleLessonIds = module.lessons.map(l => l.id);
                    if (!isCourseComplete) {
                        isPreviousModuleComplete = moduleLessonIds.every(id => userProgress.completedLessons.includes(id));
                    }
                    
                    return `<div class="accordion-item"><button class="accordion-header w-full flex justify-between items-center p-3 rounded-md hover:bg-slate-100 text-left"><span class="font-semibold ${accordionButtonClasses}">${module.title}</span><i data-lucide="${accordionIcon}" class="h-5 w-5 transition-transform text-gray-500"></i></button><div class="accordion-content ${!isModuleLocked ? 'open' : ''} pl-4"><ul class="border-l border-slate-200 py-2 space-y-1">${lessonsHtml}</ul></div></div>`;
                }).join('');

                addSidebarListeners();
            }
            
            function renderLessonContent(lesson) {
                const isCourseComplete = getIsCourseComplete();
                let materialHtml = ''; 
                if (currentLessonVideo) { currentLessonVideo.pause(); currentLessonVideo = null; }
                
                // Clear existing quiz result handlers if any
                if (window.currentQuizHandler) {
                    const checkBtn = document.getElementById('check-quiz-btn');
                    if (checkBtn) {
                        checkBtn.removeEventListener('click', window.currentQuizHandler);
                    }
                }

                switch(lesson.type) { 
                    case 'video':
                        if (lesson.videoUrl) {
                            materialHtml = `<div class="flex flex-col gap-4">
                                <div class="aspect-w-16 aspect-h-9 w-full rounded-xl overflow-hidden">
                                    <video id="course-video" controls class="w-full h-full object-cover">
                                        <source id="course-video-source" data-src="${lesson.videoUrl || ''}" type="video/mp4">
                                        ${lesson.transcriptionUrl ? `<track id="caption-track" kind="subtitles" srclang="es" label="Español" default>` : ''}
                                        Tu navegador no soporta el elemento de video.
                                    </video>
                                </div>
                                <div class="mt-2 grid grid-cols-1 sm:grid-cols-2 gap-2">
                                ${lesson.transcriptionUrl ? `
                                    <button id="toggle-subtitles-btn" class="w-full flex items-center justify-center gap-2 px-4 py-2 bg-slate-200 text-slate-800 rounded-lg font-semibold hover:bg-slate-300 transition-colors">
                                        <i data-lucide="captions" class="h-5 w-5"></i>
                                        <span>Desactivar Subtítulos</span>
                                    </button>
                                    <button id="transcription-button" class="w-full flex items-center justify-center gap-2 px-4 py-2 bg-slate-200 text-slate-800 rounded-lg font-semibold hover:bg-slate-300 transition-colors">
                                        <i data-lucide="download" class="h-5 w-5"></i>
                                        <span>Descargar Transcripción</span>
                                    </button>
                                ` : `
                                    <div class="sm:col-span-2">
                                        <button class="w-full flex items-center justify-center gap-2 px-4 py-2 bg-slate-200 text-slate-400 rounded-lg font-semibold cursor-not-allowed" disabled>
                                            <i data-lucide="captions-off" class="h-5 w-5"></i>
                                            <span>Subtítulos No Disponibles</span>
                                        </button>
                                    </div>
                                `}
                                </div>
                            </div>`;
                        } else {
                            materialHtml = `<div class="aspect-w-16 aspect-h-9"><div class="w-full h-full bg-slate-900 rounded-xl flex items-center justify-center text-white"><i data-lucide="play-circle" class="h-20 w-20 text-slate-500"></i><p class="absolute">Contenido del video</p></div></div>`;
                        }
                        break; 
                    case 'resource': materialHtml = `<div class="aspect-w-16 aspect-h-9"><div class="w-full h-full bg-white border border-slate-200 rounded-xl flex flex-col items-center justify-center text-slate-600 p-8"><i data-lucide="package-check" class="h-20 w-20 text-slate-400 mb-4"></i><p class="text-center mb-4">Recursos y entregas en la pestaña 'Recursos'.</p></div></div>`; break; 
                    case 'quiz': { // Use block scope for clarity
                        if (!lesson.questions || lesson.questions.length === 0) {
                            materialHtml = `<p class="text-center text-slate-500">Este quiz no tiene preguntas configuradas.</p>`;
                            break;
                        }

                        const isQuizCompleted = userProgress.completedLessons.includes(lesson.id);
                        const inReviewMode = isCourseComplete || isQuizCompleted;

                        let quizHtml = lesson.questions.map((question, qIndex) => {
                            const optionsHtml = question.options.map((opt, index) => {
                                if (inReviewMode) {
                                    const isCorrect = index === question.correctAnswer;
                                    const optionClasses = isCorrect ? 'quiz-option correct' : 'quiz-option opacity-60';
                                    return `<div class="${optionClasses} border-2 p-4 rounded-lg cursor-default">${opt}</div>`;
                                } else {
                                    const questionId = `quiz-${lesson.id}-q-${qIndex}`;
                                    return `<div class="quiz-option border-2 border-slate-300 p-4 rounded-lg cursor-pointer hover:bg-slate-100" data-index="${index}" data-question-id="${questionId}">${opt}</div>`;
                                }
                            }).join('');
                            
                            const questionContainerAttributes = inReviewMode ? '' : `id="quiz-${lesson.id}-q-${qIndex}"`;
                            return `<div class="space-y-4 mb-8 p-4 border-b border-slate-200" ${questionContainerAttributes}><h3 class="text-xl font-semibold">${qIndex + 1}. ${question.text}</h3><div class="space-y-3">${optionsHtml}</div></div>`;
                        }).join('');

                        if (inReviewMode) {
                            const reviewMessage = isQuizCompleted 
                                ? 'Ya has completado este quiz. Puedes revisar las respuestas correctas.'
                                : 'Curso completado. Solo puedes revisar las respuestas.';
                            materialHtml = `${quizHtml}<p class="text-sm text-slate-500 mt-4 font-semibold text-center p-4 bg-slate-100 rounded-md">${reviewMessage}</p>`;
                        } else {
                             materialHtml = `<div id="quiz-container">${quizHtml}<button id="check-quiz-btn" class="mt-4 bg-gray-800 text-white font-semibold px-6 py-3 rounded-lg hover:bg-gray-900">Verificar Respuestas</button></div>`;
                        }
                        break;
                    }
                    default: materialHtml = `<p>Tipo de lección no reconocido.</p>`;
                } 
                if (dom.tabMaterialPanel) dom.tabMaterialPanel.innerHTML = materialHtml; 
                
                if (lesson.type === 'quiz' && !isCourseComplete && lesson.questions && lesson.questions.length > 0) {
                    const isQuizCompleted = userProgress.completedLessons.includes(lesson.id);
                    if (!isQuizCompleted) {
                      dom.tabMaterialPanel.querySelectorAll('.quiz-option').forEach(opt => {
                          opt.addEventListener('click', () => {
                              const questionId = opt.dataset.questionId;
                              dom.tabMaterialPanel.querySelectorAll(`.quiz-option[data-question-id="${questionId}"]`).forEach(o => o.classList.remove('selected'));
                              opt.classList.add('selected');
                          });
                      });

                      const checkBtn = document.getElementById('check-quiz-btn');
                      if (checkBtn) {
                          window.currentQuizHandler = () => checkQuizAnswers(lesson);
                          checkBtn.addEventListener('click', window.currentQuizHandler);
                      }
                    }
                }

                const videoEl = document.getElementById('course-video');
                if (videoEl) currentLessonVideo = videoEl;

                const toggleSubtitlesBtn = document.getElementById('toggle-subtitles-btn');
                if (toggleSubtitlesBtn && videoEl) {
                    toggleSubtitlesBtn.addEventListener('click', () => {
                        if (!videoEl.textTracks || videoEl.textTracks.length === 0) return;
                        const track = videoEl.textTracks[0];
                        const btnText = toggleSubtitlesBtn.querySelector('span');
                        const btnIcon = toggleSubtitlesBtn.querySelector('i');
                        
                        const isShowing = track.mode === 'showing';
                        track.mode = isShowing ? 'hidden' : 'showing';

                        if (track.mode === 'showing') {
                            if (btnText) btnText.textContent = 'Desactivar Subtítulos';
                            if (btnIcon) btnIcon.setAttribute('data-lucide', 'captions');
                        } else {
                            if (btnText) btnText.textContent = 'Activar Subtítulos';
                            if (btnIcon) btnIcon.setAttribute('data-lucide', 'captions-off');
                        }
                        lucide.createIcons();
                    });
                }

                const transcriptionBtn = document.getElementById('transcription-button');
                if (transcriptionBtn && lesson.transcriptionUrl) { 
                    transcriptionBtn.addEventListener('click', () => downloadTranscription(lesson.transcriptionUrl, lesson.title));
                }

                (async () => {
                    if (!videoEl) return;
                    try {
                        await attachMediaAndCaptions({
                            storage,
                            videoEl,
                            videoSrc: (lesson && lesson.videoUrl) || '',
                            srtOrVttSrc: (lesson && lesson.transcriptionUrl) || ''
                        });
                    } catch (err) {
                        console.error('No se pudieron adjuntar medios/subtítulos:', err);
                    } finally {
                        // Invoca la nueva función aquí, después de renderizar el material
                        lockPostCompletionActions();
                    }
                })();
            }

            async function advanceToNextLesson() {
                const currentIndex = allLessons.findIndex(l => l.id === userProgress.currentLessonId);
                if (currentIndex < allLessons.length - 1) {
                    showToast('¡Excelente! Cargando siguiente lección...');
                    setTimeout(() => {
                        navigateToLesson(allLessons[currentIndex + 1].id);
                    }, 1500);
                } else {
                    if (!hasShownCompletionModal) {
                        await showCompletionModal();
                        hasShownCompletionModal = true;
                    }
                }
            }

            async function checkQuizAnswers(lesson) {
                const totalQuestions = lesson.questions.length;
                let correctAnswers = 0;
                let allAnswered = true;

                lesson.questions.forEach((question, qIndex) => {
                    const questionId = `quiz-${lesson.id}-q-${qIndex}`;
                    const questionContainer = document.getElementById(questionId);
                    const selectedOption = questionContainer.querySelector('.quiz-option.selected');

                    if (!selectedOption) {
                        allAnswered = false;
                        return;
                    }

                    const selectedIndex = parseInt(selectedOption.dataset.index);
                    const correctIndex = question.correctAnswer;
                    
                    if (selectedIndex === correctIndex) {
                        correctAnswers++;
                    }
                });

                if (!allAnswered) {
                    showToast('Por favor, responde todas las preguntas.');
                    return;
                }

                // Show results visually
                lesson.questions.forEach((question, qIndex) => {
                    const questionId = `quiz-${lesson.id}-q-${qIndex}`;
                    const questionContainer = document.getElementById(questionId);
                    const selectedOption = questionContainer.querySelector('.quiz-option.selected');
                    const correctIndex = question.correctAnswer;
                    
                    questionContainer.querySelectorAll('.quiz-option').forEach(opt => {
                        opt.style.pointerEvents = 'none';
                        opt.classList.remove('selected');
                    });

                    const selectedIndex = parseInt(selectedOption.dataset.index);
                    if (selectedIndex === correctIndex) {
                        selectedOption.classList.add('correct');
                    } else {
                        selectedOption.classList.add('incorrect');
                        questionContainer.querySelector(`[data-index="${correctIndex}"]`).classList.add('correct');
                    }
                });

                if (correctAnswers === totalQuestions) {
                    showToast('¡Todas las respuestas son correctas!');
                    
                    if (!userProgress.completedLessons.includes(lesson.id)) {
                        userProgress.completedLessons = [...new Set([...userProgress.completedLessons, lesson.id])];
                        await saveProgress();
                        checkForBadgeUnlock(lesson.id);
                        refreshUI();
                    }
                    
                    advanceToNextLesson();
                } else {
                    showToast(`Revisa tus respuestas. ${correctAnswers} de ${totalQuestions} son correctas.`);
                    const firstIncorrect = dom.tabMaterialPanel.querySelector('.quiz-option.incorrect');
                    if (firstIncorrect) {
                        const questionContainer = firstIncorrect.closest('.space-y-4.mb-8');
                        if (questionContainer) {
                            questionContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    }
                    setTimeout(() => {
                        dom.tabMaterialPanel.querySelectorAll('.quiz-option').forEach(opt => {
                            opt.classList.remove('incorrect', 'correct');
                            opt.style.pointerEvents = 'auto';
                        });
                    }, 5000);
                }
            }
            
            function updateMainActionButton() {
                if (!dom.navigationButtons || !dom.mainActionBtn) return;

                const isCourseComplete = getIsCourseComplete();
                if (isCourseComplete) {
                    dom.navigationButtons.classList.add('hidden');
                    return;
                }
                
                dom.navigationButtons.classList.remove('hidden');
                const lesson = allLessons.find(l => l.id === userProgress.currentLessonId);
                if (!lesson) return;

                const isCompleted = userProgress.completedLessons.includes(lesson.id);

                if (isCompleted) {
                    dom.mainActionBtn.classList.add('hidden');
                    return;
                }

                dom.mainActionBtn.classList.remove('hidden');
                dom.mainActionBtn.textContent = 'Marcar como completada';
                dom.mainActionBtn.disabled = (lesson.type === 'quiz'); 
            }

            function updateOverallProgress() { const uniqueCompleted = new Set(userProgress.completedLessons); const completedCount = uniqueCompleted.size; const percentage = allLessons.length > 0 ? Math.round((completedCount / allLessons.length) * 100) : 0; if (dom.progressBar) dom.progressBar.style.width = `${percentage}%`; if (dom.progressText) dom.progressText.textContent = `${percentage}%`; }
            
            async function navigateToLesson(lessonId) {
                const isCourseComplete = getIsCourseComplete();
                const targetLessonInfo = getLessonInfo(lessonId);
                if (!targetLessonInfo) return;

                if (!isCourseComplete) {
                    // ANALYST UPGRADE: Stricter navigation checks.

                    // 1. Check Module Lock (must complete previous module).
                    const targetModuleIndex = targetLessonInfo.moduleIndex;
                    if (targetModuleIndex > 0) {
                        const previousModule = courseData.modules[targetModuleIndex - 1];
                        const previousModuleLessonIds = previousModule.lessons.map(l => l.id);
                        if (!previousModuleLessonIds.every(id => userProgress.completedLessons.includes(id))) {
                            showToast(`Debes completar el "${previousModule.title}" para acceder.`);
                            return;
                        }
                    }
                    
                    // 2. Check Intra-Module Quiz Lock (must complete lessons before quiz).
                    const { lesson, module } = targetLessonInfo;
                    if (lesson.type === 'quiz') {
                        const otherLessonsInModule = module.lessons.filter(l => l.type !== 'quiz');
                        if (!otherLessonsInModule.every(l => userProgress.completedLessons.includes(l.id))) {
                            showToast(`Completa las lecciones del "${module.title}" para desbloquear el quiz.`);
                            return;
                        }
                    }
                }
                
                userProgress = { ...userProgress, currentLessonId: lessonId };
                await saveProgress();
                refreshUI();
                loadLessonTabData();
            }

            async function saveProgress() { if (!currentUser) return; try { const progressRef = db.collection('userProgress').doc(currentUser.uid); await progressRef.set({ [courseId]: userProgress }, { merge: true }); } catch (error) { console.error("Error al guardar el progreso:", error); } }
            
            async function loadProgressAndInitialize() { const docRef = db.collection('userProgress').doc(currentUser.uid); try { const doc = await docRef.get(); if (doc.exists) { const courseProgress = doc.data()[courseId]; if (courseProgress) { userProgress = { completedLessons: Array.isArray(courseProgress.completedLessons) ? courseProgress.completedLessons : [], currentLessonId: allLessons.some(l => l.id === courseProgress.currentLessonId) ? courseProgress.currentLessonId : allLessons[0].id, unlockedBadges: Array.isArray(courseProgress.unlockedBadges) ? courseProgress.unlockedBadges : [] }; } } } catch (error) { console.error("Error al cargar el progreso.", error); } refreshUI(); loadLessonTabData(); }
            
            function addSidebarListeners() {
                if (!dom.modulesContainer) return;
                
                dom.modulesContainer.querySelectorAll('.lesson-item a').forEach(link => {
                    link.addEventListener('click', e => {
                        e.preventDefault();
                        const li = e.currentTarget.closest('.lesson-item');
                        if (li && !e.currentTarget.classList.contains('cursor-not-allowed')) {
                            navigateToLesson(li.dataset.lessonId);
                        }
                    });
                });

                dom.modulesContainer.querySelectorAll('.accordion-item').forEach(item => {
                    const header = item.querySelector('.accordion-header');
                    const icon = header ? header.querySelector('i') : null;
                    if (header && icon && icon.getAttribute('data-lucide') !== 'lock') {
                        header.addEventListener('click', () => {
                            const content = header.nextElementSibling;
                            const iconEl = header.querySelector('i[data-lucide="chevron-down"]');
                            const isOpen = content.classList.toggle('open');
                            if(iconEl) iconEl.style.transform = isOpen ? 'rotate(180deg)' : 'rotate(0deg)';
                        });
                    }
                });
            }
            
            if (dom.mainActionBtn) dom.mainActionBtn.addEventListener('click', async () => {
                const lessonId = userProgress.currentLessonId;
                const isCompleted = userProgress.completedLessons.includes(lessonId);

                if (!isCompleted) {
                    userProgress = { ...userProgress, completedLessons: [...new Set([...userProgress.completedLessons, lessonId])] };
                    await saveProgress();
                    checkForBadgeUnlock(lessonId);
                    refreshUI();

                    const isLastLesson = allLessons.findIndex(l => l.id === lessonId) === allLessons.length - 1;
                    if (getIsCourseComplete() || isLastLesson) {
                        if (!hasShownCompletionModal) {
                            await showCompletionModal();
                            hasShownCompletionModal = true;
                        }
                    } else {
                        advanceToNextLesson();
                    }
                }
            });

            if (dom.prevBtn) dom.prevBtn.addEventListener('click', () => { const currentIndex = allLessons.findIndex(l => l.id === userProgress.currentLessonId); if (currentIndex > 0) navigateToLesson(allLessons[currentIndex - 1].id); });
            
            function showToast(message, type = 'generic') { const toastEl = type === 'badge' ? dom.badgeToast : dom.toast; const msgEl = type === 'badge' ? dom.badgeMessage : dom.toastMessage; if (!toastEl || !msgEl) return; msgEl.textContent = message; toastEl.classList.add('show'); setTimeout(() => toastEl.classList.remove('show'), 4000); }
            function checkForBadgeUnlock(completedLessonId) { const lessonInfo = getLessonInfo(completedLessonId); if (!lessonInfo || !lessonInfo.module.badge) return; const lastLessonOfModule = lessonInfo.module.lessons[lessonInfo.module.lessons.length - 1].id; if (completedLessonId !== lastLessonOfModule) return; const moduleLessonIds = lessonInfo.module.lessons.map(l => l.id); if (moduleLessonIds.every(id => userProgress.completedLessons.includes(id))) { if (!userProgress.unlockedBadges.includes(lessonInfo.module.badge)) { userProgress.unlockedBadges.push(lessonInfo.module.badge); saveProgress(); showToast(`Has ganado la insignia: "${lessonInfo.module.badge}"`, 'badge'); } } }
            
            async function generateCertificateRecord() {
                if (!currentUser || !courseData.hasCertificate) {
                    return null;
                }
                const certificateId = `${currentUser.uid}_${courseId}`;
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'aulagenia-app';

                const certRef = db.collection('artifacts').doc(appId)
                                  .collection('public').doc('data')
                                  .collection('certificates').doc(certificateId);

                try {
                    const certDoc = await certRef.get();
                    if (!certDoc.exists) {
                        console.log('Generating new certificate record...');
                        await certRef.set({
                            userId: currentUser.uid,
                            userName: currentUser.name,
                            courseId: courseId,
                            courseName: courseData.title,
                            issuedAt: firebase.firestore.FieldValue.serverTimestamp(),
                            appId: appId
                        });
                        console.log('Certificate record created:', certificateId);
                    } else {
                        console.log('Certificate record already exists.');
                    }
                    return certificateId;
                } catch (error) {
                    console.error("Error creating or checking certificate record:", error);
                    return null;
                }
            }

            async function showCompletionModal() {
                if (!dom.completionModal || !dom.completionModalOverlay) return;
                if (dom.modalUserName) dom.modalUserName.textContent = currentUser ? currentUser.name : '';
                if (dom.modalCourseName) dom.modalCourseName.textContent = courseData.title;
                
                if (courseData.hasCertificate && dom.certificateLink) {
                    const certificateId = await generateCertificateRecord();
                    if (certificateId) {
                        dom.certificateLink.href = `./portal-certificacion.html?id=${certificateId}`;
                        dom.certificateLink.classList.remove('hidden');
                        dom.certificateLink.classList.add('flex');
                    } else {
                        dom.certificateLink.classList.add('hidden');
                        dom.certificateLink.classList.remove('flex');
                    }
                } else if (dom.certificateLink) {
                    dom.certificateLink.classList.add('hidden');
                    dom.certificateLink.classList.remove('flex');
                }

                dom.completionModalOverlay.classList.remove('hidden');
                dom.completionModal.classList.remove('hidden');
                setTimeout(() => {
                    dom.completionModalOverlay.classList.add('opacity-100');
                    dom.completionModal.classList.add('show');
                }, 10);
            }

            function hideCompletionModal() {
                if (!dom.completionModal || !dom.completionModalOverlay) return;
                dom.completionModalOverlay.classList.remove('opacity-100');
                dom.completionModal.classList.remove('show');
                const inner = dom.completionModal.querySelector('div');
                if (inner) inner.classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    dom.completionModal.classList.add('hidden');
                    dom.completionModalOverlay.classList.add('hidden');
                    if (inner) inner.classList.remove('scale-95', 'opacity-0');
                }, 300);
            }

            if (dom.closeModalBtn) dom.closeModalBtn.addEventListener('click', () => window.location.href = `${baseUrl}/campus.html`);
            if (dom.reviewCourseBtn) dom.reviewCourseBtn.addEventListener('click', hideCompletionModal);
            
            const profileModalOverlay = document.getElementById('profile-modal-overlay'); const profileModal = document.getElementById('profile-modal'); const avatarButton = document.getElementById('avatar-button'); const cancelProfileBtn = document.getElementById('cancel-profile-btn'); const closeProfileBtn = document.getElementById('close-profile-modal-btn'); const profileForm = document.getElementById('profile-form'); const profileNameInput = document.getElementById('profile-name-input'); const profileRutInput = document.getElementById('profile-rut-input'); const profileEmailInput = document.getElementById('profile-email-input'); const profileJobInput = document.getElementById('profile-job-input'); const profileCountrySelect = document.getElementById('profile-country-select'); const profileGenderSelect = document.getElementById('profile-gender-select'); const profileBirthdateInput = document.getElementById('profile-birthdate-input'); const formStatus = document.getElementById('form-status'); const saveBtn = document.getElementById('save-profile-btn'); const saveBtnText = document.getElementById('save-btn-text'); const saveSpinner = document.getElementById('save-spinner');
            
            async function showProfileModal() {
                if (!profileForm || !profileEmailInput || !profileModalOverlay || !profileModal) return;
                profileForm.reset();
                clearAllErrors();
                if (formStatus) formStatus.classList.add('hidden');
                
                const user = auth.currentUser;
                if (!user) return;
                
                profileEmailInput.value = user.email || '';
                
                const userDocRef = db.collection('users').doc(user.uid);
                try {
                    const doc = await userDocRef.get();
                    const dbData = doc.exists ? doc.data() : {};
                    const isProfileCompleted = dbData.profileCompleted === true;

                    // Load name from DB ONLY if the profile has been completed before.
                    if (profileNameInput) profileNameInput.value = isProfileCompleted ? (dbData.displayName || '') : '';
                    
                    // Other fields only come from DB
                    if (profileRutInput) profileRutInput.value = dbData.rut || '';
                    if (profileJobInput) profileJobInput.value = dbData.jobTitle || '';
                    if (profileCountrySelect) profileCountrySelect.value = dbData.country || '';
                    if (profileGenderSelect) profileGenderSelect.value = dbData.gender || '';
                    if (profileBirthdateInput) profileBirthdateInput.value = dbData.birthdate || '';

                } catch (error) {
                    console.error("Error al cargar datos del perfil:", error);
                    if(formStatus) {
                        formStatus.textContent = 'Error al cargar tus datos. Intenta de nuevo.';
                        formStatus.className = 'text-center p-3 rounded-lg bg-red-100 text-red-700';
                        formStatus.classList.remove('hidden');
                    }
                }
                
                profileModalOverlay.classList.remove('hidden');
                profileModal.classList.remove('hidden');
                setTimeout(() => {
                    const inner = profileModal.querySelector('div.bg-white');
                    if(inner) inner.classList.remove('scale-95', 'opacity-0');
                }, 10);
            }

            function hideProfileModal() { if (!profileModalOverlay || !profileModal) return; const inner = profileModal.querySelector('div.bg-white'); if (inner) inner.classList.add('scale-95', 'opacity-0'); setTimeout(() => { profileModalOverlay.classList.add('hidden'); profileModal.classList.add('hidden'); if (inner) inner.classList.remove('scale-95', 'opacity-0'); }, 300); }
            if (avatarButton) avatarButton.addEventListener('click', () => showProfileModal()); if (cancelProfileBtn) cancelProfileBtn.addEventListener('click', hideProfileModal); if (closeProfileBtn) closeProfileBtn.addEventListener('click', hideProfileModal); if (profileModalOverlay) profileModalOverlay.addEventListener('click', hideProfileModal);
            function validateRut(rut) { rut = rut.replace(/\./g, '').replace(/-/g, '').trim().toLowerCase(); const rutBody = rut.slice(0, -1); let dv = rut.slice(-1); if (!/^[0-9]+[0-9kK]{1}$/.test(rut)) return false; let sum = 0, multiple = 2; for (let i = rutBody.length - 1; i >= 0; i--) { sum += rutBody.charAt(i) * multiple; if (multiple < 7) multiple++; else multiple = 2; } const calculatedDv = 11 - (sum % 11); const expectedDv = (calculatedDv === 11) ? '0' : (calculatedDv === 10) ? 'k' : calculatedDv.toString(); return dv === expectedDv; }
            function setError(field, message) { const inputEl = document.getElementById(`profile-${field}-input`) || document.getElementById(`profile-${field}-select`); if (inputEl) inputEl.classList.add('form-input-error'); const errorEl = document.getElementById(`${field}-error`); if(errorEl) errorEl.textContent = message; }
            function clearError(field) { const inputEl = document.getElementById(`profile-${field}-input`) || document.getElementById(`profile-${field}-select`); if (inputEl) inputEl.classList.remove('form-input-error'); const errorEl = document.getElementById(`${field}-error`); if(errorEl) errorEl.textContent = ''; }
            function clearAllErrors() { ['name', 'rut', 'country'].forEach(field => clearError(field)); }
            function validateForm() { let isValid = true; clearAllErrors(); if (profileNameInput && (profileNameInput.value.trim().length < 3 || !profileNameInput.value.includes(' '))) { setError('name', 'Ingresa tu nombre y apellido completo.'); isValid = false; } if (profileCountrySelect && profileCountrySelect.value === '') { setError('country', 'Selecciona tu país de residencia.'); isValid = false; } if (profileCountrySelect && profileCountrySelect.value === 'CL' && profileRutInput && !validateRut(profileRutInput.value)) { setError('rut', 'El RUT ingresado no es válido.'); isValid = false; } return isValid; }
            if (profileForm) profileForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!validateForm()) return;
                if (saveBtn) saveBtn.disabled = true;
                if (saveBtnText) saveBtnText.textContent = 'Guardando...';
                if (saveSpinner) saveSpinner.classList.remove('hidden');
                if(formStatus) formStatus.classList.add('hidden');
                const user = auth.currentUser;
                const newName = profileNameInput ? profileNameInput.value.trim() : '';
                const userDocRef = db.collection('users').doc(user.uid);
                try {
                    if (newName && user && newName !== user.displayName) {
                        await user.updateProfile({ displayName: newName });
                    }
                    await userDocRef.set({
                        displayName: newName,
                        email: user.email,
                        rut: profileRutInput ? profileRutInput.value.trim() : '',
                        jobTitle: profileJobInput ? profileJobInput.value.trim() : '',
                        country: profileCountrySelect ? profileCountrySelect.value : '',
                        gender: profileGenderSelect ? profileGenderSelect.value : '',
                        birthdate: profileBirthdateInput ? profileBirthdateInput.value : '',
                        profileCompleted: true
                    }, { merge: true });
                    if (dom.userName) dom.userName.textContent = newName;
                    if(formStatus) {
                        formStatus.className = 'text-center p-3 rounded-lg bg-green-100 text-green-700';
                        formStatus.textContent = '¡Perfil actualizado con éxito!';
                        formStatus.classList.remove('hidden');
                    }
                    showToast('¡Perfil actualizado con éxito!');
                    setTimeout(hideProfileModal, 1500);
                } catch (error) {
                    console.error("Error al guardar perfil:", error);
                    if(formStatus) {
                        formStatus.className = 'text-center p-3 rounded-lg bg-red-100 text-red-700';
                        formStatus.textContent = 'Hubo un error al guardar. Inténtalo de nuevo.';
                        formStatus.classList.remove('hidden');
                    }
                } finally {
                    if (saveBtn) saveBtn.disabled = false;
                    if (saveBtnText) saveBtnText.textContent = 'Guardar Cambios';
                    if (saveSpinner) saveSpinner.classList.add('hidden');
                }
            });
            
            function activateTab(tabId) {
                if (!dom.learningTabs) return;
                dom.learningTabs.querySelectorAll('.ltab').forEach(b => {
                    const active = b.dataset.tab === tabId;
                    b.classList.toggle('active', active);
                    b.classList.toggle('text-teal-600', active);
                    b.classList.toggle('border-teal-500', active);
                    b.classList.toggle('text-slate-500', !active);
                    b.classList.toggle('border-transparent', !active);
                });
                dom.learningTabs.querySelectorAll('.ltab-panel').forEach(p => p.classList.toggle('hidden', p.id !== tabId));
            }

            if (dom.learningTabs) dom.learningTabs.addEventListener('click', (e) => {
                const button = e.target.closest('.ltab');
                if (button) activateTab(button.dataset.tab);
            });

            function loadLessonTabData() {
                if (!currentUser) return;
                const lessonId = userProgress.currentLessonId;
                const lessonInfo = getLessonInfo(lessonId);
                if (!lessonInfo) return;

                loadNotes(lessonId);
                renderCourseResources(lessonInfo.lesson);
                loadUserResources(lessonId);
                loadTasks(lessonId);
                activateTab('tab-material');
            }

            async function loadNotes(lessonId) {
                if (!currentUser || !dom.notesTextarea || !dom.notesSaveStatus) return;
                dom.notesTextarea.value = '';
                const noteRef = db.collection('userNotes').doc(`${currentUser.uid}_${courseId}_${lessonId}`);
                try {
                    const doc = await noteRef.get();
                    if (doc.exists) dom.notesTextarea.value = doc.data().content || '';
                    dom.notesSaveStatus.textContent = 'Sin cambios';
                } catch (error) {
                    console.error("Error al cargar las notas:", error);
                    dom.notesSaveStatus.textContent = 'Error al cargar';
                }
            }

            async function saveNotes(lessonId) {
                if (!currentUser || !dom.notesTextarea || !dom.notesSaveStatus) return;
                dom.notesSaveStatus.textContent = 'Guardando...';
                const noteRef = db.collection('userNotes').doc(`${currentUser.uid}_${courseId}_${lessonId}`);
                try {
                    await noteRef.set({ uid: currentUser.uid, content: dom.notesTextarea.value, lastUpdated: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
                    dom.notesSaveStatus.textContent = 'Guardado';
                } catch (error) {
                    console.error("Error al guardar las notas:", error);
                    dom.notesSaveStatus.textContent = 'Error al guardar';
                } finally {
                    setTimeout(() => { if (dom.notesSaveStatus.textContent === 'Guardado') dom.notesSaveStatus.textContent = 'Sin cambios'; }, 2000);
                }
            }
            if (dom.notesTextarea) dom.notesTextarea.addEventListener('input', () => { if (!dom.notesSaveStatus) return; dom.notesSaveStatus.textContent = 'Editando...'; clearTimeout(notesSaveTimer); notesSaveTimer = setTimeout(() => saveNotes(userProgress.currentLessonId), 1500); });

            function renderCourseResources(lesson) {
                if (!dom.resourcesList) return;
                const resources = lesson.resources || [];
                if (resources.length > 0) {
                    dom.resourcesList.innerHTML = resources.map(resource => {
                        const isPdf = !resource.external && resource.url.includes('.pdf');
                        const icon = resource.external ? 'link' : (isPdf ? 'file-text' : 'download-cloud');
                        const actionAttr = isPdf ? `data-pdf-url="${resource.url}" data-pdf-title="${resource.name}"` : `href="${resource.url}"`;
                        const targetAttr = resource.external ? 'target="_blank" rel="noopener noreferrer"' : '';
                        const tagName = isPdf ? 'button' : 'a';
                        return `<${tagName} ${actionAttr} ${targetAttr} class="resource-item flex items-center p-3 bg-white border border-gray-200 rounded-lg hover:bg-gray-50 hover:border-teal-500 transition-all duration-200 group w-full text-left"><i data-lucide="${icon}" class="h-6 w-6 text-teal-500 mr-4"></i><span class="flex-1 font-medium text-gray-700 group-hover:text-teal-600">${resource.name}</span><i data-lucide="arrow-right" class="h-5 w-5 text-gray-400 group-hover:text-teal-500 transition-transform transform group-hover:translate-x-1"></i></${tagName}>`;
                    }).join('');
                } else {
                    dom.resourcesList.innerHTML = `<div class="text-center py-5 px-4 bg-gray-100 rounded-lg"><p class="text-gray-500 text-sm">No hay recursos del instructor para esta lección.</p></div>`;
                }
                lucide.createIcons();
            }

            function openPdfModal(url, title) {
                if (!dom.pdfModal || !dom.pdfModalOverlay || !dom.pdfModalContent || !dom.pdfIframe) return;
                dom.pdfModalTitle && (dom.pdfModalTitle.textContent = title);
                const viewerUrl = `https://docs.google.com/gview?url=${encodeURIComponent(url)}&embedded=true`;
                dom.pdfIframe.src = viewerUrl;
                dom.pdfModal.classList.remove('hidden');
                dom.pdfModalOverlay.classList.remove('hidden');
                setTimeout(() => { dom.pdfModalOverlay.classList.add('opacity-100'); dom.pdfModalContent.classList.remove('scale-95', 'opacity-0'); }, 10);
            }

            function closePdfModal() {
                if (!dom.pdfModal || !dom.pdfModalOverlay || !dom.pdfModalContent || !dom.pdfIframe) return;
                dom.pdfModalOverlay.classList.remove('opacity-100');
                dom.pdfModalContent.classList.add('scale-95', 'opacity-0');
                setTimeout(() => { dom.pdfModal.classList.add('hidden'); dom.pdfModalOverlay.classList.add('hidden'); dom.pdfIframe.src = ''; }, 300);
            }

            if (dom.resourcesList) dom.resourcesList.addEventListener('click', (e) => {
                const button = e.target.closest('.resource-item[data-pdf-url]');
                if (button) openPdfModal(button.dataset.pdfUrl, button.dataset.pdfTitle);
            });
            if (dom.pdfModalCloseBtn) dom.pdfModalCloseBtn.addEventListener('click', closePdfModal);
            if (dom.pdfModalOverlay) dom.pdfModalOverlay.addEventListener('click', closePdfModal);

            async function downloadTranscription(transcriptionUrl, lessonTitle) {
                if (!transcriptionUrl) {
                    showToast('No hay transcripción disponible para descargar.');
                    return;
                }
                
                const btn = document.getElementById('transcription-button');
                if (!btn) return;
                
                const btnSpan = btn.querySelector('span');
                const originalText = btnSpan ? btnSpan.textContent : 'Descargar Transcripción';
                
                if (btnSpan) btnSpan.textContent = 'Preparando...';
                btn.disabled = true;

                try {
                    const resolvedUrl = await resolveStorageDownloadURL(storage, transcriptionUrl);
                    const response = await fetch(resolvedUrl);
                    if (!response.ok) throw new Error('Respuesta de red no fue OK');
                    
                    const srtText = await response.text();
                    
                    const plainText = srtText
                        .split(/\r?\n/)
                        .filter(line => !/^\d+$/.test(line.trim()) && !line.includes('-->'))
                        .join('\n')
                        .replace(/(\n\s*){2,}/g, '\n\n')
                        .trim();

                    const blob = new Blob([plainText], { type: 'text/plain;charset=utf-8' });
                    
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    
                    const sanitizedTitle = lessonTitle.replace(/[^a-z0-9]/gi, '_').toLowerCase();
                    link.download = `transcripcion_${sanitizedTitle}.txt`;
                    
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    URL.revokeObjectURL(link.href);
                    showToast('Descarga iniciada.');

                } catch (error) {
                    console.error('Error al descargar la transcripción:', error);
                    showToast('No se pudo descargar la transcripción.');
                } finally {
                    if (btnSpan) btnSpan.textContent = originalText;
                    btn.disabled = false;
                }
            }

            async function loadUserResources(lessonId) {
                if (!currentUser || !dom.userResourceList) return;
                dom.userResourceList.innerHTML = '<li><p class="p-3 text-sm text-slate-500">Cargando...</p></li>';
                try {
                    const snap = await db.collection('userResources').where('uid', '==', currentUser.uid).where('courseId', '==', courseId).where('lessonId', '==', lessonId).get();
                    if (snap.empty) { dom.userResourceList.innerHTML = '<li><p class="p-3 text-sm text-slate-500">No has subido archivos.</p></li>'; return; }
                    const docs = snap.docs.sort((a, b) => { const timeA = a.data().createdAt?.toDate() || 0; const timeB = b.data().createdAt?.toDate() || 0; return timeB - timeA; });
                    dom.userResourceList.innerHTML = '';
                    docs.forEach(doc => renderUserResourceItem(doc));
                } catch (err) {
                    console.error('Error listando recursos:', err);
                    dom.userResourceList.innerHTML = '<li><p class="p-3 text-sm text-red-500">Error al cargar archivos. Revisa los permisos de Firestore.</p></li>';
                }
            }
            function renderUserResourceItem(doc) {
                if (!dom.userResourceList) return;
                const data = doc.data();
                const li = document.createElement('li');
                li.className = 'px-4 py-3 flex items-center justify-between';
                li.innerHTML = `<div class="min-w-0 flex-1"><p class="text-sm font-medium text-slate-900 truncate">${data.name}</p><p class="text-xs text-slate-500 truncate">${data.contentType || ''} - ${Math.round(data.size / 1024)} KB</p></div><div class="flex items-center gap-3"><a href="${data.downloadURL}" target="_blank" class="text-teal-700 text-sm font-semibold hover:underline">Abrir</a><button class="delete-resource-btn text-red-600 text-sm font-semibold hover:underline">Eliminar</button></div>`;
                li.querySelector('.delete-resource-btn').addEventListener('click', async () => {
                    if (!confirm(`¿Seguro que quieres eliminar "${data.name}"?`)) return;
                    try { await storage.ref(data.storagePath).delete(); await doc.ref.delete(); li.remove(); showToast('Archivo eliminado.'); } 
                    catch (err) { console.error('Error eliminando:', err); showToast('No se pudo eliminar el archivo.'); }
                });
                dom.userResourceList.prepend(li);
            }
            
            if (dom.resourceFileInput) dom.resourceFileInput.addEventListener('change', () => { if (dom.uploadResourcesBtn) dom.uploadResourcesBtn.disabled = dom.resourceFileInput.files.length === 0; });
            if (dom.uploadResourcesBtn) dom.uploadResourcesBtn.addEventListener('click', async () => {
                const files = dom.resourceFileInput ? dom.resourceFileInput.files : null;
                if (!files || !files.length || !currentUser || !dom.uploadProgress) return;
                const lessonId = userProgress.currentLessonId;
                dom.uploadProgress.classList.remove('hidden');
                for (const file of files) {
                    dom.uploadProgress.textContent = `Subiendo ${file.name}...`;
                    const storagePath = `user_uploads/${currentUser.uid}/${courseId}/${lessonId}/${Date.now()}_${file.name}`;
                    const fileRef = storage.ref(storagePath);
                    try {
                        const uploadTask = await fileRef.put(file);
                        const downloadURL = await uploadTask.ref.getDownloadURL();
                        const docRef = await db.collection('userResources').add({ uid: currentUser.uid, courseId, lessonId, name: file.name, size: file.size, contentType: file.type, storagePath, downloadURL, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
                        const newDoc = await docRef.get();
                        if (dom.userResourceList && dom.userResourceList.querySelector('p.text-slate-500')) dom.userResourceList.innerHTML = '';
                        renderUserResourceItem(newDoc);
                    } catch (err) { console.error('Error en subida:', err); dom.uploadProgress.textContent = `Error al subir ${file.name}.`; return; }
                }
                dom.uploadProgress.textContent = '¡Archivos subidos!';
                if (dom.resourceFileInput) dom.resourceFileInput.value = '';
                if (dom.uploadResourcesBtn) dom.uploadResourcesBtn.disabled = true;
                setTimeout(() => dom.uploadProgress && dom.uploadProgress.classList.add('hidden'), 3000);
            });

            async function loadTasks(lessonId) {
                if (!currentUser || !dom.taskList) return;
                const key = `${currentUser.uid}_${courseId}_${lessonId}`;
                dom.taskList.innerHTML = '';
                try {
                    const docRef = db.collection('userTasks').doc(key);
                    const doc = await docRef.get();
                    if (doc.exists) { const items = doc.data().items || []; items.forEach(task => renderTaskItem(task, docRef)); }
                } catch (err) { console.error('Error cargando tareas:', err); }
            }

            function renderTaskItem(task, docRef) {
                if (!dom.taskList) return;
                const li = document.createElement('li');
                li.className = 'bg-white border border-slate-200 rounded-lg p-3 flex items-center justify-between group';
                li.innerHTML = `<label class="flex-1 flex items-center gap-3 cursor-pointer"><input type="checkbox" class="task-toggle h-4 w-4 rounded border-gray-300 text-teal-600 focus:ring-teal-500" ${task.done ? 'checked' : ''}/><span class="text-sm ${task.done ? 'line-through text-slate-400' : 'text-slate-800'}">${task.text}</span></label><button class="task-delete text-slate-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition-opacity"><i data-lucide="trash-2" class="h-4 w-4"></i></button>`;
                const toggle = li.querySelector('.task-toggle');
                toggle.addEventListener('change', async () => { await updateTask(docRef, task, { done: toggle.checked }); const span = li.querySelector('span'); if (span) { span.classList.toggle('line-through', toggle.checked); span.classList.toggle('text-slate-400', toggle.checked); } });
                li.querySelector('.task-delete').addEventListener('click', async () => { await deleteTask(docRef, task); li.remove(); });
                dom.taskList.append(li);
                lucide.createIcons();
            }
            async function updateTask(docRef, oldTask, updates) { const doc = await docRef.get(); const items = doc.exists ? doc.data().items || [] : []; const itemIndex = items.findIndex(item => item.text === oldTask.text); if (itemIndex > -1) { items[itemIndex] = { ...items[itemIndex], ...updates }; await docRef.set({ items }, { merge: true }); } }
            async function deleteTask(docRef, taskToDelete) { const doc = await docRef.get(); const items = doc.exists ? doc.data().items || [] : []; const newItems = items.filter(item => item.text !== taskToDelete.text); await docRef.set({ items: newItems }, { merge: true }); }
            async function addTask() { if (!currentUser || !dom.taskInput) return; const text = dom.taskInput.value.trim(); if (!text) return; const lessonId = userProgress.currentLessonId; const key = `${currentUser.uid}_${courseId}_${lessonId}`; const task = { text, done: false }; try { const docRef = db.collection('userTasks').doc(key); await docRef.set({ uid: currentUser.uid, items: firebase.firestore.FieldValue.arrayUnion(task) }, { merge: true }); renderTaskItem(task, docRef); dom.taskInput.value = ''; } catch (err) { console.error('Error agregando tarea:', err); } }
            if (dom.addTaskBtn) dom.addTaskBtn.addEventListener('click', addTask);
            if (dom.taskInput) dom.taskInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); addTask(); }});
            
            if (dom.supportForm) dom.supportForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(dom.supportForm);
                const lessonInfo = getLessonInfo(userProgress.currentLessonId);
                const dataToSend = { email: auth.currentUser.email, curso: courseData.title, fecha: new Date().toLocaleString('es-CL'), asunto: formData.get('subject'), mensaje: formData.get('message'), leccion: lessonInfo ? lessonInfo.lesson.title : 'Lección no especificada', nombreAlumno: currentUser ? currentUser.name : '' };
                if (dom.supportSubmitBtn) dom.supportSubmitBtn.disabled = true;
                if (dom.supportBtnText) dom.supportBtnText.textContent = 'Enviando...';
                if (dom.supportSpinner) dom.supportSpinner.classList.remove('hidden');
                if (dom.supportFormStatus) dom.supportFormStatus.innerHTML = '';
                try {
                    const webhookUrl = 'https://muna.auto.hostybee.com/webhook-test/soporte';
                    const response = await fetch(webhookUrl, { method: 'POST', body: JSON.stringify(dataToSend), headers: { 'Content-Type': 'application/json' } });
                    if (response.ok) { if (dom.supportFormStatus) dom.supportFormStatus.innerHTML = `<p class="text-green-600 font-semibold">¡Consulta enviada con éxito!</p>`; dom.supportForm.reset(); }
                    else { throw new Error('Error en la respuesta del servidor de n8n'); }
                } catch (error) {
                    console.error('Error al enviar al webhook de n8n:', error);
                    if (dom.supportFormStatus) dom.supportFormStatus.innerHTML = `<p class="text-red-600 font-semibold">Hubo un error al enviar tu consulta. Por favor, intenta más tarde.</p>`;
                } finally {
                    if (dom.supportSubmitBtn) dom.supportSubmitBtn.disabled = false;
                    if (dom.supportBtnText) dom.supportBtnText.textContent = 'Enviar Consulta';
                    if (dom.supportSpinner) dom.supportSpinner.classList.add('hidden');
                }
            });

            function srtToVtt(srt) {
                const cleaned = srt.replace(/\r+/g, '').replace(/^\s*\d+\s*$/gm, '').replace(/(\d{2}):(\d{2}):(\d{2}),(\d{3})/g, '$1:$2:$3.$4');
                return 'WEBVTT\n\n' + cleaned.trim();
            }
            async function resolveStorageDownloadURL(storage, maybeGsOrHttpsUrl) {
                if (!maybeGsOrHttpsUrl) return null;
                try { const ref = storage.refFromURL(maybeGsOrHttpsUrl); return await ref.getDownloadURL(); }
                catch (e) { if (/^https?:\/\//i.test(maybeGsOrHttpsUrl)) return maybeGsOrHttpsUrl; throw e; }
            }
            async function attachMediaAndCaptions({ storage, videoEl, videoSrc, srtOrVttSrc }) {
                const srcEl = videoEl.querySelector('#course-video-source');
                const resolvedVideo = await resolveStorageDownloadURL(storage, videoSrc);
                if (srcEl && resolvedVideo) srcEl.src = resolvedVideo;

                const trackEl = videoEl.querySelector('#caption-track');
                if (!trackEl || !srtOrVttSrc) { videoEl.load(); return; }

                const resolvedTrack = await resolveStorageDownloadURL(storage, srtOrVttSrc);
                if (!resolvedTrack) { videoEl.load(); return; }

                const isSrt = /(\.srt)(\?|$)/i.test(resolvedTrack);
                if (isSrt) {
                    const resp = await fetch(resolvedTrack);
                    const srtTxt = await resp.text();
                    const vttTxt = srtToVtt(srtTxt);
                    const blobUrl = URL.createObjectURL(new Blob([vttTxt], { type: 'text/vtt' }));
                    trackEl.src = blobUrl;
                } else {
                    trackEl.src = resolvedTrack;
                }
                trackEl.default = true;
                const [t] = videoEl.textTracks; if (t) t.mode = 'showing';
                videoEl.load();
            }

            // --- Código del parche aquí ---
            const BLOCK_SELECTORS_ON_COMPLETE = [
              '#main-action-btn',
              'button[id*="encuesta"]',
              '[id*="btn-encuesta"]',
              '[data-action="complete"]',
              '[data-action="encuesta"]',
              '.btn-completar-modulo',
              '.btn-encuesta',
              'a[href*="encuesta"]'
            ];
            
            // Evita bloquear controles de video o elementos dentro del <video>
            function isInsideVideo(el) {
              return !!el.closest('video, .plyr, .video-js, .video-container');
            }

            function hardDisable(el, reason = 'Curso finalizado: acción deshabilitada') {
              if (!el || isInsideVideo(el)) return;
              // estados y accesibilidad
              el.setAttribute('aria-disabled', 'true');
              el.setAttribute('tabindex', '-1');
              el.title = reason;
              // estilos visuales (Tailwind disponible)
              el.classList.add('opacity-60', 'cursor-not-allowed');
              // si es <button> deshabilitar nativo
              if (el.tagName === 'BUTTON') el.disabled = true;

              // Bloqueo duro en captura (antes de cualquier otro listener)
              const blocker = (e) => {
                e.preventDefault();
                e.stopImmediatePropagation();
                e.stopPropagation();
                return false;
              };
              el.addEventListener('click', blocker, true);
              el.addEventListener('pointerdown', blocker, true);
              el.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') blocker(e);
              }, true);
            }

            function lockPostCompletionActions() {
              const courseIsDone = getIsCourseComplete();
              if (!courseIsDone) return;

              // 1) Oculta la barra de navegación si aún no está oculta
              if (dom && dom.navigationButtons) {
                dom.navigationButtons.classList.add('hidden');
              }

              // 2) Deshabilita botones/enlaces de completar y encuesta existentes
              BLOCK_SELECTORS_ON_COMPLETE.forEach((sel) => {
                document.querySelectorAll(sel).forEach((el) => hardDisable(el));
              });

              // 3) Observa futuros nodos que coincidan (por re-render dinámico)
              if (!window.__postCompleteObserver__) {
                window.__postCompleteObserver__ = new MutationObserver(() => {
                  BLOCK_SELECTORS_ON_COMPLETE.forEach((sel) => {
                    document.querySelectorAll(sel).forEach((el) => hardDisable(el));
                  });
                });
                window.__postCompleteObserver__.observe(document.body, { childList: true, subtree: true });
              }
            }
            // --- Fin del código del parche ---

            if (dom.logoutButton) dom.logoutButton.addEventListener('click', () => auth.signOut().then(() => window.location.href = `${baseUrl}/index.html`));

            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = { uid: user.uid, name: user.displayName || 'Alumno' };
                    if (dom.userName) dom.userName.textContent = currentUser.name;
                    if (dom.userAvatar) dom.userAvatar.src = user.photoURL || `https://placehold.co/100x100/14b8a6/FFFFFF?text=${currentUser.name.charAt(0).toUpperCase()}`;
                    if (dom.userProfile) { dom.userProfile.classList.remove('hidden'); dom.userProfile.classList.add('flex'); }
                    loadProgressAndInitialize();
                } else {
                    window.location.href = `${baseUrl}/acceso.html`;
                }
            });
        });
    </script>

    <!-- === START: Scripts de Sincronización y Medios (Refactorizado) === -->
    <script>
    (function(){
      // Kill switch para evitar errores si Firestore no permite escritura
      const FIRESTORE_SYNC = true;

      function getCourseId() {
        try {
          const p = new URLSearchParams(location.search);
          return p.get('course') || (window.COURSE_ID || 'ia-aplicada-esencial');
        } catch(e) { return 'ia-aplicada-esencial'; }
      }
      
      function countLessonsInDOM() {
          try {
              const allCourseData = window.ALL_COURSES_DATA;
              if (allCourseData && allCourseData[getCourseId()]) {
                  return allCourseData[getCourseId()].modules.flatMap(m => m.lessons).length;
              }
              const nodes = document.querySelectorAll('[data-lesson-id]');
              return nodes ? nodes.length : 0;
          } catch(e){ return 0; }
      }

      function whenFirebaseReady(fn, tries){
        tries = tries || 0;
        if (window.firebase && firebase.apps && firebase.apps.length > 0) return fn();
        if (tries > 100) return console.warn('Firebase no está listo para la sincronización.');
        setTimeout(function(){ whenFirebaseReady(fn, tries+1); }, 100);
      }
      
      function syncTotalLessons(){
        if (!FIRESTORE_SYNC) { console.log('[sync] Sincronización de total de lecciones deshabilitada.'); return; }
        try {
          const total = countLessonsInDOM();
          if (!total || !(total > 0)) return;
          const courseId = getCourseId();
          const db = firebase.firestore();
          db.collection('courses').doc(courseId)
            .set({ totalLessons: total }, { merge: true })
            .then(() => console.log(`[sync] Total de lecciones actualizado para ${courseId}: ${total}`))
            .catch(err => console.warn('[sync] Falló la actualización de total de lecciones:', err));
        } catch(e){ console.warn('[sync] Excepción en syncTotalLessons:', e); }
      }
      
      whenFirebaseReady(syncTotalLessons);
      document.addEventListener('DOMContentLoaded', syncTotalLessons);
    })();
    </script>
    <!-- === END: Scripts de Sincronización y Medios === -->

</body>
</html>

