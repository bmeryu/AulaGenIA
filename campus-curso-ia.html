<!DOCTYPE html>
<html lang="es-CL">
<head>
    <meta charset="UTF-8" />
    <title>Lección del Curso - Aula GenIA (Corregido)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="noindex, nofollow">
    <meta name="description" content="Continúa tu aprendizaje en el curso de Inteligencia Artificial Aplicada a Negocios.">
    <link rel="canonical" href="https://aulagenia.cl/campus-curso-ia.html">
    <link rel="icon" href="https://aulagenia.cl/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="https://aulagenia.cl/Logo_AGIA.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@0.368.0/dist/umd/lucide.min.js"></script>
    <style>
        :root { --brand-teal: #14b8a6; }
        body { font-family: 'Poppins', sans-serif; background-color: #f8fafc; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-in-out; }
        .accordion-content.open { max-height: 1000px; }
        .tab-button.active { color: var(--brand-teal); border-bottom-color: var(--brand-teal); }
        .toast-notification { position: fixed; top: 20px; right: 20px; transform: translateX(120%); transition: transform 0.3s ease-in-out; z-index: 1000; }
        .toast-notification.show { transform: translateX(0); }
        .quiz-option { transition: all 0.2s ease-in-out; }
        .quiz-option.selected { border-color: var(--brand-teal); background-color: #f0fdfa; box-shadow: 0 0 0 2px var(--brand-teal); }
        .quiz-option.correct { border-color: #22c55e; background-color: #f0fdf4; }
        .quiz-option.incorrect { border-color: #ef4444; background-color: #fef2f2; }
        #completion-modal.show > div { transform: scale(1); opacity: 1; }
    </style>
</head>
<body class="text-gray-800">

    <div id="app" class="flex flex-col h-screen">
        <header class="bg-white shadow-sm z-20">
            <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
                <a href="campus.html" aria-label="Volver al Campus de Aula GenIA">
                    <img src="https://aulagenia.cl/Logo_AGIA.png" alt="Logo de Aula GenIA" class="h-10 w-auto">
                </a>
                <div id="user-profile-container" class="flex items-center gap-4" style="display: none;">
                    <span class="font-semibold text-gray-700 hidden sm:block" id="user-name"></span>
                    <img id="user-avatar" src="" alt="Avatar del usuario" class="w-10 h-10 rounded-full border-2 border-teal-500">
                    <button id="logout-button" class="text-sm text-gray-500 hover:text-red-600 font-medium transition-colors">Cerrar sesión</button>
                </div>
            </nav>
        </header>

        <main class="flex-1 flex flex-col lg:flex-row overflow-hidden">
            <aside id="course-sidebar" class="w-full lg:w-80 xl:w-96 bg-white border-r border-slate-200 flex-shrink-0 overflow-y-auto">
                <div class="p-6">
                    <a href="campus.html" class="text-sm text-teal-600 hover:text-teal-700 font-semibold flex items-center mb-4"><i data-lucide="arrow-left" class="h-4 w-4 mr-2"></i>Volver a Mis Cursos</a>
                    <h1 id="course-title" class="text-2xl font-bold text-gray-900">Cargando...</h1>
                    <div class="mt-4">
                        <div class="flex justify-between text-sm font-medium text-gray-600 mb-1"><span>Progreso</span><span id="progress-text">0%</span></div>
                        <div class="w-full bg-slate-200 rounded-full h-2.5"><div id="progress-bar" class="bg-teal-500 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div></div>
                    </div>
                </div>
                <nav id="modules-container" class="space-y-1 px-2 pb-6"></nav>
            </aside>

            <section id="lesson-content" class="flex-1 bg-slate-50 overflow-y-auto">
                <div class="p-6 md:p-8 lg:p-10">
                    <h2 id="lesson-title" class="text-3xl font-bold text-gray-900 mb-4">Cargando...</h2>
                    <div id="lesson-material-container" class="mb-6"></div>
                    <div id="tabs-container">
                        <div class="border-b border-slate-200">
                            <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                                <button class="tab-button active" data-tab="descripcion">Descripción</button>
                                <button class="tab-button" data-tab="recursos">Recursos</button>
                                <button class="tab-button" data-tab="notas">Mis Notas</button>
                            </nav>
                        </div>
                        <div class="py-6">
                            <div id="descripcion" class="tab-content prose max-w-none text-gray-600"></div>
                            <div id="recursos" class="tab-content hidden prose max-w-none text-gray-600"></div>
                            <div id="notas" class="tab-content hidden"><textarea class="w-full h-40 p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500" placeholder="Escribe tus notas privadas para esta lección..."></textarea></div>
                        </div>
                    </div>
                    <div class="mt-8 pt-6 border-t border-slate-200 flex justify-between items-center">
                        <button id="prev-lesson-btn" class="px-4 py-2 text-sm font-semibold text-gray-700 bg-white border border-slate-300 rounded-lg shadow-sm hover:bg-slate-100 disabled:opacity-50 disabled:cursor-not-allowed">Lección Anterior</button>
                        <button id="main-action-btn" class="px-6 py-3 text-sm font-semibold text-white bg-teal-500 rounded-lg shadow-sm hover:bg-teal-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 disabled:opacity-50 disabled:cursor-not-allowed">Marcar como completada</button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Notificaciones y Modales -->
    <div id="toast-notification" class="toast-notification bg-gray-800 text-white py-3 px-5 rounded-lg shadow-lg flex items-center gap-3"><i data-lucide="check-circle" class="text-teal-400"></i><span id="toast-message"></span></div>
    <div id="badge-toast" class="toast-notification bg-gradient-to-br from-yellow-400 to-orange-500 text-white p-4 rounded-lg shadow-xl flex items-center gap-4"><i data-lucide="award" class="h-12 w-12 text-white"></i><div><h4 class="font-bold">¡Insignia Desbloqueada!</h4><p id="badge-message" class="text-sm"></p></div></div>
    <div id="completion-modal-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden z-40 transition-opacity duration-300"></div>
    <div id="completion-modal" class="fixed inset-0 hidden z-50 flex items-center justify-center p-4"><div class="bg-white rounded-2xl shadow-2xl p-8 max-w-lg w-full text-center transform transition-all scale-95 opacity-0 duration-300"><i data-lucide="party-popper" class="mx-auto h-20 w-20 text-yellow-500"></i><h2 class="text-3xl font-bold text-gray-900 mt-4">¡Felicitaciones, <span id="modal-user-name"></span>!</h2><p class="text-gray-600 mt-2">Has completado exitosamente el curso "Inteligencia Artificial Aplicada".</p><div class="text-left bg-slate-100 p-4 rounded-lg mt-6"><h3 class="font-semibold flex items-center gap-2"><i data-lucide="award"></i>Tu Certificado</h3><p class="text-sm text-gray-600 mt-1">Tu certificado digital está siendo procesado por nuestro equipo académico. Una vez validado, recibirás un correo con el documento y un enlace para añadirlo a tu perfil de LinkedIn.</p></div><div class="text-left bg-teal-50 border border-teal-200 p-4 rounded-lg mt-4"><h3 class="font-semibold flex items-center gap-2 text-teal-800"><i data-lucide="gift"></i>Tu Recompensa Exclusiva</h3><p class="text-sm text-teal-700 mt-1">Como premio a tu dedicación, hemos desbloqueado un <strong>cupón del 20% de descuento</strong> para tu próximo curso.</p></div><button id="close-modal-btn" class="mt-8 w-full bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-5 rounded-lg transition-colors">Ir a Mis Certificaciones</button></div></div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js" defer></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js" defer></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js" defer></script>

    <script defer>
        document.addEventListener('DOMContentLoaded', () => {
            // --- CONFIGURACIÓN E INICIALIZACIÓN ---
            const firebaseConfig = { apiKey: "AIzaSyC9sVJwEfFdIN4VmSMooAoQLXYl5Mcu1yM", authDomain: "aulagenia.firebaseapp.com", projectId: "aulagenia", storageBucket: "aulagenia.appspot.com", messagingSenderId: "173328075630", appId: "1:173328075630:web:825606db4271ea1e66cf7f" };
            
            try {
                firebase.initializeApp(firebaseConfig);
            } catch(e) {
                console.warn("Firebase ya fue inicializado.");
            }

            const auth = firebase.auth();
            const db = firebase.firestore();
            
            // ===================================================================
            // INICIO: CORRECCIÓN CLAVE 1 - FUENTE DE DATOS ÚNICA
            // Esta estructura de datos ahora define TODOS los cursos. Es la "única fuente de verdad".
            // Debe ser idéntica en todos los archivos que la necesiten (ej. campus.html).
            // ===================================================================
            const ALL_COURSES_DATA = {
                'geniaweek': {
                    title: 'Inteligencia Artificial Aplicada',
                    modules: [
                        {
                            title: 'Módulo 1: Fundamentos',
                            badge: 'Maestro de Fundamentos',
                            lessons: [
                                { id: '1-1', title: '¿Qué es la IA?', type: 'video', desc: 'Introducción conceptual al mundo de la IA.', res: '<li><a href="#">Paper de Alan Turing</a></li>' },
                                { id: '1-2', title: 'Historia y Evolución', type: 'video', desc: 'Un recorrido histórico desde los inicios hasta hoy.', res: '' },
                                { id: '1-3', title: 'IA, ML y Deep Learning', type: 'text', desc: 'Aclarando las diferencias clave entre estos términos.', res: '<li><a href="#">Artículo de Forbes</a></li>' },
                                { id: 'q-1', title: 'Quiz: Módulo 1', type: 'quiz', desc: 'Pon a prueba tus conocimientos sobre los fundamentos.', questions: [{ text: '¿Cuál de estos es un ejemplo de IA "estrecha"?', options: ['Un robot con conciencia', 'Siri o Alexa', 'Terminator'], correctAnswer: 1 }] }
                            ]
                        },
                        {
                            title: 'Módulo 2: IA Generativa',
                            badge: 'Domador de Prompts',
                            lessons: [
                                { id: '2-1', title: 'Introducción a los LLMs', type: 'video', desc: 'Descubre cómo funcionan los modelos de lenguaje.', res: '' },
                                { id: '2-2', title: 'El Arte del Prompt Engineering', type: 'video', desc: 'Aprende a comunicarte efectivamente con la IA.', res: '' },
                                { id: '2-3', title: 'Taller Práctico: Creando Prompts', type: 'resource', desc: 'Descarga nuestra guía y pon a prueba tus habilidades.', res: '<li><a href="#">Guía de Prompts (PDF)</a></li>' },
                                { id: 'q-2', title: 'Quiz: Módulo 2', type: 'quiz', desc: 'Valida tu entendimiento sobre IA Generativa.', questions: [{ text: '¿Qué es un "LLM"?', options: ['Un tipo de hardware', 'Un modelo de lenguaje grande', 'Una criptomoneda'], correctAnswer: 1 }] }
                            ]
                        }
                    ]
                }
                // Aquí se podrían añadir más cursos en el futuro.
            };
            // ===================================================================
            // FIN: CORRECCIÓN CLAVE 1
            // ===================================================================

            const courseId = 'geniaweek'; // ID del curso actual
            const courseData = ALL_COURSES_DATA[courseId];
            
            // --- ESTADO DE LA APLICACIÓN ---
            const allLessons = courseData.modules.flatMap(m => m.lessons);
            let currentUser = null;
            let userProgress = { completedLessons: [], currentLessonId: allLessons[0].id };

            // --- REFERENCIAS AL DOM ---
            const dom = {
                userProfile: document.getElementById('user-profile-container'), userName: document.getElementById('user-name'), userAvatar: document.getElementById('user-avatar'), logoutButton: document.getElementById('logout-button'), courseTitle: document.getElementById('course-title'), progressBar: document.getElementById('progress-bar'), progressText: document.getElementById('progress-text'), modulesContainer: document.getElementById('modules-container'), lessonTitle: document.getElementById('lesson-title'), prevBtn: document.getElementById('prev-lesson-btn'), mainActionBtn: document.getElementById('main-action-btn'), toast: document.getElementById('toast-notification'), toastMessage: document.getElementById('toast-message'), badgeToast: document.getElementById('badge-toast'), badgeMessage: document.getElementById('badge-message'), lessonMaterialContainer: document.getElementById('lesson-material-container'), tabs: { descripcion: document.getElementById('descripcion'), recursos: document.getElementById('recursos'), notas: document.getElementById('notas') }, tabButtons: document.querySelectorAll('.tab-button'), completionModalOverlay: document.getElementById('completion-modal-overlay'), completionModal: document.getElementById('completion-modal'), modalUserName: document.getElementById('modal-user-name'), closeModalBtn: document.getElementById('close-modal-btn')
            };

            // --- FUNCIONES DE RENDERIZADO Y LÓGICA DE UI ---

            function refreshUI() {
                dom.courseTitle.textContent = courseData.title;
                renderSidebar();
                const lesson = allLessons.find(l => l.id === userProgress.currentLessonId);
                if (lesson) {
                    dom.lessonTitle.textContent = lesson.title;
                    renderLessonContent(lesson);
                    updateMainActionButton();
                    dom.prevBtn.disabled = allLessons.findIndex(l => l.id === lesson.id) === 0;
                }
                updateOverallProgress();
                lucide.createIcons();
            }

            function renderSidebar() {
                dom.modulesContainer.innerHTML = courseData.modules.map(module => {
                    const lessonsHtml = module.lessons.map(lesson => {
                        const isCompleted = userProgress.completedLessons.includes(lesson.id);
                        const isActive = userProgress.currentLessonId === lesson.id;
                        const statusIcon = isCompleted ? 'check-circle-2' : (lesson.type === 'quiz' ? 'help-circle' : 'circle');
                        const iconColor = isCompleted ? 'text-green-500' : 'text-slate-300';
                        const activeClass = isActive ? 'bg-teal-50 text-teal-700 font-semibold' : 'text-gray-600 hover:bg-slate-100';
                        const typeIcon = { video: 'video', text: 'file-text', resource: 'download', quiz: 'edit-3' }[lesson.type] || 'file';
                        return `<li class="lesson-item" data-lesson-id="${lesson.id}"><a href="#" class="flex items-center p-2 ml-2 rounded-md ${activeClass}"><i data-lucide="${isActive ? 'play-circle' : statusIcon}" class="h-5 w-5 mr-3 ${isActive ? '' : iconColor}"></i><span class="flex-1 text-sm">${lesson.title}</span><i data-lucide="${typeIcon}" class="h-4 w-4 ml-2"></i></a></li>`;
                    }).join('');
                    return `<div class="accordion-item"><button class="accordion-header w-full flex justify-between items-center p-3 rounded-md hover:bg-slate-100 text-left"><span class="font-semibold text-gray-800">${module.title}</span><i data-lucide="chevron-down" class="h-5 w-5 transition-transform text-gray-500"></i></button><div class="accordion-content open pl-4"><ul class="border-l border-slate-200 py-2 space-y-1">${lessonsHtml}</ul></div></div>`;
                }).join('');
                addSidebarListeners();
            }

            function renderLessonContent(lesson) {
                let materialHtml = '';
                switch(lesson.type) {
                    case 'video': materialHtml = `<div class="aspect-w-16 aspect-h-9"><div class="w-full h-full bg-slate-900 rounded-xl flex items-center justify-center text-white"><i data-lucide="play-circle" class="h-20 w-20 text-slate-500"></i></div></div>`; break;
                    case 'text': materialHtml = `<div class="aspect-w-16 aspect-h-9"><div class="w-full h-full bg-white border border-slate-200 rounded-xl flex flex-col items-center justify-center text-slate-600 p-8"><i data-lucide="file-text" class="h-20 w-20 text-slate-400 mb-4"></i><p class="text-center">Material de lectura en la pestaña 'Descripción'.</p></div></div>`; break;
                    case 'resource': materialHtml = `<div class="aspect-w-16 aspect-h-9"><div class="w-full h-full bg-white border border-slate-200 rounded-xl flex flex-col items-center justify-center text-slate-600 p-8"><i data-lucide="package-check" class="h-20 w-20 text-slate-400 mb-4"></i><p class="text-center mb-4">Recursos descargables en la pestaña 'Recursos'.</p><a href="#" class="bg-teal-500 text-white font-semibold px-4 py-2 rounded-lg hover:bg-teal-600 flex items-center gap-2"><i data-lucide="download"></i>Descargar</a></div></div>`; break;
                    case 'quiz':
                        const question = lesson.questions[0];
                        const optionsHtml = question.options.map((opt, index) => `<div class="quiz-option border-2 border-slate-300 p-4 rounded-lg cursor-pointer hover:bg-slate-100" data-index="${index}">${opt}</div>`).join('');
                        materialHtml = `<div class="space-y-4"><h3 class="text-xl font-semibold">${question.text}</h3><div class="space-y-3">${optionsHtml}</div><button id="check-quiz-btn" class="mt-4 bg-gray-800 text-white font-semibold px-4 py-2 rounded-lg hover:bg-gray-900">Verificar Respuesta</button></div>`;
                        break;
                }
                dom.lessonMaterialContainer.innerHTML = materialHtml;
                if (lesson.type === 'quiz') {
                    dom.lessonMaterialContainer.querySelectorAll('.quiz-option').forEach(opt => opt.addEventListener('click', () => {
                        dom.lessonMaterialContainer.querySelectorAll('.quiz-option').forEach(o => o.classList.remove('selected'));
                        opt.classList.add('selected');
                    }));
                    document.getElementById('check-quiz-btn').addEventListener('click', () => checkQuizAnswer(lesson));
                }
                dom.tabs.descripcion.innerHTML = lesson.desc || 'No hay descripción.';
                dom.tabs.recursos.innerHTML = lesson.res ? `<ul>${lesson.res}</ul>` : 'No hay recursos.';
            }
            
            function updateMainActionButton() {
                const lesson = allLessons.find(l => l.id === userProgress.currentLessonId);
                const isCompleted = userProgress.completedLessons.includes(lesson.id);
                const isLastLesson = allLessons.findIndex(l => l.id === lesson.id) === allLessons.length - 1;
                
                dom.mainActionBtn.disabled = false; // Habilitar por defecto
                
                if (lesson.type === 'quiz' && !isCompleted) {
                    dom.mainActionBtn.disabled = true;
                }
                
                dom.mainActionBtn.textContent = isCompleted ? (isLastLesson ? 'Finalizar Curso' : 'Siguiente Lección') : 'Marcar como completada';
                
                if (isLastLesson && !isCompleted) {
                    const allOthersCompleted = allLessons.filter(l => l.id !== lesson.id).every(l => userProgress.completedLessons.includes(l.id));
                    if (!allOthersCompleted) dom.mainActionBtn.disabled = true;
                }
            }

            function updateOverallProgress() {
                const completedCount = Array.isArray(userProgress.completedLessons) ? userProgress.completedLessons.length : 0;
                const percentage = allLessons.length > 0 ? Math.round((completedCount / allLessons.length) * 100) : 0;
                dom.progressBar.style.width = `${percentage}%`;
                dom.progressText.textContent = `${percentage}%`;
            }

            function checkQuizAnswer(lesson) {
                const selectedOption = dom.lessonMaterialContainer.querySelector('.quiz-option.selected');
                if (!selectedOption) { showToast('Por favor, selecciona una respuesta.'); return; }
                const selectedIndex = parseInt(selectedOption.dataset.index);
                const correctIndex = lesson.questions[0].correctAnswer;
                dom.lessonMaterialContainer.querySelectorAll('.quiz-option').forEach(opt => opt.style.pointerEvents = 'none');
                if (selectedIndex === correctIndex) {
                    selectedOption.classList.add('correct');
                    showToast('¡Respuesta Correcta!');
                    dom.mainActionBtn.disabled = false;
                } else {
                    selectedOption.classList.add('incorrect');
                    dom.lessonMaterialContainer.querySelector(`[data-index="${correctIndex}"]`).classList.add('correct');
                    showToast('Respuesta incorrecta. ¡Sigue intentando!');
                    setTimeout(() => {
                        dom.lessonMaterialContainer.querySelectorAll('.quiz-option').forEach(opt => {
                            opt.classList.remove('incorrect', 'correct', 'selected');
                            opt.style.pointerEvents = 'auto';
                        });
                    }, 2000);
                }
            }

            // --- MANEJO DE ESTADO Y DATOS ---

            async function navigateToLesson(lessonId) {
                const lesson = allLessons.find(l => l.id === lessonId);
                if (!lesson) {
                    console.error(`Error: Se intentó navegar a una lección inexistente con ID: ${lessonId}`);
                    return;
                }
                userProgress.currentLessonId = lessonId;
                await saveProgress();
                refreshUI();
            }

            // ===================================================================
            // INICIO: CORRECCIÓN CLAVE 2 - FUNCIÓN DE GUARDADO ROBUSTA
            // Se añaden logs para depuración. Ahora podemos ver en la consola si el
            // guardado fue exitoso o si falló.
            // ===================================================================
            async function saveProgress() {
                if (!currentUser) {
                    console.warn("Intento de guardar progreso sin un usuario autenticado.");
                    return;
                }
                try {
                    const progressRef = db.collection('userProgress').doc(currentUser.uid);
                    // Aseguramos que completedLessons sea siempre un array para evitar errores
                    if (!Array.isArray(userProgress.completedLessons)) {
                        userProgress.completedLessons = [];
                    }
                    await progressRef.set({ [courseId]: userProgress }, { merge: true });
                    console.log("Progreso guardado exitosamente en Firestore:", userProgress);
                } catch (error) {
                    console.error("Error CRÍTICO al guardar el progreso:", error);
                    alert("No se pudo guardar tu progreso. Por favor, revisa tu conexión a internet y la consola para más detalles.");
                }
            }
            // ===================================================================
            // FIN: CORRECCIÓN CLAVE 2
            // ===================================================================

            async function loadProgressAndInitialize() {
                const docRef = db.collection('userProgress').doc(currentUser.uid);
                try {
                    const doc = await docRef.get();
                    if (doc.exists) {
                        const courseProgress = doc.data()[courseId];
                        if (courseProgress) {
                            const savedLessonIdIsValid = courseProgress.currentLessonId && allLessons.some(l => l.id === courseProgress.currentLessonId);
                            userProgress = {
                                completedLessons: Array.isArray(courseProgress.completedLessons) ? courseProgress.completedLessons : [],
                                currentLessonId: savedLessonIdIsValid ? courseProgress.currentLessonId : allLessons[0].id
                            };
                        }
                    }
                } catch (error) { 
                    console.error("Error crítico al cargar progreso. Se usará el progreso por defecto.", error);
                }
                refreshUI();
            }

            // --- MANEJADORES DE EVENTOS ---
            function addSidebarListeners() {
                dom.modulesContainer.querySelectorAll('.lesson-item a').forEach(link => link.addEventListener('click', e => { e.preventDefault(); navigateToLesson(e.currentTarget.closest('.lesson-item').dataset.lessonId); }));
                dom.modulesContainer.querySelectorAll('.accordion-header').forEach(header => header.addEventListener('click', () => { const content = header.nextElementSibling; content.classList.toggle('open'); header.querySelector('i').style.transform = content.classList.contains('open') ? 'rotate(180deg)' : 'rotate(0deg)'; }));
            }

            dom.mainActionBtn.addEventListener('click', async () => {
                console.log('Botón de acción principal presionado.'); // Log para depuración
                const lessonId = userProgress.currentLessonId;
                const isCompleted = userProgress.completedLessons.includes(lessonId);
                
                if (!isCompleted) {
                    // Solo añade la lección si no está ya en la lista
                    userProgress.completedLessons.push(lessonId);
                    await saveProgress(); // Guardamos el progreso
                    checkForBadgeUnlock(lessonId);
                    showToast('¡Lección completada!');
                    refreshUI(); // Actualizamos la UI para reflejar el estado "completado"
                }
                
                // Lógica para avanzar a la siguiente lección o finalizar
                const currentIndex = allLessons.findIndex(l => l.id === lessonId);
                if (currentIndex < allLessons.length - 1) {
                    navigateToLesson(allLessons[currentIndex + 1].id);
                } else {
                    // Solo mostramos el modal de finalización si TODAS las lecciones están completas
                    if(userProgress.completedLessons.length === allLessons.length) {
                       showCompletionModal();
                    } else {
                       showToast('¡Felicidades! Has terminado la última lección.');
                    }
                }
            });

            dom.prevBtn.addEventListener('click', () => {
                const currentIndex = allLessons.findIndex(l => l.id === userProgress.currentLessonId);
                if (currentIndex > 0) navigateToLesson(allLessons[currentIndex - 1].id);
            });

            dom.tabButtons.forEach(button => button.addEventListener('click', () => {
                dom.tabButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                Object.values(dom.tabs).forEach(content => content.classList.add('hidden'));
                dom.tabs[button.dataset.tab].classList.remove('hidden');
            }));
            
            dom.closeModalBtn.addEventListener('click', () => window.location.href = 'campus.html');
            dom.completionModalOverlay.addEventListener('click', () => window.location.href = 'campus.html');

            // --- AUTENTICACIÓN Y PUNTO DE ENTRADA ---
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = { uid: user.uid, name: user.displayName || 'Alumno' };
                    
                    const name = currentUser.name;
                    const photoURL = user.photoURL || `https://placehold.co/100x100/14b8a6/FFFFFF?text=${name.charAt(0).toUpperCase()}`;
                    dom.userName.textContent = name;
                    dom.userAvatar.src = photoURL;
                    dom.userProfile.style.display = 'flex';
                    dom.logoutButton.addEventListener('click', () => auth.signOut().then(() => window.location.href = 'index.html'));

                    loadProgressAndInitialize();
                } else {
                    window.location.href = 'acceso.html';
                }
            });

            // --- FUNCIONES UTILITARIAS ---
            function showToast(message, type = 'generic') {
                const toastEl = type === 'badge' ? dom.badgeToast : dom.toast;
                const msgEl = type === 'badge' ? dom.badgeMessage : dom.toastMessage;
                msgEl.textContent = message;
                toastEl.classList.add('show');
                setTimeout(() => toastEl.classList.remove('show'), 4000);
            }

            function checkForBadgeUnlock(completedLessonId) {
                const module = courseData.modules.find(m => m.lessons.some(l => l.id === completedLessonId));
                if (!module || !module.badge) return;
                const lastLessonOfModule = module.lessons[module.lessons.length - 1].id;
                if (completedLessonId !== lastLessonOfModule) return;
                const moduleLessonsIds = module.lessons.map(l => l.id);
                if (moduleLessonsIds.every(id => userProgress.completedLessons.includes(id))) {
                    showToast(`Has ganado la insignia: "${module.badge}"`, 'badge');
                }
            }
            
            function showCompletionModal() {
                dom.modalUserName.textContent = currentUser.name;
                dom.completionModalOverlay.classList.remove('hidden');
                dom.completionModal.classList.remove('hidden');
                setTimeout(() => {
                    dom.completionModalOverlay.classList.add('opacity-100');
                    dom.completionModal.classList.add('show');
                }, 10);
            }
        });
    </script>
</body>
</html>
