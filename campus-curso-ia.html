<!DOCTYPE html>
<html lang="es-CL">
<head>
    <meta charset="UTF-8" />
    <title>Lección del Curso - Aula GenIA</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="noindex, nofollow">
    <meta name="description" content="Continúa tu aprendizaje en el curso de Inteligencia Artificial Aplicada a Negocios.">
    <link rel="canonical" href="https://aulagenia.cl/campus-curso-ia.html">
    <link rel="icon" href="https://aulagenia.cl/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="https://aulagenia.cl/Logo_AGIA.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@0.368.0/dist/umd/lucide.min.js"></script>
    <style>
        :root {
            --brand-teal: #14b8a6;
        }
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f8fafc;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
        }
        .accordion-content.open {
            max-height: 1000px; /* Aumentado para más lecciones */
        }
        .tab-button.active {
            color: var(--brand-teal);
            border-bottom-color: var(--brand-teal);
        }
        /* Estilos para la notificación Toast */
        .toast-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            transform: translateX(120%);
            transition: transform 0.3s ease-in-out;
            z-index: 1000;
        }
        .toast-notification.show {
            transform: translateX(0);
        }
    </style>
</head>
<body class="text-gray-800">

    <div id="app" class="flex flex-col h-screen">
        <header class="bg-white shadow-sm z-20">
            <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
                <a href="campus.html" aria-label="Volver al Campus de Aula GenIA">
                    <img src="https://aulagenia.cl/Logo_AGIA.png" alt="Logo de Aula GenIA" class="h-10 w-auto">
                </a>
                <div id="user-profile-container" class="flex items-center gap-4" style="display: none;">
                    <span class="font-semibold text-gray-700 hidden sm:block" id="user-name"></span>
                    <img id="user-avatar" src="" alt="Avatar del usuario" class="w-10 h-10 rounded-full border-2 border-teal-500">
                    <button id="logout-button" class="text-sm text-gray-500 hover:text-red-600 font-medium transition-colors">Cerrar sesión</button>
                </div>
            </nav>
        </header>

        <main class="flex-1 flex flex-col lg:flex-row overflow-hidden">
            <aside id="course-sidebar" class="w-full lg:w-80 xl:w-96 bg-white border-r border-slate-200 flex-shrink-0 overflow-y-auto">
                <div class="p-6">
                    <a href="campus.html" class="text-sm text-teal-600 hover:text-teal-700 font-semibold flex items-center mb-4">
                        <i data-lucide="arrow-left" class="h-4 w-4 mr-2"></i>
                        Volver a Mis Cursos
                    </a>
                    <h1 class="text-2xl font-bold text-gray-900">GenIA Week: Acceso Total</h1>
                    <div class="mt-4">
                        <div class="flex justify-between text-sm font-medium text-gray-600 mb-1">
                            <span>Progreso</span>
                            <span id="progress-text">0%</span>
                        </div>
                        <div class="w-full bg-slate-200 rounded-full h-2.5">
                            <div id="progress-bar" class="bg-teal-500 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                
                <nav id="modules-container" class="space-y-1 px-2 pb-6"></nav>
            </aside>

            <section id="lesson-content" class="flex-1 bg-slate-50 overflow-y-auto">
                <div class="p-6 md:p-8 lg:p-10">
                    <h2 id="lesson-title" class="text-3xl font-bold text-gray-900 mb-4">Cargando...</h2>
                    
                    <div id="lesson-material-container" class="aspect-w-16 aspect-h-9 mb-6">
                        <!-- El contenido dinámico de la lección (video, texto, etc.) se renderizará aquí -->
                    </div>

                    <div id="tabs-container">
                        <div class="border-b border-slate-200">
                            <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                                <button class="tab-button active" data-tab="descripcion">Descripción</button>
                                <button class="tab-button" data-tab="recursos">Recursos</button>
                                <button class="tab-button" data-tab="notas">Mis Notas</button>
                            </nav>
                        </div>
                        <div class="py-6">
                            <div id="descripcion" class="tab-content prose max-w-none text-gray-600"></div>
                            <div id="recursos" class="tab-content hidden prose max-w-none text-gray-600"></div>
                            <div id="notas" class="tab-content hidden">
                                <textarea class="w-full h-40 p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500" placeholder="Escribe tus notas privadas para esta lección..."></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="mt-8 pt-6 border-t border-slate-200 flex justify-between items-center">
                        <button id="prev-lesson-btn" class="px-4 py-2 text-sm font-semibold text-gray-700 bg-white border border-slate-300 rounded-lg shadow-sm hover:bg-slate-100 disabled:opacity-50 disabled:cursor-not-allowed">Lección Anterior</button>
                        <button id="main-action-btn" class="px-6 py-3 text-sm font-semibold text-white bg-teal-500 rounded-lg shadow-sm hover:bg-teal-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 disabled:opacity-50 disabled:cursor-not-allowed">Marcar como completada</button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Notificación Toast Genérica -->
    <div id="toast-notification" class="toast-notification bg-gray-800 text-white py-3 px-5 rounded-lg shadow-lg flex items-center gap-3">
        <i data-lucide="check-circle" class="text-teal-400"></i>
        <span id="toast-message"></span>
    </div>
    <!-- Notificación Toast de Insignia -->
    <div id="badge-toast" class="toast-notification bg-gradient-to-br from-yellow-400 to-orange-500 text-white p-4 rounded-lg shadow-xl flex items-center gap-4">
        <i data-lucide="award" class="h-12 w-12 text-white"></i>
        <div>
            <h4 class="font-bold">¡Insignia Desbloqueada!</h4>
            <p id="badge-message" class="text-sm"></p>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js" defer></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js" defer></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js" defer></script>

    <script type="module">
        document.addEventListener('DOMContentLoaded', () => {
            const firebaseConfig = { apiKey: "AIzaSyC9sVJwEfFdIN4VmSMooAoQLXYl5Mcu1yM", authDomain: "aulagenia.firebaseapp.com", projectId: "aulagenia", storageBucket: "aulagenia.appspot.com", messagingSenderId: "173328075630", appId: "1:173328075630:web:825606db4271ea1e66cf7f" };
            firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const db = firebase.firestore();
            
            const courseId = 'geniaweek';
            const courseData = {
                title: 'GenIA Week: Acceso Total',
                modules: [
                    {
                        title: 'Módulo 1: Fundamentos de la IA',
                        badge: 'Maestro de Fundamentos',
                        lessons: [
                            { id: '1-1', title: '¿Qué es la Inteligencia Artificial?', type: 'video', description: 'Una introducción conceptual al mundo de la IA.', resources: '<li><a href="#">Paper de Alan Turing</a></li>' },
                            { id: '1-2', title: 'Historia y Evolución de la IA', type: 'video', description: 'Un recorrido histórico desde los inicios hasta hoy.', resources: '' },
                            { id: '1-3', title: 'IA, Machine Learning y Deep Learning', type: 'text', description: 'Aclarando las diferencias clave entre estos términos.', resources: '<li><a href="#">Artículo de Forbes</a></li>' },
                        ]
                    },
                    {
                        title: 'Módulo 2: IA Generativa y LLMs',
                        badge: 'Domador de Prompts',
                        lessons: [
                            { id: '2-1', title: 'Introducción a los LLMs', type: 'video', description: 'Descubre cómo funcionan los modelos de lenguaje grandes.', resources: '' },
                            { id: '2-2', title: 'El Arte del Prompt Engineering', type: 'video', description: 'Aprende a comunicarte efectivamente con la IA.', resources: '' },
                            { id: '2-3', title: 'Taller Práctico: Creando Prompts', type: 'resource', description: 'Descarga nuestra guía de prompts y pon a prueba tus habilidades.', resources: '<li><a href="#">Guía de Prompts Avanzados (PDF)</a></li>' },
                        ]
                    }
                ]
            };
            const allLessons = courseData.modules.flatMap(m => m.lessons);
            let currentUserId = null;
            let userProgress = { completedLessons: [], currentLessonId: allLessons[0].id };

            const dom = {
                userProfile: document.getElementById('user-profile-container'), userName: document.getElementById('user-name'), userAvatar: document.getElementById('user-avatar'), logoutButton: document.getElementById('logout-button'), progressBar: document.getElementById('progress-bar'), progressText: document.getElementById('progress-text'), modulesContainer: document.getElementById('modules-container'), lessonTitle: document.getElementById('lesson-title'), prevBtn: document.getElementById('prev-lesson-btn'), mainActionBtn: document.getElementById('main-action-btn'), toast: document.getElementById('toast-notification'), toastMessage: document.getElementById('toast-message'), badgeToast: document.getElementById('badge-toast'), badgeMessage: document.getElementById('badge-message'), lessonMaterialContainer: document.getElementById('lesson-material-container'), tabs: { desc: document.getElementById('descripcion'), res: document.getElementById('recursos'), notes: document.getElementById('notas') }, tabButtons: document.querySelectorAll('.tab-button')
            };

            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUserId = user.uid;
                    setupUserProfile(user);
                    loadProgressAndInitialize();
                } else {
                    window.location.href = 'acceso.html';
                }
            });

            function setupUserProfile(user) {
                const displayName = user.displayName || 'Alumno';
                const photoURL = user.photoURL || `https://placehold.co/100x100/14b8a6/FFFFFF?text=${displayName.charAt(0).toUpperCase()}`;
                dom.userName.textContent = displayName;
                dom.userAvatar.src = photoURL;
                dom.userProfile.style.display = 'flex';
                dom.logoutButton.addEventListener('click', () => auth.signOut().then(() => window.location.href = 'index.html'));
            }

            async function loadProgressAndInitialize() {
                const docRef = db.collection('userProgress').doc(currentUserId);
                try {
                    const doc = await docRef.get();
                    if (doc.exists) {
                        const courseProgress = doc.data()[courseId];
                        if (courseProgress) userProgress = { ...userProgress, ...courseProgress };
                    }
                    initializeAppUI();
                } catch (error) {
                    console.error("Error al cargar progreso:", error);
                    initializeAppUI();
                }
            }

            function initializeAppUI() {
                renderSidebar();
                navigateToLesson(userProgress.currentLessonId);
                updateOverallProgress();
                lucide.createIcons();
            }
            
            function renderSidebar() {
                dom.modulesContainer.innerHTML = courseData.modules.map(module => {
                    const lessonsHtml = module.lessons.map(lesson => {
                        const isCompleted = userProgress.completedLessons.includes(lesson.id);
                        const isActive = userProgress.currentLessonId === lesson.id;
                        const statusIcon = isCompleted ? 'check-circle-2' : 'circle';
                        const iconColor = isCompleted ? 'text-green-500' : 'text-slate-300';
                        const activeClass = isActive ? 'bg-teal-50 text-teal-700 font-semibold' : 'text-gray-600 hover:bg-slate-100';
                        const typeIcon = { video: 'video', text: 'file-text', resource: 'download' }[lesson.type] || 'file';
                        return `<li class="lesson-item" data-lesson-id="${lesson.id}"><a href="#" class="flex items-center p-2 ml-2 rounded-md ${activeClass}"><i data-lucide="${isActive ? 'play-circle' : statusIcon}" class="h-5 w-5 mr-3 ${isActive ? '' : iconColor}"></i><span class="flex-1 text-sm">${lesson.title}</span><i data-lucide="${typeIcon}" class="h-4 w-4 ml-2"></i></a></li>`;
                    }).join('');
                    return `<div class="accordion-item"><button class="accordion-header w-full flex justify-between items-center p-3 rounded-md hover:bg-slate-100 text-left"><span class="font-semibold text-gray-800">${module.title}</span><i data-lucide="chevron-down" class="h-5 w-5 transition-transform text-gray-500"></i></button><div class="accordion-content open pl-4"><ul class="border-l border-slate-200 py-2 space-y-1">${lessonsHtml}</ul></div></div>`;
                }).join('');
                addSidebarListeners();
            }

            function addSidebarListeners() {
                dom.modulesContainer.querySelectorAll('.lesson-item a').forEach(link => link.addEventListener('click', e => { e.preventDefault(); navigateToLesson(e.currentTarget.closest('.lesson-item').dataset.lessonId); }));
                dom.modulesContainer.querySelectorAll('.accordion-header').forEach(header => header.addEventListener('click', () => { const content = header.nextElementSibling; content.classList.toggle('open'); header.querySelector('i').style.transform = content.classList.contains('open') ? 'rotate(180deg)' : 'rotate(0deg)'; }));
            }

            function renderLessonContent(lesson) {
                let materialHtml = '';
                switch(lesson.type) {
                    case 'video':
                        materialHtml = `<div class="w-full h-full bg-slate-900 rounded-xl flex items-center justify-center text-white"><i data-lucide="play-circle" class="h-20 w-20 text-slate-500"></i></div>`;
                        break;
                    case 'text':
                        materialHtml = `<div class="w-full h-full bg-white border border-slate-200 rounded-xl flex flex-col items-center justify-center text-slate-600 p-8"><i data-lucide="file-text" class="h-20 w-20 text-slate-400 mb-4"></i><p class="text-center">Este es un material de lectura. Encuentra el contenido en la pestaña de 'Descripción'.</p></div>`;
                        break;
                    case 'resource':
                        materialHtml = `<div class="w-full h-full bg-white border border-slate-200 rounded-xl flex flex-col items-center justify-center text-slate-600 p-8"><i data-lucide="package-check" class="h-20 w-20 text-slate-400 mb-4"></i><p class="text-center mb-4">Esta lección contiene recursos descargables.</p><a href="#" class="bg-teal-500 text-white font-semibold px-4 py-2 rounded-lg hover:bg-teal-600 flex items-center gap-2"><i data-lucide="download"></i>Descargar Recursos</a></div>`;
                        break;
                }
                dom.lessonMaterialContainer.innerHTML = materialHtml;
                dom.tabs.desc.innerHTML = lesson.description || 'No hay descripción disponible.';
                dom.tabs.res.innerHTML = lesson.resources ? `<ul>${lesson.resources}</ul>` : 'No hay recursos para esta lección.';
                lucide.createIcons();
            }

            function navigateToLesson(lessonId) {
                const lesson = allLessons.find(l => l.id === lessonId);
                if (!lesson) return;
                userProgress.currentLessonId = lessonId;
                const currentIndex = allLessons.findIndex(l => l.id === lessonId);
                dom.lessonTitle.textContent = lesson.title;
                renderLessonContent(lesson);
                updateMainActionButton();
                dom.prevBtn.disabled = currentIndex === 0;
                renderSidebar();
                saveProgress();
            }

            function updateMainActionButton() {
                const isCompleted = userProgress.completedLessons.includes(userProgress.currentLessonId);
                const isLastLesson = allLessons.findIndex(l => l.id === userProgress.currentLessonId) === allLessons.length - 1;
                
                if (isCompleted) {
                    dom.mainActionBtn.textContent = isLastLesson ? 'Finalizar Curso' : 'Continuar';
                } else {
                    dom.mainActionBtn.textContent = 'Marcar como completada';
                }
                
                if (isLastLesson) {
                    const allOthersCompleted = allLessons.filter(l => l.id !== userProgress.currentLessonId).every(l => userProgress.completedLessons.includes(l.id));
                    dom.mainActionBtn.disabled = !allOthersCompleted && !isCompleted;
                } else {
                    dom.mainActionBtn.disabled = false;
                }
            }

            function updateOverallProgress() {
                const percentage = allLessons.length > 0 ? Math.round((userProgress.completedLessons.length / allLessons.length) * 100) : 0;
                dom.progressBar.style.width = `${percentage}%`;
                dom.progressText.textContent = `${percentage}%`;
            }

            async function saveProgress() {
                if (!currentUserId) return;
                await db.collection('userProgress').doc(currentUserId).set({ [courseId]: userProgress }, { merge: true });
            }

            function showToast(message, type = 'generic') {
                let toastEl, msgEl;
                if (type === 'badge') {
                    toastEl = dom.badgeToast;
                    msgEl = dom.badgeMessage;
                } else {
                    toastEl = dom.toast;
                    msgEl = dom.toastMessage;
                }
                msgEl.textContent = message;
                toastEl.classList.add('show');
                setTimeout(() => toastEl.classList.remove('show'), 4000);
            }

            function checkForBadgeUnlock(completedLessonId) {
                const module = courseData.modules.find(m => m.lessons.some(l => l.id === completedLessonId));
                if (!module || !module.badge) return;

                const moduleLessons = module.lessons.map(l => l.id);
                const allModuleLessonsCompleted = moduleLessons.every(id => userProgress.completedLessons.includes(id));
                
                if (allModuleLessonsCompleted) {
                    showToast(`Has ganado la insignia: "${module.badge}"`, 'badge');
                }
            }

            dom.mainActionBtn.addEventListener('click', () => {
                const lessonId = userProgress.currentLessonId;
                const isCompleted = userProgress.completedLessons.includes(lessonId);
                
                if (!isCompleted) {
                    userProgress.completedLessons.push(lessonId);
                    updateOverallProgress();
                    checkForBadgeUnlock(lessonId);
                    updateMainActionButton();
                    saveProgress();
                    showToast('¡Lección completada!');
                    renderSidebar();
                } else {
                    const currentIndex = allLessons.findIndex(l => l.id === lessonId);
                    if (currentIndex < allLessons.length - 1) {
                        navigateToLesson(allLessons[currentIndex + 1].id);
                    } else {
                        showToast('¡Felicidades, has completado el curso!');
                    }
                }
            });

            dom.prevBtn.addEventListener('click', () => {
                const currentIndex = allLessons.findIndex(l => l.id === userProgress.currentLessonId);
                if (currentIndex > 0) navigateToLesson(allLessons[currentIndex - 1].id);
            });

            dom.tabButtons.forEach(button => button.addEventListener('click', () => {
                dom.tabButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                Object.values(dom.tabs).forEach(content => content.classList.add('hidden'));
                dom.tabs[button.dataset.tab.slice(0, 5)].classList.remove('hidden');
            }));
        });
    </script>
</body>
</html>
