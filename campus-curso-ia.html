<!DOCTYPE html>
<!-- 
  PÁGINA DE CURSO · AULA GENIA v3.0 
  -------------------------------------------------------------------
  Este archivo representa la vista detallada de un curso.
  La lógica de progreso y la estructura de datos son consistentes
  con el campus principal.
  -------------------------------------------------------------------
-->
<html lang="es-CL" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <title>Curso: Domina la IA Aplicada – Aula GenIA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="noindex, nofollow">
  <meta name="description" content="Contenido del curso Domina la IA Aplicada en Aula GenIA.">
  <link rel="canonical" href="https://aulagenia.cl/campus-curso-ia.html">
  <link rel="icon" href="https://aulagenia.cl/favicon.ico" type="image/x-icon" />
  <link rel="apple-touch-icon" href="https://aulagenia.cl/Logo_AGIA.png">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;900&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@0.368.0/dist/umd/lucide.min.js"></script>

  <style>
    :root {
      --brand-teal: #14b8a6;
      --brand-green: #22c55e;
    }
    html { font-family: 'Poppins', sans-serif; }
    body { background-color: #f8fafc; }
    .lesson-item[data-completed="true"] {
        background-color: #f0fdf4;
        border-left-color: var(--brand-green);
    }
     .lesson-item[data-completed="true"] .lesson-title {
        color: #15803d;
        text-decoration: line-through;
    }
  </style>
</head>
<body class="text-gray-800">

  <header class="bg-white shadow-sm sticky top-0 z-30">
    <nav class="container mx-auto px-6 py-4 flex items-center justify-between">
      <a href="campus.html" class="flex items-center gap-2 text-sm text-teal-600 hover:text-teal-800" aria-label="Volver al campus">
        <i data-lucide="arrow-left" class="h-5 w-5"></i>
        <span>Volver al Campus</span>
      </a>
      <div id="user-profile" class="hidden sm:flex items-center gap-3 relative">
        <span id="user-name" class="font-semibold text-gray-700 truncate max-w-[10ch]"></span>
        <img id="user-avatar" alt="Avatar del usuario" class="w-10 h-10 rounded-full border-2 border-teal-500" />
      </div>
    </nav>
  </header>

  <main class="container mx-auto px-6 py-12 max-w-7xl">
    
    <div class="lg:grid lg:grid-cols-3 lg:gap-8">
        <!-- Columna Principal: Contenido del Video -->
        <div class="lg:col-span-2">
            <div class="bg-black aspect-video rounded-xl mb-6 shadow-lg flex items-center justify-center">
                <p class="text-white">Simulación de Video Player</p>
            </div>
            <h1 id="lesson-title" class="text-3xl font-bold text-gray-900">Módulo 0: Onboarding</h1>
            <p id="lesson-description" class="text-lg text-gray-600 mt-2">¡Bienvenido al curso! Prepárate para un viaje increíble.</p>
            <hr class="my-6">
            <div>
                <h2 class="text-xl font-bold">Recursos de la Lección</h2>
                <ul class="list-disc list-inside mt-2 text-teal-600">
                    <li><a href="#" class="hover:underline">Guía de Inicio Rápido.pdf</a></li>
                    <li><a href="#" class="hover:underline">Link a la comunidad de Discord</a></li>
                </ul>
            </div>
             <div class="mt-8 flex justify-end">
                <button id="mark-complete-btn" class="bg-teal-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-teal-600 transition-colors flex items-center gap-2">
                    <i data-lucide="check-circle" class="h-5 w-5"></i>
                    <span>Marcar como completada</span>
                </button>
            </div>
        </div>

        <!-- Columna Lateral: Malla Curricular -->
        <aside class="lg:col-span-1 mt-12 lg:mt-0">
            <div class="bg-white p-6 rounded-2xl shadow-lg">
                <h2 class="text-xl font-bold mb-4">Malla Curricular</h2>
                <div class="flex justify-between text-sm font-medium text-gray-600 mb-1">
                    <span>Progreso</span>
                    <span id="course-progress-percent">0%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2.5 mb-6">
                    <div id="course-progress-bar" class="bg-teal-500 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
                
                <div id="curriculum-container" class="space-y-4">
                    <!-- El contenido de la malla se generará con JS -->
                </div>
                 <div id="completion-banner" class="hidden mt-6 p-4 bg-green-50 border border-green-200 rounded-lg text-center">
                    <h3 class="font-bold text-green-800">¡Curso Completado!</h3>
                    <p class="text-sm text-green-700 mt-1">¡Felicitaciones! Ya puedes generar tu certificado.</p>
                    <a href="portal-certificacion.html" class="mt-3 inline-block bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 text-sm">
                        Ir a Certificación
                    </a>
                </div>
            </div>
        </aside>
    </div>

  </main>

  <footer class="bg-white border-t mt-16 text-center text-gray-500 text-sm py-6">
    © 2025 Aula GenIA · Todos los derechos reservados.
  </footer>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js" defer></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js" defer></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js" defer></script>

  <script defer>
    document.addEventListener('DOMContentLoaded', () => {
      const firebaseConfig = { apiKey: "AIzaSyC9sVJwEfFdIN4VmSMooAoQLXYl5Mcu1yM", authDomain: "aulagenia.firebaseapp.com", projectId: "aulagenia", storageBucket: "aulagenia.appspot.com", messagingSenderId: "173328075630", appId: "1:173328075630:web:825606db4271ea1e66cf7f" };
      
      try {
        firebase.initializeApp(firebaseConfig);
      } catch(e) {
        console.warn("Firebase ya fue inicializado.");
      }
      
      const auth = firebase.auth();
      const db = firebase.firestore();
      const COURSE_ID = 'geniaweek';

      // Estructura de curso sincronizada y correcta
      const COURSE_DATA = {
          title: 'Domina la IA Aplicada',
          modules: [
              { 
                title: 'Módulo 0: Onboarding', 
                lessons: [
                    { id: '0-1', title: 'Bienvenida y Setup Inicial', description: '¡Bienvenido al curso! Prepárate para un viaje increíble.' }
                ] 
              },
              { 
                title: 'Módulo 1: ¿Qué es la IA?', 
                lessons: [
                    { id: '1-1', title: 'Fundamentos de la IA Generativa', description: 'Explora los conceptos clave detrás de la IA.' }, 
                    { id: 'q-1', title: 'Quiz: Módulo 1', description: 'Pon a prueba tus conocimientos sobre los fundamentos.' }
                ] 
              }
          ]
      };
      
      const dom = {
          userName: document.getElementById('user-name'),
          userAvatar: document.getElementById('user-avatar'),
          curriculumContainer: document.getElementById('curriculum-container'),
          progressBar: document.getElementById('course-progress-bar'),
          progressPercent: document.getElementById('course-progress-percent'),
          markCompleteBtn: document.getElementById('mark-complete-btn'),
          completionBanner: document.getElementById('completion-banner'),
          lessonTitle: document.getElementById('lesson-title'),
          lessonDescription: document.getElementById('lesson-description'),
      };

      let currentUser = null;
      let userProgress = { completedLessons: [] };
      let currentLesson = COURSE_DATA.modules[0].lessons[0];

      function renderCurriculum() {
        dom.curriculumContainer.innerHTML = '';
        COURSE_DATA.modules.forEach(module => {
            const moduleEl = document.createElement('div');
            moduleEl.innerHTML = `<h4 class="font-bold mb-2">${module.title}</h4>`;
            const lessonList = document.createElement('ul');
            lessonList.className = 'space-y-2';
            module.lessons.forEach(lesson => {
                const isCompleted = userProgress.completedLessons.includes(lesson.id);
                const lessonItem = document.createElement('li');
                lessonItem.className = 'lesson-item border-l-4 p-3 rounded-r-md cursor-pointer transition-colors hover:bg-gray-100';
                lessonItem.dataset.lessonId = lesson.id;
                lessonItem.dataset.completed = isCompleted;
                lessonItem.innerHTML = `
                    <div class="flex items-center gap-3">
                        <i data-lucide="${isCompleted ? 'check-circle' : 'circle'}" class="h-5 w-5 ${isCompleted ? 'text-green-600' : 'text-gray-400'}"></i>
                        <span class="lesson-title font-medium text-sm">${lesson.title}</span>
                    </div>`;
                lessonItem.addEventListener('click', () => selectLesson(lesson.id));
                lessonList.appendChild(lessonItem);
            });
            moduleEl.appendChild(lessonList);
            dom.curriculumContainer.appendChild(moduleEl);
        });
        lucide.createIcons();
        updateProgressUI();
      }
      
      function selectLesson(lessonId) {
        const { module, lesson } = findLessonById(lessonId);
        if (lesson) {
            currentLesson = lesson;
            dom.lessonTitle.textContent = lesson.title;
            dom.lessonDescription.textContent = lesson.description;
            updateMarkCompleteButton();
        }
      }

      function findLessonById(lessonId) {
        for (const module of COURSE_DATA.modules) {
            const lesson = module.lessons.find(l => l.id === lessonId);
            if (lesson) return { module, lesson };
        }
        return { module: null, lesson: null };
      }

      function updateProgressUI() {
        const totalLessons = COURSE_DATA.modules.reduce((acc, mod) => acc + mod.lessons.length, 0);
        const completedCount = userProgress.completedLessons.length;
        const progress = totalLessons > 0 ? Math.round((completedCount / totalLessons) * 100) : 0;
        
        dom.progressBar.style.width = `${progress}%`;
        dom.progressPercent.textContent = `${progress}%`;

        if (progress >= 100) {
            dom.progressBar.style.backgroundColor = 'var(--brand-green)';
            dom.completionBanner.classList.remove('hidden');
        } else {
            dom.progressBar.style.backgroundColor = 'var(--brand-teal)';
            dom.completionBanner.classList.add('hidden');
        }
      }

      function updateMarkCompleteButton() {
          const isCompleted = userProgress.completedLessons.includes(currentLesson.id);
          if (isCompleted) {
              dom.markCompleteBtn.disabled = true;
              dom.markCompleteBtn.textContent = 'Lección Completada';
              dom.markCompleteBtn.classList.replace('bg-teal-500', 'bg-green-600');
          } else {
              dom.markCompleteBtn.disabled = false;
              dom.markCompleteBtn.innerHTML = `<i data-lucide="check-circle" class="h-5 w-5"></i><span>Marcar como completada</span>`;
              dom.markCompleteBtn.classList.replace('bg-green-600', 'bg-teal-500');
              lucide.createIcons();
          }
      }

      async function handleMarkComplete() {
        if (!currentUser || userProgress.completedLessons.includes(currentLesson.id)) return;

        userProgress.completedLessons.push(currentLesson.id);
        dom.markCompleteBtn.disabled = true;
        
        try {
            const progressRef = db.collection('userProgress').doc(currentUser.uid);
            await progressRef.set({
                [COURSE_ID]: {
                    completedLessons: firebase.firestore.FieldValue.arrayUnion(currentLesson.id),
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                }
            }, { merge: true });

            renderCurriculum();
            updateMarkCompleteButton();
        } catch (error) {
            console.error("Error al guardar progreso:", error);
            // Revertir el cambio en la UI si falla el guardado
            userProgress.completedLessons.pop();
            dom.markCompleteBtn.disabled = false;
            alert("No se pudo guardar tu progreso. Revisa tu conexión.");
        }
      }

      async function loadUserProgress() {
          const progressRef = db.collection('userProgress').doc(currentUser.uid);
          const doc = await progressRef.get();
          if (doc.exists && doc.data()[COURSE_ID]) {
              userProgress = {
                  completedLessons: doc.data()[COURSE_ID].completedLessons || []
              };
          }
          renderCurriculum();
          selectLesson(currentLesson.id); // Seleccionar la lección inicial
      }

      auth.onAuthStateChanged(user => {
        if (user) {
          currentUser = user;
          const name = user.displayName || 'Alumno';
          dom.userName.textContent = name;
          dom.userAvatar.src = user.photoURL || `https://placehold.co/100x100/14b8a6/FFFFFF?text=${name[0].toUpperCase()}`;
          document.getElementById('user-profile').classList.remove('hidden');
          
          loadUserProgress();
        } else {
          window.location.href = 'acceso.html';
        }
      });
      
      dom.markCompleteBtn.addEventListener('click', handleMarkComplete);
      lucide.createIcons();
    });
  </script>
</body>
</html>
