<!DOCTYPE html>
<!-- 
  CAMPUS CURSO · AULA GENIA v4.8.8 (Update: Onboarding Module)
  -------------------------------------------------------------------
  - ADD: Módulo de Onboarding como primera lección.
  - MOV: Recursos "Link ChatGPT" y "Guía de Acceso" de M1 a Onboarding.
  - INTEGRIDAD: Se mantiene el 100% de la lógica original y estilos.
  -------------------------------------------------------------------
-->
<html lang="es-CL">

<head>
    <meta charset="UTF-8" />
    <title>Lección del Curso - Aula GenIA (Perfil Unificado)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="noindex, nofollow">
    <meta name="description"
        content="Continúa tu aprendizaje en el curso de Inteligencia Artificial Aplicada a Negocios.">
    <link rel="canonical" href="https://aulagenia.cl/campus-curso-ia.html">
    <link rel="icon" href="https://aulagenia.cl/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="https://aulagenia.cl/Logo_AGIA.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@0.368.0/dist/umd/lucide.min.js"></script>
    <style>
        :root {
            --brand-teal: #14b8a6;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f8fafc;
        }

        #profile-modal,
        .toast-notification,
        #completion-modal {
            transition: all 0.3s ease-in-out;
        }

        label span.required {
            color: #ef4444;
        }

        .form-input-error {
            @apply border-red-500 ring-red-500;
        }

        .form-input-success {
            @apply border-green-500 ring-green-500;
        }

        .error-message {
            @apply text-red-600 text-xs mt-1;
        }

        .toast-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            transform: translateX(120%);
            z-index: 1000;
        }

        .toast-notification.show {
            transform: translateX(0);
        }

        #completion-modal.show>div {
            transform: scale(1);
            opacity: 1;
        }

        .quiz-option {
            transition: all 0.2s ease-in-out;
        }

        .quiz-option.selected {
            border-color: var(--brand-teal);
            background-color: #f0fdfa;
            box-shadow: 0 0 0 2px var(--brand-teal);
        }

        .quiz-option.correct {
            border-color: #22c55e;
            background-color: #f0fdf4;
        }

        .quiz-option.incorrect {
            border-color: #ef4444;
            background-color: #fef2f2;
        }

        .ltab.active {
            color: var(--brand-teal);
            border-bottom-color: var(--brand-teal);
        }

        .ltab-panel {
            @apply py-4;
        }

        #pdf-modal-overlay {
            transition: opacity 0.3s ease-in-out;
        }

        #pdf-modal-content {
            transition: all 0.3s ease-in-out;
        }

        details>summary {
            list-style: none;
        }

        details>summary::-webkit-details-marker {
            display: none;
        }

        details[open] summary .arrow-down {
            transform: rotate(180deg);
        }

        .arrow-down {
            transition: transform 0.2s ease-in-out;
        }

        .accordion-content {
            display: none;
        }

        .accordion-content.open {
            display: block;
        }

        /* --- NUEVAS OPTIMIZACIONES DASHBOARD PROFESIONAL (DESKTOP) --- */
        @media (min-width: 1024px) {

            /* Sidebar Refactor */
            #course-sidebar {
                width: 280px !important;
                flex-basis: 280px !important;
                transition: margin-left 0.3s ease, opacity 0.3s ease;
            }

            #course-sidebar.collapsed {
                margin-left: -280px;
                opacity: 0;
                pointer-events: none;
            }

            /* Font Scaling (Factor 0.85) */
            #course-title {
                font-size: 1.25rem !important;
            }

            /* Aprox 0.85 de 2xl */
            #lesson-title {
                font-size: 1.6rem !important;
                line-height: 1.2;
            }

            /* Aprox 0.85 de 3xl */
            .accordion-header span {
                font-size: 0.85rem !important;
            }

            .lesson-item span {
                font-size: 0.78rem !important;
                line-height: 1.3;
            }

            /* Ajuste para evitar que se corte */
            .lesson-item i {
                width: 1.1rem;
                height: 1.1rem;
            }

            /* Escala de iconos */

            /* Densidad de Información */
            .lesson-item a {
                padding-top: 0.4rem !important;
                padding-bottom: 0.4rem !important;
            }

            .accordion-header {
                padding: 0.6rem 0.75rem !important;
            }

            /* Layout & Spacing */
            #lesson-content {
                gap: 32px;
                display: flex;
                flex-direction: column;
            }

            .content-max-container {
                max-width: 1200px;
                margin-left: auto;
                margin-right: auto;
                width: 100%;
            }

            /* Toggle Button Styling */
            #sidebar-toggle-desktop {
                display: flex !important;
            }
        }

        #sidebar-toggle-desktop {
            display: none;
        }

        /* AJUSTES DE REPRODUCTOR DE VIDEO OPTIMIZADOS */
        .video-wrapper-optimized {
            width: 100%;
            /* Mobile first: full width */
            max-width: 1200px;
            max-height: 65vh;
            /* Restricción crítica de altura */
            margin: 0 auto;
            overflow: hidden;
            background-color: transparent;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #course-video {
            width: auto;
            height: auto;
            max-width: 100%;
            max-height: 65vh;
            object-fit: contain;
            display: block;
        }

        /* Estilo estético para subtítulos */
        video::cue {
            background-color: rgba(0, 0, 0, 0.7);
            color: #ffffff;
            font-size: 1.25rem;
            /* Aumentado en 50% para mejor legibilidad */
            font-family: 'Poppins', sans-serif;
        }

        /* --- FIN OPTIMIZACIONES --- */
    </style>
</head>

<body class="text-gray-800">

    <div id="app" class="flex flex-col min-h-screen">
        <header class="bg-white/80 backdrop-blur-lg sticky top-0 z-50 shadow-sm">
            <nav class="container mx-auto px-6 py-3 flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <!-- Botón Toggle Sidebar (Mobile) - NUEVO -->
                    <button id="mobile-sidebar-toggle" class="lg:hidden p-2 text-gray-600 hover:bg-gray-100 rounded-lg"
                        aria-label="Abrir menú">
                        <i data-lucide="menu" class="h-6 w-6"></i>
                    </button>

                    <!-- Botón Toggle Sidebar (Desktop) -->
                    <button id="sidebar-toggle-desktop"
                        class="hidden lg:flex p-2 hover:bg-slate-100 rounded-lg text-gray-500 transition-colors"
                        title="Alternar menú">
                        <i data-lucide="panel-left-close" class="h-5 w-5" id="toggle-icon"></i>
                    </button>
                    <a href="index.html" class="flex items-center" aria-label="Página de inicio de Aula GenIA">
                        <img src="https://aulagenia.cl/Logo_AGIA_big.png" alt="Logo de Aula GenIA"
                            class="h-10 sm:h-12 md:h-16 w-auto transition-all duration-300">
                    </a>
                </div>
                <div class="flex items-center gap-2 sm:gap-4">
                    <a href="quienes-somos.html"
                        class="text-gray-700 font-semibold border-2 border-gray-300 rounded-full px-3 text-xs py-2 sm:px-5 sm:text-sm hover:bg-gray-100 hover:border-gray-400 transition-colors duration-300 hidden md:flex items-center">
                        Quiénes Somos
                    </a>
                    <a href="cursos.html"
                        class="text-teal-600 font-semibold border-2 border-teal-500 rounded-full px-3 text-xs py-2 sm:px-5 sm:text-sm hover:bg-teal-500 hover:text-white transition-colors duration-300 flex items-center">
                        Ver Cursos
                    </a>
                    <div id="user-profile-container" class="hidden items-center gap-3 relative">
                        <span class="font-semibold text-gray-700 hidden sm:block" id="user-name"></span>
                        <div class="relative group">
                            <button id="avatar-button" aria-label="Abrir menú de perfil">
                                <img id="user-avatar" alt="Avatar del usuario"
                                    class="w-10 h-10 rounded-full border-2 border-teal-500 cursor-pointer group-hover:opacity-90 transition-opacity" />
                            </button>
                        </div>
                        <button id="logout-button"
                            class="text-sm text-gray-500 hover:text-red-600 font-medium transition-colors">Cerrar
                            sesión</button>
                    </div>
                </div>
            </nav>
        </header>

        <main class="flex-1 flex flex-col lg:flex-row overflow-hidden bg-slate-50">
            <!-- Sidebar Refactorizado para Mobile First -->
            <!-- Mobile Overlay -->
            <div id="mobile-sidebar-overlay"
                class="fixed inset-0 bg-black/50 z-40 hidden lg:hidden transition-opacity opacity-0"></div>

            <aside id="course-sidebar"
                class="fixed inset-y-0 left-0 z-50 w-72 bg-white border-r border-slate-200 transform -translate-x-full transition-transform duration-300 lg:relative lg:translate-x-0 lg:w-80 lg:block flex flex-col h-full lg:h-auto overflow-y-auto">
                <div class="p-5 flex-shrink-0">
                    <div class="flex justify-between items-center lg:hidden mb-4">
                        <span class="text-sm font-bold text-gray-500 uppercase tracking-wider">Menú del Curso</span>
                        <button id="mobile-sidebar-close" class="p-2 text-gray-500 hover:text-gray-700">
                            <i data-lucide="x" class="h-5 w-5"></i>
                        </button>
                    </div>
                    <a href="./campus.html"
                        class="text-xs text-teal-600 hover:text-teal-700 font-semibold flex items-center mb-4 uppercase tracking-wider"><i
                            data-lucide="arrow-left" class="h-3 w-3 mr-2"></i>Mis Cursos</a>
                    <h1 id="course-title" class="text-xl font-bold text-gray-900 leading-tight">Cargando...</h1>
                    <div class="mt-4">
                        <div class="flex justify-between text-[10px] font-bold text-gray-400 uppercase mb-1">
                            <span>Progreso</span><span id="progress-text">0%</span>
                        </div>
                        <div class="w-full bg-slate-100 rounded-full h-1.5">
                            <div id="progress-bar" class="bg-teal-500 h-1.5 rounded-full transition-all duration-500"
                                style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                <!-- Ajuste de scroll para el contenido del nav -->
                <nav id="modules-container" class="space-y-1 px-2 pb-6 flex-grow overflow-y-auto"></nav>
            </aside>

            <!-- Área de Contenido (Centrada y con Max-width) -->
            <section id="lesson-content" class="flex-1 overflow-y-auto lg:p-8">
                <div class="content-max-container p-6 md:p-0">
                    <h2 id="lesson-title" class="text-2xl font-bold text-gray-900 mb-2 break-words">Cargando...</h2>

                    <div id="learning-tabs" class="mt-6">
                        <div id="tabs-navigation-container" class="border-b border-slate-200 mb-4">
                            <nav class="-mb-px flex gap-6 text-sm font-medium overflow-x-auto">
                                <button
                                    class="ltab active px-2 py-2 border-b-2 border-transparent text-slate-500 hover:text-teal-600 whitespace-nowrap"
                                    data-tab="tab-clases">
                                    <span class="inline-flex items-center gap-2"><i data-lucide="play-circle"
                                            class="h-4 w-4"></i>Clases</span>
                                </button>
                                <button
                                    class="ltab px-2 py-2 border-b-2 border-transparent text-slate-500 hover:text-teal-600 whitespace-nowrap"
                                    data-tab="tab-material">
                                    <span class="inline-flex items-center gap-2"><i data-lucide="library"
                                            class="h-4 w-4"></i>Materiales del Módulo</span>
                                </button>
                                <button
                                    class="ltab px-2 py-2 border-b-2 border-transparent text-slate-500 hover:text-teal-600 whitespace-nowrap"
                                    data-tab="tab-notes">
                                    <span class="inline-flex items-center gap-2"><i data-lucide="notebook-pen"
                                            class="h-4 w-4"></i>Notas</span>
                                </button>
                                <button
                                    class="ltab px-2 py-2 border-b-2 border-transparent text-slate-500 hover:text-teal-600 whitespace-nowrap"
                                    data-tab="tab-tasks">
                                    <span class="inline-flex items-center gap-2"><i data-lucide="check-square"
                                            class="h-4 w-4"></i>Tareas y Archivos</span>
                                </button>
                                <button
                                    class="ltab px-2 py-2 border-b-2 border-transparent text-slate-500 hover:text-teal-600 whitespace-nowrap"
                                    data-tab="tab-support">
                                    <span class="inline-flex items-center gap-2"><i data-lucide="message-square-heart"
                                            class="h-4 w-4"></i>Soporte y Tutoría</span>
                                </button>
                            </nav>
                        </div>

                        <!-- PANEL CLASES: Video, Quizzes, Talleres -->
                        <div id="tab-clases" class="ltab-panel">
                            <div id="lesson-material-container" class="mb-6"></div>
                        </div>

                        <!-- PANEL MATERIALES: Descargables y PDFs -->
                        <div id="tab-material" class="ltab-panel hidden">
                            <div id="integrated-resources-container" class="pt-4">
                                <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                                    <i data-lucide="file-down" class="h-5 w-5 text-teal-500"></i>
                                    Material del Módulo para descargar
                                </h3>
                                <div id="resources-list" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div>
                            </div>
                        </div>

                        <div id="tab-notes" class="ltab-panel hidden">
                            <div class="grid gap-3">
                                <div class="flex items-center justify-between">
                                    <h3 class="text-lg font-semibold text-gray-900">Tus notas de esta lección</h3>
                                    <span id="notes-save-status" class="text-xs text-slate-500 transition-opacity">Sin
                                        cambios</span>
                                </div>
                                <textarea id="notes-textarea"
                                    class="w-full min-h-[160px] rounded-lg border border-slate-300 p-3 focus:outline-none focus:ring-2 focus:ring-teal-500"
                                    placeholder="Escribe aquí tus ideas, resúmenes o preguntas..."></textarea>
                                <div class="flex gap-3 text-xs text-slate-500">
                                    <span class="inline-flex items-center gap-1"><i data-lucide="cloud"
                                            class="h-4 w-4"></i>Guardado automático</span>
                                </div>
                            </div>
                        </div>

                        <div id="tab-tasks" class="ltab-panel hidden">
                            <div class="space-y-8">
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Checklist de práctica</h3>
                                    <div class="flex gap-2 mb-4">
                                        <input id="task-input" type="text"
                                            class="flex-1 rounded-lg border border-slate-300 p-2 focus:outline-none focus:ring-2 focus:ring-teal-500"
                                            placeholder="Ej: Probar un prompt en Gemini..." />
                                        <button id="add-task-btn"
                                            class="px-3 py-2 bg-slate-800 text-white rounded-lg hover:bg-slate-900">Agregar</button>
                                    </div>
                                    <ul id="task-list" class="space-y-2"></ul>
                                </div>

                                <div class="pt-6 border-t border-slate-200">
                                    <h3 class="text-lg font-semibold text-gray-900 mb-2">Entregas y Archivos Personales
                                    </h3>
                                    <p class="text-sm text-gray-600 mb-4">Sube aquí tus capturas de pantalla, documentos
                                        o cualquier archivo que desees guardar para esta lección.</p>
                                    <div class="flex items-center gap-3">
                                        <input id="resource-file-input" type="file"
                                            class="block w-full text-sm text-slate-700 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-teal-50 file:text-teal-700 hover:file:bg-teal-100"
                                            multiple />
                                        <button id="upload-resources-btn"
                                            class="px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700 disabled:opacity-50"
                                            disabled title="Subir archivos">
                                            <i data-lucide="upload" class="h-4 w-4"></i>
                                        </button>
                                    </div>
                                    <div id="upload-progress" class="hidden text-sm text-slate-600 mt-2"></div>
                                    <ul id="user-resource-list"
                                        class="mt-4 divide-y divide-slate-200 bg-white rounded-lg border border-slate-200">
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div id="tab-support" class="ltab-panel hidden">
                            <div class="bg-white p-6 rounded-lg border border-slate-200">
                                <h3 class="text-xl font-bold text-gray-900">Habla con tu Tutor</h3>
                                <p class="text-gray-600 mt-1 mb-6">Estamos aquí para ayudarte a resolver cualquier duda.
                                    Describe tu consulta y un tutor de nuestro equipo te responderá directamente a tu
                                    correo en un plazo de 24 a 48 horas hábiles.</p>

                                <form id="support-form">
                                    <div class="space-y-4">
                                        <div>
                                            <label for="support-subject"
                                                class="block text-sm font-medium text-gray-700 mb-1">Asunto</label>
                                            <input type="text" id="support-subject" name="subject"
                                                class="w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500"
                                                placeholder="Ej: Duda sobre el Módulo 2" required>
                                        </div>
                                        <div>
                                            <label for="support-message"
                                                class="block text-sm font-medium text-gray-700 mb-1">Tu mensaje</label>
                                            <textarea id="support-message" name="message" rows="5"
                                                class="w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500"
                                                placeholder="Describe tu pregunta o el feedback que necesitas aquí..."
                                                required></textarea>
                                        </div>
                                    </div>
                                    <div class="mt-6 flex justify-end">
                                        <button type="submit" id="support-submit-btn"
                                            class="bg-teal-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-teal-600 transition-colors flex items-center gap-2">
                                            <span id="support-btn-text">Enviar Consulta</span>
                                            <i id="support-spinner" data-lucide="loader-2"
                                                class="h-5 w-5 animate-spin hidden"></i>
                                        </button>
                                    </div>
                                </form>
                                <div id="support-form-status" class="mt-4 text-center"></div>
                            </div>
                        </div>

                    </div>

                    <div id="navigation-buttons"
                        class="mt-8 pt-6 border-t border-slate-200 flex justify-between items-center">
                        <button id="prev-lesson-btn"
                            class="px-4 py-2 text-sm font-semibold text-gray-700 bg-white border border-slate-300 rounded-lg shadow-sm hover:bg-slate-100 disabled:opacity-50 disabled:cursor-not-allowed">Lección
                            Anterior</button>
                        <button id="main-action-btn"
                            class="px-6 py-3 text-sm font-semibold text-white bg-teal-500 rounded-lg shadow-sm hover:bg-teal-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 disabled:opacity-50 disabled:cursor-not-allowed">Marcar
                            como completada</button>
                    </div>
                </div>
            </section>
        </main>

        <footer class="bg-gray-100 border-t border-gray-200 mt-auto">
            <div class="container mx-auto px-6 py-8 text-center text-gray-600">
                <a href="index.html" class="flex items-center justify-center mb-4">
                    <img src="https://aulagenia.cl/Logo_AGIA_big.png" alt="Logo de Aula GenIA al pie de página"
                        class="h-12 w-auto">
                </a>
                <div class="flex justify-center items-center gap-6 mb-4">
                    <a href="https://instagram.com" target="_blank" rel="noopener noreferrer"
                        aria-label="Instagram de Aula GenIA"
                        class="text-gray-500 hover:text-gray-800 transition-colors">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                            <path
                                d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.85s-.011 3.584-.069 4.85c-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07s-3.584-.012-4.85-.07c-3.252-.148-4.771-1.691-4.919-4.919-.058-1.265-.069-1.645-.069-4.85s.011-3.584.069-4.85c.149-3.225 1.664-4.771 4.919-4.919C8.416 2.175 8.796 2.163 12 2.163zm0 1.802c-3.116 0-3.483.01-4.71.068-2.69.123-3.996 1.428-4.12 4.12C3.12 9.483 3.11 9.85 3.11 12s.01 2.517.068 3.74c.124 2.692 1.43 3.996 4.12 4.12 1.227.058 1.594.068 4.71.068s3.483-.01 4.71-.068c2.69-.124 3.996-1.428 4.12-4.12.058-1.223.068-1.594.068-4.71s-.01-2.517-.068-3.74c-.124-2.692-1.43-3.996-4.12-4.12C15.483 3.973 15.116 3.965 12 3.965zM12 8.25a3.75 3.75 0 100 7.5 3.75 3.75 0 000-7.5zm0 5.698a1.948 1.948 0 110-3.896 1.948 1.948 0 010 3.896zM16.838 7.162a.96.96 0 100 1.92.96.96 0 000-1.92z" />
                        </svg>
                    </a>
                    <a href="https://linkedin.com" target="_blank" rel="noopener noreferrer"
                        aria-label="LinkedIn de Aula GenIA" class="text-gray-500 hover:text-gray-800 transition-colors">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                            <path
                                d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z" />
                        </svg>
                    </a>
                </div>
                <div class="text-sm space-x-4">
                    <button id="open-faq-modal" class="hover:underline">Preguntas Frecuentes</button>
                    <span>&bull;</span>
                    <button id="open-cookies-modal" class="hover:underline">Política de Cookies</button>
                </div>
                <p class="text-sm mt-4">&copy; 2024 Aula GenIA - Todos los derechos reservados.</p>
            </div>
        </footer>
    </div>

    <!-- Modales y notificaciones -->
    <div id="profile-modal-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden z-40"></div>
    <div id="profile-modal" class="fixed inset-0 hidden z-50 flex items-center justify-center p-4">
        <div
            class="bg-white rounded-2xl shadow-2xl w-full max-w-lg flex flex-col transform transition-all scale-95 opacity-0">
            <div class="p-6 flex-shrink-0">
                <div class="flex justify-between items-start">
                    <div>
                        <h3 id="profile-modal-title" class="text-2xl font-bold text-gray-900">Editar Perfil</h3>
                        <p id="profile-modal-subtitle" class="text-gray-600 mt-1">Mantén tus datos actualizados.</p>
                    </div>
                    <button id="close-profile-modal-btn" class="text-gray-400 hover:text-gray-600">&times;</button>
                </div>
            </div>

            <div class="px-6 pb-2 flex-grow overflow-y-auto">
                <form id="profile-form" class="space-y-3" novalidate>
                    <div>
                        <label for="profile-name-input" class="block text-sm font-medium text-gray-700 mb-1">Nombre
                            Completo <span class="required">*</span></label>
                        <div class="relative">
                            <input type="text" id="profile-name-input" name="fullName"
                                class="w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 pr-10"
                                placeholder="Ej: Ada Lovelace">
                            <span id="name-status-icon"
                                class="absolute inset-y-0 right-0 flex items-center pr-3"></span>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">Este será el nombre en tu certificado.</p>
                        <div id="name-error" class="error-message"></div>
                    </div>
                    <div>
                        <label for="profile-rut-input" class="block text-sm font-medium text-gray-700 mb-1">RUT (Chile)
                            <span class="required">*</span></label>
                        <div class="relative">
                            <input type="text" id="profile-rut-input" name="rut"
                                class="w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 pr-10"
                                placeholder="Ej: 12345678-9">
                            <span id="rut-status-icon" class="absolute inset-y-0 right-0 flex items-center pr-3"></span>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">Requerido si tu país es Chile.</p>
                        <div id="rut-error" class="error-message"></div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                            <label for="profile-country-select"
                                class="block text-sm font-medium text-gray-700 mb-1">País <span
                                    class="required">*</span></label>
                            <div class="relative">
                                <select id="profile-country-select" name="country"
                                    class="w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500 appearance-none pr-10">
                                    <option value="">Selecciona tu país</option>
                                    <option value="CL">Chile</option>
                                    <option value="AR">Argentina</option>
                                    <option value="PE">Perú</option>
                                    <option value="CO">Colombia</option>
                                    <option value="MX">México</option>
                                    <option value="ES">España</option>
                                    <option value="US">Estados Unidos</option>
                                    <option value="OT">Otro</option>
                                </select>
                                <span id="country-status-icon"
                                    class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none"></span>
                            </div>
                            <div id="country-error" class="error-message"></div>
                        </div>
                        <div>
                            <label for="profile-job-input" class="block text-sm font-medium text-gray-700 mb-1">Cargo o
                                Profesión</label>
                            <input type="text" id="profile-job-input" name="jobTitle"
                                class="w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500"
                                placeholder="Ej: Estudiante">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                            <label for="profile-gender-select"
                                class="block text-sm font-medium text-gray-700 mb-1">Género</label>
                            <select id="profile-gender-select" name="gender"
                                class="w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500">
                                <option value="">Seleccionar...</option>
                                <option value="female">Femenino</option>
                                <option value="male">Masculino</option>
                                <option value="other">Otro</option>
                                <option value="prefer_not-to-say">Prefiero no decir</option>
                            </select>
                        </div>
                        <div>
                            <label for="profile-birthdate-input"
                                class="block text-sm font-medium text-gray-700 mb-1">Fecha de Nacimiento</label>
                            <input type="date" id="profile-birthdate-input" name="birthdate"
                                class="w-full rounded-md border-gray-300 shadow-sm focus:border-teal-500 focus:ring-teal-500">
                        </div>
                    </div>
                    <div>
                        <label for="profile-email-input" class="block text-sm font-medium text-gray-700 mb-1">Correo
                            Electrónico</label>
                        <input type="email" id="profile-email-input"
                            class="w-full rounded-md border-gray-300 shadow-sm bg-gray-100 cursor-not-allowed" disabled>
                    </div>
                    <div id="form-status" class="text-center p-3 rounded-lg hidden"></div>
                </form>
            </div>
            <div class="p-6 pt-4 flex-shrink-0">
                <div class="flex justify-end gap-3 pt-4 border-t">
                    <button type="button" id="cancel-profile-btn"
                        class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors">Cancelar</button>
                    <button type="submit" form="profile-form" id="save-profile-btn"
                        class="bg-teal-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-600 transition-colors flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                        <span id="save-btn-text">Guardar Cambios</span>
                        <i id="save-spinner" data-lucide="loader-2" class="h-5 w-5 animate-spin hidden"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div id="toast-notification"
        class="toast-notification bg-gray-800 text-white py-3 px-5 rounded-lg shadow-lg flex items-center gap-3"><i
            data-lucide="check-circle" class="text-teal-400"></i><span id="toast-message"></span></div>
    <div id="badge-toast"
        class="toast-notification bg-gradient-to-br from-yellow-400 to-orange-500 text-white p-4 rounded-lg shadow-xl flex items-center gap-4">
        <i data-lucide="award" class="h-12 w-12 text-white"></i>
        <div>
            <h4 class="font-bold">¡Insignia Desbloqueada!</h4>
            <p id="badge-message" class="text-sm"></p>
        </div>
    </div>

    <div id="completion-modal-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden z-40 opacity-0"></div>
    <div id="completion-modal" class="fixed inset-0 hidden z-50 flex items-center justify-center p-4">
        <div
            class="bg-white rounded-2xl shadow-2xl p-8 max-w-lg w-full text-center transform transition-all scale-95 opacity-0 duration-300">
            <i data-lucide="party-popper" class="mx-auto h-20 w-20 text-yellow-500"></i>
            <h2 class="text-3xl font-bold text-gray-900 mt-4">¡Felicitaciones, <span id="modal-user-name"></span>!</h2>
            <p class="text-gray-600 mt-2">Has completado exitosamente el curso "<span id="modal-course-name"></span>".
            </p>
            <div class="space-y-3 mt-6">
                <a id="certificate-link" href="#"
                    class="hidden items-center justify-center gap-2 w-full text-center bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-5 rounded-lg transition-colors">
                    <i data-lucide="award" class="h-5 w-5"></i>
                    <span>Ver Certificado</span>
                </a>
                <button id="review-course-btn"
                    class="block w-full text-sm text-gray-500 hover:text-teal-600 font-semibold transition-colors text-center py-2">Repasar
                    Curso</button>
            </div>
            <button id="close-modal-btn"
                class="mt-8 w-full bg-gray-800 hover:bg-gray-900 text-white font-bold py-3 px-5 rounded-lg transition-colors">Volver
                al Campus</button>
        </div>
    </div>

    <div id="pdf-modal-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden z-40 opacity-0"></div>
    <div id="pdf-modal" class="fixed inset-0 hidden z-50 flex items-center justify-center p-4">
        <div id="pdf-modal-content"
            class="bg-white rounded-lg shadow-2xl w-full max-w-4xl h-full max-h-[90vh] flex flex-col transform transition-all scale-95 opacity-0">
            <header class="flex items-center justify-between p-4 border-b border-gray-200 flex-shrink-0">
                <h3 id="pdf-modal-title" class="text-lg font-semibold text-gray-800">Visor de Documentos</h3>
                <button id="pdf-modal-close-btn" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="h-6 w-6"></i>
                </button>
            </header>
            <div class="flex-grow p-2 bg-gray-200">
                <iframe id="pdf-iframe" class="w-full h-full border-0" src=""></iframe>
            </div>
        </div>
    </div>

    <div id="faq-modal"
        class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-[100] hidden">
        <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full relative p-6 md:p-8">
            <button id="close-faq-modal" aria-label="Cerrar modal"
                class="absolute top-4 right-4 bg-gray-100 rounded-full p-2 text-gray-700 hover:bg-gray-200 z-10">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                    xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                    </path>
                </svg>
            </button>
            <div class="text-center mb-8">
                <h2 class="text-3xl md:text-4xl font-bold">Preguntas Frecuentes</h2>
                <p class="text-gray-600 text-lg mt-2">Resolvemos tus dudas para que tomes la mejor decisión.</p>
            </div>
            <div class="space-y-4 max-h-[70vh] overflow-y-auto pr-4">
                <details class="bg-gray-50 p-6 rounded-lg group">
                    <summary class="flex justify-between items-center font-bold text-lg cursor-pointer">
                        ¿Necesito saber programar o tener experiencia previa?
                        <svg class="w-5 h-5 text-gray-500 arrow-down" xmlns="http://www.w3.org/2000/svg" fill="none"
                            viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                        </svg>
                    </summary>
                    <p class="text-gray-600 mt-4">
                        ¡Para nada! Este curso está diseñado desde cero para principiantes.
                    </p>
                </details>
            </div>
        </div>
    </div>

    <div id="cookies-modal"
        class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-[100] hidden">
        <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full relative p-6 md:p-8">
            <button id="close-cookies-modal" aria-label="Cerrar modal"
                class="absolute top-4 right-4 bg-gray-100 rounded-full p-2 text-gray-700 hover:bg-gray-200 z-10">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                    xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                    </path>
                </svg>
            </button>
            <div class="prose lg:prose-xl max-h-[80vh] overflow-y-auto pr-4">
                <h1>Política de Cookies</h1>
                <p class="text-sm text-gray-500">Última actualización: 23 de diciembre de 2025</p>
                <p>En Aula GenIA, utilizamos cookies y tecnologías similares…</p>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs (sin defer) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-functions-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>

    <script defer>
        document.addEventListener('DOMContentLoaded', () => {
            const firebaseConfig = {
                apiKey: "AIzaSyC9sVJwEfFdIN4VmSMooAoQLXYl5Mcu1yM",
                authDomain: "aulagenia.firebaseapp.com",
                projectId: "aulagenia",
                storageBucket: "aulagenia.firebasestorage.app",
                messagingSenderId: "173328075630",
                appId: "1:173328075630:web:825606db4271ea1e66cf7f"
            };

            try { firebase.initializeApp(firebaseConfig); } catch (e) { console.warn("Firebase ya fue inicializado."); }

            const auth = firebase.auth();
            const db = firebase.firestore();
            const storage = firebase.storage();

            const baseUrl = window.location.origin + window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/'));
            const urlParams = new URLSearchParams(window.location.search);
            const courseId = urlParams.get('course') || 'ia-aplicada-esencial';

            const ALL_COURSES_DATA = {
                'ia-aplicada-esencial': {
                    title: 'IA Aplicada · Esencial',
                    hasCertificate: true,
                    modules: [
                        {
                            title: 'Bienvenida al Curso',
                            badge: 'Alumno Registrado',
                            practiceTasks: [
                                { text: 'Video 1 | El Pacto: Me comprometo a ver a la IA como un "asistente" o "copiloto" para facilitar mi aprendizaje, aunque entienda que es un programa.', done: false },
                                { text: 'Video 2 | Recursos: Descargué las guías de acceso rápido desde la pestaña de materiales de la plataforma.', done: false }
                            ],
                            lessons: [
                                {
                                    id: '0-1',
                                    title: 'Video de Onboarding: ¡Bienvenido a Aula GenIA!',
                                    type: 'video',
                                    videoUrl: 'gs://aulagenia.firebasestorage.app/ONBOARDING-IA-Aplicada-Programa-Esencial.mp4',
                                    transcriptionUrl: 'gs://aulagenia.firebasestorage.app/ONBOARDING-IA-Aplicada-Programa-Esencial-caption.srt',
                                    resources: [
                                        { name: 'Link ChatGPT', url: 'https://chatgpt.com', external: true },
                                        { name: 'Guía de Acceso: ChatGPT', url: 'gs://aulagenia.firebasestorage.app/Guía-de-Acceso-a-ChatGPT-para-Novatos.pdf', external: false },
                                        { name: 'Link Gemini', url: 'https://gemini.google.com', external: true },
                                        { name: 'Guía de Acceso: Gemini', url: 'gs://aulagenia.firebasestorage.app/Guía-de-Acceso-a-Gemini-para-Novatos.pdf', external: false },
                                        { name: 'Link Grok', url: 'https://x.com/i/grok', external: true },
                                        { name: 'Guía de Acceso: Grok', url: 'gs://aulagenia.firebasestorage.app/Guía-de-Acceso-a-Grok-para-Novatos.pdf', external: false }
                                    ]
                                }
                            ]
                        },
                        {
                            title: 'Módulo 1: ¿Qué es la Inteligencia Artificial?',
                            badge: 'Explorador Conceptual',
                            practiceTasks: [
                                { text: 'Video 1 | Desafío de Debate: Ingresé al chat y le planteé a la IA una duda actual o una opinión subjetiva para debatirla juntos, tal como se indicó en el taller.', done: false },
                                { text: 'Video 2 | Detector de Alucinaciones: Le pedí información sobre un tema que domino al 100% para comprobar si la IA inventaba datos o "alucinaba".', done: false },
                                { text: 'Video 3 | Verificación: Hice una búsqueda crítica de un resultado que me dio la IA para confirmar que la información fuera correcta, actuando como el supervisor del copiloto.', done: false }
                            ],
                            lessons: [
                                {
                                    id: '1-1',
                                    title: 'Qué es la Inteligencia Artificial y por qué es tu nuevo "Copiloto"',
                                    type: 'video',
                                    videoUrl: 'gs://aulagenia.firebasestorage.app/MODULO1-VIDEO1-IA-Aplicada-Programa-Esencial.mp4',
                                    transcriptionUrl: 'gs://aulagenia.firebasestorage.app/MODULO1-VIDEO1-IA-Aplicada-Programa-Esencial-caption.srt',
                                    resources: [
                                        { name: 'Glosario 1.1', url: 'gs://aulagenia.firebasestorage.app/Glosario-M1V1.pdf', external: false },
                                        { name: 'Infografía: El rol del Copiloto', url: 'gs://aulagenia.firebasestorage.app/Copiloto_vs_Programador.pdf', external: false },
                                        { name: '¿Qué hay dentro del Copiloto? 1.0', url: 'gs://aulagenia.firebasestorage.app/Que-hay-dentro-del-copiloto.pdf', external: false },
                                        { name: 'Listado de Verificación del Módulo', url: 'gs://aulagenia.firebasestorage.app/Listado-Verificacion.pdf', external: false },
                                        { name: 'Fuentes de Autoridad 1.0', url: 'gs://aulagenia.firebasestorage.app/Fuentesde-Autoridad-1.pdf', external: false }
                                    ]
                                },
                                {
                                    id: '1-2',
                                    title: 'Diccionario IA: Hablando con el Genio',
                                    type: 'video',
                                    videoUrl: 'gs://aulagenia.firebasestorage.app/MODULO1-VIDEO2-IA-Aplicada-Programa-Esencial.mp4',
                                    transcriptionUrl: 'gs://aulagenia.firebasestorage.app/MODULO1-VIDEO2-IA-Aplicada-Programa-Esencial-caption.srt',
                                    resources: [
                                        { name: 'Glosario 1.2', url: 'gs://aulagenia.firebasestorage.app/Glosario-M1V2.pdf', external: false },
                                        { name: 'Guía: 6 Pilares de la IA', url: 'gs://aulagenia.firebasestorage.app/Guía-Conceptos-Clave-Los-6-Pilares-de-laIA.pdf', external: false }
                                    ]
                                },
                                {
                                    id: '1-3',
                                    title: 'Desarmando los Mitos de la IA',
                                    type: 'video',
                                    videoUrl: 'gs://aulagenia.firebasestorage.app/MODULO1-VIDEO3-IA-Aplicada-Programa-Esencial.mp4',
                                    transcriptionUrl: 'gs://aulagenia.firebasestorage.app/MODULO1-VIDEO3-IA-Aplicada-Programa-Esencial-caption.srt',
                                    resources: [
                                        { name: 'Glosario 1.3', url: 'gs://aulagenia.firebasestorage.app/Glosario-M1V3.pdf', external: false },
                                        { name: 'Mitos Derribados de la IA', url: 'gs://aulagenia.firebasestorage.app/Mitos-Derribados-de-la IA.pdf', external: false }
                                    ]
                                },
                                {
                                    id: 'q-1',
                                    title: 'Test: Módulo 1',
                                    type: 'quiz',
                                    questions: [
                                        {
                                            text: '¿Qué es el "cerebro" de ChatGPT y otras IAs conversacionales?',
                                            options: [
                                                'Un buscador como Google',
                                                'Un modelo que aprendió leyendo millones de textos',
                                                'Una base de datos con respuestas fijas',
                                                'Un programa que solo traduce'
                                            ],
                                            correctAnswerHash: '4f12c7b863c648b23f3b487f54cece480f0cb675827fb8408405e431a64669e9',
                                            tip: 'Es como un estudiante que leyó muchísimos libros y ahora puede conversar sobre cualquier tema.'
                                        },
                                        {
                                            text: 'Si la IA te da información falsa pero con mucha confianza, ¿cómo se llama ese problema?',
                                            options: [
                                                'Error de internet',
                                                'Alucinación de la IA',
                                                'Falta de batería',
                                                'Problema de traducción'
                                            ],
                                            correctAnswerHash: '4f12c7b863c648b23f3b487f54cece480f0cb675827fb8408405e431a64669e9',
                                            tip: 'Es cuando la IA "inventa" datos que suenan reales pero son completamente falsos.'
                                        },
                                        {
                                            text: '¿Qué significa que una IA pueda "ver" fotos, "leer" texto y "escuchar" audio?',
                                            options: [
                                                'Que trabaja en varios idiomas',
                                                'Que es Multimodal (entiende varios tipos de información)',
                                                'Que tiene varias versiones',
                                                'Que funciona en varios dispositivos'
                                            ],
                                            correctAnswerHash: '4f12c7b863c648b23f3b487f54cece480f0cb675827fb8408405e431a64669e9',
                                            tip: 'Como tener varios sentidos: puede procesar imágenes, texto y sonido al mismo tiempo.'
                                        },
                                        {
                                            text: '¿Cómo lee la IA el texto que le escribes?',
                                            options: [
                                                'Letra por letra',
                                                'En pedacitos de palabras llamados "tokens"',
                                                'Solo palabras completas',
                                                'Como una imagen'
                                            ],
                                            correctAnswerHash: '4f12c7b863c648b23f3b487f54cece480f0cb675827fb8408405e431a64669e9',
                                            tip: 'La IA divide el texto en fragmentos pequeños para procesarlo mejor.'
                                        },
                                        {
                                            text: 'Si la IA olvida lo que le dijiste al inicio de una conversación muy larga, ¿qué pasó?',
                                            options: [
                                                'Se quedó sin internet',
                                                'Alcanzó su límite de memoria (Ventana de Contexto)',
                                                'Se quedó sin batería',
                                                'Tuvo un error de traducción'
                                            ],
                                            correctAnswerHash: '4f12c7b863c648b23f3b487f54cece480f0cb675827fb8408405e431a64669e9',
                                            tip: 'Es como una pizarra: si escribes mucho, tienes que borrar lo viejo para seguir.'
                                        }
                                    ],
                                    resources: []
                                }
                            ]
                        },
                        {
                            title: 'Módulo 2: La IA para ti, en tu día a día',
                            badge: 'Asistente IA Personal',
                            practiceTasks: [
                                { text: 'Video 2 | Creatividad Visual: Entré a Ideogram (o Midjourney) y generé una imagen o logo para mi proyecto usando IA.', done: false },
                                { text: 'Video 3 | El Diagnóstico: Identifiqué y anoté esa tarea repetitiva que hago todos los días y que me consume al menos 30 minutos.', done: false },
                                { text: 'Video 3 | La Decisión: Elegí cuál de mis tareas identificadas voy a delegar o automatizar primero con IA durante este curso.', done: false }
                            ],
                            lessons: [
                                {
                                    id: '2-1',
                                    title: 'Del Uso Superficial al Estratégico',
                                    type: 'video',
                                    videoUrl: 'gs://aulagenia.firebasestorage.app/MODULO2-VIDEO1-IA-Aplicada-Programa-Esencial.mp4',
                                    transcriptionUrl: 'gs://aulagenia.firebasestorage.app/MODULO2-VIDEO1-IA-Aplicada-Programa-Esencial-caption.srt',
                                    resources: [
                                        { name: 'Glosario 2.1', url: 'gs://aulagenia.firebasestorage.app/Glosario-M2V1.pdf', external: false },
                                        { name: 'Guía Maestra de Herramientas', url: 'gs://aulagenia.firebasestorage.app/Guía-Maestra-Herramientas.pdf', external: false },
                                        { name: 'Fuentes de Autoridad 2.0', url: 'gs://aulagenia.firebasestorage.app/Fuentesde-Autoridad-2.pdf', external: false }
                                    ]
                                },
                                {
                                    id: '2-2',
                                    title: 'El Efecto Real: María, Carlos y Luis',
                                    type: 'video',
                                    videoUrl: 'gs://aulagenia.firebasestorage.app/MODULO2-VIDEO2-IA-Aplicada-Programa-Esencial.mp4',
                                    transcriptionUrl: 'gs://aulagenia.firebasestorage.app/MODULO2-VIDEO2-IA-Aplicada-Programa-Esencial-caption.srt',
                                    resources: [
                                        { name: 'Glosario 2.2', url: 'gs://aulagenia.firebasestorage.app/Glosario-M2V2.pdf', external: false },
                                        { name: 'El Salto de Principiante a Pro', url: 'gs://aulagenia.firebasestorage.app/El-Salto-de-Principiante-a Pro.pdf', external: false },
                                        { name: '¿Qué hay dentro del Copiloto? 2.0', url: 'gs://aulagenia.firebasestorage.app/Que-hay-dentro-del-copiloto-2.pdf', external: false },
                                        { name: 'Aprende de los Expertos: Los Caminos de María, Carlos y Luis', url: 'gs://aulagenia.firebasestorage.app/Aprende-de-los-Expertos-Los-Caminos-de-María-Carlos-y-Luis.pdf', external: false },
                                        { name: 'Test de Diagnóstico Avanzado: Tu Ruta', url: 'gs://aulagenia.firebasestorage.app/Test-de-Diagnóstico-Avanzado-Tu-Ruta.pdf', external: false },
                                        { name: 'Guía de Acceso: Ideogram', url: 'gs://aulagenia.firebasestorage.app/Guía-de-Acceso-a-Ideogram-para-Novatos.pdf', external: false },
                                        { name: 'Guía de Acceso: Midjourney', url: 'gs://aulagenia.firebasestorage.app/Guía-de-Acceso-a-Midjourney-para-Novatos.pdf', external: false },
                                        { name: 'Guía de Acceso: Gamma', url: 'gs://aulagenia.firebasestorage.app/Guía-de-Acceso-a-Gamma-para-Novatos.pdf', external: false },
                                        { name: 'Guía de Acceso: DALL-E 3', url: 'gs://aulagenia.firebasestorage.app/Guía-Acceso-a-DALL-E3-para-Novatos.pdf', external: false },
                                        { name: 'Guía de Acceso: Canva', url: 'gs://aulagenia.firebasestorage.app/Guía-de-Acceso-a-Canva-para-Novatos.pdf', external: false }
                                    ]
                                },
                                {
                                    id: '2-3',
                                    title: 'Tu Radar de Automatización',
                                    type: 'video',
                                    videoUrl: 'gs://aulagenia.firebasestorage.app/MODULO2-VIDEO3-IA-Aplicada-Programa-Esencial.mp4',
                                    transcriptionUrl: 'gs://aulagenia.firebasestorage.app/MODULO2-VIDEO3-IA-Aplicada-Programa-Esencial-caption.srt',
                                    resources: [
                                        { name: 'Herramienta: Checklist de Complejidad', url: 'gs://aulagenia.firebasestorage.app/Herramienta-Checklist-de-Complejidad.pdf', external: false }
                                    ]
                                },
                                {
                                    id: '2-taller',
                                    title: 'Aplicación: Radar de Automatización',
                                    type: 'taller',
                                    resources: []
                                },
                                {
                                    id: 'q-2',
                                    title: 'Test: Módulo 2',
                                    type: 'quiz',
                                    questions: [
                                        {
                                            text: '¿Cuál es la diferencia entre usar la IA de forma "superficial" vs "estratégica"?',
                                            options: [
                                                'Pagar más dinero por la herramienta',
                                                'Usarla con un objetivo claro y repetirlo en tus tareas diarias',
                                                'Saber programar',
                                                'Tener la última versión'
                                            ],
                                            correctAnswerHash: '4f12c7b863c648b23f3b487f54cece480f0cb675827fb8408405e431a64669e9',
                                            tip: 'Lo importante es cómo la integras en tu trabajo, no cuánto pagas por ella.'
                                        },
                                        {
                                            text: 'Si quieres hacer presentaciones rápidas y profesionales, ¿qué herramienta te ayuda?',
                                            options: [
                                                'Excel',
                                                'Gamma',
                                                'WhatsApp',
                                                'Photoshop'
                                            ],
                                            correctAnswerHash: '4f12c7b863c648b23f3b487f54cece480f0cb675827fb8408405e431a64669e9',
                                            tip: 'Es una herramienta que transforma tus ideas en slides visuales en minutos.'
                                        },
                                        {
                                            text: '¿Qué tareas deberías automatizar primero con IA?',
                                            options: [
                                                'Todas las tareas sin importar cuánto tiempo tomen',
                                                'Las que se repiten mucho y te quitan al menos 30 minutos',
                                                'Solo las más difíciles',
                                                'Las que haces una vez al año'
                                            ],
                                            correctAnswerHash: '4f12c7b863c648b23f3b487f54cece480f0cb675827fb8408405e431a64669e9',
                                            tip: 'Busca el "fruto que cuelga más bajo": lo que se repite mucho y consume tiempo.'
                                        },
                                        {
                                            text: '¿Para qué sirve DALL-E 3?',
                                            options: [
                                                'Para escribir correos',
                                                'Para crear imágenes originales con IA',
                                                'Para hacer cálculos',
                                                'Para traducir idiomas'
                                            ],
                                            correctAnswerHash: '4f12c7b863c648b23f3b487f54cece480f0cb675827fb8408405e431a64669e9',
                                            tip: 'Es una herramienta que genera imágenes personalizadas desde cero.'
                                        },
                                        {
                                            text: '¿Qué logró María usando la IA como "asistente mágico"?',
                                            options: [
                                                'Aprendió a programar',
                                                'Duplicó su trabajo reduciendo sus horas',
                                                'Compró una computadora nueva',
                                                'Cambió de profesión'
                                            ],
                                            correctAnswerHash: '4f12c7b863c648b23f3b487f54cece480f0cb675827fb8408405e431a64669e9',
                                            tip: 'La IA le liberó tiempo para enfocarse en estrategia y creatividad.'
                                        }
                                    ],
                                    resources: []
                                }
                            ]
                        },
                        {
                            title: 'Módulo 3: Preparando tus herramientas',
                            badge: 'Creativo IA',
                            practiceTasks: [
                                { text: 'Video 1 | La Receta Básica: Escribí mi primer prompt estructurado definiendo claramente: 1) El Rol, 2) El Contexto y 3) La Meta (Propósito).', done: false },
                                { text: 'Video 2 | Nivel Experto: Reescribí el prompt anterior agregando los dos ingredientes faltantes de la "Estructura Maestra": Restricciones (qué NO quiero) y Formato (cómo lo quiero).', done: false },
                                { text: 'Video 2 | Rotación de Sombrero: Sin cambiar de chat, le pedí a la IA que asuma un nuevo rol (ej. de "Estratega" a "Redactor") para aprovechar el contexto que ya tenía.', done: false }
                            ],
                            lessons: [
                                {
                                    id: '3-1',
                                    title: 'La Receta WOW: El Arte de Pedir',
                                    type: 'video',
                                    videoUrl: 'gs://aulagenia.firebasestorage.app/MODULO3-VIDEO1-IA-Aplicada-Programa-Esencial.mp4',
                                    transcriptionUrl: 'gs://aulagenia.firebasestorage.app/MODULO3-VIDEO1-IA-Aplicada-Programa-Esencial-caption.srt',
                                    resources: [
                                        { name: 'Glosario 3.1', url: 'gs://aulagenia.firebasestorage.app/Glosario-M3V1.pdf', external: false },
                                        { name: 'Mi Primer Prompt WOW', url: 'gs://aulagenia.firebasestorage.app/Mi-Primer-Prompt-WOW.pdf', external: false },
                                        { name: 'Infografía: La Receta WOW', url: 'gs://aulagenia.firebasestorage.app/Infografía-La Receta-WOW.pdf', external: false },
                                        { name: 'Plantilla: Rellena tu Prompt WOW', url: 'gs://aulagenia.firebasestorage.app/Plantilla-Rellena-tu-Prompt-WOW.pdf', external: false },
                                        { name: 'Fuentes de Autoridad 3.0', url: 'gs://aulagenia.firebasestorage.app/Fuentesde-Autoridad-3.pdf', external: false }
                                    ]
                                },
                                {
                                    id: '3-2',
                                    title: 'Fórmula AGIA: Instrucciones Maestras',
                                    type: 'video',
                                    videoUrl: 'gs://aulagenia.firebasestorage.app/MODULO3-VIDEO2-IA-Aplicada-Programa-Esencial.mp4',
                                    transcriptionUrl: 'gs://aulagenia.firebasestorage.app/MODULO3-VIDEO2-IA-Aplicada-Programa-Esencial-caption.srt',
                                    resources: [
                                        { name: 'Glosario 3.2', url: 'gs://aulagenia.firebasestorage.app/Glosario-M3V2.pdf', external: false },
                                        { name: 'El Arte de la Persuasión', url: 'gs://aulagenia.firebasestorage.app/El-Arte-de-la-Persuacion.pdf', external: false },
                                        { name: 'El Código de las Frases de Poder', url: 'gs://aulagenia.firebasestorage.app/El-Código-de-las-Frases-de-Poder.pdf', external: false },
                                        { name: 'Diccionario de Verbos de Poder', url: 'gs://aulagenia.firebasestorage.app/Diccionario-de-Verbos-de-Poder.pdf', external: false },
                                        { name: 'Ejemplos: Instrucciones de Alta Fidelidad', url: 'gs://aulagenia.firebasestorage.app/Ejemplos-Instrucciones-de-Alta-Fidelidad.pdf', external: false },
                                        { name: 'Guía de Acceso: Gemini Image', url: 'gs://aulagenia.firebasestorage.app/Guía-de-Acceso-a-Gemini-Image-Nano-Banana.pdf', external: false }
                                    ]
                                },
                                {
                                    id: '3-3',
                                    title: '3 Salvavidas para Prompts en Crisis',
                                    type: 'video',
                                    videoUrl: 'gs://aulagenia.firebasestorage.app/MODULO3-VIDEO3-IA-Aplicada-Programa-Esencial.mp4',
                                    transcriptionUrl: 'gs://aulagenia.firebasestorage.app/MODULO3-VIDEO3-IA-Aplicada-Programa-Esencial-caption.srt',
                                    resources: [
                                        { name: 'Glosario 3.3', url: 'gs://aulagenia.firebasestorage.app/Glosario-M3V3.pdf', external: false },
                                        { name: 'Kit Maestro: Delegación IA', url: 'gs://aulagenia.firebasestorage.app/Kit-Maestro-Delegación-IA.pdf', external: false },
                                        { name: 'Kit de Primeros Auxilios IA', url: 'gs://aulagenia.firebasestorage.app/Kit-Primeros-Auxilios-IA.pdf', external: false }
                                    ]
                                },
                                {
                                    id: 'q-3',
                                    title: 'Test: Módulo 3',
                                    type: 'quiz',
                                    questions: [
                                        {
                                            text: 'Para pedirle algo a la IA de forma efectiva, ¿qué 3 cosas básicas necesitas decirle?',
                                            options: [
                                                'Título, Cuerpo y Conclusión',
                                                'Rol (quién es), Contexto (la situación) y Meta (qué quieres)',
                                                'Pregunta, Respuesta y Gracias',
                                                'Inicio, Desarrollo y Final'
                                            ],
                                            correctAnswerHash: '4f12c7b863c648b23f3b487f54cece480f0cb675827fb8408405e431a64669e9',
                                            tip: 'Piensa en: ¿Quién debe actuar? ¿En qué situación? ¿Qué resultado quieres?'
                                        },
                                        {
                                            text: 'Si quieres que la IA NO haga algo específico, ¿dónde lo pones en tu pedido?',
                                            options: [
                                                'En el Formato',
                                                'En las Restricciones',
                                                'En el Rol',
                                                'En el Contexto'
                                            ],
                                            correctAnswerHash: '4f12c7b863c648b23f3b487f54cece480f0cb675827fb8408405e431a64669e9',
                                            tip: 'Es donde defines los límites o lo que NO quieres que haga.'
                                        },
                                        {
                                            text: 'Si la IA corta su respuesta a la mitad, ¿qué es lo más rápido para que continúe?',
                                            options: [
                                                'Empezar de nuevo',
                                                'Escribir "Continúa"',
                                                'Cerrar y abrir el chat',
                                                'Borrar todo'
                                            ],
                                            correctAnswerHash: '4f12c7b863c648b23f3b487f54cece480f0cb675827fb8408405e431a64669e9',
                                            tip: 'Una sola palabra es suficiente para que retome donde quedó.'
                                        },
                                        {
                                            text: '¿Qué es la "Estructura Maestra AGIA"?',
                                            options: [
                                                'Un tipo de IA',
                                                'La forma completa de pedirle algo a la IA: Rol, Contexto, Meta, Restricciones y Formato',
                                                'Un programa de computadora',
                                                'Una empresa de tecnología'
                                            ],
                                            correctAnswerHash: '4f12c7b863c648b23f3b487f54cece480f0cb675827fb8408405e431a64669e9',
                                            tip: 'Es la receta completa con todos los ingredientes para un prompt perfecto.'
                                        },
                                        {
                                            text: 'Si quieres que la IA te dé una respuesta más profunda, ¿qué puedes hacer?',
                                            options: [
                                                'Gritar al micrófono',
                                                'Decirle que es importante y crítico para tu trabajo',
                                                'Escribir en mayúsculas',
                                                'Reiniciar el chat'
                                            ],
                                            correctAnswerHash: '4f12c7b863c648b23f3b487f54cece480f0cb675827fb8408405e431a64669e9',
                                            tip: 'Añadir importancia o consecuencias activa las capacidades más avanzadas de la IA.'
                                        }
                                    ],
                                    resources: []
                                }
                            ]
                        },
                        {
                            title: 'Módulo 4: Arquitectura de Ideas',
                            badge: 'Maestro de Prompts',
                            practiceTasks: [
                                { text: 'Video 1 | El Plano: Elegí un proyecto grande y le pedí a la IA solo el índice o la estructura general, prohibiéndole desarrollar el contenido todavía.', done: false },
                                { text: 'Video 2 | El Ladrillo: Seleccioné un único punto del índice y le pedí a la IA que se concentre exclusivamente en desarrollarlo a fondo.', done: false },
                                { text: 'Video 2 | El Cemento: Le pedí a la IA que transforme ese contenido suelto en un formato ejecutable (como una tabla de planificación semanal o calendario).', done: false },
                                { text: 'Video 2 | Desafío de Estilo: Subí mi logo (o una imagen de referencia) y le pedí 3 variaciones de estilo (cinemático, minimalista, 3D) para entrenar mi criterio visual.', done: false }
                            ],
                            lessons: [
                                {
                                    id: '4-1',
                                    title: 'Intro al Arquitecto de Ideas',
                                    type: 'video',
                                    videoUrl: 'gs://aulagenia.firebasestorage.app/MODULO4-VIDEO1-IA-Aplicada-Programa-Esencial.mp4',
                                    transcriptionUrl: 'gs://aulagenia.firebasestorage.app/MODULO4-VIDEO1-IA-Aplicada-Programa-Esencial-caption.srt',
                                    resources: [
                                        { name: 'Glosario 4.1', url: 'gs://aulagenia.firebasestorage.app/Glosario-M4V1.pdf', external: false },
                                        { name: 'Fuentes de Autoridad 4.0', url: 'gs://aulagenia.firebasestorage.app/Fuentesde-Autoridad-4.pdf', external: false },
                                        { name: 'Guía Visual: El Mapa del Arquitecto', url: 'gs://aulagenia.firebasestorage.app/Guía-Visual-El-Mapa-del-Arquitecto.pdf', external: false }
                                    ]
                                },
                                {
                                    id: '4-2',
                                    title: 'Tú eres el Arquitecto de Ideas',
                                    type: 'video',
                                    videoUrl: 'gs://aulagenia.firebasestorage.app/MODULO4-VIDEO2-IA-Aplicada-Programa-Esencial.mp4',
                                    transcriptionUrl: 'gs://aulagenia.firebasestorage.app/MODULO4-VIDEO2-IA-Aplicada-Programa-Esencial-caption.srt',
                                    resources: [
                                        { name: 'Glosario 4.2', url: 'gs://aulagenia.firebasestorage.app/Glosario-M4V2.pdf', external: false },
                                        { name: 'Guía Visual: El Mapa del Arquitecto', url: 'gs://aulagenia.firebasestorage.app/Guía-Visual-El-Mapa-del-Arquitecto.pdf', external: false },
                                        { name: 'Herramienta: Checklist de Complejidad', url: 'gs://aulagenia.firebasestorage.app/Herramienta-Checklist-de-Complejidad.pdf', external: false },
                                        { name: 'Caso Práctico: Estrategia 0 a 10k Seguidores', url: 'gs://aulagenia.firebasestorage.app/Caso-Practico-Estrategia-0-a-10k-Seguidores.pdf', external: false }
                                    ]
                                },
                                {
                                    id: 'q-4',
                                    title: 'Test: Módulo 4',
                                    type: 'quiz',
                                    questions: [
                                        {
                                            text: '¿Qué hace diferente a un "Arquitecto de Ideas" de alguien que solo pide cosas a la IA?',
                                            options: [
                                                'Usa mejores palabras',
                                                'Planifica y estructura proyectos complejos paso a paso',
                                                'Sabe programar',
                                                'Paga más por la herramienta'
                                            ],
                                            correctAnswerHash: '4f12c7b863c648b23f3b487f54cece480f0cb675827fb8408405e431a64669e9',
                                            tip: 'No solo pide, sino que organiza la información para que la IA trabaje mejor.'
                                        },
                                        {
                                            text: 'Si tu pedido a la IA es muy complejo y se confunde, ¿qué deberías hacer?',
                                            options: [
                                                'Pedirle que vaya más rápido',
                                                'Dividirlo en pasos más pequeños y claros',
                                                'Cambiar de IA',
                                                'Escribir más texto'
                                            ],
                                            correctAnswerHash: '4f12c7b863c648b23f3b487f54cece480f0cb675827fb8408405e431a64669e9',
                                            tip: 'A veces menos es más. Divide tareas grandes en pasos pequeños.'
                                        },
                                        {
                                            text: '¿Por qué TÚ eres importante al trabajar con IA?',
                                            options: [
                                                'Porque pagas la suscripción',
                                                'Porque tú das la dirección y el criterio que la IA no tiene',
                                                'Porque sabes arreglar computadoras',
                                                'Porque tienes las contraseñas'
                                            ],
                                            correctAnswerHash: '4f12c7b863c648b23f3b487f54cece480f0cb675827fb8408405e431a64669e9',
                                            tip: 'La IA es la herramienta, pero tú eres quien decide qué hacer y cómo.'
                                        },
                                        {
                                            text: '¿Qué es el "Mapa del Arquitecto"?',
                                            options: [
                                                'Un plano de construcción',
                                                'Una herramienta para organizar ideas complejas antes de pedirlas a la IA',
                                                'Un tipo de GPS',
                                                'Un programa de diseño'
                                            ],
                                            correctAnswerHash: '4f12c7b863c648b23f3b487f54cece480f0cb675827fb8408405e431a64669e9',
                                            tip: 'Te ayuda a estructurar proyectos grandes dividiéndolos en partes manejables.'
                                        },
                                        {
                                            text: 'Si un proyecto es muy grande, ¿qué es mejor hacer?',
                                            options: [
                                                'Pedirlo todo de una vez',
                                                'Dividirlo en pasos pequeños y claros',
                                                'Abandonarlo',
                                                'Cambiar de IA'
                                            ],
                                            correctAnswerHash: '4f12c7b863c648b23f3b487f54cece480f0cb675827fb8408405e431a64669e9',
                                            tip: 'Menos es más: divide tareas complejas en módulos simples.'
                                        }
                                    ],
                                    resources: []
                                }
                            ]
                        },
                        // MÓDULO 5 OCULTO TEMPORALMENTE
                        /*{
                            title: 'Módulo 5: Estrategias Avanzadas y Productividad',
                            badge: 'Arquitecto de Eficiencia',
                            lessons: [
                                {
                                    id: '5-1',
                                    title: 'IA y Productividad Extrema',
                                    type: 'video',
                                    videoUrl: 'gs://aulagenia.firebasestorage.app/MODULO5-VIDEO1.mp4',
                                    resources: []
                                },
                                {
                                    id: '5-2',
                                    title: 'Herramientas de Siguiente Generación',
                                    type: 'video',
                                    videoUrl: 'gs://aulagenia.firebasestorage.app/MODULO5-VIDEO2.mp4',
                                    resources: []
                                },
                                {
                                    id: '5-3',
                                    title: 'Ética y Seguridad en el Uso Profesional',
                                    type: 'video',
                                    videoUrl: 'gs://aulagenia.firebasestorage.app/MODULO5-VIDEO3.mp4',
                                    resources: []
                                }
                            ]
                        },*/
                        {
                            title: 'Final del Camino: Certificación',
                            badge: 'Maestro de IA Aplicada',
                            lessons: [
                                {
                                    id: 'final-exam',
                                    title: 'Examen Final de Certificación (Módulos 1-4)',
                                    type: 'quiz',
                                    questions: [
                                        {
                                            text: 'CASO INTEGRAL: Recibes un reporte de la IA sobre tendencias de mercado pero sospechas que algunos datos de 2024 son "alucinaciones". Según el curso, ¿cuál es el procedimiento correcto de un Alumno Aula GenIA?',
                                            options: [
                                                'Aceptar el reporte porque los LLM nunca se equivocan en datos numéricos.',
                                                'Aplicar el truco de validación: preguntar "¿Estás 100% seguro de estos datos?" y contrastar con fuentes de autoridad.',
                                                'Borrar el chat y pedirle que use Google Search únicamente.',
                                                'Rechazar el uso de IA para reportes y hacerlo manualmente de nuevo.'
                                            ],
                                            correctAnswerHash: '4f12c7b863c648b23f3b487f54cece480f0cb675827fb8408405e431a64669e9',
                                            tip: 'Recuerda que la IA es tu copiloto, no tu oráculo. El pensamiento crítico y la validación iterativa son tu mayor poder.'
                                        },
                                        {
                                            text: 'CASO DE AUTOMATIZACIÓN: Tienes 3 tareas acumuladas: A) Responder 50 correos similares al día. B) Decidir la estrategia de expansión de tu empresa a 5 años. C) Revisar la ortografía de un post. Según el Radar de Automatización, ¿cuál deberías delegar a la IA hoy mismo?',
                                            options: [
                                                'La tarea B, porque es la más difícil y la IA piensa mejor.',
                                                'La tarea A, porque es mecánica, repetitiva y consume bloques grandes de tiempo.',
                                                'Ninguna, todas requieren criterio humano del 100%.',
                                                'Solo la tarea C, porque es la más rápida.'
                                            ],
                                            correctAnswerHash: '4f12c7b863c648b23f3b487f54cece480f0cb675827fb8408405e431a64669e9',
                                            tip: 'Buscamos tareas que estén en el área de "Tareas Mecánicas" que consuman más de 30 minutos por sesión para liberar tu tiempo estratégico.'
                                        },
                                        {
                                            text: 'INGENIERÍA DE PROMPTS: Deseas que la IA analice el perfil de un cliente ideal para tu negocio. ¿Qué estructura de la "Fórmula AGIA" garantiza el mejor resultado?',
                                            options: [
                                                'Contexto + Formato solamente.',
                                                'Rol (Experto en ventas) + Contexto (Datos de tu negocio) + Meta (Perfil del cliente) + Restricciones (Evitar tecnicismos) + Formato (Tabla resumen).',
                                                'Pedirle: "Dame un perfil de cliente ideal" de forma directa.',
                                                'Usar solamente la Ventana de Contexto sin darle un Rol.'
                                            ],
                                            correctAnswerHash: '4f12c7b863c648b23f3b487f54cece480f0cb675827fb8408405e431a64669e9',
                                            tip: 'Una instrucción completa de un "Arquitecto de Ideas" siempre define quién es la IA, qué sabe, qué busca y cómo debe entregar el resultado.'
                                        },
                                        {
                                            text: 'CASO DE ARQUITECTURA: Estás diseñando un flujo para automatizar la creación de facturas a partir de fotos de recibos. ¿Qué combinación de capacidades estás uniendo?',
                                            options: [
                                                'Tokenización y LLM básico.',
                                                'Multimodalidad (visión) y Extracción de Patrones estratégica.',
                                                'Navegación web y Búsqueda semántica.',
                                                'Traducción automática y Alucinación controlada.'
                                            ],
                                            correctAnswerHash: '4f12c7b863c648b23f3b487f54cece480f0cb675827fb8408405e431a64669e9',
                                            tip: 'La capacidad de "ver" archivos (multimodalidad) y entender la estructura de un documento es una de las aplicaciones más potentes del curso.'
                                        },
                                        {
                                            text: 'CONCEPTO ESTRATÉGICO: Según lo visto en el curso, ¿por qué los humanos que usan IA reemplazarán a los que no la usan?',
                                            options: [
                                                'Porque la suscripción a la IA los hace más ricos.',
                                                'Porque pueden procesar información, iterar y ejecutar a una velocidad y escala humanamente imposibles sin ayuda.',
                                                'Porque la IA les da siempre la razón en las discusiones de negocio.',
                                                'Porque ya no necesitan estudiar ni tener criterio propio.'
                                            ],
                                            correctAnswerHash: '4f12c7b863c648b23f3b487f54cece480f0cb675827fb8408405e431a64669e9',
                                            tip: 'La IA no es magia, es un amplificador de tus propias capacidades. Quien tiene un motor corre más que quien va a pie.'
                                        }
                                    ],
                                    resources: []
                                }
                            ]
                        }
                    ]
                }
            };

            const courseData = ALL_COURSES_DATA[courseId];
            if (!courseData) {
                console.error("Curso no encontrado");
                return;
            }
            const allLessons = courseData.modules.flatMap(m => m.lessons);
            let currentUser = null;
            let userProgress = { completedLessons: [], currentLessonId: allLessons.length > 0 ? allLessons[0].id : null, unlockedBadges: [] };
            let notesSaveTimer = null;
            let currentLessonVideo = null;
            let hasShownCompletionModal = false;

            const dom = {
                userName: document.getElementById('user-name'),
                userAvatar: document.getElementById('user-avatar'),
                userProfile: document.getElementById('user-profile-container'),
                logoutButton: document.getElementById('logout-button'),
                courseTitle: document.getElementById('course-title'),
                progressBar: document.getElementById('progress-bar'),
                progressText: document.getElementById('progress-text'),
                modulesContainer: document.getElementById('modules-container'),
                lessonTitle: document.getElementById('lesson-title'),
                lessonMaterialContainer: document.getElementById('lesson-material-container'),
                navigationButtons: document.getElementById('navigation-buttons'),
                prevBtn: document.getElementById('prev-lesson-btn'),
                mainActionBtn: document.getElementById('main-action-btn'),
                toast: document.getElementById('toast-notification'),
                toastMessage: document.getElementById('toast-message'),
                badgeToast: document.getElementById('badge-toast'),
                badgeMessage: document.getElementById('badge-message'),
                completionModalOverlay: document.getElementById('completion-modal-overlay'),
                completionModal: document.getElementById('completion-modal'),
                modalUserName: document.getElementById('modal-user-name'),
                modalCourseName: document.getElementById('modal-course-name'),
                certificateLink: document.getElementById('certificate-link'),
                reviewCourseBtn: document.getElementById('review-course-btn'),
                closeModalBtn: document.getElementById('close-modal-btn'),
                learningTabs: document.getElementById('learning-tabs'),
                notesTextarea: document.getElementById('notes-textarea'),
                notesSaveStatus: document.getElementById('notes-save-status'),
                resourceFileInput: document.getElementById('resource-file-input'),
                uploadResourcesBtn: document.getElementById('upload-resources-btn'),
                uploadProgress: document.getElementById('upload-progress'),
                resourcesList: document.getElementById('resources-list'),
                userResourceList: document.getElementById('user-resource-list'),
                taskInput: document.getElementById('task-input'),
                addTaskBtn: document.getElementById('add-task-btn'),
                taskList: document.getElementById('task-list'),
                tabMaterialPanel: document.getElementById('tab-material'),
                integratedResourcesArea: document.getElementById('integrated-resources-container'),
                pdfModalOverlay: document.getElementById('pdf-modal-overlay'),
                pdfModal: document.getElementById('pdf-modal'),
                pdfModalContent: document.getElementById('pdf-modal-content'),
                pdfModalTitle: document.getElementById('pdf-modal-title'),
                pdfModalCloseBtn: document.getElementById('pdf-modal-close-btn'),
                pdfIframe: document.getElementById('pdf-iframe'),
                supportForm: document.getElementById('support-form'),
                supportSubmitBtn: document.getElementById('support-submit-btn'),
                supportBtnText: document.getElementById('support-btn-text'),
                supportSpinner: document.getElementById('support-spinner'),
                supportFormStatus: document.getElementById('support-form-status'),
                sidebar: document.getElementById('course-sidebar'),
                sidebarToggle: document.getElementById('sidebar-toggle-desktop'),
                tabsNavContainer: document.getElementById('tabs-navigation-container')
            };

            if (dom.sidebarToggle && dom.sidebar) {
                dom.sidebarToggle.addEventListener('click', () => {
                    dom.sidebar.classList.toggle('collapsed');
                    const icon = document.getElementById('toggle-icon');
                    if (dom.sidebar.classList.contains('collapsed')) {
                        icon.setAttribute('data-lucide', 'panel-left-open');
                        dom.sidebarToggle.title = "Mostrar menú";
                    } else {
                        icon.setAttribute('data-lucide', 'panel-left-close');
                        dom.sidebarToggle.title = "Ocultar menú";
                    }
                    lucide.createIcons();
                });
            }

            function getIsCourseComplete() {
                if (allLessons.length === 0) return false;
                const uniqueCompleted = new Set(userProgress.completedLessons);
                return uniqueCompleted.size >= allLessons.length;
            }

            function getLessonInfo(lessonId) { for (let i = 0; i < courseData.modules.length; i++) { const module = courseData.modules[i]; const lessonIndex = module.lessons.findIndex(l => l.id === lessonId); if (lessonIndex !== -1) { return { lesson: module.lessons[lessonIndex], moduleIndex: i, module: module }; } } return null; }

            function refreshUI() {
                if (!userProgress.currentLessonId && allLessons.length > 0) {
                    userProgress.currentLessonId = allLessons[0].id;
                }
                dom.courseTitle.textContent = courseData.title;
                renderSidebar();
                const lessonInfo = getLessonInfo(userProgress.currentLessonId);
                if (lessonInfo) {
                    dom.lessonTitle.textContent = lessonInfo.lesson.title;
                    renderLessonContent(lessonInfo.lesson);
                    if (dom.prevBtn) dom.prevBtn.disabled = allLessons.findIndex(l => l.id === lessonInfo.lesson.id) === 0;
                }
                updateOverallProgress();
                updateMainActionButton();
                lucide.createIcons();
                lockPostCompletionActions();
            }

            function renderSidebar() {
                if (!dom.modulesContainer) return;

                dom.modulesContainer.innerHTML = courseData.modules.map((module, moduleIndex) => {
                    const lessonsHtml = module.lessons.map(lesson => {
                        const isCompleted = userProgress.completedLessons.includes(lesson.id);
                        const isActive = userProgress.currentLessonId === lesson.id;
                        let linkClasses = 'text-gray-600 hover:bg-slate-50';
                        let statusIcon = isCompleted ? 'check-circle-2' : (lesson.type === 'quiz' ? 'edit-3' : (lesson.type === 'video' ? 'play' : 'file-text'));
                        let iconColor = isCompleted ? 'text-green-500' : (lesson.type === 'quiz' ? 'text-amber-500' : (lesson.type === 'video' ? 'text-teal-500' : 'text-slate-400'));

                        if (isActive) {
                            linkClasses = 'bg-teal-50 text-teal-700 font-semibold';
                            statusIcon = lesson.type === 'video' ? 'play-circle' : (lesson.type === 'quiz' ? 'help-circle' : 'file-text');
                            iconColor = 'text-teal-600';
                        }
                        const typeIcon = { video: 'video', resource: 'book-open', quiz: 'edit-3' }[lesson.type] || 'file';
                        return `<li class="lesson-item" data-lesson-id="${lesson.id}"><a href="#" class="flex items-center px-4 py-2 ml-2 rounded-md transition-colors ${linkClasses}"><i data-lucide="${statusIcon}" class="h-4 w-4 mr-3 flex-shrink-0 ${iconColor}"></i><span class="flex-1 text-[11px] whitespace-normal leading-tight">${lesson.title}</span><i data-lucide="${typeIcon}" class="h-3.5 w-3.5 ml-2 opacity-30"></i></a></li>`;
                    }).join('');

                    const accordionIcon = 'chevron-down';
                    return `<div class="accordion-item"><button class="accordion-header w-full flex justify-between items-center p-3 rounded-md hover:bg-slate-50 text-left"><span class="font-semibold text-xs tracking-wide text-gray-800">${module.title}</span><i data-lucide="${accordionIcon}" class="h-4 w-4 transition-transform text-gray-400"></i></button><div class="accordion-content open"><ul class="py-1 space-y-0.5">${lessonsHtml}</ul></div></div>`;
                }).join('');
                addSidebarListeners();
            }

            function renderLessonContent(lesson) {
                let materialHtml = '';
                if (currentLessonVideo) { currentLessonVideo.pause(); currentLessonVideo = null; }

                if (window.currentQuizHandler) {
                    const checkBtn = document.getElementById('check-quiz-btn');
                    if (checkBtn) { checkBtn.removeEventListener('click', window.currentQuizHandler); }
                }

                if (dom.tabsNavContainer) {
                    if (lesson.type === 'quiz' || lesson.type === 'taller') {
                        dom.tabsNavContainer.classList.add('hidden');
                        activateTab('tab-clases');
                    } else {
                        dom.tabsNavContainer.classList.remove('hidden');
                    }
                }

                switch (lesson.type) {
                    case 'taller':
                        materialHtml = `
                        <div class="bg-white p-8 md:p-12 rounded-xl border border-slate-200 shadow-sm flex flex-col items-center justify-center text-center min-h-[400px]">
                            <div class="bg-gradient-to-br from-teal-100 to-blue-100 p-6 rounded-full mb-6 shadow-inner">
                                <i data-lucide="target" class="h-16 w-16 text-teal-600"></i>
                            </div>
                            <h3 class="text-3xl font-bold text-gray-900 mb-3">Radar de Automatización Pro</h3>
                            <span class="inline-block px-3 py-1 bg-blue-100 text-blue-700 text-xs font-bold rounded-full mb-6">Herramienta Interactiva</span>
                            <p class="text-gray-600 text-lg max-w-xl mb-8 leading-relaxed">
                                Accede a nuestra herramienta exclusiva para diagnosticar, priorizar y automatizar tus tareas diarias. 
                                <br class="hidden md:block">Descubre dónde está tu verdadero retorno de inversión (ROI) con IA.
                            </p>
                            <a href="radar-automatizacion-pro.html" target="_blank"
                                class="bg-gradient-to-r from-teal-500 to-blue-600 hover:from-teal-600 hover:to-blue-700 text-white font-bold py-4 px-10 rounded-xl shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-1 flex items-center gap-3 text-lg group">
                                <span>Iniciar Aplicación</span>
                                <i data-lucide="external-link" class="h-5 w-5 group-hover:translate-x-1 transition-transform"></i>
                            </a>
                            <p class="text-sm text-slate-400 mt-6 flex items-center gap-2">
                                <i data-lucide="info" class="h-4 w-4"></i> Se abrirá en una nueva pestaña para no perder tu progreso.
                            </p>
                        </div>`;
                        break;
                    case 'video':
                        if (lesson.videoUrl) {
                            materialHtml = `<div class="flex flex-col gap-4 mt-8">
                                <div class="video-wrapper-optimized">
                                    <video id="course-video" controls>
                                        <source id="course-video-source" data-src="${lesson.videoUrl || ''}" type="video/mp4">
                                        ${lesson.transcriptionUrl ? `<track id="caption-track" kind="subtitles" srclang="es" label="Español" default>` : ''}
                                        Tu navegador no soporta el elemento de video.
                                    </video>
                                </div>
                                <div class="mt-2 grid grid-cols-1 sm:grid-cols-2 gap-2 max-w-[1200px] mx-auto w-full">
                                ${lesson.transcriptionUrl ? `
                                    <button id="toggle-subtitles-btn" class="w-full flex items-center justify-center gap-2 px-4 py-2 bg-slate-200 text-slate-800 rounded-lg font-semibold hover:bg-slate-300 transition-colors">
                                        <i data-lucide="captions" class="h-5 w-5"></i>
                                        <span>Desactivar Subtítulos</span>
                                    </button>
                                    <button id="transcription-button" class="w-full flex items-center justify-center gap-2 px-4 py-2 bg-slate-200 text-slate-800 rounded-lg font-semibold hover:bg-slate-300 transition-colors">
                                        <i data-lucide="download" class="h-5 w-5"></i>
                                        <span>Descargar Transcripción</span>
                                    </button>
                                ` : `
                                    <div class="sm:col-span-2">
                                        <button class="w-full flex items-center justify-center gap-2 px-4 py-2 bg-slate-200 text-slate-400 rounded-lg font-semibold cursor-not-allowed" disabled>
                                            <i data-lucide="captions-off" class="h-5 w-5"></i>
                                            <span>Subtítulos No Disponibles</span>
                                        </button>
                                    </div>
                                `}
                                </div>
                            </div>`;
                        } else {
                            materialHtml = `<div class="aspect-w-16 aspect-h-9"><div class="w-full h-full bg-slate-900 rounded-xl flex items-center justify-center text-white"><i data-lucide="play-circle" class="h-20 w-20 text-slate-500"></i><p class="absolute">Contenido del video</p></div></div>`;
                        }
                        break;
                    case 'resource':
                        materialHtml = `<div class="bg-white p-12 border border-slate-200 rounded-xl flex flex-col items-center justify-center text-slate-600 text-center">
                            <i data-lucide="library-big" class="h-16 w-16 text-teal-500 mb-4"></i>
                            <h3 class="text-xl font-bold text-gray-900">Lección de Consulta</h3>
                            <p class="mt-2 text-gray-600 max-w-md">Esta lección se compone de recursos teóricos y enlaces externos que puedes consultar en la pestaña "Materiales".</p>
                        </div>`;
                        break;
                    case 'quiz': {
                        if (!lesson.questions || lesson.questions.length === 0) {
                            materialHtml = `<p class="text-center text-slate-500">Este quiz no tiene preguntas configuradas.</p>`;
                            break;
                        }
                        const isQuizCompleted = userProgress.completedLessons.includes(lesson.id);
                        const inReviewMode = isQuizCompleted;
                        let quizHtml = lesson.questions.map((question, qIndex) => {
                            const optionsHtml = question.options.map((opt, index) => {
                                if (inReviewMode) {
                                    const isCorrect = index === question.correctAnswer;
                                    const optionClasses = isCorrect ? 'quiz-option correct' : 'quiz-option opacity-60';
                                    return `<div class="${optionClasses} border-2 p-4 rounded-lg cursor-default">${opt}</div>`;
                                } else {
                                    const questionId = `quiz-${lesson.id}-q-${qIndex}`;
                                    return `<div class="quiz-option border-2 border-slate-300 p-4 rounded-lg cursor-pointer hover:bg-slate-100" data-index="${index}" data-question-id="${questionId}">${opt}</div>`;
                                }
                            }).join('');
                            const tipHtml = question.tip ? `
                                <div class="mt-2">
                                    <button onclick="this.nextElementSibling.classList.toggle('hidden')" class="text-xs text-teal-600 font-bold flex items-center gap-1 hover:text-teal-700 transition-colors">
                                        <i data-lucide="lightbulb" class="h-3.5 w-3.5"></i> ¿Necesitas una pista?
                                    </button>
                                    <p class="hidden text-[11px] text-slate-500 mt-2 italic bg-teal-50 p-2 rounded-lg border border-teal-100 leading-relaxed shadow-sm">
                                        ${question.tip}
                                    </p>
                                </div>` : '';
                            const questionContainerAttributes = inReviewMode ? '' : `id="quiz-${lesson.id}-q-${qIndex}"`;
                            return `<div class="space-y-4 mb-8 p-4 bg-white rounded-xl border border-slate-200 shadow-sm" ${questionContainerAttributes}>
                                        <h3 class="text-lg font-bold text-slate-800">${qIndex + 1}. ${question.text}</h3>
                                        <div class="space-y-2.5">${optionsHtml}</div>
                                        ${tipHtml}
                                    </div>`;
                        }).join('');
                        if (inReviewMode) {
                            const reviewMessage = 'Ya has completado este quiz. Puedes revisar las respuestas correctas.';
                            materialHtml = `${quizHtml}<p class="text-sm text-slate-500 mt-4 font-semibold text-center p-4 bg-slate-100 rounded-md">${reviewMessage}</p>`;
                        } else {
                            materialHtml = `<div id="quiz-container" class="max-w-3xl mx-auto">${quizHtml}<div class="flex justify-center mt-6"><button id="check-quiz-btn" class="bg-slate-900 text-white font-bold px-10 py-4 rounded-full hover:bg-slate-800 transition-all shadow-lg hover:scale-105">Verificar Respuestas</button></div></div>`;
                        }
                        break;
                    }
                    default: materialHtml = `<p>Tipo de lección no reconocido.</p>`;
                }

                const materialContainer = document.getElementById('lesson-material-container');
                if (materialContainer) materialContainer.innerHTML = materialHtml;
                renderCourseResources(lesson);

                if (lesson.type === 'quiz' && lesson.questions && lesson.questions.length > 0) {
                    const isQuizCompleted = userProgress.completedLessons.includes(lesson.id);
                    if (!isQuizCompleted) {
                        const quizWrapper = document.getElementById('tab-clases');
                        quizWrapper.querySelectorAll('.quiz-option').forEach(opt => {
                            opt.addEventListener('click', () => {
                                const questionId = opt.dataset.questionId;
                                quizWrapper.querySelectorAll(`.quiz-option[data-question-id="${questionId}"]`).forEach(o => o.classList.remove('selected'));
                                opt.classList.add('selected');
                            });
                        });
                        const checkBtn = document.getElementById('check-quiz-btn');
                        if (checkBtn) {
                            window.currentQuizHandler = () => checkQuizAnswers(lesson);
                            checkBtn.addEventListener('click', window.currentQuizHandler);
                        }
                    }
                }

                const videoEl = document.getElementById('course-video');
                if (videoEl) {
                    currentLessonVideo = videoEl;
                    videoEl.onended = async () => {
                        if (!userProgress.completedLessons.includes(lesson.id)) {
                            userProgress.completedLessons.push(lesson.id);
                            await saveProgress();
                            updateOverallProgress();
                            refreshUI();
                            showToast('¡Lección completada al ver el video!');
                        }
                    };
                }

                const toggleSubtitlesBtn = document.getElementById('toggle-subtitles-btn');
                if (toggleSubtitlesBtn && videoEl) {
                    toggleSubtitlesBtn.addEventListener('click', () => {
                        if (!videoEl.textTracks || videoEl.textTracks.length === 0) return;
                        const track = videoEl.textTracks[0];
                        const btnText = toggleSubtitlesBtn.querySelector('span');
                        const btnIcon = toggleSubtitlesBtn.querySelector('i');
                        const isShowing = track.mode === 'showing';
                        track.mode = isShowing ? 'hidden' : 'showing';
                        if (track.mode === 'showing') {
                            if (btnText) btnText.textContent = 'Desactivar Subtítulos';
                            if (btnIcon) btnIcon.setAttribute('data-lucide', 'captions');
                        } else {
                            if (btnText) btnText.textContent = 'Activar Subtítulos';
                            if (btnIcon) btnIcon.setAttribute('data-lucide', 'captions-off');
                        }
                        lucide.createIcons();
                    });
                }
                const transcriptionBtn = document.getElementById('transcription-button');
                if (transcriptionBtn && lesson.transcriptionUrl) {
                    transcriptionBtn.addEventListener('click', () => downloadTranscription(lesson.transcriptionUrl, lesson.title));
                }

                (async () => {
                    if (!videoEl) return;
                    try {
                        await attachMediaAndCaptions({
                            storage,
                            videoEl,
                            videoSrc: (lesson && lesson.videoUrl) || '',
                            srtOrVttSrc: (lesson && lesson.transcriptionUrl) || ''
                        });
                    } catch (err) { console.error('No se pudieron adjuntar medios/subtítulos:', err); }
                    finally { lockPostCompletionActions(); }
                })();
            }

            async function advanceToNextLesson() {
                const currentIndex = allLessons.findIndex(l => l.id === userProgress.currentLessonId);
                if (currentIndex < allLessons.length - 1) {
                    showToast('¡Excelente! Cargando siguiente lección...');
                    setTimeout(() => { navigateToLesson(allLessons[currentIndex + 1].id); }, 1500);
                } else {
                    if (!hasShownCompletionModal) {
                        await showCompletionModal();
                        hasShownCompletionModal = true;
                    }
                }
            }

            async function hashAnswer(index) {
                const msgBuffer = new TextEncoder().encode('AGIA-SEC-' + index);
                const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            }

            async function checkQuizAnswers(lesson) {
                const totalQuestions = lesson.questions.length;
                let correctAnswers = 0;
                let allAnswered = true;
                for (let qIndex = 0; qIndex < lesson.questions.length; qIndex++) {
                    const questionId = `quiz-${lesson.id}-q-${qIndex}`;
                    const questionContainer = document.getElementById(questionId);
                    const selectedOption = questionContainer.querySelector('.quiz-option.selected');
                    if (!selectedOption) { allAnswered = false; break; }
                }
                if (!allAnswered) { showToast('Por favor, responde todas las preguntas.'); return; }

                const validations = await Promise.all(lesson.questions.map(async (question, qIndex) => {
                    const questionId = `quiz-${lesson.id}-q-${qIndex}`;
                    const questionContainer = document.getElementById(questionId);
                    const selectedOption = questionContainer.querySelector('.quiz-option.selected');
                    const selectedIndex = parseInt(selectedOption.dataset.index);
                    const selectedHash = await hashAnswer(selectedIndex);
                    const isCorrect = selectedHash === question.correctAnswerHash;
                    return { questionContainer, selectedOption, isCorrect, correctHash: question.correctAnswerHash };
                }));

                for (const res of validations) {
                    const { questionContainer, selectedOption, isCorrect, correctHash } = res;
                    questionContainer.querySelectorAll('.quiz-option').forEach(opt => {
                        opt.style.pointerEvents = 'none';
                        opt.classList.remove('selected');
                    });
                    if (isCorrect) { selectedOption.classList.add('correct'); correctAnswers++; }
                    else {
                        selectedOption.classList.add('incorrect');
                        for (let i = 0; i < 4; i++) {
                            const hash = await hashAnswer(i);
                            if (hash === correctHash) {
                                questionContainer.querySelector(`[data-index="${i}"]`)?.classList.add('correct');
                                break;
                            }
                        }
                    }
                }
                if (correctAnswers === totalQuestions) {
                    showToast('¡Todas las respuestas son correctas!');
                    if (!userProgress.completedLessons.includes(lesson.id)) {
                        userProgress.completedLessons = [...new Set([...userProgress.completedLessons, lesson.id])];
                        await saveProgress();
                        checkForBadgeUnlock(lesson.id);
                        refreshUI();
                    }
                    advanceToNextLesson();
                } else {
                    showToast(`Revisa tus respuestas. ${correctAnswers} de ${totalQuestions} son correctas.`);
                    const firstIncorrect = document.querySelector('.quiz-option.incorrect');
                    if (firstIncorrect) {
                        const questionContainer = firstIncorrect.closest('.space-y-4.mb-8');
                        if (questionContainer) { questionContainer.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
                    }
                    setTimeout(() => {
                        document.querySelectorAll('.quiz-option').forEach(opt => {
                            opt.classList.remove('incorrect', 'correct');
                            opt.style.pointerEvents = 'auto';
                        });
                    }, 5000);
                }
            }

            function updateMainActionButton() {
                if (!dom.navigationButtons || !dom.mainActionBtn) return;
                dom.navigationButtons.classList.remove('hidden');
                const lesson = allLessons.find(l => l.id === userProgress.currentLessonId);
                if (!lesson) return;
                const isCompleted = userProgress.completedLessons.includes(lesson.id);
                if (isCompleted) {
                    dom.mainActionBtn.textContent = 'Lección completada ✓';
                    dom.mainActionBtn.disabled = true;
                    dom.mainActionBtn.classList.replace('bg-teal-500', 'bg-slate-400');
                    dom.mainActionBtn.classList.remove('hover:bg-teal-600');
                    return;
                }
                dom.mainActionBtn.disabled = (lesson.type === 'quiz');
                dom.mainActionBtn.textContent = 'Marcar como completada';
                dom.mainActionBtn.classList.replace('bg-slate-400', 'bg-teal-500');
                dom.mainActionBtn.classList.add('hover:bg-teal-600');
            }

            function updateOverallProgress() { const uniqueCompleted = new Set(userProgress.completedLessons); const completedCount = uniqueCompleted.size; const percentage = allLessons.length > 0 ? Math.round((completedCount / allLessons.length) * 100) : 0; if (dom.progressBar) dom.progressBar.style.width = `${percentage}%`; if (dom.progressText) dom.progressText.textContent = `${percentage}%`; }

            async function navigateToLesson(lessonId) {
                const targetLessonInfo = getLessonInfo(lessonId);
                if (!targetLessonInfo) return;
                userProgress = { ...userProgress, currentLessonId: lessonId };
                await saveProgress();
                refreshUI();
                loadLessonTabData();
            }

            async function saveProgress() { if (!currentUser) return; try { const progressRef = db.collection('userProgress').doc(currentUser.uid); await progressRef.set({ [courseId]: userProgress }, { merge: true }); } catch (error) { console.error("Error al guardar el progreso:", error); } }
            async function loadProgressAndInitialize() { const docRef = db.collection('userProgress').doc(currentUser.uid); try { const doc = await docRef.get(); if (doc.exists) { const courseProgress = doc.data()[courseId]; if (courseProgress) { userProgress = { completedLessons: Array.isArray(courseProgress.completedLessons) ? courseProgress.completedLessons : [], currentLessonId: allLessons.some(l => l.id === courseProgress.currentLessonId) ? courseProgress.currentLessonId : allLessons[0].id, unlockedBadges: Array.isArray(courseProgress.unlockedBadges) ? courseProgress.unlockedBadges : [] }; } } } catch (error) { console.error("Error al cargar el progreso.", error); } refreshUI(); loadLessonTabData(); }

            function addSidebarListeners() {
                if (!dom.modulesContainer) return;
                dom.modulesContainer.querySelectorAll('.lesson-item a').forEach(link => {
                    link.addEventListener('click', e => {
                        e.preventDefault();
                        const li = e.currentTarget.closest('.lesson-item');
                        if (li) { navigateToLesson(li.dataset.lessonId); }
                    });
                });
                dom.modulesContainer.querySelectorAll('.accordion-item').forEach(item => {
                    const header = item.querySelector('.accordion-header');
                    if (header) {
                        header.addEventListener('click', () => {
                            const content = header.nextElementSibling;
                            const iconEl = header.querySelector('i');
                            const isOpen = content.classList.toggle('open');
                            if (iconEl && iconEl.getAttribute('data-lucide') === 'chevron-down') {
                                iconEl.style.transform = isOpen ? 'rotate(180deg)' : 'rotate(0deg)';
                            }
                        });
                    }
                });
            }

            if (dom.mainActionBtn) dom.mainActionBtn.addEventListener('click', async () => {
                const lessonId = userProgress.currentLessonId;
                const isCompleted = userProgress.completedLessons.includes(lessonId);
                if (!isCompleted) {
                    userProgress = { ...userProgress, completedLessons: [...new Set([...userProgress.completedLessons, lessonId])] };
                    await saveProgress();
                    checkForBadgeUnlock(lessonId);
                    refreshUI();
                    const isLastLesson = allLessons.findIndex(l => l.id === lessonId) === allLessons.length - 1;
                    if (getIsCourseComplete() || isLastLesson) {
                        if (!hasShownCompletionModal) { await showCompletionModal(); hasShownCompletionModal = true; }
                    } else { advanceToNextLesson(); }
                }
            });

            if (dom.prevBtn) dom.prevBtn.addEventListener('click', () => { const currentIndex = allLessons.findIndex(l => l.id === userProgress.currentLessonId); if (currentIndex > 0) navigateToLesson(allLessons[currentIndex - 1].id); });

            function showToast(message, type = 'generic') { const toastEl = type === 'badge' ? dom.badgeToast : dom.toast; const msgEl = type === 'badge' ? dom.badgeMessage : dom.toastMessage; if (!toastEl || !msgEl) return; msgEl.textContent = message; toastEl.classList.add('show'); setTimeout(() => toastEl.classList.remove('show'), 4000); }
            function checkForBadgeUnlock(completedLessonId) { const lessonInfo = getLessonInfo(completedLessonId); if (!lessonInfo || !lessonInfo.module.badge) return; const lastLessonOfModule = lessonInfo.module.lessons[lessonInfo.module.lessons.length - 1].id; if (completedLessonId !== lastLessonOfModule) return; const moduleLessonIds = lessonInfo.module.lessons.map(l => l.id); if (moduleLessonIds.every(id => userProgress.completedLessons.includes(id))) { if (!userProgress.unlockedBadges.includes(lessonInfo.module.badge)) { userProgress.unlockedBadges.push(lessonInfo.module.badge); saveProgress(); showToast(`Has ganado la insignia: "${lessonInfo.module.badge}"`, 'badge'); } } }

            async function generateCertificateRecord() {
                if (!currentUser || !courseData.hasCertificate) return null;
                const certificateId = `${currentUser.uid}_${courseId}`;
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'aulagenia-app';
                const certRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('certificates').doc(certificateId);
                try {
                    const certDoc = await certRef.get();
                    if (!certDoc.exists) {
                        await certRef.set({ userId: currentUser.uid, userName: currentUser.name, courseId: courseId, courseName: courseData.title, issuedAt: firebase.firestore.FieldValue.serverTimestamp(), appId: appId });
                    }
                    return certificateId;
                } catch (error) { console.error("Error creating or checking certificate record:", error); return null; }
            }

            async function showCompletionModal() {
                if (!dom.completionModal || !dom.completionModalOverlay) return;
                if (dom.modalUserName) dom.modalUserName.textContent = currentUser ? currentUser.name : '';
                if (dom.modalCourseName) dom.modalCourseName.textContent = courseData.title;
                if (courseData.hasCertificate && dom.certificateLink) {
                    const certificateId = await generateCertificateRecord();
                    if (certificateId) {
                        dom.certificateLink.href = `./portal-certificacion.html?id=${certificateId}`;
                        dom.certificateLink.classList.remove('hidden');
                        dom.certificateLink.classList.add('flex');
                    } else { dom.certificateLink.classList.add('hidden'); dom.certificateLink.classList.remove('flex'); }
                } else if (dom.certificateLink) { dom.certificateLink.classList.add('hidden'); dom.certificateLink.classList.remove('flex'); }
                dom.completionModalOverlay.classList.remove('hidden');
                dom.completionModal.classList.remove('hidden');
                setTimeout(() => { dom.completionModalOverlay.classList.add('opacity-100'); dom.completionModal.classList.add('show'); }, 10);
            }

            function hideCompletionModal() {
                if (!dom.completionModal || !dom.completionModalOverlay) return;
                dom.completionModalOverlay.classList.remove('opacity-100');
                dom.completionModal.classList.remove('show');
                const inner = dom.completionModal.querySelector('div');
                if (inner) inner.classList.add('scale-95', 'opacity-0');
                setTimeout(() => { dom.completionModal.classList.add('hidden'); dom.completionModalOverlay.classList.add('hidden'); if (inner) inner.classList.remove('scale-95', 'opacity-0'); }, 300);
            }
            if (dom.closeModalBtn) dom.closeModalBtn.addEventListener('click', () => window.location.href = `${baseUrl}/campus.html`);
            if (dom.reviewCourseBtn) dom.reviewCourseBtn.addEventListener('click', hideCompletionModal);

            const profileModalOverlay = document.getElementById('profile-modal-overlay');
            const profileModal = document.getElementById('profile-modal');
            const avatarButton = document.getElementById('avatar-button');
            const cancelProfileBtn = document.getElementById('cancel-profile-btn');
            const closeProfileBtn = document.getElementById('close-profile-modal-btn');
            const profileForm = document.getElementById('profile-form');
            const profileNameInput = document.getElementById('profile-name-input');
            const profileRutInput = document.getElementById('profile-rut-input');
            const profileEmailInput = document.getElementById('profile-email-input');
            const profileJobInput = document.getElementById('profile-job-input');
            const profileCountrySelect = document.getElementById('profile-country-select');
            const profileGenderSelect = document.getElementById('profile-gender-select');
            const profileBirthdateInput = document.getElementById('profile-birthdate-input');
            const formStatus = document.getElementById('form-status');
            const saveBtn = document.getElementById('save-profile-btn');
            const saveBtnText = document.getElementById('save-btn-text');
            const saveSpinner = document.getElementById('save-spinner');

            async function showProfileModal() {
                if (!profileForm || !profileEmailInput || !profileModalOverlay || !profileModal) return;
                profileForm.reset();
                const user = auth.currentUser;
                if (!user) return;
                profileEmailInput.value = user.email || '';
                const userDocRef = db.collection('users').doc(user.uid);
                try {
                    const doc = await userDocRef.get();
                    const dbData = doc.exists ? doc.data() : {};
                    const isProfileCompleted = dbData.profileCompleted === true;
                    if (profileNameInput) profileNameInput.value = isProfileCompleted ? (dbData.displayName || '') : (user.displayName || '');
                    if (profileRutInput) profileRutInput.value = dbData.rut || '';
                    if (profileJobInput) profileJobInput.value = dbData.jobTitle || '';
                    if (profileCountrySelect) profileCountrySelect.value = dbData.country || '';
                    if (profileGenderSelect) profileGenderSelect.value = dbData.gender || '';
                    if (profileBirthdateInput) profileBirthdateInput.value = dbData.birthdate || '';
                } catch (error) { console.error("Error al cargar datos del perfil:", error); }
                checkAllFieldsAndToggleButtonState();
                formStatus.classList.add('hidden');
                profileModalOverlay.classList.remove('hidden');
                profileModal.classList.remove('hidden');
                setTimeout(() => {
                    const inner = profileModal.querySelector('div.bg-white');
                    if (inner) inner.classList.remove('scale-95', 'opacity-0');
                }, 10);
            }

            function hideProfileModal() { if (!profileModalOverlay || !profileModal) return; const inner = profileModal.querySelector('div.bg-white'); if (inner) inner.classList.add('scale-95', 'opacity-0'); setTimeout(() => { profileModalOverlay.classList.add('hidden'); profileModal.classList.add('hidden'); if (inner) inner.classList.remove('scale-95', 'opacity-0'); }, 300); }
            if (avatarButton) avatarButton.addEventListener('click', () => showProfileModal()); if (cancelProfileBtn) cancelProfileBtn.addEventListener('click', hideProfileModal); if (closeProfileBtn) closeProfileBtn.addEventListener('click', hideProfileModal); if (profileModalOverlay) profileModalOverlay.addEventListener('click', (e) => { if (e.target === profileModalOverlay) hideProfileModal(); });

            function validateRut(rut) { rut = rut.replace(/\./g, '').replace(/-/g, '').trim().toLowerCase(); const rutBody = rut.slice(0, -1); let dv = rut.slice(-1); if (!/^[0-9]+[0-9kK]{1}$/.test(rut)) return false; let sum = 0, multiple = 2; for (let i = rutBody.length - 1; i >= 0; i--) { sum += rutBody.charAt(i) * multiple; if (multiple < 7) multiple++; else multiple = 2; } const calculatedDv = 11 - (sum % 11); const expectedDv = (calculatedDv === 11) ? '0' : (calculatedDv === 10) ? 'k' : calculatedDv.toString(); return dv === expectedDv; }
            function setFieldState(field, state, message = '') {
                const inputEl = document.getElementById(`profile-${field}-input`) || document.getElementById(`profile-${field}-select`);
                const errorEl = document.getElementById(`${field}-error`);
                const iconEl = document.getElementById(`${field}-status-icon`);
                if (!inputEl) return;
                inputEl.classList.remove('form-input-error', 'form-input-success');
                if (errorEl) errorEl.textContent = '';
                if (iconEl) iconEl.innerHTML = '';
                if (state === 'error') {
                    inputEl.classList.add('form-input-error');
                    if (errorEl) errorEl.textContent = message;
                    if (iconEl) iconEl.innerHTML = `<i data-lucide="alert-circle" class="h-5 w-5 text-red-500"></i>`;
                } else if (state === 'success') {
                    inputEl.classList.add('form-input-success');
                    if (iconEl) iconEl.innerHTML = `<i data-lucide="check-circle" class="h-5 w-5 text-green-500"></i>`;
                }
                if (iconEl && iconEl.innerHTML) { lucide.createIcons({ nodes: [iconEl.querySelector('i')] }); }
            }
            function validateName() { if (profileNameInput.value.trim().length < 3 || !profileNameInput.value.includes(' ')) { setFieldState('name', 'error', 'Ingresa tu nombre y apellido completo.'); return false; } setFieldState('name', 'success'); return true; }
            function validateCountry() { if (profileCountrySelect.value === '') { setFieldState('country', 'error', 'Selecciona tu país de residencia.'); return false; } setFieldState('country', 'success'); return true; }
            function validateRutField() { if (profileCountrySelect.value === 'CL') { if (!validateRut(profileRutInput.value)) { setFieldState('rut', 'error', 'El RUT ingresado no es válido.'); return false; } setFieldState('rut', 'success'); } else { setFieldState('rut', 'neutral'); } return true; }
            function checkAllFieldsAndToggleButtonState() {
                const isNameValid = validateName(); const isCountryValid = validateCountry(); const isRutValid = validateRutField();
                const isFormValid = isNameValid && isCountryValid && (profileCountrySelect.value !== 'CL' || isRutValid);
                if (saveBtn) saveBtn.disabled = !isFormValid;
            }
            if (profileNameInput) profileNameInput.addEventListener('input', checkAllFieldsAndToggleButtonState);
            if (profileRutInput) profileRutInput.addEventListener('input', checkAllFieldsAndToggleButtonState);
            if (profileCountrySelect) profileCountrySelect.addEventListener('change', checkAllFieldsAndToggleButtonState);
            if (profileForm) profileForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                checkAllFieldsAndToggleButtonState();
                if (saveBtn && saveBtn.disabled) {
                    if (formStatus) { formStatus.className = 'text-center p-3 rounded-lg bg-yellow-100 text-yellow-700'; formStatus.textContent = 'Por favor, corrige los campos marcados en rojo.'; formStatus.classList.remove('hidden'); }
                    return;
                }
                if (saveBtn) saveBtn.disabled = true; if (saveBtnText) saveBtnText.textContent = 'Guardando...';
                if (saveSpinner) saveSpinner.classList.remove('hidden'); if (formStatus) formStatus.classList.add('hidden');
                const user = auth.currentUser; const newName = profileNameInput ? profileNameInput.value.trim() : ''; const userDocRef = db.collection('users').doc(user.uid);
                try {
                    if (newName && user && newName !== user.displayName) { await user.updateProfile({ displayName: newName }); }
                    await userDocRef.set({ displayName: newName, email: user.email, rut: profileRutInput ? profileRutInput.value.trim() : '', jobTitle: profileJobInput ? profileJobInput.value.trim() : '', country: profileCountrySelect ? profileCountrySelect.value : '', gender: profileGenderSelect ? profileGenderSelect.value : '', birthdate: profileBirthdateInput ? profileBirthdateInput.value : '', profileCompleted: true }, { merge: true });
                    if (dom.userName) dom.userName.textContent = newName;
                    if (formStatus) { formStatus.className = 'text-center p-3 rounded-lg bg-green-100 text-green-700'; formStatus.textContent = '¡Perfil actualizado con éxito!'; formStatus.classList.remove('hidden'); }
                    showToast('¡Perfil actualizado con éxito!'); setTimeout(hideProfileModal, 1500);
                } catch (error) { console.error("Error al guardar perfil:", error); if (formStatus) { formStatus.className = 'text-center p-3 rounded-lg bg-red-100 text-red-700'; formStatus.textContent = 'Hubo un error al guardar. Inténtalo de nuevo.'; formStatus.classList.remove('hidden'); } }
                finally { if (saveBtnText) saveBtnText.textContent = 'Guardar Cambios'; if (saveSpinner) saveSpinner.classList.add('hidden'); }
            });

            function activateTab(tabId) {
                if (!dom.learningTabs) return;
                dom.learningTabs.querySelectorAll('.ltab').forEach(b => {
                    const active = b.dataset.tab === tabId;
                    b.classList.toggle('active', active); b.classList.toggle('text-teal-600', active); b.classList.toggle('border-teal-500', active);
                    b.classList.toggle('text-slate-500', !active); b.classList.toggle('border-transparent', !active);
                });
                dom.learningTabs.querySelectorAll('.ltab-panel').forEach(p => p.classList.toggle('hidden', p.id !== tabId));
            }
            if (dom.learningTabs) dom.learningTabs.addEventListener('click', (e) => { const button = e.target.closest('.ltab'); if (button) activateTab(button.dataset.tab); });

            function loadLessonTabData() { if (!currentUser) return; const lessonId = userProgress.currentLessonId; loadNotes(lessonId); loadUserResources(lessonId); loadTasks(lessonId); activateTab('tab-clases'); }
            async function loadNotes(lessonId) {
                if (!currentUser || !dom.notesTextarea || !dom.notesSaveStatus) return; dom.notesTextarea.value = '';
                const noteRef = db.collection('userNotes').doc(`${currentUser.uid}_${courseId}_${lessonId}`);
                try { const doc = await noteRef.get(); if (doc.exists) dom.notesTextarea.value = doc.data().content || ''; dom.notesSaveStatus.textContent = 'Sin cambios'; }
                catch (error) { console.error("Error al cargar las notas:", error); dom.notesSaveStatus.textContent = 'Error al cargar'; }
            }
            async function saveNotes(lessonId) {
                if (!currentUser || !dom.notesTextarea || !dom.notesSaveStatus) return; dom.notesSaveStatus.textContent = 'Guardando...';
                const noteRef = db.collection('userNotes').doc(`${currentUser.uid}_${courseId}_${lessonId}`);
                try { await noteRef.set({ uid: currentUser.uid, content: dom.notesTextarea.value, lastUpdated: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true }); dom.notesSaveStatus.textContent = 'Guardado'; }
                catch (error) { console.error("Error al guardar las notas:", error); dom.notesSaveStatus.textContent = 'Error al cargar'; }
                finally { setTimeout(() => { if (dom.notesSaveStatus.textContent === 'Guardado') dom.notesSaveStatus.textContent = 'Sin cambios'; }, 2000); }
            }
            if (dom.notesTextarea) dom.notesTextarea.addEventListener('input', () => { if (!dom.notesSaveStatus) return; dom.notesSaveStatus.textContent = 'Editando...'; clearTimeout(notesSaveTimer); notesSaveTimer = setTimeout(() => saveNotes(userProgress.currentLessonId), 1500); });

            async function renderCourseResources(lesson) {
                if (!dom.resourcesList || !dom.integratedResourcesArea) return;
                const lessonInfo = getLessonInfo(lesson.id);
                if (!lessonInfo || !lessonInfo.module) return;
                const moduleResources = lessonInfo.module.lessons.flatMap(l => l.resources || []);
                const uniqueResources = Array.from(new Map(moduleResources.map(item => [item['name'], item])).values());
                if (uniqueResources.length > 0) {
                    dom.integratedResourcesArea.classList.remove('hidden');
                    dom.resourcesList.innerHTML = '<div class="col-span-full py-5"><p class="text-gray-500 animate-pulse">Cargando recursos del módulo...</p></div>';
                    const resourcesHtmlArray = await Promise.all(uniqueResources.map(async (resource) => {
                        let resolvedUrl = resource.url;
                        if (resource.url.startsWith('gs://')) { try { resolvedUrl = await resolveStorageDownloadURL(storage, resource.url); } catch (e) { console.error("Error resolviendo recurso:", resource.name, e); } }
                        const isPdf = !resource.external && resolvedUrl.toLowerCase().includes('.pdf');
                        const icon = resource.external ? 'link' : (isPdf ? 'file-text' : 'download-cloud');
                        const actionAttr = isPdf ? `data-pdf-url="${resolvedUrl}" data-pdf-title="${resource.name}"` : `href="${resolvedUrl}"`;
                        const targetAttr = resource.external ? 'target="_blank" rel="noopener noreferrer"' : (isPdf ? '' : 'download');
                        const tagName = isPdf ? 'button' : 'a';
                        return `<${tagName} ${actionAttr} ${targetAttr} class="resource-item flex items-center p-4 bg-white border border-gray-200 rounded-xl hover:bg-slate-50 hover:border-teal-500 transition-all duration-200 group text-left">
                                    <div class="bg-teal-50 p-2 rounded-lg mr-4 group-hover:bg-teal-100 transition-colors"><i data-lucide="${icon}" class="h-6 w-6 text-teal-600"></i></div>
                                    <span class="flex-1 font-medium text-gray-700 group-hover:text-teal-700 truncate">${resource.name}</span>
                                    <i data-lucide="chevron-right" class="h-5 w-5 text-gray-400 group-hover:text-teal-500 transition-transform transform group-hover:translate-x-1"></i>
                                </${tagName}>`;
                    }));
                    dom.resourcesList.innerHTML = resourcesHtmlArray.join('');
                } else { dom.integratedResourcesArea.classList.add('hidden'); }
                lucide.createIcons();
            }

            function openPdfModal(url, title) {
                if (!dom.pdfModal || !dom.pdfModalOverlay || !dom.pdfModalContent || !dom.pdfIframe) return;
                dom.pdfModalTitle && (dom.pdfModalTitle.textContent = title);
                const viewerUrl = `https://docs.google.com/gview?url=${encodeURIComponent(url)}&embedded=true`;
                dom.pdfIframe.src = viewerUrl;
                dom.pdfModal.classList.remove('hidden'); dom.pdfModalOverlay.classList.remove('hidden');
                setTimeout(() => { dom.pdfModalOverlay.classList.add('opacity-100'); dom.pdfModalContent.classList.remove('scale-95', 'opacity-0'); }, 10);
            }
            function closePdfModal() {
                if (!dom.pdfModal || !dom.pdfModalOverlay || !dom.pdfModalContent || !dom.pdfIframe) return;
                dom.pdfModalOverlay.classList.remove('opacity-100'); dom.pdfModalContent.classList.add('scale-95', 'opacity-0');
                setTimeout(() => { dom.pdfModal.classList.add('hidden'); dom.pdfModalOverlay.classList.add('hidden'); dom.pdfIframe.src = ''; }, 300);
            }

            if (dom.tabMaterialPanel) {
                dom.tabMaterialPanel.addEventListener('click', (e) => {
                    const button = e.target.closest('.resource-item[data-pdf-url]');
                    if (button) openPdfModal(button.dataset.pdfUrl, button.dataset.pdfTitle);
                });
            }
            if (dom.pdfModalCloseBtn) dom.pdfModalCloseBtn.addEventListener('click', closePdfModal);
            if (dom.pdfModalOverlay) dom.pdfModalOverlay.addEventListener('click', closePdfModal);

            async function downloadTranscription(transcriptionUrl, lessonTitle) {
                if (!transcriptionUrl) { showToast('No hay transcripción disponible.'); return; }
                const btn = document.getElementById('transcription-button');
                const btnSpan = btn ? btn.querySelector('span') : null;
                const originalText = btnSpan ? btnSpan.textContent : '';
                if (btnSpan) btnSpan.textContent = 'Preparando...'; if (btn) btn.disabled = true;
                try {
                    const resolvedUrl = await resolveStorageDownloadURL(storage, transcriptionUrl);
                    const response = await fetch(resolvedUrl); if (!response.ok) throw new Error('Respuesta de red no fue OK');
                    const srtText = await response.text();
                    const plainText = srtText.split(/\r?\n/).filter(line => !/^\d+$/.test(line.trim()) && !line.includes('-->')).join('\n').replace(/(\n\s*){2,}/g, '\n\n').trim();
                    const blob = new Blob([plainText], { type: 'text/plain;charset=utf-8' });
                    const link = document.createElement('a'); link.href = URL.createObjectURL(blob);
                    const sanitizedTitle = lessonTitle.replace(/[^a-z0-9]/gi, '_').toLowerCase();
                    link.download = `transcripcion_${sanitizedTitle}.txt`;
                    document.body.appendChild(link); link.click(); document.body.removeChild(link);
                    URL.revokeObjectURL(link.href); showToast('Descarga iniciada.');
                } catch (error) { console.error('Error al descargar transcripción:', error); showToast('No se pudo descargar.'); }
                finally { if (btnSpan) btnSpan.textContent = originalText; if (btn) btn.disabled = false; }
            }

            async function loadUserResources(lessonId) {
                if (!currentUser || !dom.userResourceList) return;
                dom.userResourceList.innerHTML = '<li><p class="p-3 text-sm text-slate-500">Cargando tus archivos...</p></li>';
                try {
                    const snap = await db.collection('userResources').where('uid', '==', currentUser.uid).where('courseId', '==', courseId).where('lessonId', '==', lessonId).get();
                    if (snap.empty) { dom.userResourceList.innerHTML = '<li><p class="p-3 text-sm text-slate-500 italic">No has subido archivos aún.</p></li>'; return; }
                    const docs = snap.docs.sort((a, b) => (b.data().createdAt?.toDate() || 0) - (a.data().createdAt?.toDate() || 0));
                    dom.userResourceList.innerHTML = '';
                    docs.forEach(doc => renderUserResourceItem(doc));
                } catch (err) { console.error('Error listando recursos:', err); dom.userResourceList.innerHTML = '<li><p class="p-3 text-sm text-red-500">Error al cargar archivos.</p></li>'; }
            }
            function renderUserResourceItem(doc) {
                const data = doc.data(); const li = document.createElement('li'); li.className = 'px-4 py-3 flex items-center justify-between';
                li.innerHTML = `<div class="min-w-0 flex-1"><p class="text-sm font-medium text-slate-900 truncate">${data.name}</p><p class="text-xs text-slate-500 truncate">${data.contentType || ''} - ${Math.round(data.size / 1024)} KB</p></div><div class="flex items-center gap-3"><a href="${data.downloadURL}" target="_blank" class="text-teal-700 text-sm font-semibold hover:underline">Abrir</a><button class="delete-resource-btn text-red-600 text-sm font-semibold hover:underline">Eliminar</button></div>`;
                li.querySelector('.delete-resource-btn').addEventListener('click', async () => {
                    if (!confirm(`¿Seguro que quieres eliminar "${data.name}"?`)) return;
                    try { await storage.ref(data.storagePath).delete(); await doc.ref.delete(); li.remove(); showToast('Archivo eliminado.'); }
                    catch (err) { console.error('Error eliminando:', err); showToast('No se pudo eliminar.'); }
                });
                dom.userResourceList.prepend(li);
            }
            if (dom.resourceFileInput) dom.resourceFileInput.addEventListener('change', () => { if (dom.uploadResourcesBtn) dom.uploadResourcesBtn.disabled = dom.resourceFileInput.files.length === 0; });
            if (dom.uploadResourcesBtn) dom.uploadResourcesBtn.addEventListener('click', async () => {
                const files = dom.resourceFileInput ? dom.resourceFileInput.files : null; if (!files || !files.length || !currentUser) return;
                const lessonId = userProgress.currentLessonId; dom.uploadProgress.classList.remove('hidden');
                for (const file of files) {
                    dom.uploadProgress.textContent = `Subiendo ${file.name}...`; const storagePath = `user_uploads/${currentUser.uid}/${courseId}/${lessonId}/${Date.now()}_${file.name}`; const fileRef = storage.ref(storagePath);
                    try {
                        const uploadTask = await fileRef.put(file); const downloadURL = await uploadTask.ref.getDownloadURL();
                        const docRef = await db.collection('userResources').add({ uid: currentUser.uid, courseId, lessonId, name: file.name, size: file.size, contentType: file.type, storagePath, downloadURL, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
                        const newDoc = await docRef.get(); if (dom.userResourceList.querySelector('p.text-slate-500')) dom.userResourceList.innerHTML = ''; renderUserResourceItem(newDoc);
                    } catch (err) { console.error('Error en subida:', err); dom.uploadProgress.textContent = `Error al subir ${file.name}.`; return; }
                }
                dom.uploadProgress.textContent = '¡Archivos subidos!'; if (dom.resourceFileInput) dom.resourceFileInput.value = ''; if (dom.uploadResourcesBtn) dom.uploadResourcesBtn.disabled = true;
                setTimeout(() => dom.uploadProgress && dom.uploadProgress.classList.add('hidden'), 3000);
            });

            async function loadTasks(lessonId) {
                if (!currentUser || !dom.taskList) return;
                const key = `${currentUser.uid}_${courseId}_${lessonId}`;
                dom.taskList.innerHTML = '';

                // Get the module for this lesson to check for practice tasks
                const lessonInfo = getLessonInfo(lessonId);
                const modulePracticeTasks = lessonInfo?.module?.practiceTasks || [];

                try {
                    const docRef = db.collection('userTasks').doc(key);
                    const doc = await docRef.get();

                    let existingTasks = [];
                    if (doc.exists) {
                        existingTasks = doc.data().items || [];
                    }

                    // Check if we need to add module practice tasks
                    // Only add them if they don't already exist in the user's tasks
                    if (modulePracticeTasks.length > 0 && existingTasks.length === 0) {
                        // First time accessing this lesson - add the module's practice tasks
                        await docRef.set({
                            uid: currentUser.uid,
                            items: modulePracticeTasks.map(task => ({ ...task }))
                        }, { merge: true });

                        // Render the newly added tasks
                        modulePracticeTasks.forEach(task => renderTaskItem(task, docRef));
                    } else if (existingTasks.length > 0) {
                        // Render existing tasks
                        existingTasks.forEach(task => renderTaskItem(task, docRef));
                    }
                }
                catch (err) { console.error('Error cargando tareas:', err); }
            }
            function renderTaskItem(task, docRef) {
                const li = document.createElement('li'); li.className = 'bg-white border border-slate-200 rounded-lg p-3 flex items-center justify-between group';
                li.innerHTML = `<label class="flex-1 flex items-center gap-3 cursor-pointer"><input type="checkbox" class="task-toggle h-4 w-4 rounded border-gray-300 text-teal-600 focus:ring-teal-500" ${task.done ? 'checked' : ''}/><span class="text-sm ${task.done ? 'line-through text-slate-400' : 'text-slate-800'}">${task.text}</span></label><button class="task-delete text-slate-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition-opacity"><i data-lucide="trash-2" class="h-4 w-4"></i></button>`;
                const toggle = li.querySelector('.task-toggle');
                toggle.addEventListener('change', async () => {
                    const doc = await docRef.get(); const items = doc.exists ? doc.data().items || [] : []; const idx = items.findIndex(i => i.text === task.text); if (idx > -1) { items[idx].done = toggle.checked; await docRef.set({ items }, { merge: true }); }
                    const span = li.querySelector('span'); if (span) { span.classList.toggle('line-through', toggle.checked); span.classList.toggle('text-slate-400', toggle.checked); }
                });
                li.querySelector('.task-delete').addEventListener('click', async () => { const doc = await docRef.get(); const items = (doc.data().items || []).filter(i => i.text !== task.text); await docRef.set({ items }, { merge: true }); li.remove(); });
                dom.taskList.append(li); lucide.createIcons();
            }
            async function addTask() {
                if (!currentUser || !dom.taskInput) return; const text = dom.taskInput.value.trim(); if (!text) return;
                const lessonId = userProgress.currentLessonId; const key = `${currentUser.uid}_${courseId}_${lessonId}`; const task = { text, done: false };
                try { const docRef = db.collection('userTasks').doc(key); await docRef.set({ uid: currentUser.uid, items: firebase.firestore.FieldValue.arrayUnion(task) }, { merge: true }); renderTaskItem(task, docRef); dom.taskInput.value = ''; }
                catch (err) { console.error('Error agregando tarea:', err); }
            }
            if (dom.addTaskBtn) dom.addTaskBtn.addEventListener('click', addTask);
            if (dom.taskInput) dom.taskInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); addTask(); } });

            if (dom.supportForm) dom.supportForm.addEventListener('submit', async (e) => {
                e.preventDefault(); const formData = new FormData(dom.supportForm); const lessonInfo = getLessonInfo(userProgress.currentLessonId);
                const dataToSend = { email: auth.currentUser.email, curso: courseData.title, fecha: new Date().toLocaleString('es-CL'), asunto: formData.get('subject'), mensaje: formData.get('message'), leccion: lessonInfo ? lessonInfo.lesson.title : 'N/A', nombreAlumno: currentUser ? currentUser.name : '' };
                if (dom.supportSubmitBtn) dom.supportSubmitBtn.disabled = true; if (dom.supportBtnText) dom.supportBtnText.textContent = 'Enviando...'; if (dom.supportSpinner) dom.supportSpinner.classList.remove('hidden');
                try {
                    const response = await fetch('https://muna.auto.hostybee.com/webhook/soporte', { method: 'POST', body: JSON.stringify(dataToSend), headers: { 'Content-Type': 'application/json' } });
                    if (response.ok) { dom.supportFormStatus.innerHTML = `<p class="text-green-600 font-semibold">¡Consulta enviada!</p>`; dom.supportForm.reset(); }
                    else throw new Error('Error en el envío');
                } catch (error) { dom.supportFormStatus.innerHTML = `<p class="text-red-600 font-semibold">Error al enviar. Intenta más tarde.</p>`; }
                finally { if (dom.supportSubmitBtn) dom.supportSubmitBtn.disabled = false; if (dom.supportBtnText) dom.supportBtnText.textContent = 'Enviar Consulta'; if (dom.supportSpinner) dom.supportSpinner.classList.add('hidden'); }
            });

            function srtToVtt(srt) { const cleaned = srt.replace(/\r+/g, '').replace(/^\s*\d+\s*$/gm, '').replace(/(\d{2}):(\d{2}):(\d{2}),(\d{3})/g, '$1:$2:$3.$4'); return 'WEBVTT\n\n' + cleaned.trim(); }
            async function resolveStorageDownloadURL(storage, maybeGsOrHttpsUrl) { if (!maybeGsOrHttpsUrl) return null; try { const ref = storage.refFromURL(maybeGsOrHttpsUrl); return await ref.getDownloadURL(); } catch (e) { if (/^https?:\/\//i.test(maybeGsOrHttpsUrl)) return maybeGsOrHttpsUrl; throw e; } }
            async function attachMediaAndCaptions({ storage, videoEl, videoSrc, srtOrVttSrc }) {
                const srcEl = videoEl.querySelector('#course-video-source'); const resolvedVideo = await resolveStorageDownloadURL(storage, videoSrc); if (srcEl && resolvedVideo) srcEl.src = resolvedVideo;
                const trackEl = videoEl.querySelector('#caption-track'); if (!trackEl || !srtOrVttSrc) { videoEl.load(); return; }
                const resolvedTrack = await resolveStorageDownloadURL(storage, srtOrVttSrc); if (!resolvedTrack) { videoEl.load(); return; }
                if (/(\.srt)(\?|$)/i.test(resolvedTrack)) { const resp = await fetch(resolvedTrack); const srtTxt = await resp.text(); trackEl.src = URL.createObjectURL(new Blob([srtToVtt(srtTxt)], { type: 'text/vtt' })); }
                else trackEl.src = resolvedTrack;
                trackEl.default = true; const [t] = videoEl.textTracks; if (t) t.mode = 'showing'; videoEl.load();
            }

            function hardDisable(el) { if (!el) return; el.setAttribute('aria-disabled', 'true'); el.setAttribute('tabindex', '-1'); el.classList.add('opacity-60', 'cursor-not-allowed'); if (el.tagName === 'BUTTON') el.disabled = true; const b = (e) => { e.preventDefault(); e.stopImmediatePropagation(); return false; }; el.addEventListener('click', b, true); }
            function lockPostCompletionActions() { if (!getIsCourseComplete()) return; document.querySelectorAll('button[id*="encuesta"], .btn-encuesta, a[href*="encuesta"]').forEach(el => hardDisable(el)); }

            if (dom.logoutButton) dom.logoutButton.addEventListener('click', () => auth.signOut().then(() => window.location.href = `${baseUrl}/index.html`));
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = { uid: user.uid, name: user.displayName || 'Alumno' };
                    if (dom.userName) dom.userName.textContent = currentUser.name;
                    if (dom.userAvatar) dom.userAvatar.src = user.photoURL || `https://placehold.co/100x100/14b8a6/FFFFFF?text=${currentUser.name.charAt(0).toUpperCase()}`;
                    if (dom.userProfile) { dom.userProfile.classList.remove('hidden'); dom.userProfile.classList.add('flex'); }
                    loadProgressAndInitialize();
                } else { window.location.href = `${baseUrl}/acceso.html`; }
            });

            // --- LOGICA MOBILE SIDEBAR ---
            const mobileSidebarToggle = document.getElementById('mobile-sidebar-toggle');
            const mobileSidebarClose = document.getElementById('mobile-sidebar-close');
            const mobileSidebarOverlay = document.getElementById('mobile-sidebar-overlay');
            const sidebar = document.getElementById('course-sidebar');
            const modulesContainerNav = document.getElementById('modules-container');

            function openMobileSidebar() {
                if (!sidebar) return;
                sidebar.classList.remove('-translate-x-full');
                if (mobileSidebarOverlay) {
                    mobileSidebarOverlay.classList.remove('hidden');
                    setTimeout(() => {
                        mobileSidebarOverlay.classList.remove('opacity-0');
                    }, 10);
                }
            }

            function closeMobileSidebar() {
                if (!sidebar) return;
                sidebar.classList.add('-translate-x-full');
                if (mobileSidebarOverlay) {
                    mobileSidebarOverlay.classList.add('opacity-0');
                    setTimeout(() => {
                        mobileSidebarOverlay.classList.add('hidden');
                    }, 300);
                }
            }

            if (mobileSidebarToggle) mobileSidebarToggle.addEventListener('click', openMobileSidebar);
            if (mobileSidebarClose) mobileSidebarClose.addEventListener('click', closeMobileSidebar);
            if (mobileSidebarOverlay) mobileSidebarOverlay.addEventListener('click', closeMobileSidebar);

            if (modulesContainerNav) {
                modulesContainerNav.addEventListener('click', (e) => {
                    if (window.innerWidth < 1024 && e.target.closest('a')) {
                        closeMobileSidebar();
                    }
                });
            }
            if (window.lucide) window.lucide.createIcons();
            // --- FIN LOGICA MOBILE SIDEBAR ---
        });
    </script>
</body>

</html>